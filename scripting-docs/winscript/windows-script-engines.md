---
title: Обработчики скриптов Windows | Документы Майкрософт
ms.custom: ''
ms.date: 01/18/2017
ms.reviewer: ''
ms.suite: ''
ms.tgt_pltfrm: ''
ms.topic: article
helpviewer_keywords:
- Windows script engines
ms.assetid: e576853d-7252-4eb9-81eb-9d5bb7626ab4
caps.latest.revision: 12
author: mikejo5000
ms.author: mikejo
manager: ghogen
ms.openlocfilehash: 94fca3befc13e32e6e2859c7b1ef6330af7b812f
ms.sourcegitcommit: 184e2ff0ff514fb980724fa4b51e0cda753d4c6e
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 10/18/2019
ms.locfileid: "72568940"
---
# <a name="windows-script-engines"></a>Обработчики скриптов Windows
Для реализации обработчика скриптов Microsoft Windows создайте OLE COM-объект, который поддерживает следующие интерфейсы.  
  
|||  
|-|-|  
|Интерфейс|Описание|  
|[IActiveScript](../winscript/reference/iactivescript.md)|Предоставляет базовую возможность создания скриптов. Реализация этого интерфейса является обязательной.|  
|[IActiveScriptParse](../winscript/reference/iactivescriptparse.md)|Предоставляет возможность добавления текста скрипта, вычисления выражений и т. д. Реализация этого интерфейса является необязательной. Тем не менее, если он не реализован, обработчик скриптов должен реализовать один из интерфейсов IPersist* для загрузки скрипта.|  
|IPersist*|Обеспечивает поддержку сохраняемости. Реализация по меньшей мере одного из следующих интерфейсов является обязательной, если интерфейс [IActiveScriptParse](../winscript/reference/iactivescriptparse.md) не реализован.<br /><br /> IPersistStorage: обеспечивает поддержку атрибута DATA={url} в теге OBJECT.<br /><br /> IPersistStreamInit: обеспечивает поддержку для того, что и `IPersistStorage`, а также поддержку атрибута DATA="string-encoded byte stream" в теге OBJECT.<br /><br /> IPersistPropertyBag: обеспечивает поддержку атрибута PARAM= в теге OBJECT.|  
  
> [!NOTE]
> Возможно, что обработчик скриптов никогда не будет вызван для сохранения или восстановления состояния скрипта через `IPersist*`. Вместо этого используется [IActiveScriptParse](../winscript/reference/iactivescriptparse.md) путем вызова [IActiveScriptParse::InitNew](../winscript/reference/iactivescriptparse-initnew.md) для создания пустого скрипта, затем скрипты добавляются и подключаются к событиям с помощью [IActiveScriptParse::AddScriptlet](../winscript/reference/iactivescriptparse-addscriptlet.md), а общий код добавляется с помощью [IActiveScriptParse::ParseScriptText](../winscript/reference/iactivescriptparse-parsescripttext.md). Тем не менее обработчик скриптов должен полностью реализовать по меньшей мере один интерфейс `IPersist*` (предпочтительно `IPersistStreamInit`), так как другие ведущие приложения могут попытаться их использовать.  
  
 В следующих разделах реализация обработчика скриптов Windows описывается более подробно.  
  
 Дополнительные сведения см. в [справочнике по интерфейсам скриптов Windows](../winscript/reference/windows-script-interfaces-reference.md).  
  
## <a name="registry-standard"></a>Стандарт реестра  
 Обработчик скриптов Windows может идентифицировать себя с помощью идентификаторов категорий. В настоящее время скрипт Windows определяет два идентификатора категории.  
  
|||  
|-|-|  
|Категория|Описание|  
|CATID_ActiveScript|Указывает, что идентификаторы классов (CLSID) являются обработчиками скриптов Windows, которые поддерживают как минимум интерфейс [IActiveScript](../winscript/reference/iactivescript.md) и механизм сохраняемости (интерфейсы `IPersistStorage`, `IPersistStreamInit` или IPersistPropertyBag).|  
|CATID_ActiveScriptParse|Указывает, что идентификаторы классов (CLSID) являются обработчиками скриптов Windows, которые поддерживают как минимум интерфейсы [IActiveScript](../winscript/reference/iactivescript.md) и [IActiveScriptParse](../winscript/reference/iactivescriptparse.md).|  
  
 Несмотря на то, что [IActiveScriptParse](../winscript/reference/iactivescriptparse.md) не является действительным механизмом сохраняемости, он поддерживает метод [IActiveScriptParse::InitNew](../winscript/reference/iactivescriptparse-initnew.md), который функционально эквивалентен `IPersist*::InitNew`.  
  
## <a name="script-engine-states"></a>Состояния обработчика скриптов  
 В любой момент времени обработчик скриптов Windows может находиться в одном из нескольких состояний.  
  
|||  
|-|-|  
|Область|Описание|  
|не инициализирован|Скрипт не был инициализирован или загружен с помощью интерфейса IPersist*, или для него не задан интерфейс [IActiveScriptSite](../winscript/reference/iactivescriptsite.md). Обработчик скриптов обычно не работает в этом состоянии, пока не будет загружен скрипт.|  
|инициализирован|Скрипт был инициализирован с помощью интерфейса `IPersist*`, и для него задан интерфейс [IActiveScriptSite](../winscript/reference/iactivescriptsite.md), но он не подключен к объектам узла и событиям приема. Обратите внимание, что это состояние просто означает, что `IPersist*::Load`, `IPersist*::InitNew` или метод [IActiveScriptParse::InitNew](../winscript/reference/iactivescriptparse-initnew.md) были завершены и что был вызван метод [IActiveScript::SetScriptSite](../winscript/reference/iactivescript-setscriptsite.md). Обработчик не может выполнять код в этом режиме. Обработчик помещает в очередь код, который ему передает узел с помощью метода [IActiveScriptParse::ParseScriptText](../winscript/reference/iactivescriptparse-parsescripttext.md), и после перехода в состояние "Запущен" выполняет код.<br /><br /> Поскольку семантика языков может существенно различаться, обработчики скриптов не должны поддерживать переход в это состояние. Однако переход в это состояние должны поддерживать обработчики, поддерживающие метод [IActiveScript::Clone](../winscript/reference/iactivescript-clone.md). Узлы должны подготовиться к этому переходу и выполнить соответствующее действие: освободить текущий обработчик скриптов, создать новый обработчик скриптов и вызвать `IPersist*::Load`, `IPersist*::InitNew` или [IActiveScriptParse::InitNew](../winscript/reference/iactivescriptparse-initnew.md) (возможно, также вызывать [IActiveScriptParse::ParseScriptText](../winscript/reference/iactivescriptparse-parsescripttext.md)). Использование этого перехода следует рассматривать как оптимизацию приведенных выше шагов. Обратите внимание, что все сведения, которые обработчик скриптов получил об именах именованных элементов, и сведения о типе, описывающие именованные элементы, остаются допустимыми.<br /><br /> Поскольку языки сильно различаются, определить точную семантику этого перехода сложно. Как минимум, обработчик скриптов должен отключиться от всех событий и освободить все указатели SCRIPTINFO_IUNKNOWN, полученные путем вызова метода [IActiveScriptSite::GetItemInfo](../winscript/reference/iactivescriptsite-getiteminfo.md). Обработчик должен повторно получить эти указатели после повторного запуска скрипта. Обработчику скриптов также следует сбросить сценарий в исходное состояние, которое подходит для языка. VBScript, например, сбрасывает все переменные и сохраняет любой динамически добавленный код путем вызова метода [IActiveScriptParse::ParseScriptText](../winscript/reference/iactivescriptparse-parsescripttext.md) с установленным флагом SCRIPTTEXT_ISPERSISTENT. Для других языков может потребоваться сохранить текущие значения (например, Lisp, так здесь нет разделения между данными и кодом) или выполнить сброс до хорошо известного состояния (сюда входят языки со статически инициализируемыми переменными).<br /><br /> Обратите внимание, что переход в состояние "Запущен" должен иметь ту же семантику (то есть обработчик скриптов должен оставаться в том же состоянии), что и вызов `IPersist*::Save` для сохранения обработчика скриптов и последующий вызов `IPersist*::Load` для загрузки нового обработчика скриптов. Семантика этих действий должна совпадать с [IActiveScript::Clone](../winscript/reference/iactivescript-clone.md). Обработчики скриптов, которые еще не поддерживают `IActiveScript::Clone` или `IPersist*`, должны обязательно учитывать поведение перехода в состояние "Запущен", чтобы такой переход не нарушал описанные выше условия, если позже была добавлена поддержка `IActiveScript::Clone` или `IPersist*`.<br /><br /> Во время перехода в состояние "Запущен" обработчик скриптов отключится от приемников событий после выполнения соответствующих деструкторов и т. д. в скрипте. Чтобы избежать выполнения этих деструкторов, узел может сначала перевести скрипт в отключенное состояние до перехода в состояние запуска.<br /><br /> Используйте [IActiveScript::InterruptScriptThread](../winscript/reference/iactivescript-interruptscriptthread.md), чтобы отменить выполняющийся поток скрипта без ожидания завершения текущих событий и т. д., чтобы закончить выполнение.|  
|запущен|Переход из состояния "Инициализирован" в состояние "Запущен" приводит к тому, что обработчик выполняет любой код, который был помещен в очередь в состоянии "Инициализирован". Обработчик может выполнять код в состоянии "Запущен", но он не подключен ни к каким событиям, добавленным с помощью метода [IActiveScript::AddNamedItem](../winscript/reference/iactivescript-addnameditem.md). Обработчик может выполнять код путем вызова интерфейса IDispatch, полученного из метода [IActiveScript::GetScriptDispatch](../winscript/reference/iactivescript-getscriptdispatch.md), или путем вызова метода [IActiveScriptParse::ParseScriptText](../winscript/reference/iactivescriptparse-parsescripttext.md). Возможно, что дальнейший процесс фоновой инициализации (прогрессивная загрузка) по-прежнему будет выполняться и вызов метода [IActiveScript::SetScriptState](../winscript/reference/iactivescript-setscriptstate.md) с установленным флагом SCRIPTSTATE_CONNECTED может привести к блокировке скрипта до завершения инициализации.|  
|подключено|Скрипт загружен и подключен для получения событий от объектов узла. Если это переход из состояния "Инициализирован", до входа в состояние "Подключен" и до подключения к событиям обработчик скриптов должен перейти через состояние "Запущен", выполнив необходимые действия.|  
|отключен|Скрипт загружается и находится в состоянии выполнения, но временно отключен от приема событий от объектов узла. Это можно сделать либо логически (без учета полученных событий), либо физически (путем вызова метода IConnectionPoint::Unadvise на соответствующих точках подключения). Если это переход из состояния "инициализирован", до входа в состояние "отключен" обработчик скриптов должен перейти через состояние "запущен", выполнив необходимые действия. Выполняющиеся приемники событий завершают работу до изменения состояния (для отмены выполняющегося потока скрипта используйте [IActiveScript::InterruptScriptThread](../winscript/reference/iactivescript-interruptscriptthread.md)). Это состояние отличается от состояния "инициализирован" тем, что переход в это состояние не приводит к сбросу скрипта, состояние времени выполнения скрипта не сбрасывается и процедура инициализации скрипта не выполняется.|  
|закрыт|Скрипт был закрыт. Обработчик скриптов больше не работает и возвращает ошибки для большинства методов.|  
  
 На следующем рисунке показаны отношения между различными состояниями обработчика скриптов, а также показаны методы, которые вызывают переходы из одного состояния в другое.  
  
 На следующем рисунке показаны действия, выполняемые обработчиком скриптов во время различных переходов между состояниями.  
  
## <a name="scripting-engine-threading"></a>Работа с потоками обработчика скриптов  
 Поскольку обработчик скриптов Windows можно использовать во многих средах, очень важно сохранить его модель выполнения как можно более гибкой. Например, серверному узлу может потребоваться сохранить многопоточную архитектуру и одновременно эффективно использовать скрипт Windows. В то же время узел, который не использует потоки, например стандартное приложение, не должен испытывать нагрузку по управлению потоками. Скрипт Windows достигает этого компромисса, ограничивая способы, которыми свободнопоточный обработчик скриптов может выполнять обратный вызов к узлу, освобождая узел от этой нагрузки.  
  
 Обработчики скриптов, используемые на серверах, обычно реализовывались как свободнопоточные COM-объекты. Это означает, что методы в интерфейсе [IActiveScript](../winscript/reference/iactivescript.md) и его связанных интерфейсах можно вызывать из любого потока в процессе без маршалинга. (К сожалению, это также означает, что обработчик скриптов должен быть реализован в качестве внутрипроцессного сервера, поскольку в настоящее время OLE не поддерживает упаковку свободных потоков объектов в данный момент.) Ответственность за синхронизацию отвечает обработчику сценариев. Для обработчиков, которые внутренне не допускают повторного входа, или для моделей языков, которые не являются многопоточными, процесс синхронизации может быть настолько простым, как сериализация доступа к обработчику скриптов с мьютексом. Конечно, определенные методы, такие как [IActiveScript::InterruptScriptThread](../winscript/reference/iactivescript-interruptscriptthread.md), не должны быть сериализованы таким образом, чтобы постоянно выполняющийся скрипт мог быть остановлен из другого потока.  
  
 Тот факт, что интерфейс [IActiveScript](../winscript/reference/iactivescript.md) обычно является свободнопоточным, обычно означает, что интерфейс [IActiveScriptSite](../winscript/reference/iactivescriptsite.md) и объектная модель узла также должны быть свободнопоточными. Это усложняет реализацию узла, особенно в общем случае, когда узел представляет собой однопоточное приложение Windows с однопоточным контейнерным элементом управления ActiveX в его объектной модели. По этой причине на использование обработчиком скриптов интерфейса [IActiveScriptSite](../winscript/reference/iactivescriptsite.md) налагаются приведенные далее ограничения.  
  
 Сайт скрипта всегда вызывается в контексте потока узлов. То есть обработчик скриптов никогда не вызывает сайт скрипта в контексте созданного им потока. Он делает это только из метода обработчика скриптов, который был вызван с узла посредством [IActiveScript](../winscript/reference/iactivescript.md) и его производных через объект диспетчеризации обработчика скриптов, через сообщение Windows или из источника событий в объектной модели узла.  
  
 Сайт скрипта никогда не вызывается из контекста простого метода управления состояния потока (например, метод [IActiveScript::InterruptScriptThread](../winscript/reference/iactivescript-interruptscriptthread.md)) или из метода [IActiveScript::Clone](../winscript/reference/iactivescript-clone.md).  
  
## <a name="see-also"></a>См. также  
 [Интерфейсы скриптов Windows](../winscript/windows-script-interfaces.md)
