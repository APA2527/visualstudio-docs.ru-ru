---
title: Учебник по DOCKER. часть 6. многоконтейнерные приложения
description: Как настроить сеть между контейнерами и добавить контейнер для базы данных MySQL.
ms.date: 08/04/2020
author: nebuk89
ms.author: ghogen
manager: jillfra
ms.technology: vs-azure
ms.topic: conceptual
ms.workload:
- azure
ms.openlocfilehash: 9513a3414a38aa02f6a4607a8c95bbf02c0e1cf6
ms.sourcegitcommit: c4212f40df1a16baca1247cac2580ae699f97e4c
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 08/31/2020
ms.locfileid: "89176802"
---
# <a name="multi-container-apps"></a>Создание многоконтейнерного приложения

До этого момента вы работали с приложениями с одним контейнером. Но теперь вы добавите MySQL в стек приложений. Часто возникает следующий вопрос: "где будет выполняться MySQL? Установите его в том же контейнере или выполните его отдельно? " Как правило, **каждый контейнер должен выполнять одно и то** же действие. Несколько причин:

- Есть хороший шанс, что вам придется масштабировать API и внешние интерфейсы не так, как базы данных.
- Отдельные контейнеры позволяют изолировать версии и обновить версии
- Хотя контейнер для базы данных можно использовать локально, может потребоваться использовать управляемую службу для базы данных в рабочей среде. Вы не хотите поставлять ядро СУБД вместе с приложением.
- Для выполнения нескольких процессов потребуется диспетчер процессов (контейнер запускает только один процесс), что усложняет запуск и завершение контейнера.

И есть и другие причины. Поэтому вы обновите приложение так, чтобы оно работало следующим образом:

![Приложение Todo, подключенное к контейнеру MySQL](media/multi-app-architecture.png)

## <a name="container-networking"></a>Работа с контейнерами в сети

Помните, что контейнеры по умолчанию работают изолированно и не имеют ничего известного о других процессах или контейнерах на одном компьютере. Итак, как разрешить одному контейнеру взаимодействовать с другим? Ответ — это **сеть**. Теперь вам не нужно быть сетевым инженером (радостных!). Просто запомните это правило...

> [!NOTE]
> Если два контейнера находятся в одной сети, они могут взаимодействовать друг с другом. В противном случае они не могут.

## <a name="start-mysql"></a>Запустите MySQL.

Существует два способа размещения контейнера в сети: назначить его при запуске или подключить существующий контейнер. Сейчас вы создадите сеть и присоедините контейнер MySQL при запуске.

1. Создайте сеть.

    ```bash
    docker network create todo-app
    ```

1. Запустите контейнер MySQL и подключите его к сети. Мы также определим несколько переменных среды, которые база данных будет использовать для инициализации базы данных (см. раздел "переменные среды" в [перечне MySQL DOCKER Hub](https://hub.docker.com/_/mysql/)) (замените ` \ ` символы `` ` `` в в Windows PowerShell).

    ```bash
    docker run -d \
        --network todo-app --network-alias mysql \
        -v todo-mysql-data:/var/lib/mysql \
        -e MYSQL_ROOT_PASSWORD=secret \
        -e MYSQL_DATABASE=todos \
        mysql:5.7
    ```

    Вы также увидите указанный `--network-alias` флаг. Мы вернемся к этому чуть позже.

    > [!TIP]
    > Вы заметите, что здесь вы используете имя тома и подключаете `todo-mysql-data` его на `/var/lib/mysql` , где MySQL хранит свои данные. Однако вы никогда не выполняли `docker volume create` команду. DOCKER распознает, что вы хотите использовать именованный том и автоматически создает его.

1. Чтобы убедиться, что база данных работает, подключитесь к базе данных и убедитесь, что она подключена.

    ```bash
    docker exec -it <mysql-container-id> mysql -p
    ```

    Когда появится запрос на ввод пароля, введите **секретный код**. В интерпретаторе MySQL выведите список баз данных и убедитесь, что вы видите `todos` базу данных.

    ```cli
    mysql> SHOW DATABASES;
    ```

    Вы должны получить следующий результат:

    ```plaintext
    +--------------------+
    | Database           |
    +--------------------+
    | information_schema |
    | mysql              |
    | performance_schema |
    | sys                |
    | todos              |
    +--------------------+
    5 rows in set (0.00 sec)
    ```

    Радостных! У вас есть `todos` база данных, и она готова к использованию!

## <a name="connect-to-mysql"></a>Подключение к MySQL

Теперь, когда вы умеете работать с MySQL, давайте будем использовать его! Но вопрос —... настройке? Если запустить другой контейнер в той же сети, как найти контейнер (Помните, что каждый контейнер имеет свой собственный IP-адрес)?

Чтобы понять, как это сделать, вы будете использовать контейнер [николака/нетшут](https://github.com/nicolaka/netshoot) , который поставляется с *множеством* средств, полезных для устранения неполадок или отладки сетевых проблем.

1. Запустите новый контейнер с помощью `nicolaka/netshoot` образа. Обязательно подключите его к той же сети.

    ```bash
    docker run -it --network todo-app nicolaka/netshoot
    ```

1. В контейнере используйте `dig` команду, которая является полезным средством DNS. Найдите IP-адрес для имени узла `mysql` .

    ```bash
    dig mysql
    ```

    И вы получите вывод, подобный этому...

    ```text
    ; <<>> DiG 9.14.1 <<>> mysql
    ;; global options: +cmd
    ;; Got answer:
    ;; ->>HEADER<<- opcode: QUERY, status: NOERROR, id: 32162
    ;; flags: qr rd ra; QUERY: 1, ANSWER: 1, AUTHORITY: 0, ADDITIONAL: 0

    ;; QUESTION SECTION:
    ;mysql.             IN  A

    ;; ANSWER SECTION:
    mysql.          600 IN  A   172.23.0.2

    ;; Query time: 0 msec
    ;; SERVER: 127.0.0.11#53(127.0.0.11)
    ;; WHEN: Tue Oct 01 23:47:24 UTC 2019
    ;; MSG SIZE  rcvd: 44
    ```

    В разделе "ответ" вы увидите `A` запись с `mysql` разрешениями `172.23.0.2` (ваш IP-адрес, скорее всего, будет иметь другое значение). Хотя это `mysql` и не является допустимым именем узла, Docker удалось разрешить его IP-адресу контейнера, который имел такой сетевой псевдоним (Помните, что `--network-alias` вы использовали ранее флаг).

    Это означает... вашему приложению просто нужно подключиться к узлу с именем `mysql` , и он будет обращаться к базе данных. Это не намного проще, чем это сделать!

## <a name="run-your-app-with-mysql"></a>Запуск приложения с помощью MySQL

Приложение Todo поддерживает настройку нескольких переменных среды для указания параметров подключения MySQL. К ним относятся:

- `MYSQL_HOST` — имя узла для работающего сервера MySQL.
- `MYSQL_USER` — имя пользователя, используемое для соединения.
- `MYSQL_PASSWORD` — пароль, используемый для подключения.
- `MYSQL_DB` — база данных, которая будет использоваться после подключения

> [!WARNING]
> **Настройка параметров соединения с помощью переменных среды** Использование переменных среды для установки параметров соединения обычно подходит для разработки, поэтому при запуске приложений в рабочей среде настоятельно не рекомендуется. Чтобы понять причину, см. раздел Почему не следует [использовать переменные среды для секретных данных](https://diogomonica.com/2017/03/27/why-you-shouldnt-use-env-variables-for-secret-data/).
> Более безопасный механизм заключается в использовании поддержки секрета, предоставляемой платформой оркестрации контейнеров. В большинстве случаев эти секреты монтируются как файлы в работающем контейнере. Вы увидите, что многие приложения (включая образ MySQL и приложение Todo) также поддерживают env переменных с `_FILE` суффиксом, который указывает на файл, содержащий файл.
> Например, если задать значение `MYSQL_PASSWORD_FILE` var, приложение будет использовать содержимое файла, на который указывает ссылка, в качестве пароля подключения. DOCKER не делает ничего для поддержки этих env переменных. Приложение должно знать, что нужно найти переменную и получить содержимое файла.

Используя все эти объяснения, запустите контейнер, готовый для разработки.

1. Укажите каждую из переменных среды, приведенных выше, и подключите контейнер к сети приложений (замените ` \ ` символы `` ` `` в в Windows PowerShell).

    ```bash hl_lines="3 4 5 6 7"
    docker run -dp 3000:3000 \
      -w /app -v ${PWD}:/app \
      --network todo-app \
      -e MYSQL_HOST=mysql \
      -e MYSQL_USER=root \
      -e MYSQL_PASSWORD=secret \
      -e MYSQL_DB=todos \
      node:12-alpine \
      sh -c "yarn install && yarn run dev"
    ```

1. Если взглянуть на журналы контейнера ( `docker logs <container-id>` ), вы увидите сообщение, указывающее, что используется база данных MySQL.

    ```plaintext hl_lines="7"
    # Previous log messages omitted
    $ nodemon src/index.js
    [nodemon] 1.19.2
    [nodemon] to restart at any time, enter `rs`
    [nodemon] watching dir(s): *.*
    [nodemon] starting `node src/index.js`
    Connected to mysql db at host mysql
    Listening on port 3000
    ```

1. Откройте приложение в браузере и добавьте несколько элементов в список дел.

1. Подключитесь к базе данных MySQL и подтвердите, что элементы записываются в базу данных. Помните, что пароль является **секретным**.

    ```bash
    docker exec -ti <mysql-container-id> mysql -p todos
    ```

    В оболочке MySQL выполните следующую команду:

    ```plaintext
    mysql> select * from todo_items;
    +--------------------------------------+--------------------+-----------+
    | id                                   | name               | completed |
    +--------------------------------------+--------------------+-----------+
    | c906ff08-60e6-44e6-8f49-ed56a0853e85 | Do amazing things! |         0 |
    | 2912a79e-8486-4bc3-a4c5-460793a575ab | Be awesome!        |         0 |
    +--------------------------------------+--------------------+-----------+
    ```

    Очевидно, что таблица будет выглядеть иначе, так как она содержит элементы. Но вы должны увидеть, что они хранятся!

Если взглянуть на расширение DOCKER, вы увидите, что у вас работают два контейнера приложений. Но нет никакой реальной индикации того, что они группируются в одном приложении. Вы узнаете, как сделать это лучше в ближайшее время!

![Расширение DOCKER, демонстрирующее два несгруппированных контейнера приложений](media/vs-multi-container-app.png)

## <a name="recap"></a>Резюме

На этом этапе у вас есть приложение, которое теперь хранит свои данные во внешней базе данных, работающей в отдельном контейнере. Вы узнали немного о сетях контейнеров и увидели, как можно выполнять обнаружение служб с помощью DNS.

Но есть хорошая вероятность того, что вы начнете немного, что вам нужно сделать для запуска этого приложения. Необходимо создать сеть, запустить контейнеры, указать все переменные среды, предоставить порты и многое другое. Это очень важно помнить, и, безусловно, это затрудняет передачу другим сотрудникам.

В следующем разделе мы поговорим о Docker Compose. С помощью Docker Compose можно значительно упростить общий доступ к стекам приложений и позволить другим расвращать их с помощью одной (и простой) команды.

## <a name="next-steps"></a>Дальнейшие действия

Продолжайте работу с руководством.

> [!div class="nextstepaction"]
> [Использование Docker Compose](use-docker-compose.md)
