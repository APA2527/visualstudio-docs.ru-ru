---
title: Поддержка потоков в Office
ms.date: 02/02/2017
ms.topic: conceptual
dev_langs:
- VB
- CSharp
helpviewer_keywords:
- multiple threads [Office development in Visual Studio]
- threading [Office development in Visual Studio]
- Office applications [Office development in Visual Studio], threading support
- object models [Office development in Visual Studio], threading support
author: John-Hart
ms.author: johnhart
manager: jillfra
ms.workload:
- office
ms.openlocfilehash: 3218a12add86739c76cd50f82fdda5d845e2b069
ms.sourcegitcommit: 94b3a052fb1229c7e7f8804b09c1d403385c7630
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 04/23/2019
ms.locfileid: "62978771"
---
# <a name="threading-support-in-office"></a>Поддержка потоков в Office
  В этой статье сведения о поддержке потоков в объектной модели Microsoft Office. Объектная модель Office не является потокобезопасным, но это можно работать с несколькими потоками в решении Office. Приложения Office являются серверами компонент объекта модели (COM). COM позволяет клиентам вызывать COM-серверов с произвольными потоками. Для COM-серверов, которые не являются потокобезопасными предоставляют механизм для сериализации одновременных вызовов, чтобы только один логический поток выполняется на сервере в любое время. Этот механизм известен как модели однопотоковое подразделение (STA). Так как вызовы сериализуются, вызывающие объекты могут быть заблокированы для периодов времени, пока сервер занят или обрабатывает другие вызовы в фоновом потоке.

 [!INCLUDE[appliesto_all](../vsto/includes/appliesto-all-md.md)]

## <a name="knowledge-required-when-using-multiple-threads"></a>Знания, необходимые при использовании нескольких потоков
 Для работы с несколькими потоками, необходимо иметь хотя бы базовые знания о следующих характеристик многопоточности:

- API-интерфейсы Windows

- COM многопоточных основные понятия

- параллелизм

- Синхронизация

- Маршалинг

  Общие сведения о многопоточности см [Managed threading](/dotnet/standard/threading/).

  Office работает в главной STA. Основные сведения о последствиях это дает возможность понять, как использовать несколько потоков с Office.

## <a name="basic-multithreading-scenario"></a>Основной сценарий многопоточности
 Код в решениях Office всегда выполняется в основном потоке пользовательского интерфейса. Может потребоваться сгладить производительность приложения, выполнив отдельную задачу в фоновом потоке. Целью является выполнить две задачи первый взгляд за один раз вместо одной задачи, которые следуют другой, что должно привести плавного выполнения (основная причина использования нескольких потоков). Например возможно, ваш код события в основном потоке пользовательского интерфейса Excel и в фоновом потоке можно запустить задачу, которая собирает данные с сервера и обновляет ячейки в пользовательском Интерфейсе Excel с данными с сервера.

## <a name="background-threads-that-call-into-the-office-object-model"></a>Фоновые потоки, которые вызывают объектной модели Office
 Автоматически, когда фоновый поток выполняет вызов в приложение Office, вызов маршалируется через границу однопотокового Подразделения. Тем не менее нет никакой гарантии, что приложения Office могут обрабатывать вызовов во время фонового потока. Существует несколько вариантов:

1. Приложения Office необходимо передавать сообщения для вызова иметь возможность ввести. Если это происходит без торможения, это может занять время.

2. Если другой логический поток уже находится в подразделении, не удается ввести новый поток. Это часто происходит, когда логический поток поступает в приложение Office, а затем делает повторный входящий вызов обратно к подразделению вызывающей стороны. Приложение ожидает возвращения звонка.

3. Excel может находиться в состоянии, таким образом, чтобы он не может обработать немедленно входящего вызова. Например приложения Office могут применяться для отображения модального диалогового окна.

   Для возможности, 2 и 3, обеспечивает COM [IMessageFilter](/windows/desktop/api/objidl/nn-objidl-imessagefilter) интерфейс. Если такой интерфейс сервера, все вызовы поступают через [HandleIncomingCall](/windows/desktop/api/objidl/nf-objidl-imessagefilter-handleincomingcall) метод. 2 варианте вызовы будут автоматически отклонены. 3 варианте сервер может отклонить вызов, в зависимости от обстоятельств. Если вызов отклоняется, вызывающий объект должен выбрать нужное действие. Как правило, вызывающий объект реализует [IMessageFilter](/windows/desktop/api/objidl/nn-objidl-imessagefilter), в этом случае он будет получать уведомления о отклонения по [RetryRejectedCall](/windows/desktop/api/objidl/nf-objidl-imessagefilter-retryrejectedcall) метод.

   Однако в случае решений, созданных с помощью средств разработки Office в Visual Studio, COM-взаимодействия преобразует все отклоненные вызовы <xref:System.Runtime.InteropServices.COMException> («фильтр сообщений выдал приложение занято»). При осуществлении звонка объектной модели в фоновом потоке, должны быть готовы обрабатывать это исключение. Обычно повторных попыток в течение отведенного времени и затем отображения диалогового окна. Тем не менее можно также создать фоновый поток как STA и затем зарегистрировать фильтр сообщений для потока для обработки таких случаев.

## <a name="start-the-thread-correctly"></a>Правильно запустить поток
 При создании нового потока STA, задайте состояние подразделения в STA, перед началом потока. В следующем примере кода показано, как это сделать.

 [!code-csharp[Trin_VstcoreCreatingExcel#5](../vsto/codesnippet/CSharp/Trin_VstcoreCreatingExcelCS/ThisWorkbook.cs#5)]
 [!code-vb[Trin_VstcoreCreatingExcel#5](../vsto/codesnippet/VisualBasic/Trin_VstcoreCreatingExcelVB/ThisWorkbook.vb#5)]

 Дополнительные сведения см. в разделе [управляемых потоков рекомендации](/dotnet/standard/threading/managed-threading-best-practices).

## <a name="modeless-forms"></a>Безрежимные формы
 Немодальной формы позволяет какого-либо рода взаимодействия с приложением при отображении формы. Пользователь взаимодействует с формой и формы взаимодействуют с открытыми приложениями. Объектная модель Office поддерживает Безрежимные формы; Тем не менее они должны использоваться не в фоновом потоке.

## <a name="see-also"></a>См. также
- [Threading (C#)](/dotnet/csharp/programming-guide/concepts/threading/index) (Работа с потоками (C#))
- [Threading (Visual Basic)](/dotnet/visual-basic/programming-guide/concepts/threading/index) (Работа с потоками (Visual Basic))
- [Использование потоков и работа с потоками](/dotnet/standard/threading/using-threads-and-threading)
- [Разработка и создание решений Office](../vsto/designing-and-creating-office-solutions.md)
