---
title: Развертывание Инструменты Visual Studio для решения Office с помощью установщик Windows
ms.date: 08/18/2010
ms.topic: conceptual
dev_langs:
- VB
- CSharp
helpviewer_keywords:
- Office development in Visual Studio, setup project
- Office development in Visual Studio, MSI
- deploying applications [Office development in Visual Studio], setup project
- deploying applications [Office development in Visual Studio], MSI
- ClickOnce deployment [Office development in Visual Studio], MSI
- publishing Office solutions [Office development in Visual Studio], setup project
- Office applications [Office development in Visual Studio], MSI
author: John-Hart
ms.author: johnhart
manager: jillfra
ms.workload:
- office
ms.openlocfilehash: 46bfa808cbf99e942d7aadd2802f51eecfcefae8
ms.sourcegitcommit: 6cfffa72af599a9d667249caaaa411bb28ea69fd
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 09/02/2020
ms.locfileid: "81444910"
---
# <a name="deploying-a-visual-studio-tools-for-office-solution-using-windows-installer"></a>Развертывание Инструменты Visual Studio для решения Office с помощью установщик Windows

## <a name="summary"></a>Сводка

Узнайте, как развернуть надстройку Microsoft Visual Studio Tools для Office (VSTO) или решение на уровне документа с помощью проекта Visual Studio Installer.

Ваутер Van Вугт, Code юристом

Pattison), Группа Pattison)

Эта статья была обновлена корпорацией Майкрософт с разрешениями от оригинальных авторов.

**Применимо к:** Инструменты Visual Studio для Office, Microsoft Office Microsoft Visual Studio.

## <a name="overview"></a>Обзор

Вы можете разработать решение VSTO и развернуть решение с помощью пакета установщик Windows. В этом обсуждении содержатся инструкции по развертыванию простой надстройки Office.

## <a name="deployment-methods"></a>Методы развертывания

ClickOnce можно легко использовать для создания настроек для надстроек и решений. Однако он не может устанавливать надстройки, для которых требуются права администратора, например надстройки уровня компьютера.

Надстройки, требующие прав администратора, могут быть установлены с помощью установщик Windows но для их создания требуется больше усилий.

Общие сведения о развертывании решения VSTO с помощью ClickOnce см. в статье [развертывание решения Office](deploying-an-office-solution-by-using-clickonce.md)с помощью ClickOnce.

## <a name="deploying-office-solutions-that-target-the-vsto-runtime"></a>Развертывание решений Office, предназначенных для среды выполнения VSTO

При установке решения Office пакеты ClickOnce и установщик Windows должны выполнять те же элементарные задачи.

1. Установите необходимые компоненты на компьютере пользователя.
2. Развертывание конкретных компонентов для решения.
3. Для надстроек создайте записи реестра.
4. Доверяете решению, чтобы разрешить его выполнение.

### <a name="required-prerequisite-components-on-the-target-computer"></a>Необходимые обязательные компоненты на конечном компьютере

Ниже приведен список программного обеспечения, которое должно быть установлено на компьютере для запуска решений VSTO.

- Microsoft Office 2010 или более поздней версии.
- Microsoft .NET Framework 4 или более поздней версии.
- Среда выполнения средств Microsoft Visual Studio 2010 для Office.
  Среда выполнения предоставляет среду, которая управляет надстройками и решениями на уровне документа. Версия среды выполнения поставляется с Microsoft Office но вам может потребоваться повторно распространить определенную версию с помощью надстройки.
- Основные сборки взаимодействия для Microsoft Office, если не используются внедренные типы взаимодействия.
- Все служебные сборки, на которые ссылаются проекты.

### <a name="specific-components-for-the-solution"></a>Конкретные компоненты для решения

Пакет установщика должен установить эти компоненты на компьютер пользователя:

- Microsoft Office документ, если вы создаете решение на уровне документа.
- Сборка настройки и все необходимые сборки.
- Дополнительные компоненты, такие как файлы конфигурации.
- Манифест приложения (manifest).
- Манифест развертывания (VSTO).

### <a name="registry-entries-for-add-ins"></a>Записи реестра для надстроек

Microsoft Office использует записи реестра для нахождение и загрузки надстроек. Эти записи реестра должны быть созданы как часть процесса развертывания. Дополнительные сведения об этих записях реестра см. в разделе [записи реестра для надстроек VSTO](registry-entries-for-vsto-add-ins.md).

Для надстроек Outlook, отображающих настраиваемые области формы, требуются дополнительные записи реестра, позволяющие идентифицировать области форм. Дополнительные сведения о записях реестра см. в разделе [записи реестра для областей формы Outlook](registry-entries-for-vsto-add-ins.md#OutlookEntries).

Для решений уровня документа не требуются никакие записи реестра. Вместо этого для нахождение настройки используются свойства внутри документа. Дополнительные сведения об этих свойствах см. в разделе [Общие сведения о пользовательских свойствах документа](custom-document-properties-overview.md).

### <a name="trusting-the-vsto-solution"></a>Доверие к решению VSTO

Чтобы выполнить настройку, решение должно быть доверенным для компьютера. Надстройку можно доверять, подписывая манифест с помощью сертификата, создав отношение доверия со списком включения или установив его в надежное расположение на компьютере.

Дополнительные сведения о получении сертификата для подписания см. в разделе [Развертывание ClickOnce и Authenticode](../deployment/clickonce-and-authenticode.md). Дополнительные сведения о доверии решений см. в разделе [доверие решений Office с помощью списков включения](trusting-office-solutions-by-using-inclusion-lists.md). Вы можете добавить запись списка включения с настраиваемым действием в файл установщик Windows. Дополнительные сведения о включении списка включения см. [в разделе инструкции. Настройка безопасности списка включений](how-to-configure-inclusion-list-security.md).

Если ни один из этих вариантов не используется, пользователю отображается запрос о доверии, позволяющий решить, следует ли доверять решению.

Дополнительные сведения о безопасности, связанной с решениями на уровне документа, см. в разделе [Предоставление доверия документам](granting-trust-to-documents.md).

## <a name="creating-a-basic-installer"></a>Создание базового установщика

Шаблоны проектов установки и развертывания включены в расширение [проектов Microsoft Visual Studio Installer](https://marketplace.visualstudio.com/items?itemName=visualstudioclient.MicrosoftVisualStudio2017InstallerProjects) , доступное для загрузки.

Чтобы создать установщик для решения Office, необходимо выполнить следующие задачи.

- Добавьте компоненты решения Office, которые будут развернуты.
- Для надстроек уровня приложения настройте разделы реестра.
- Настройте необходимые компоненты, чтобы их можно было установить на компьютерах конечных пользователей.
- Настройте условия запуска, чтобы убедиться в доступности необходимых необходимых компонентов. Условия запуска можно использовать для блокирования установки, если не установлены все необходимые компоненты.

Первым шагом является создание проекта установки.

### <a name="to-create-the-addin-setup-project"></a>Создание проекта установки надстройки

1. Откройте проект надстройки Office, который требуется развернуть. В этом примере мы используем надстройку Excel под названием ExcelAddIn.
2. Откройте проект Office, в меню **файл** разверните узел **Добавить** и щелкните **Новый проект** , чтобы добавить новый проект.
::: moniker range="=vs-2017"
3. В диалоговом окне **Добавление нового проекта** разверните узел **другие типы проектов** на панели **типы проектов** , затем разверните узел **настройка и развертывание** , а затем выберите **Visual Studio Installer**.
4. В области **шаблоны** выберите пункт **Настройка проекта** из группы **Установленные шаблоны Visual Studio** .
::: moniker-end
::: moniker range="=vs-2019"
3. В диалоговом окне **Добавление нового проекта** выберите шаблон **проекта установки** .
4. Нажмите кнопку **Далее**.
::: moniker-end

5. В поле **имя** введите **OfficeAddInSetup**.
::: moniker range="=vs-2017"
6. Нажмите кнопку **Открыть** , чтобы создать новый проект установки.
::: moniker-end
::: moniker range="=vs-2019"
6. Нажмите кнопку **создать** , чтобы создать новый проект установки.
::: moniker-end

Visual Studio откроет обозреватель файловой системы для нового проекта установки. Обозреватель файловой системы позволяет добавлять файлы в проект установки.

   ![Снимок экрана: обозреватель файловой системы для проекта установки](media/setup-project-figure-1.png)

   **Рис. 1. Обозреватель файловой системы для проекта установки**

Проект установки должен развернуть ExcelAddIn. Вы можете настроить проект установки для этой задачи, добавив выходные данные проекта ExcelAddIn в проект установки.

### <a name="to-add-the-exceladdin-project-output"></a>Добавление выходных данных проекта ExcelAddIn

1. В **Обозреватель решений**щелкните правой кнопкой мыши **OfficeAddInSetup**, выберите **Добавить** , а затем **выходные данные проекта**.
2. В диалоговом окне **Добавление выходной группы проекта** выберите **ExcelAddIn** из списка проект и **Основные выходные данные**.
3. Нажмите кнопку **ОК** , чтобы добавить выходные данные проекта в проект установки.

    ![Снимок экрана: диалоговое окно добавления выходной группы проекта установки](media/setup-project-figure-2.png)

    **Рис. 2. диалоговое окно установки проекта "Добавление выходной группы проекта"**

Проект установки должен развернуть манифест развертывания и манифест приложения. Добавьте эти два файла в проект установки как автономные файлы из выходной папки проекта ExcelAddIn.

### <a name="to-add-the-deployment-and-application-manifests"></a>Добавление манифестов развертывания и приложений

1. В **Обозреватель решений**щелкните правой кнопкой мыши **OfficeAddInSetup**, выберите команду **добавить**и щелкните **файл**.
2. В диалоговом окне **Добавление файлов** перейдите к выходному каталогу **ExcelAddIn** . Обычно выходным каталогом является вложенная папка **bin \\ Release** в корневом каталоге проекта в зависимости от выбранной конфигурации сборки.
3. Выберите файлы **ExcelAddIn. VSTO** и **ExcelAddIn.dll. manifest** и нажмите кнопку **Открыть** , чтобы добавить эти два файла в проект установки.

    ![Снимок экрана манифестов приложения и развертывания в обозреватель решений](media/setup-project-figure-3.jpg)

    **Рис. 3. манифесты приложения и развертывания для надстройки в обозреватель решений**

Ссылка на ExcelAddIn включает все компоненты, необходимые ExcelAddIn. Эти компоненты необходимо исключить и развернуть с помощью пакетов необходимых компонентов, чтобы разрешить их правильную регистрацию. Кроме того, перед началом установки необходимо отобразить и принять условия лицензионного соглашения на использование программного обеспечения.

### <a name="to-exclude-the-exceladdin-project-dependencies"></a>Исключение зависимостей проекта ExcelAddIn

1. В **Обозреватель решений**в узле **OfficeAddInSetup** выберите все элементы зависимостей под элементом **обнаруженные зависимости** , за исключением **платформы Microsoft .NET Framework** или любой сборки, завершающей ** \*.Utilities.dll**. Сборки служебных программ предназначены для развертывания вместе с приложением.
2. Щелкните правой кнопкой мыши группу и выберите пункт **Свойства**.
3. В окне **Свойства** измените значение свойства **исключить** на **true** , чтобы исключить зависимые сборки из проекта установки. Не следует исключать какие бы то ни было сборки служебных программ.

    ![Снимок экрана обозреватель решений с отображением зависимостей для исключения](media/setup-project-figure-4.jpg)

    **Рис. 4. исключение зависимостей**

Вы можете настроить пакет установщик Windows для установки необходимых компонентов путем добавления программы установки, которая также называется загрузчиком. Эта программа установки может установить необходимые компоненты — процесс, называемый начальной загрузкой.

Для **ExcelAddIn**необходимо установить эти необходимые компоненты, чтобы надстройка могла работать правильно.

- Версия платформы Microsoft .NET Framework, для которой предназначено решение Office.
- Набор средств Microsoft Visual Studio 2010 для Office Runtime.

Настройка зависимых компонентов в качестве предварительных требований

1. В **Обозреватель решений**щелкните правой кнопкой мыши проект **OfficeAddInSetup** и выберите пункт **Свойства**.
2. Откроется диалоговое окно **страницы свойств OfficeAddInSetup** .
3. Нажмите кнопку **Предварительные требования** .
4. В диалоговом окне необходимые компоненты выберите правильную версию .NET Framework и средства Microsoft Visual Studio для среды выполнения Office.

    ![Снимок экрана: диалоговое окно "необходимые компоненты"](media/setup-project-figure-5.png)

    **Рис. 5. диалоговое окно "необходимые компоненты"**

    > [!NOTE]
    >Некоторые из настроенных необходимых пакетов в проекте установки Visual Studio зависят от выбранной конфигурации сборки. Необходимо выбрать нужные компоненты для каждой используемой конфигурации сборки.

Microsoft Office находит надстройки с помощью разделов реестра. Ключи в \_ Hive текущего пользователя hKey \_ используются для регистрации надстройки для каждого отдельного пользователя. Ключи в \_ \_ кусте реестра hKey Local Machine используются для регистрации надстройки для всех пользователей компьютера. Дополнительные сведения о разделах реестра см. в разделе [записи реестра для надстроек VSTO](registry-entries-for-vsto-add-ins.md).

### <a name="to-configure-the-registry"></a>Настройка реестра

1. В **Обозреватель решений**щелкните правой кнопкой мыши **OfficeAddInSetup**.
2. Развернуть **представление**.
3. Щелкните **Реестр** , чтобы открыть окно редактора реестра.
4. В редакторе **реестра (OfficeAddInSetup)** разверните узел **hKey \_ локальный \_ компьютер** , а затем **программное обеспечение**.
5. Удалить ** \[ изготовителя \] **? ключ, найденный в разделе ** \_ \_ \\ программное обеспечение для локального компьютера hKey**.
6. Разверните раздел **hKey \_ текущий \_ пользователь** , а затем **программное обеспечение**.
7. Удалите ключ ** \[ производителя \] ** , найденный в разделе ** \_ \_ \\ программное обеспечение для текущего пользователя hKey**.
8. Чтобы добавить разделы реестра для установки надстройки, щелкните правой кнопкой мыши раздел **Hive пользователя или компьютера** и выберите **создать раздел**. Используйте текстовое **по** для имени нового ключа. Щелкните правой кнопкой мыши созданный **программный** ключ и создайте новый ключ с текстом **Microsoft**.
9. Используйте аналогичную процедуру, чтобы создать всю иерархию ключей, необходимую для регистрации надстройки:

    **Пользователь или компьютер Hive \\ программное обеспечение \\ Microsoft \\ Office \\ Excel \\ AddIns \\ самплекомпани. ExcelAddIn**

    Название компании часто используется в качестве префикса для имени надстройки, чтобы обеспечить уникальность.

10. Щелкните правой кнопкой мыши ключ **самплекомпани. ExcelAddIn** , выберите пункт **создать**и щелкните **строковое значение**. Используйте текстовое **Описание** для имени.
11. Используйте этот шаг, чтобы добавить еще три значения:
    - **FriendlyName** **строки** типа
    - **LoadBehavior** типа **DWORD**
    - **Манифест** **строкового** типа

12. Щелкните правой кнопкой мыши значение **Description** в редакторе реестра и выберите пункт **окно "свойства**". В **окне Свойства**введите **демонстрационную надстройку Excel** для свойства Value.
13. Выберите ключ **FriendlyName** в редакторе реестра. В **окне Свойства**измените **значение свойства Value** на **демонстрационную надстройку Excel**.
14. Выберите ключ **LoadBehavior** в редакторе реестра. В **окне Свойства**измените **значение свойства Value** на **3.** Значение 3 для параметра LoadBehavior указывает, что надстройка должна загружаться при запуске ведущего приложения. Дополнительные сведения о поведении нагрузки см. в разделе [записи реестра для надстроек VSTO](registry-entries-for-vsto-add-ins.md).

15. Выберите ключ **манифеста** в редакторе реестра. В **окне Свойства**измените **значение свойства Value** на **File:///[TARGETDIR] ExcelAddIn. VSTO | vstolocal**

    ![Снимок экрана редактора реестра](media/setup-project-figure-6.png)

    **Рис. 6. Настройка разделов реестра**

      Среда выполнения VSTO использует этот раздел реестра для размещения манифеста развертывания. Макрос [TARGETDIR] будет заменен папкой, в которую устанавливается надстройка. Макрос будет содержать символ \ \ \, поэтому имя файла манифеста развертывания должно быть ExcelAddIn. VSTO без символа \.
      Постфиксный параметр **vstolocal** сообщает среде выполнения VSTO, что надстройка должна загружаться из этого расположения, а не из кэша ClickOnce. Удаление этого постфикса приведет к тому, что среда выполнения скопирует настройку в кэш ClickOnce.

   >[!WARNING]
   >При работе с редактором реестра в Visual Studio следует соблюдать особую осторожность. Например, если вы случайно настроили Делетеатунинсталл для неправильного ключа, можно удалить активную часть реестра, разоставляющую компьютер пользователя в нестабильном или даже более плохом состоянии.

64-разрядные версии Office будут использовать куст реестра 64-bit для поиска надстроек. Для регистрации надстроек в 64-разрядном кусте реестра Целевая платформа проекта установки должна быть установлена только на 64-бит.

1. Выберите проект **OfficeAddInSetup** в обозревателе решений.
2. Перейдите в окно **свойств** и задайте для свойства **таржетплатформ** значение **x64**.

При установке надстройки для 32-разрядных и 64-разрядных версий Office потребуется создать два отдельных пакета MSI. Один для 32-бит и один для 64-бит.

  ![Снимок экрана: окно "Свойства", показывающее целевую платформу для регистрации надстроек с 64-разрядным Office](media/setup-project-figure-7.jpg)

  **Рис. 7. Целевая платформа для регистрации надстроек с 64-разрядным Office**

Если пакет MSI используется для установки надстройки или решения, он может быть установлен без установки необходимых компонентов. Вы можете использовать условия запуска в MSI, чтобы заблокировать установку надстройки, если необходимые компоненты не установлены.

### <a name="configure-a-launch-condition-to-detect-the-vsto-runtime"></a>Настройка условия запуска для обнаружения среды выполнения VSTO

1. В **Обозреватель решений**щелкните правой кнопкой мыши **OfficeAddInSetup**.
2. Развернуть **представление**.
3. Щелкните **условия запуска**.
4. В редакторе **условий запуска (OfficeAddInSetup)** щелкните правой кнопкой мыши **требования на целевом компьютере**и выберите пункт **Добавить условие запуска "реестр**". Это условие поиска может выполнять поиск ключа, устанавливаемого средой выполнения VSTO, в реестре. Значение ключа затем доступно различным частям установщика через именованное свойство. Условие запуска использует свойство, определенное условием поиска, для проверки определенного значения.
5. В редакторе **условий запуска (OfficeAddInSetup)** выберите условие поиска **RegistryEntry1** , щелкните правой кнопкой мыши условие и выберите пункт **окно свойств**.

6. В окне **Свойства** задайте следующие свойства.
   1. Задайте значение **(Name)** для **поиска среды выполнения VSTO 2010**.
   2. Измените значение **Свойства** на **всторунтимередист**.
   3. Присвойте параметру **RegKey** значение **Software \\ Microsoft \\ VSTO Runtime Setup \\ v4R**
   4. Оставьте свойство **root** равным **всдррхклм**.
   5. Измените свойство **value** на **Version**.

7. В редакторе **условий запуска (OfficeAddInSetup)** выберите условие запуска **condition1** , щелкните правой кнопкой мыши условие и выберите пункт **окно свойств**.
8. В окне Свойства задайте следующие свойства.
   1. Задайте значение **(Name)** , чтобы **проверить доступность среды выполнения VSTO 2010**.
   2. Измените значение **условия** на **всторунтимередист \> = "10.0.30319"** .
   3. Оставьте свойство **InstallUrl** пустым.
   4. Задать **сообщение** для **среды выполнения средств Visual Studio 2010 для Office не установлено. Запустите Setup.exe, чтобы установить надстройку**.

        ![Снимок экрана: окно "Свойства" для условия запуска "проверить доступность среды выполнения"](media/setup-project-figure-8.jpg)

        **Рис. 8. окно "Свойства" для условия запуска "проверить доступность среды выполнения"**

 Условие запуска выше явно проверяет наличие среды выполнения VSTO, когда она устанавливается пакетом начального загрузчика.

### <a name="configure-a-launch-condition-to-detect-the-vsto-runtime-installed-by-office"></a>Настройка условия запуска для обнаружения среды выполнения VSTO, установленной Office

1. В редакторе **условий запуска (OfficeAddInSetup)** щелкните правой кнопкой мыши элемент **Поиск целевого компьютера**и выберите команду **Добавить поиск реестра**.
2. Выберите условие поиска **RegistryEntry1** , щелкните правой кнопкой мыши условие и выберите пункт **окно свойств**.
3. В окне **Свойства** задайте следующие свойства.
    1. Задайте значение **(Name)** для **поиска среды выполнения Office VSTO**.
    2. Измените значение **Свойства** на **оффицерунтиме**.
    3. Присвойте параметру **RegKey** значение **Software \\ Microsoft \\ VSTO Runtime Setup \\ v4**.
    4. Оставьте свойство **root** равным **всдррхклм**.
    5. Измените свойство **value** на **Version**.

4. В редакторе **условий запуска (OfficeAddInSetup)** выберите условие " **проверить доступность среды выполнения VSTO 2010** ", которое было определено ранее, щелкните условие правой кнопкой мыши и выберите **окно "свойства**".

5. Измените значение свойства **Condition** на **всторунтимередист \> = "10.0.30319" или оффицерунтиме \> = "10.0.21022"**. Номера версий могут отличаться в зависимости от версии среды выполнения, требуемой для надстройки.

    ![Снимок экрана окна свойств для условия запуска](media/setup-project-figure-9.jpg)
  
    **Рис. 9. окна свойств для проверки доступности среды выполнения с помощью Redist или условия запуска Office**

Если надстройка предназначена для .NET Framework 4 или более поздних версий, то типы внутри основных сборок взаимодействия (PIA), на которые указывают ссылки, могут быть внедрены в сборку VSTO.

Чтобы проверить, будут ли типы взаимодействия внедрены в надстройку, выполните следующие действия.

1. Разверните узел ссылки в обозреватель решений
2. Выберите одну из ссылок PIA, например **Office**.
3. Просмотрите окна свойств, нажав клавишу F4 или выбрав пункт Свойства в контекстном меню сборки.
4. Проверьте значение **типов взаимодействия, внедряемых**свойством.

Если задано значение **true**, то типы внедряются и можно перейти к разделу [**для сборки проекта установки**](#to-build-the-setup-project) .

Дополнительные сведения см. в разделе [эквивалентность типов и внедренные типы взаимодействия](/dotnet/framework/interop/type-equivalence-and-embedded-interop-types) .

### <a name="to-configure-launch-conditions-to-detect-that-for-office-pias"></a>Настройка условий запуска для определения того, что для основных сборок взаимодействия Office

1. В редакторе **условий запуска (OfficeAddInSetup)** щелкните правой кнопкой мыши **требования на целевом компьютере**и **выберите Добавить установщик Windows условие запуска**. Это условие запуска выполняет поиск сборки PIA Office, выполняя поиск конкретного идентификатора компонента.
2. Щелкните правой кнопкой мыши **Поиск Component1** и выберите пункт **окно свойств** , чтобы отобразить свойства условия запуска.
3. В **окне Свойства**задайте следующие свойства:

    1. Измените значение свойства **(Name)** , чтобы **найти общую основную сборку взаимодействия Office** .
    2. Измените значение параметра **ComponentID** на идентификатор компонента для компонента Office, который вы используете. Список идентификаторов компонентов можно найти в таблице ниже, например **{64E2917E-AA13-4CA4-BFFE-EA6EDA3AFCB4}**.
    3. Измените значение свойства **Property** на **хасшаредпиа**.

4. В редакторе **условий запуска (OfficeAddInSetup)** щелкните правой кнопкой мыши **condition1** и выберите пункт **окно свойств** , чтобы отобразить свойства условия запуска.

5. Измените эти свойства **condition1**:

    1. Измените значение **(Name)** , чтобы **проверить доступность Office Shared PIA**.
    2. Измените **условие** на **хасшаредпиа**.
    3. Оставьте поле **InstallUrl** пустым.
    4. Изменение **сообщения** на **требуемый компонент для взаимодействия с Excel недоступен. Выполните setup.exe**.

    ![Снимок экрана окна "Свойства" для условия запуска "Проверка общего вызова PIA Office"](media/setup-project-figure-10.jpg)
  
    **Рис. 10. окно "Свойства" для условия запуска "Проверка общего вызова PIA Office"**

### <a name="component-ids-of-the-primary-interop-assemblies-for-microsoft-office"></a>Идентификаторы компонентов основных сборок взаимодействия для Microsoft Office

|Основная сборка взаимодействия|Office 2010|Office 2013|Office 2013 (64-разрядная версия)|Office 2016|Office 2016 (64-разрядная версия)|
|------------------------|------------------------|------------------------|------------------------|------------------------|------------------------|
|Excel|{EA7564AC-C67D-4868-BE5C-26E4FC2223FF}|{C8A65ABE-3270-4FD7-B854-50C8082C8F39}|{E3BD1151-B9CA-4D45-A77E-51A6E0ED322A}|C4ACE6DB-AA99-401F-8BE6-8784BD09F003}|{C4ACE6DB-AA99-401F-8BE6-8784BD09F003}|
|InfoPath|{4153F732-D670-4E44-8AB7-500F2B576BDA}|{0F825A16-25B2-4771-A497-FC8AF3B355D8}|{C5BBD36E-B320-47EF-A512-556B99CB7E41}|-|-|
|Outlook|{1D844339-3DAE-413E-BC13-62D6A52816B2}|{F9F828D5-9F0B-46F9-9E3E-9C59F3C5E136}|{7824A03F-28CC-4371-BC54-93D15EFC1E7F}|{7C6D92EF-7B45-46E5-8670-819663220E4E}|{7C6D92EF-7B45-46E5-8670-819663220E4E}|
|PowerPoint|{EECBA6B8-3A62-44AD-99EB-8666265466F9}|{813139AD-6DAB-4DDD-8C6D-0CA30D073B41}|{05758318-БКФД-4288-AD8D-81185841C235}|{E0A76492-0FD5-4EC2-8570-AE1BAA61DC88}|{E0A76492-0FD5-4EC2-8570-AE1BAA61DC88}|
|Visio|{3EA123B5-6316-452E-9D51-A489E06E2347}|{C1713368-12A8-41F1-ACA1-934B01AD6EEB}|{2CC0B221-22D2-4C15-A9FB-DE818E51AF75}|{2D4540EC-2C88-4C28-AE88-2614B5460648}|{2D4540EC-2C88-4C28-AE88-2614B5460648}|
|Word|{8B74A499-37F8-4DEA-B5A0-D72FC501CEFA}|{9FE736B7-B1EE-410C-8D07-082891C3DAC8}|{13C07AF5-B206-4A48-BB5B-B8022333E3CA}|{DC5CCACD-A7AC-4FD3-9F70-9454B5DE5161}|{DC5CCACD-A7AC-4FD3-9F70-9454B5DE5161}|
|Microsoft Forms 2,0|{B2279272-3FD2-434D-B94E-E4E0F8561AC4}|{B2279272-3FD2-434D-B94E-E4E0F8561AC4}|{A5A30117-2D2A-4C5C-B3C8-8897AC32C2AC}|-|-|
|Microsoft Graph|{011B9112-EBB1-4A6C-86CB-C2FDC9EA7B0E}|{52DA4B37-B8EB-4B7F-89C1-824654CE4C70}|{24706F33-F0CE-4EB4-BC91-9E935394F510}|-|-|
|Смарт-тег|{7102C98C-EF47-4F04-A227-FE33650BF954}|{487A7921-EB3A-4262-BB5B-A5736B732486}|{74EFC1F9-747D-4867-B951-EFCF29F51AF7}|-|-|
|Office Shared|{64E2917E-AA13-4CA4-BFFE-EA6EDA3AFCB4}|{6A174BDB-0049-4D1C-86EF-3114CB0C4C4E}|{76601EBB-44A7-49EE-8DE3-7B7B9D7EBB05}|{625F5772-C1B3-497E-8ABE-7254EDB00506}|{625F5772-C1B3-497E-8ABE-7254EDB00506}|
|Project|{957A4EC0-E67B-4E86-A383-6AF7270B216A}|{1C50E422-24FA-44A9-A120-E88280C8C341}|{706D7F44-8231-489D-9B25-3025ADE9F114}|{107BCD9A-F1DC-4004-A444-33706FC10058}|{107BCD9A-F1DC-4004-A444-33706FC10058}|

  ![Снимок экрана конечного условия запуска](media/setup-project-figure-11.jpg)

  **Рис. 11. Окончательные условия запуска**

Вы можете дополнительно уточнить условия запуска для установки ExcelAddIn. Например, может быть полезно проверить, установлено ли фактическое целевое приложение Office.

### <a name="to-build-the-setup-project"></a>Построение проекта установки

1. В **Обозреватель решений**щелкните правой кнопкой мыши проект **OfficeAddInSetup** и выберите пункт **Сборка**.
2. В **проводнике Windows**перейдите к выходному каталогу проекта **OfficeAddInSetup** и перейдите в папку Release или Debug в зависимости от выбранной конфигурации сборки. Скопируйте все файлы из папки в расположение, к которому пользователи могут обращаться.

Тестирование установки ExcelAddIn

1. Перейдите к расположению, куда вы скопировали **OfficeAddInSetup** .
2. Дважды щелкните файл setup.exe, чтобы установить надстройку **OfficeAddInSetup** . Примите все отображаемые условия лицензии на программное обеспечение и завершите работу мастера установки, чтобы установить надстройку на компьютере пользователя.

Решение Excel Office должно устанавливаться и запускаться из расположения, указанного во время установки.

## <a name="additional-requirements-for-document-level-solutions"></a>Дополнительные требования к решениям на уровне документа

Развертывание решений на уровне документа требует выполнения нескольких различных действий по настройке в проекте установки установщик Windows.

Ниже приведен список основных шагов, необходимых для развертывания решения на уровне документа.

- Создайте проект установки Visual Studio.
- Добавьте основные выходные данные решения уровня документа. Основные выходные данные также содержат документ Microsoft Office.
- Добавьте манифесты развертывания и приложения как свободные файлы.
- Исключите зависимые компоненты из пакета установщика (за исключением сборок служебных программ).
- Настройте пакеты необходимых компонентов.
- Настройте условия запуска.
- Создайте проект установки и скопируйте результаты в место развертывания.
- Разверните решение уровня документа на компьютере пользователя, выполнив установку.
- При необходимости обновите свойства пользовательского документа.

### <a name="changing-the-location-of-the-deployed-document"></a>Изменение расположения развернутого документа

Свойства в документе Office используются для выявления решений на уровне документа. Если документ устанавливается в ту же папку, что и сборка VSTO, изменения не требуются. Однако при установке в другую папку эти свойства необходимо будет обновить во время установки.

Дополнительные сведения об этих свойствах документа см. в разделе [Общие сведения о пользовательских свойствах документа](custom-document-properties-overview.md).

Чтобы изменить эти свойства, во время установки необходимо использовать настраиваемое действие.

В следующем примере используется решение на уровне документа с именем Ексцелворкбукпрожект и проект установки с именем Ексцелворкбуксетуп. Проект Ексцелворкбуксетуп настраивается с помощью тех же действий, описанных выше, за исключением настройки разделов реестра.

Добавление проекта настраиваемого действия в решение Visual Studio

1. Добавьте в решение новый проект консоли .NET, щелкнув правой кнопкой мыши **проект развертывания документов Office** в **Обозреватель решений**
2. Разверните узел **Добавить** и щелкните **Новый проект**.
3. Выберите шаблон Консольное приложение и назовите проект **аддкустомизатионкустомактион**.

    ![Снимок экрана обозреватель решений Аддкустомизатионкустомактион](media/setup-project-figure-15.jpg)
  
    **Рис. 12. обозреватель решений-Аддкустомизатионкустомактион**

4. Добавьте ссылку на эти сборки:
    1. System.ComponentModel
    2. System.Configфигурации. Взнос
    3. Microsoft. VisualStudio. Tools. Applications
    4. Microsoft.VisualStudio.Tools.Applications.ServerDocument

5. Скопируйте этот код в Program.cs или Program. vb

```csharp
    using System;
    using System.IO;
    using System.Collections;
    using System.ComponentModel;
    using System.Configuration.Install;
    using Microsoft.VisualStudio.Tools.Applications;
    using Microsoft.VisualStudio.Tools.Applications.Runtime;

    namespace AddCustomizationCustomAction
    {
        [RunInstaller(true)]
        public class AddCustomizations : Installer
        {
            public AddCustomizations() : base() { }

            public override void Install(IDictionary savedState)
            {
                base.Install(savedState);

                //Get the CustomActionData Parameters
                string documentLocation = Context.Parameters.ContainsKey("documentLocation") ? Context.Parameters["documentLocation"] : String.Empty;
                string assemblyLocation = Context.Parameters.ContainsKey("assemblyLocation") ? Context.Parameters["assemblyLocation"] : String.Empty;
                string deploymentManifestLocation = Context.Parameters.ContainsKey("deploymentManifestLocation") ? Context.Parameters["deploymentManifestLocation"] : String.Empty;
                Guid solutionID = Context.Parameters.ContainsKey("solutionID") ? new Guid(Context.Parameters["solutionID"]) : new Guid();

                string newDocLocation = Path.Combine(Environment.GetFolderPath(Environment.SpecialFolder.MyDocuments), Path.GetFileName(documentLocation));

                try
                {
                    //Move the file and set the Customizations
                    if (Uri.TryCreate(deploymentManifestLocation, UriKind.Absolute, out Uri docManifestLocationUri))
                    {
                        File.Move(documentLocation, newDocLocation);
                        ServerDocument.RemoveCustomization(newDocLocation);
                        ServerDocument.AddCustomization(newDocLocation, assemblyLocation,
                                                        solutionID, docManifestLocationUri,
                                                        true, out string[] nonpublicCachedDataMembers);
                    }
                    else
                    {
                        LogMessage("The document could not be customized.");
                    }
                }
                catch (ArgumentException)
                {
                    LogMessage("The document could not be customized.");
                }
                catch (DocumentNotCustomizedException)
                {
                    LogMessage("The document could not be customized.");
                }
                catch (InvalidOperationException)
                {
                    LogMessage("The customization could not be removed.");
                }
                catch (IOException)
                {
                    LogMessage("The document does not exist or is read-only.");
                }
            }

            public override void Rollback(IDictionary savedState)
            {
                base.Rollback(savedState);
                DeleteDocument();
            }
            public override void Uninstall(IDictionary savedState)
            {
                base.Uninstall(savedState);
                DeleteDocument();
            }
            private void DeleteDocument()
            {
                string documentLocation = Context.Parameters.ContainsKey("documentLocation") ? Context.Parameters["documentLocation"] : String.Empty;

                try
                {
                    File.Delete(Path.Combine(Environment.GetFolderPath(Environment.SpecialFolder.MyDocuments), Path.GetFileName(documentLocation)));
                }
                catch (Exception)
                {
                    LogMessage("The document doesn't exist or is read-only.");
                }
            }
            private void LogMessage(string Message)
            {
                if (Context.Parameters.ContainsKey("LogFile"))
                {
                    Context.LogMessage(Message);
                }
            }

            static void Main() { }
            }
    }
```

Чтобы добавить настройку в документ, необходим идентификатор решения VSTO на уровне документа. Это значение извлекается из файла проекта Visual Studio.

Получение идентификатора решения

1. В меню **Сборка** выберите пункт **построить решение** , чтобы создать решение на уровне документа и добавить в файл проекта свойство идентификатор решения.
2. В **Обозреватель решений**щелкните правой кнопкой мыши проект уровня документа **ексцелворкбукпрожект**
3. Щелкните **унлоадпрожект** , чтобы получить доступ к файлу проекта из Visual Studio.

    ![Снимок экрана обозреватель решений выгрузки решения документа Excel](media/setup-project-figure-16.jpg)

    **Рис. 13. выгрузка решения документа Excel**

4. В **Обозреватель решений**щелкните правой кнопкой мыши **Ексцелворкбукпрожект** и выберите **Едитексцелворкбукпрожект. vbproj** или **Edit ексцелворкбукпрожект. csproj**.
5. В редакторе **ексцелворкбукпрожект** нахождение элемента **SolutionId** внутри элемента **PropertyGroup** .
6. Скопируйте значение идентификатора GUID этого элемента.

    ![Получение SolutionID](media/setup-project-figure-17.jpg)

    **Рис. 14. получение SolutionID**

7. В **Обозреватель решений**щелкните правой кнопкой мыши **ексцелворкбукпрожект** и выберите **Перезагрузить проект**.
8. Нажмите кнопку **Да** в появившемся диалоговом окне, чтобы закрыть редактор **ексцелворкбукпрожект** .
9. **Идентификатор решения** будет использоваться в настраиваемом действии установить.

Последним шагом является настройка настраиваемого действия для шагов **установки** и **удаления** .

### <a name="to-configure-the-setup-project"></a>Настройка проекта установки

1. В **Обозреватель решений**щелкните правой кнопкой мыши **Ексцелворкбуксетуп**, разверните **Добавить** и выберите пункт **выходные данные проекта**.
2. В диалоговом окне **Добавление выходной группы проекта** в списке **проект** щелкните **аддкустомизатионкустомактион**.
3. Выберите **Основные выходные данные** и нажмите кнопку **ОК** , чтобы закрыть диалоговое окно и добавить сборку, содержащую настраиваемое действие, в проект установки.

    ![Снимок экрана: настраиваемое действие "Манифест документа" — Добавление окна выходной группы проекта](media/setup-project-figure-18.jpg)

    **Рис. 15. настраиваемое действие манифеста документа — Добавление выходной группы проекта**

4. В **Обозреватель решений**щелкните правой кнопкой мыши **ексцелворкбуксетуп**.
5. Разверните узел **Просмотр** и щелкните **Настраиваемые действия**.
6. В редакторе **пользовательских действий (ексцелворкбуксетуп)** щелкните правой кнопкой мыши **Настраиваемые действия** и выберите команду **Добавить настраиваемое действие**.
7. В диалоговом окне **Выбор элемента в проекте** в списке **Искать в** выберите пункт **Папка приложения**. Выберите **Основные выходные данные из аддкустомизатионкустомактион (Active)** и нажмите кнопку **ОК** , чтобы добавить настраиваемое действие к шагу установки.
8. В **узле установка**щелкните правой кнопкой мыши **Основные выходные данные из аддкустомизатионкустомактион (Active)** и выберите команду **Переименовать**. Присвойте **документу копию настраиваемого действия в папку Мои документы и присоедините настройку**.
9. В **узле удаление**щелкните правой кнопкой мыши **Основные выходные данные из аддкустомизатионкустомактион (Active)** и выберите команду **Переименовать**. Имя настраиваемого действия **удалить документ из папки документы**.

    ![Снимок экрана: окно настраиваемых действий манифеста документа](media/setup-project-figure-19.jpg)

    **Рис. 16. пользовательские действия манифеста документа**

10. В редакторе **Custom Actions (ексцелворкбуксетуп)** щелкните правой кнопкой мыши **Копировать документ в папку Мои документы и присоедините настройку** и выберите пункт **окно свойств**.
11. В окне **CustomActionData** **свойства** CustomActionData введите расположение библиотеки DLL настройки, манифест развертывания и расположение документа Microsoft Office. Также требуется SolutionID.
12. Если вы хотите регистрировать ошибки установки в файле, включите параметр LogFile.
s
    ``` text
    /assemblyLocation="[INSTALLDIR]ExcelWorkbookProject.dll" /deploymentManifestLocation="[INSTALLDIR]ExcelWorkbookProject.vsto" /documentLocation="[INSTALLDIR]ExcelWorkbookProject.xlsx" /solutionID="Your Solution ID" /LogFile="[TARGETDIR]Setup.log"
    ```

    ![Снимок экрана: настраиваемое действие для копирования документа в папку "Мои документы" окно свойств](media/setup-project-figure-20.jpg)

    **Рис. 17. настраиваемое действие для копирования документа в папку «Мои документы»**

13. Настраиваемому действию для удаления требуется имя документа. его можно указать с помощью того же параметра Документлокатион в параметре **CustomActionData**

    ``` text
    /documentLocation="[INSTALLDIR]ExcelWorkbookProject.xlsx"
    ```

14. Скомпилируйте и разверните проект **ексцелворкбуксетуп** .
15. Найдите в папке **Мои документы** и откройте файл ExcelWorkbookProject.xlsx.

## <a name="additional-resources"></a>Дополнительные ресурсы

[Руководство. Установка Инструменты Visual Studio для среды выполнения Office](how-to-install-the-visual-studio-tools-for-office-runtime-redistributable.md)

[Основные сборки взаимодействия Office](office-primary-interop-assemblies.md)

[Записи реестра для надстроек VSTO](registry-entries-for-vsto-add-ins.md)

[Custom Document Properties Overview](custom-document-properties-overview.md)

[Указание областей формы в реестре Windows](/office/vba/outlook/concepts/creating-form-regions/specifying-form-regions-in-the-windows-registry)

[Granting Trust to Documents](granting-trust-to-documents.md)

## <a name="about-the-authors"></a>Об авторах

Ваутер Van Вугт — это Microsoft MVP с технологиями Office Open XML и независимым консультантом по созданию Business Applications Office (OBA) с SharePoint, Microsoft Office и связанных технологий .NET.
Ваутер является частой участником веб-узлов сообщества разработчиков, таких как [MSDN](/previous-versions/office/developer/office-2007/bb879915(v=office.12)). Он опубликовал несколько технических документов и статей, а также книгу, доступную в строке Open XML: Описание электронной книги.
Ваутер — это основатель кода юристом, голландская компания, которая посвящена доставке новейшего технического содержимого с помощью различных каналов. Дополнительные сведения о Ваутер можно узнать в блоге.

\ Pattison) — это специалист MVP по SharePoint, автор, преподаватель и основатель Pattison) группы. В течение 2005 г. Корпорация Майкрософт приработала в группе разработчиков Microsoft Developer Platform Evangelism Group, чтобы разработать учебный учебный курс для разработчиков Windows SharePoint Services 3,0 и Microsoft Office SharePoint Server 2007. С этого момента программное обеспечения было полностью нацелено на обучение профессиональных разработчиков на технологиях SharePoint 2007. После завершения написания книги издательства Microsoft Press в Windows SharePoint Services 3,0, который посвящен использованию SharePoint в качестве платформы разработки для создания бизнес-решений. А также записывает ориентированный на разработчика столбец в журнал MSDN Magazine, озаглавленный «кабинет».
