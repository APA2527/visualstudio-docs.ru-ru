---
title: Развертывание визуальных студийных инструментов для офисных решений с помощью установки Windows
ms.date: 08/18/2010
ms.topic: conceptual
dev_langs:
- VB
- CSharp
helpviewer_keywords:
- Office development in Visual Studio, setup project
- Office development in Visual Studio, MSI
- deploying applications [Office development in Visual Studio], setup project
- deploying applications [Office development in Visual Studio], MSI
- ClickOnce deployment [Office development in Visual Studio], MSI
- publishing Office solutions [Office development in Visual Studio], setup project
- Office applications [Office development in Visual Studio], MSI
author: John-Hart
ms.author: johnhart
manager: jillfra
ms.workload:
- office
ms.openlocfilehash: 876781cb6967f5d10dddccd54a46e218170445ab
ms.sourcegitcommit: 92361aac3665a934faa081e1d1ea89a067b01c5b
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/17/2020
ms.locfileid: "79432201"
---
# <a name="deploying-a-visual-studio-tools-for-office-solution-using-windows-installer"></a>Развертывание визуальных студийных инструментов для офисных решений с помощью установки Windows

## <a name="summary"></a>Сводка

Узнайте, как развернуть надстройку Microsoft Visual Studio Tools for Office (VSTO) с помощью проекта Visual Studio Installer.

Ваутер ван Вугт, адвокат по коду

Тед Паттисон, Тед Паттисон Групп

Эта статья была обновлена корпорацией Майкрософт с разрешения первоначальных авторов.

**Применяется к:** Инструменты визуальной студии для Office, Microsoft Office, Microsoft Visual Studio.

## <a name="overview"></a>Обзор

Вы можете разработать решение VSTO и развернуть его с помощью пакета Установки Windows. Это обсуждение включает в себя шаги для развертывания простого office Add-in.

## <a name="deployment-methods"></a>Методы развертывания

ClickOnce можно легко использовать для создания насетроприностнодляек для ваших надсмов и решений. Тем не менее, он не может установить надстройки, которые требуют административных привилегий, таких как надстройки уровня машины.

Надстройки, требующие административных привилегий, могут быть установлены с помощью установки Windows, но для создания настройки требуется больше усилий.

Для получения обзора того, как развернуть решение VSTO с помощью ClickOnce, [см.](deploying-an-office-solution-by-using-clickonce.md)

## <a name="deploying-office-solutions-that-target-the-vsto-runtime"></a>Развертывание решений Office, нацеленных на время выполнения VSTO

Пакеты ClickOnce и Windows Installer должны выполнять те же элементарные задачи при установке решения Office.

1. Установите компоненты предпосылки на компьютере пользователя.
2. Развертывание конкретных компонентов для решения.
3. Для надстройки создавайте записи реестра.
4. Доверяйте решению, позволяющему его выполнять.

### <a name="required-prerequisite-components-on-the-target-computer"></a>Необходимые обязательные компоненты на целевом компьютере

Вот список программного обеспечения, которое должно быть установлено на компьютере для запуска решений VSTO:

- Microsoft Office 2010 или новее.
- Microsoft .NET Framework 4 или новее.
- Среда выполнения средств Microsoft Visual Studio 2010 для Office.
  Время выполнения обеспечивает среду, которая управляет решениями надстройки и уровня документов. Версия Runtime действительно подает в Microsoft Office, но вы можете перераспределить конкретную версию с надстройкой.
- Сборки Primary Interop для Microsoft Office, если вы не используете встроенные типы Interop.
- Любые утилиты сборки, на которые ссылаются проекты.

### <a name="specific-components-for-the-solution"></a>Конкретные компоненты для решения

Пакет установки должен установить эти компоненты на компьютер пользователя:

- Документ Microsoft Office, если вы создаете решение уровня документа.
- Сборка настройки и любые сборки, которые она требует.
- Дополнительные компоненты, такие как файлы конфигурации.
- Манифест применения (.manifest).
- Манифест развертывания (.vsto).

### <a name="registry-entries-for-add-ins"></a>Записи регистрации для адшерных всасываемых

Microsoft Office использует записи реестра для поиска и загрузки надстройки. Эти записи реестра должны быть созданы в рамках процесса развертывания. Для получения дополнительной информации об этих записях реестра, см [записи реестра для VSTO Адыт-усбытных входов](registry-entries-for-vsto-add-ins.md).

Надстройки Outlook, отображающие области пользовательских форм, требуют дополнительных записей реестра, которые позволяют идентифицировать регионы формы. Для получения дополнительной информации о записях в [реестре](registry-entries-for-vsto-add-ins.md#OutlookEntries)см.

Решения на уровне документов не требуют регистрационных записей. Вместо этого свойства внутри документа используются для определения местом настройки. Для получения дополнительной информации [Custom Document Properties Overview](custom-document-properties-overview.md)об этих свойствах см.

### <a name="trusting-the-vsto-solution"></a>Доверие к решению VSTO

Для запуска настройки машине необходимо доверять решению. Надстройке можно доверять, подписав манифест с сертификатом, создав доверительные отношения со списком включений или установив его в доверенное место на машине.

Для получения дополнительной информации о том, как получить сертификат для подписания, [см.](../deployment/clickonce-and-authenticode.md) Для получения дополнительной информации [Trusting Office Solutions by Using Inclusion Lists](trusting-office-solutions-by-using-inclusion-lists.md)о доверительных решениях см. Вы можете добавить запись списка включений с пользовательским действием в файле установки Windows. Для получения дополнительной информации о включении списка включений [см.](how-to-configure-inclusion-list-security.md)

Если ни один из вариантов не используется, пользователю отображается запрос доверия, который позволяет ему решать, доверять ли решению.

Для получения дополнительной информации о безопасности, связанной с решениями на уровне документов, [см.](granting-trust-to-documents.md)

## <a name="creating-a-basic-installer"></a>Создание базового установщика

Шаблоны проекта настройки и развертывания включены в расширение [Microsoft Visual Studio Installer Projects,](https://marketplace.visualstudio.com/items?itemName=visualstudioclient.MicrosoftVisualStudio2017InstallerProjects) которое доступно для скачивания.

Для создания установщика для решения Office эти задачи должны быть выполнены:

- Добавьте компоненты решения Office, которые будут развернуты.
- Для присдебных стыковок на уровне приложений настройте ключи реестра.
- Налаживать компоненты предпосылок, чтобы они могли быть установлены на компьютерах конечных пользователей.
- Налаживайте условия запуска, чтобы убедиться, что необходимые компоненты необходимы. Условия запуска могут быть использованы для блокирования установки, если не установлены все необходимые предпосылки.

Первым шагом является создание проекта настройки.

### <a name="to-create-the-addin-setup-project"></a>Создание проекта настройки AddIn

1. Откройте проект Office AddIn, который необходимо развернуть. В этом примере мы используем пристройку Excel под названием ExcelAddIn.
2. С Office Project Open, в меню **файла,** расширить **Добавить** и нажмите **Новый проект,** чтобы добавить новый проект.
::: moniker range="=vs-2017"
3. В диалоге **Добавить новый проект** расширьте **другие типы проектов** в панели **типов проектов,** затем расширьте **настройку и развертывание,** а затем выберите **установку Visual Studio.**
4. В панели **шаблонов** выберите **проект настройки** из группы **шаблонов Visual Studio.**
::: moniker-end
::: moniker range="=vs-2019"
3. В диалоге **«Добавить новый проект»** выберите шаблон **проекта настройки.**
4. Нажмите кнопку **Далее**.
::: moniker-end

5. В поле **Name** введите **OfficeAddInSetup**.
::: moniker range="=vs-2017"
6. Нажмите **Открыть** для создания нового проекта установки.
::: moniker-end
::: moniker range="=vs-2019"
6. Нажмите **Создать** для создания нового проекта настройки.
::: moniker-end

Visual Studio открывает исследователь файловой системы для нового проекта установки. Исследователь файловой системы позволяет добавлять файлы в проект настройки.

   ![Скриншот проводника файловой системы для проекта настройки](media/setup-project-figure-1.png)

   **Рисунок 1: Исследователь файловой системы для проекта настройки**

Проект настройки должен развернуть ExcelAddIn. Вы можете настроить проект настройки для этой задачи, добавив выход проекта ExcelAddIn в проект настройки.

### <a name="to-add-the-exceladdin-project-output"></a>Добавление вывода проекта ExcelAddIn

1. В **Solution Explorer**, правой щелкните **OfficeAddInSetup**, нажмите **Добавить,** а затем **выход проекта**.
2. В диалоге **Группы добавления выходного** проекта выберите **ExcelAddIn** из списка проектов и **первичный выход.**
3. Нажмите **OK,** чтобы добавить выход проекта в проект настройки.

    ![Скриншот диалога Setup Project Add Project Output Group](media/setup-project-figure-2.png)

    **Рисунок 2: Настройка проекта Добавить проект выход группы диалога**

Проект установки должен развернуть манифест развертывания и манифест приложения. Добавьте эти два файла в проект настройки в качестве автономных файлов из папки вывода проекта ExcelAddIn.

### <a name="to-add-the-deployment-and-application-manifests"></a>Добавление манифестов развертывания и применения

1. В **Solution Explorer**, правой кнопкой **мыши OfficeAddInSetup**, нажмите **Добавить**, и нажмите **файл**.
2. В диалоговом поле **Add Files** перейдите в каталог **вывода ExcelAddIn.** Обычно каталог вывода является субфолдером **выделения ячейки\\** корневого каталога проекта, в зависимости от выбранной конфигурации сборки.
3. Выберите файлы **ExcelAddIn.vsto** и **ExcelAddIn.dll.manifest** и нажмите **Open,** чтобы добавить эти два файла в проект настройки.

    ![Скриншот манифестов приложения и развертывания в Solution Explorer](media/setup-project-figure-3.jpg)

    **Рисунок 3: Манифесты приложения и развертывания для Проводника решений надстройки**

Ссылка на ExcelAddIn включает в себя все компоненты, которые требуется ExcelAddIn. Эти компоненты должны быть исключены и развернуты с использованием предварительных пакетов, чтобы они были зарегистрированы правильно. Кроме того, условия лицензии на программное обеспечение должны отображаться и приниматься до начала установки.

### <a name="to-exclude-the-exceladdin-project-dependencies"></a>Исключить зависимости проекта ExcelAddIn

1. В **solution Explorer**в узло **OfficeAddInSetup** выберите все элементы зависимости под элементом **Detected Dependencies,** за исключением **рамок Microsoft .NET** или любой сборки, которая ** \*заканчивается. Утилиты.dll**. Сборки утилит предназначены для развертывания вместе с вашим приложением.
2. Нажмите правой кнопкой мыши в группе и выберите **Свойства**.
3. В окне **свойств** измените свойство **Exclude** на **True,** чтобы исключить зависимые сборки из проекта настройки. Убедитесь в том, чтобы не исключать каких-либо утилит сборки.

    ![Скриншот исследователя решений, показывающий зависимости для исключения](media/setup-project-figure-4.jpg)

    **Рисунок 4: Исключая зависимости**

Вы можете настроить пакет Установки Windows для установки компонентов предпосылок, добавив программу настройки, также известную как загрузчик. Эта программа настройки может установить компоненты предпосылки, процесс, называемый загрузкой.

Для **ExcelAddIn**эти предпосылки должны быть установлены до того, как надстройка может работать правильно:

- Рамочная версия Microsoft .NET, на которую нацелено решение Office.
- Набор средств Microsoft Visual Studio 2010 для Office Runtime.

Настройка зависимых компонентов в качестве предварительных условий

1. В **Solution Explorer**, правой кнопкой мыши **проекта OfficeAddInSetup** и выберите **свойства**.
2. Отослана коробка диалога **страниц свойств OfficeAddInSetup.**
3. Нажмите кнопку **«Предпосылки».**
4. В диалоговом окне Prerequisites выберите правильную версию рамочного соглашения .NET и инструменты Microsoft Visual Studio для Office Runtime.

    ![Скриншот Предпосылки Dialog Box](media/setup-project-figure-5.png)

    **Рисунок 5: Предпосылки Диалог Box**

    > [!NOTE]
    >Некоторые из настроенных пакетов предпосылок в проекте настройки Visual Studio зависят от выбранной конфигурации сборки. Необходимо выбрать нужные компоненты предварительного условия для каждой использоваваемых конфигураций сборки.

Microsoft Office находит надстройки с помощью ключей реестра. Ключи в улье\_\_HKEY CURRENT USER используются для регистрации надстройки для каждого отдельного пользователя. Ключи под ульем\_\_HKEY LOCAL MACHINE используются для регистрации надстройки для всех пользователей машины. Для получения дополнительной информации [Registry entries for VSTO Add-ins](registry-entries-for-vsto-add-ins.md)о ключах реестра см.

### <a name="to-configure-the-registry"></a>Настройка реестра

1. В **Solution Explorer**, правой щелчком **OfficeAddInSetup**.
2. Расширить **представление**.
3. Нажмите **реестр,** чтобы открыть окно редактора реестра.
4. В **реестре (OfficeAddInSetup)** редактор, расширить **HKEY\_LOCAL\_MACHINE,** а затем **программное обеспечение**.
5. Удалить ** \[Производитель\]**?ключ найти в **HKEY\_LOCAL\_MACHINE\\программного обеспечения**.
6. Расширить **\_HKEY\_CURRENT USER,** а затем **программное обеспечение**.
7. Удалите ключ ** \[производителя,\] ** найденный под **HKEY\_CURRENT\_USER\\Software.**
8. Чтобы добавить ключи реестра для надстройки установки правой кнопкой **пользователь / машина Hive** ключ, выберите **Новый ключ**. Используйте текст **программного обеспечения** для названия нового ключа. Нажмите правой кнопкой мыши на недавно созданный ключ **программного обеспечения** и создать новый ключ с текстом **Microsoft**.
9. Используйте аналогичный процесс для создания всей иерархии ключей, необходимой для регистрации надстройки:

    **Пользователь / машина\\\\Hive\\программное\\обеспечение Microsoft\\Office\\Excel Addins SampleCompany.ExcelAddIn**

    Название компании часто используется в качестве приставки для названия надстройки, чтобы обеспечить уникальность.

10. Нажмите правой кнопкой мыши на клавишу **SampleCompany.ExcelAddIn,** выберите **новое**значение и нажмите **строку значение**. Используйте текст **Описание** для имени.
11. Используйте этот шаг, чтобы добавить еще три значения:
    - **FriendlyName** типа **Строка**
    - **LoadBehavior** типа **DWORD**
    - **Манифест** **типстроки**

12. Нажмите **правой** кнопкой описание значения в редакторе реестра и нажмите **Свойства окна**. В **окне свойств**введите **Excel Demo AddIn** для свойства Значения.
13. Выберите ключ **FriendlyName** в редакторе реестра. В **окне свойств**измените свойство **значения** на Excel **Demo AddIn.**
14. Выберите ключ **LoadBehavior** в редакторе реестра. В **окне свойств**измените свойство **значения** на **3.** Значение 3 для LoadBehavior указывает на то, что надстройка должна быть загружена при запуске приложения хоста. Для получения дополнительной информации о поведении [нагрузки](registry-entries-for-vsto-add-ins.md)см.

15. Выберите ключ **Манифеста** в редакторе реестра. В **окне свойств**, изменить свойство **значения** **файл: / / / ТАРГЕТДИРЫ ExcelAddIn.vsto'vstolocal**

    ![Скриншот редактора реестра](media/setup-project-figure-6.png)

    **Рисунок 6: Настройка ключей реестра**

      Время выполнения VSTO использует этот ключ реестра для определения местом развертывания. Макрос «TARGETDIR» будет заменен папкой, в которой установлена надстройка. Макрос будет включать в себя задний символ, поэтому имя файла манифеста развертывания должно быть ExcelAddIn.vsto без символа.
      **Vstolocal** postfix сообщает время выполнения VSTO, что надстройка должна загружаться из этого места вместо кэша ClickOnce. Удаление этого постфикса приведет к тому, что время выполнения скопирует настройку в кэш ClickOnce.

   >[!WARNING]
   >Вы должны быть очень осторожны с редактором реестра в Visual Studio. Например, если вы случайно установите DeleteAtUninstall для неправильного ключа, можно удалить активную часть реестра, оставив компьютер пользователя в несогласованном или, что еще хуже, нарушенном состоянии.

64-битные версии Office будут использовать 64-битный реестру улья для поиска надсмежных стычек. Для регистрации надстройки под 64-битным улей реестра, целевая платформа проекта установки должна быть установлена только на 64-битную.

1. Выберите проект **OfficeAddInSetup** в исследователе решений.
2. Перейти к окну **Свойства** и установить свойство **TargetPlatform** **на x64**.

Установка дополнения для 32-битной и 64-битной версий Office потребует создания двух отдельных пакетов MSI. Один для 32-битных и один для 64-битного.

  ![Скриншот окна Свойств, показывающий целевую платформу для регистрации надсбывок с 64-разрядным Office](media/setup-project-figure-7.jpg)

  **Рисунок 7: Целевая платформа для регистрации надсбык с 64-разрядным офисом**

Если пакет MSI используется для установки надстройки или решения, он может быть установлен без необходимых предпосылок. Условия запуска в MSI можно использовать для того, чтобы заблокировать установку надстройки, если предпосылки не установлены.

### <a name="configure-a-launch-condition-to-detect-the-vsto-runtime"></a>Настройка состояния запуска для обнаружения времени выполнения VSTO

1. В **Solution Explorer**, правой щелчком **OfficeAddInSetup**.
2. Расширить **представление**.
3. Нажмите **Кнопка Условия запуска**.
4. В **настройках запуска (OfficeAddInSetup)** редактор, правой кнопкой **кнопку Требования на целевую машину**, а затем нажмите **Добавить состояние запуска реестра**. Это условие поиска может искать в реестре ключ, который устанавливает время выполнения VSTO. Значение ключа затем доступно для различных частей установки через названное свойство. Условие запуска использует свойство, определяемое условием поиска, для проверки определенного значения.
5. В редакторе **«Условия запуска» (OfficeAddInSetup)** выберите условие **поиска «Поиск для RegistryEntry1»,** нажмите правой кнопкой мыши и выберите **окно свойств.**

6. В окне **Свойства** задайте следующие свойства.
   1. Установите значение **(имя)** для **поиска VSTO 2010 Runtime**.
   2. Измените стоимость **недвижимости** на **VSTORUNTIMEREDIST**.
   3. Установите значение **RegKey** для **SOFTWARE\\Microsoft\\VSTO Runtime Setup\\v4R**
   4. Оставьте свойство **Root** настроено на **vsdrrHKLM.**
   5. Измените свойство **значения** на **версию**.

7. В редакторе **«Условия запуска» (OfficeAddInSetup)** выберите условие запуска **Condition1,** нажмите правой кнопкой мыши и выберите **окно свойств.**
8. В окне Свойства задайте следующие свойства.
   1. Установите **(имя)** для **проверки доступности vsTO 2010 Runtime**.
   2. Изменение значения **условия** на **\>VSTORUNTIMEREDIST 10.0.30319"**
   3. Оставьте свойство **InstallURL** пустым.
   4. Настройка **Сообщения** **в Visual Studio 2010 Инструменты для Office Runtime не установлена. Пожалуйста, запустите Setup.exe для установки дополнения**.

        ![Скриншот окна свойств для состояния запуска Проверки времени выполнения](media/setup-project-figure-8.jpg)

        **Рисунок 8: Окно свойств для состояния запуска проверки runtime**

 Состояние запуска выше явно проверяет наличие времени выполнения VSTO, когда он установлен пакетом загрузчика.

### <a name="configure-a-launch-condition-to-detect-the-vsto-runtime-installed-by-office"></a>Настройка состояния запуска для обнаружения vsTO Runtime, установленного Office

1. В **настройках запуска (OfficeAddInSetup)** редактор, правой кнопкой **мыши Поиск Целевой машины**, а затем нажмите **Добавить поиск реестра**.
2. Выберите условие **поиска RegistryEntry1,** нажмите правой кнопкой мыши и выберите **окно свойств.**
3. В окне **Свойства** задайте следующие свойства.
    1. Установите значение **(имя)** для **поиска office VSTO Runtime.**
    2. Измените значение **свойства** на **OfficeRuntime.**
    3. Установите значение **RegKey** для **SOFTWARE\\Microsoft\\VSTO Runtime Setup\\v4.**
    4. Оставьте свойство **Root** настроено на **vsdrrHKLM.**
    5. Измените свойство **значения** на **версию**.

4. В редакторе **«Условия запуска» (OfficeAddInSetup)** выберите условие **запуска Доступности Runtime,** определяемое ранее, правое нажатие кнопки **«Окно свойств»** и выберите окно свойств.

5. Измените значение свойства **Условия** на **VSTORUNTIMEREDIST \>:10.0.30319"\>ИЛИ ЕМЕКУНТОМ No10.0.21022 "**. Номера версий, возможно, отличаются для вас в зависимости от версий времени выполнения, что требуется для добавления.

    ![Скриншот Windows Свойства для состояния запуска](media/setup-project-figure-9.jpg)
  
    **Рисунок 9: Свойства Windows для проверки доступности runtime через Redist или состояние запуска Office**

Если пристройки нацелены на .NET Framework 4 или более новые, типы внутри первичных межпромных собраний (PIA), на которые ссылаются, могут быть встроены в сборку VSTO.

Чтобы проверить, будут ли встроены типы Interop в надстройку, выполняя следующие действия:

1. Расширить узла ссылок в solution Explorer
2. Выберите одну из ссылок PIA, например **Office**.
3. Просматривайте окна свойств, нажимая на F4 или выбрав свойства из контекстного меню Assemblies.
4. Проверьте стоимость свойства **Встраиваемых типов Interop.**

Если значение настроено на **True,** то типы встраиваются, и вы можете перейти к [**разделу проекта настройки.**](#to-build-the-setup-project)

Для получения дополнительной [Type Equivalence and Embedded Interop Types](/dotnet/framework/interop/type-equivalence-and-embedded-interop-types) информации см.

### <a name="to-configure-launch-conditions-to-detect-that-for-office-pias"></a>Настройка условий запуска для обнаружения этого для офисных PIA

1. В **настройках запуска (OfficeAddInSetup)** редактор, правой кнопкой **кнопку Требования к целевой машине**, а затем **нажмите Добавить Windows Установщик Состояние запуска**. Это условие запуска ищет Office PIA путем поиска определенного идентификатора компонента.
2. Нажмите справа **Поиск компонента1** и нажмите **Properties Window,** чтобы показать свойства состояния запуска.
3. В **окне свойств**установите следующие свойства:

    1. Изменение значения **(имя)** свойства для **поиска Office Shared PIA**
    2. Измените значение **компонента** идентификатора на компонентный идентификатор для использовававаемого компонента Office. Список идентификаторов компонентов можно найти в таблице ниже, например, **«64E2917E-AA13-4CA4-BFFE-EA6EDA3AFCB4».**
    3. Измените стоимость **свойства** на **HASSHAREDPIA.**

4. В редакторе **«Условия запуска» (OfficeAddInSetup)** — **«Условии 1** и щелкните окно свойств» и нажмите **«Свойства»,** чтобы показать свойства состояния запуска.

5. Измените эти свойства **Условия1**:

    1. Измените **(имя)** для **проверки доступности PIA-офиса.**
    2. Измените **условие** на **HASSHAREDPIA**.
    3. Оставьте **InstallUrl** пустым.
    4. Изменение **Сообщения** на **необходимый компонент для взаимодействия с Excel недоступно. Пожалуйста, запустите setup.exe**.

    ![Скриншот окна свойств для совместного состояния запуска PIA](media/setup-project-figure-10.jpg)
  
    **Рисунок 10: Окно свойств для условия запуска Verify Office Shared PIA**

### <a name="component-ids-of-the-primary-interop-assemblies-for-microsoft-office"></a>Идобытые икдкомпоненты первичных межпромных собраний для Microsoft Office

|Первичная интероп сборка|Office 2010|Office 2013|Офис 2013 (64-разрядный)|Office 2016|Офис 2016 (64-разрядный)|
|------------------------|------------------------|------------------------|------------------------|------------------------|------------------------|
|Excel|(EA7564AC-C67D-4868-BE5C-26E4FC223FF)|(C8A65ABE-3270-4FD7-B854-50C882C8F39)|(E3BD1151-B9CA-4D45-A77E-51A6E0ED322A)|C4ACE6DB-AA99-401F-8BE6-8784BD09F003|(C4ACE6DB-AA99-401F-8BE6-8784BD09F003)|
|InfoPath|4153F732-D670-4E44-8AB7-500f2B576Bda|0F825A16-25B2-4771-A497-FC8AF3B355D8|(C5BBD36E-B320-47EF-A512-556B99CB7E41)|-|-|
|Outlook|1D844339-3DAe-413E-BC13-62D6A52816B2|F9F828D5-9F0B-46F9-9E3E-9C59F3C5E136|(7824A03F-28CC-4371-BC54-93D15EFC1E7F)|7C6D92EF-7B45-46E5-8670-819663220E4E|7C6D92EF-7B45-46E5-8670-819663220E4E|
|PowerPoint|(EECBA6B8-3A62-44AD-99EB-86662655466F9)|813139Ад-6DAB-4DDD-8C6D-0CA30D073B41|05758318-BCFD-4288-AD8D-8185841C235|(E0A76492-0FD5-4EC2-8570-AE1BAA61DC88)|(E0A76492-0FD5-4EC2-8570-AE1BAA61DC88)|
|Visio|3EA123B5-6316-452E-9D51-A489E06E2347|(C1713368-12A8-41F1-ACA1-934B01AD6EEB)|2CC0B221-22D2-4C15-A9FB-DE818E51AF75|2D4540EC-2C88-4C28-AE88-2614B5460648|2D4540EC-2C88-4C28-AE88-2614B5460648|
|Word|8B74A499-37F8-4DEA-B5A0-D72FC501CEFA|9FE736B7-B1EE-410C-8D07-082891C3DAC8|13C07AF5-B206-4A48-BB5B-B8022333E3CA|(DC5CCACD-A7AC-4FD3-9F70-9454B5DE5161)|(DC5CCACD-A7AC-4FD3-9F70-9454B5DE5161)|
|Формы Microsoft 2.0|(B2279272-3FD2-434D-B94E-E4E0F8561AC4)|(B2279272-3FD2-434D-B94E-E4E0F8561AC4)|(A5A30117-2D2A-4C5C-B3C8-8897AC32C2AC)|-|-|
|Microsoft Graph|(011B9112-EBB1-4A6C-86CB-C2FDC9EA7B0E)|52DA4B37-B8EB-4B7F-89C1-824654CE4C70|24706F33-F0CE-4EB4-BC91-9E935394F510|-|-|
|Смарт-тег|7102C98C-EF47-4F04-A227-FE33650BF954|487A7921-EB3A-4262-BB5B-A5736B732486|(74EFC1F9-747D-4867-B951-EFCF29F51AF7)|-|-|
|Офис Общий|(64E2917E-AA13-4CA4-BFFE-EA6EDA3AFCB4)|6A174BDB-0049-4D1C-86EF-3114CB0C4C4E|(76601EBB-44A7-49EE-8DE3-7B7B9D7EBB05)|(625F5772-C1B3-497E-8ABE-7254EDB00506)|(625F5772-C1B3-497E-8ABE-7254EDB00506)|
|Проект|(957A4EC0-E67B-4E86-A383-6AF770B216A)|1C50E422-24FA-44A9-A120-E88280C8C341|706D7F44-8231-489D-9B25-3025ADE9F114|107BCD9A-F1DC-4004-A444-33706FC10058|107BCD9A-F1DC-4004-A444-33706FC10058|

  ![Скриншот условий финального запуска](media/setup-project-figure-11.jpg)

  **Рисунок 11: Окончательные условия запуска**

Вы можете дополнительно уточнить условия запуска для установки ExcelAddIn. Например, возможно, полезно проверить, установлено ли реальное целевое приложение Office.

### <a name="to-build-the-setup-project"></a>Создание проекта установки

1. В **Solution Explorer**, правой кнопкой мыши **проекта OfficeAddInSetup** и нажмите **на кнопку Сборка**.
2. Используя **Windows Explorer,** перейдите в каталог вывода проекта **OfficeAddInSetup** и перейдите в папку release или Debug в зависимости от выбранной конфигурации сборки. Копируйте все файлы из папки в место, к которое пользователи могут получить доступ.

Для тестирования установки ExcelAddIn

1. Перейдите к месту, где вы скопировали **OfficeAddInSetup.**
2. Дважды нажмите на файл setup.exe для установки дополнения **OfficeAddInSetup.** Примите любые отображаемые условия лицензии на программное обеспечение и заполните мастер установки для установки надстройки на компьютере пользователя.

Решение Excel Office должно устанавливаться и работать с места, указанного во время настройки.

## <a name="additional-requirements-for-document-level-solutions"></a>Дополнительные требования к решениям уровня документов

Развертывание решений уровня документов требует нескольких различных этапов конфигурации в проекте установки установки Windows.

Ниже приведен список основных шагов, необходимых для развертывания решения уровня документов:

- Создайте проект настройки визуальной студии.
- Добавьте основной выход решения уровня документа. Основная часть также включает документ Microsoft Office.
- Добавьте развертывание и манифесты приложения как свободные файлы.
- Исключить зависимые компоненты из пакета установки (за исключением любых сборки утилит).
- Настройка предварительных пакетов.
- Настройка условий запуска.
- Создайте проект настройки и скопируйте результаты в место развертывания.
- Развертывание решения уровня документа на компьютере пользователя, выражая настройку.
- При необходимости обновите свойства пользовательских документов.

### <a name="changing-the-location-of-the-deployed-document"></a>Изменение местоположения развернутого документа

Свойства внутри документа Office используются для поиска решений уровня документов. Если документ установлен в той же папке, что и сборка VSTO, изменения не требуются. Однако, если он установлен в другой папке, эти свойства должны быть обновлены во время настройки.

Для получения дополнительной информации [Custom Document Properties Overview](custom-document-properties-overview.md)об этих свойствах документов см.

Чтобы изменить эти свойства, необходимо использовать пользовательское действие во время настройки.

В следующем примере используется решение уровня документов под названием ExcelWorkbookProject и проект настройки под названием ExcelWorkbookSetup. Проект ExcelWorkbookSetup настроен с помощью тех же шагов, описанных выше, за исключением настройки ключей реестра.

Добавление пользовательского проекта действий в решение Visual Studio

1. Добавьте новый проект консоли .NET к решению, нажав на **проект развертывания документов Office** в **исследователе решений**
2. Расширить **Добавить** и нажмите **Новый проект**.
3. Выберите шаблон приложения console и назовите проект **AddCustomizationCustomAction.**

    ![Скриншот проводника решений - AddCustomizationCustomAction](media/setup-project-figure-15.jpg)
  
    **Рисунок 12: Исследователь решений - AddCustomizationCustomAction**

4. Добавьте Ссылку на эти сборки:
    1. System.ComponentModel
    2. System.Configuration.Install
    3. Microsoft.VisualStudio.Tools.Applications
    4. Microsoft.VisualStudio.Tools.Applications.ServerDocument

5. Скопируйте этот код на Program.cs или Program.vb

```csharp
    using System;
    using System.IO;
    using System.Collections;
    using System.ComponentModel;
    using System.Configuration.Install;
    using Microsoft.VisualStudio.Tools.Applications;
    using Microsoft.VisualStudio.Tools.Applications.Runtime;

    namespace AddCustomizationCustomAction
    {
        [RunInstaller(true)]
        public class AddCustomizations : Installer
        {
            public AddCustomizations() : base() { }

            public override void Install(IDictionary savedState)
            {
                base.Install(savedState);

                //Get the CustomActionData Parameters
                string documentLocation = Context.Parameters.ContainsKey("documentLocation") ? Context.Parameters["documentLocation"] : String.Empty;
                string assemblyLocation = Context.Parameters.ContainsKey("assemblyLocation") ? Context.Parameters["assemblyLocation"] : String.Empty;
                string deploymentManifestLocation = Context.Parameters.ContainsKey("deploymentManifestLocation") ? Context.Parameters["deploymentManifestLocation"] : String.Empty;
                Guid solutionID = Context.Parameters.ContainsKey("solutionID") ? new Guid(Context.Parameters["solutionID"]) : new Guid();

                string newDocLocation = Path.Combine(Environment.GetFolderPath(Environment.SpecialFolder.MyDocuments), Path.GetFileName(documentLocation));

                try
                {
                    //Move the file and set the Customizations
                    if (Uri.TryCreate(deploymentManifestLocation, UriKind.Absolute, out Uri docManifestLocationUri))
                    {
                        File.Move(documentLocation, newDocLocation);
                        ServerDocument.RemoveCustomization(newDocLocation);
                        ServerDocument.AddCustomization(newDocLocation, assemblyLocation,
                                                        solutionID, docManifestLocationUri,
                                                        true, out string[] nonpublicCachedDataMembers);
                    }
                    else
                    {
                        LogMessage("The document could not be customized.");
                    }
                }
                catch (ArgumentException)
                {
                    LogMessage("The document could not be customized.");
                }
                catch (DocumentNotCustomizedException)
                {
                    LogMessage("The document could not be customized.");
                }
                catch (InvalidOperationException)
                {
                    LogMessage("The customization could not be removed.");
                }
                catch (IOException)
                {
                    LogMessage("The document does not exist or is read-only.");
                }
            }

            public override void Rollback(IDictionary savedState)
            {
                base.Rollback(savedState);
                DeleteDocument();
            }
            public override void Uninstall(IDictionary savedState)
            {
                base.Uninstall(savedState);
                DeleteDocument();
            }
            private void DeleteDocument()
            {
                string documentLocation = Context.Parameters.ContainsKey("documentLocation") ? Context.Parameters["documentLocation"] : String.Empty;

                try
                {
                    File.Delete(Path.Combine(Environment.GetFolderPath(Environment.SpecialFolder.MyDocuments), Path.GetFileName(documentLocation)));
                }
                catch (Exception)
                {
                    LogMessage("The document doesn't exist or is read-only.");
                }
            }
            private void LogMessage(string Message)
            {
                if (Context.Parameters.ContainsKey("LogFile"))
                {
                    Context.LogMessage(Message);
                }
            }

            static void Main() { }
            }
    }
```

Чтобы добавить настройку в документ, необходимо иметь идентификатор решения решения вашего решения уровня документов VSTO. Это значение извлекается из файла проекта Visual Studio.

Для получения идентификатора решения

1. В меню **сборки** нажмите **«Решение сборки»,** чтобы создать решение уровня документа и добавить свойство идентификатора решения в файл проекта.
2. В **Solution Explorer**, право йняйте на уровне документов проекта **ExcelWorkbookProject**
3. Нажмите **UnloadProject,** чтобы получить доступ к файлу проекта изнутри Visual Studio.

    ![Скриншот решения Solution Explorer разгрузки Excel Документ решение](media/setup-project-figure-16.jpg)

    **Рисунок 13: Разгрузка решения excel Document**

4. В **Solution Explorer**, правой кнопкой **мыши ExcelWorkbookProject** и нажмите **EditExcelWorkbookProject.vbproj** или **Edit ExcelWorkbookProject.csproj**.
5. В редакторе **ExcelWorkbookProject** найдите элемент **SolutionID** внутри элемента **PropertyGroup.**
6. Копируйте значение GUID этого элемента.

    ![Получение решенияID](media/setup-project-figure-17.jpg)

    **Рисунок 14: Получение решенияID**

7. В **Solution Explorer**, правой кнопкой **мыши ExcelWorkbookProject** и нажмите **Reload Project**.
8. Нажмите **"Да"** в диалоговом окне, которое закрывает редактор **ExcelWorkbookProject.**
9. **Идентификатор решения** будет использоваться в пользовательском действии Install.

Последним шагом является настройка пользовательского действия для шагов **установки** и **удаления.**

### <a name="to-configure-the-setup-project"></a>Настройка проекта настройки

1. В **Solution Explorer**, правой кнопкой **мыши ExcelWorkbookSetup**, расширить **Добавить** и нажмите **на вывод проекта**.
2. В диалоговом окне **Add Project Output Group** в списке **проектов** нажмите **AddCustomizationCustomAction.**
3. Выберите **первичный выход** и нажмите **OK,** чтобы закрыть диалоговую коробку и добавить сборку, содержащую пользовательские действия, в проект настройки.

    ![Скриншот документа Манифест пользовательских действий - Добавить проект выход группы окна](media/setup-project-figure-18.jpg)

    **Рисунок 15: Документ Манифест пользовательских действий - Добавить проект выходной группы**

4. В **Solution Explorer**, правой кнопкой **мыши ExcelWorkbookSetup**.
5. Расширьте **представление** и нажмите **пользовательские действия**.
6. В редакторе **пользовательских действий (ExcelWorkbookSetup)** нажмите на **пользовательские действия** и нажмите **«Добавить пользовательские действия».**
7. В поле диалога **Select Item in Project** в списке Look **In** нажмите **Кнопка Приложения Folder**. Выберите **первичный выход из AddCustomizationCustomAction (активный)** и нажмите **OK,** чтобы добавить пользовательское действие в шаг установки.
8. Под **узлам установки**, право-нажмите **Основной выход от AddCustomizationCustomAction (Активный)**, и нажмите **Переименовать**. Назовите пользовательский документ копирования действия **к моим документам и приложите настройку.**
9. Под **узлами Uninstall**, правый щелчок **Первичный выход из AddCustomizationCustomAction (Активный)** и нажмите **Переименовать**. Назовите пользовательское действие **Удалить документ из папки Документы**.

    ![Скриншот окна пользовательских действий Манифеста документа](media/setup-project-figure-19.jpg)

    **Рисунок 16: Документ Манифест пользовательских действий**

10. В редакторе **пользовательских действий (ExcelWorkbookSetup)** нажмите правой кнопкой **мыши Копия документа к моим документам и приложите настройку** и нажмите Окно **свойств**.
11. В окне **CustomActionData** **Properties** введите местоположение DLL настройки, манифест развертывания и местоположение документа Microsoft Office. Также необходимо SolutionID.
12. Если вы хотите войти в файл каких-либо ошибок настройки, включите параметр LogFile.
s
    ``` text
    /assemblyLocation="[INSTALLDIR]ExcelWorkbookProject.dll" /deploymentManifestLocation="[INSTALLDIR]ExcelWorkbookProject.vsto" /documentLocation="[INSTALLDIR]ExcelWorkbookProject.xlsx" /solutionID="Your Solution ID" /LogFile="[TARGETDIR]Setup.log"
    ```

    ![Скриншот пользовательских действий по копированию документа в окне свойств моих документов](media/setup-project-figure-20.jpg)

    **Рисунок 17: Пользовательские действия по копированию документа в мои документы**

13. Пользовательские действия для удаления не требует сявка документа, вы можете предоставить, что, используя тот же параметр documentLocation в **CustomActionData**

    ``` text
    /documentLocation="[INSTALLDIR]ExcelWorkbookProject.xlsx"
    ```

14. Составить и развернуть проект **ExcelWorkbookSetup.**
15. Загляните в папку **"Мои документы"** и откройте файл ExcelWorkbookProject.xlsx.

## <a name="additional-resources"></a>Дополнительные ресурсы

[Как: Установка визуальных инструментов студии для office Runtime](how-to-install-the-visual-studio-tools-for-office-runtime-redistributable.md)

[Офисные первичные межпрома](office-primary-interop-assemblies.md)

[Записи в реестре для адбов VSTO](registry-entries-for-vsto-add-ins.md)

[Custom Document Properties Overview](custom-document-properties-overview.md)

[Определение регионов формы в реестре Windows](/office/vba/outlook/concepts/creating-form-regions/specifying-form-regions-in-the-windows-registry)

[Granting Trust to Documents](granting-trust-to-documents.md)

## <a name="about-the-authors"></a>Об авторах

Ваутер ван Вугт является MVP корпорации Майкрософт с технологиями Office Open XML и независимым консультантом, специализирующимся на создании офисных бизнес-приложений (OBA) с SharePoint, Microsoft Office и связанными с ними технологиями .NET.
Wouter часто вносит вклад в сайты сообщества разработчиков, такие как [OpenXmlDeveloper.org](http://openxmldeveloper.org/) и [MSDN.](/previous-versions/office/developer/office-2007/bb879915(v=office.12)) Он опубликовал несколько информационных документов и статей, а также книгу, доступную в строке под названием Open XML: Explained e-book.
Ваутер является основателем Code-Counsel, голландской компании, специализирующейся на предоставлении передового технического контента по различным каналам. Вы можете узнать больше о Ваутер, прочитав его блог и посетив [веб-сайт Code-Counsel](http://www.code-counsel.net/).

Тед Паттисон является SharePoint MVP, автор, тренер и основатель Тед Паттисон группы. Осенью 2005 года Тед был нанят группой разработчиков платформы Microsoft Evangelism для автора учебной программы для разработчиков Ascend для Служб Ыдопад3 3.0 и Microsoft Office SharePoint Server 2007. С тех пор Тед полностью сосредоточился на обучении профессиональных разработчиков технологиям SharePoint 2007. Тед закончил писать книгу для Microsoft Press под названием Inside Windows SharePoint Services 3.0, в которую основное внимание уделяется использованию SharePoint в качестве платформы для разработки бизнес-решений. Тед также пишет колонку для журнала MSDN под названием Office Space.
