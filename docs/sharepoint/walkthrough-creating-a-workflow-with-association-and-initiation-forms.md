---
title: Создание рабочего процесса с формами ассоциаций и инициации
ms.date: 02/02/2017
ms.topic: conceptual
dev_langs:
- VB
- CSharp
helpviewer_keywords:
- SharePoint development in Visual Studio, workflows
- SharePoint development in Visual Studio, workflow association forms
- workflows [SharePoint development in Visual Studio]
- association forms [SharePoint development in Visual Studio]
- initiation forms [SharePoint development in Visual Studio]
- SharePoint development in Visual Studio, workflow initiation forms
author: John-Hart
ms.author: johnhart
manager: jillfra
ms.workload:
- office
ms.openlocfilehash: 7946e48502ea4fd8e9e9382a20de3c8ce25987b3
ms.sourcegitcommit: dcbb876a5dd598f2538e62e1eabd4dc98595b53a
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 10/28/2019
ms.locfileid: "72984684"
---
# <a name="walkthrough-create-a-workflow-with-association-and-initiation-forms"></a>Пошаговое руководство. Создание рабочего процесса с формами ассоциаций и инициации
  В этом пошаговом руководстве показано, как создать базовый последовательный рабочий процесс, который включает в себя использование форм связи и инициации. Это формы ASPX, которые позволяют добавлять параметры в рабочий процесс при первом его связывании с администратором SharePoint (форма ассоциации), а также при запуске рабочего процесса пользователем (форма запуска).

 В этом пошаговом руководстве описывается сценарий, в котором пользователь хочет создать рабочий процесс утверждения для отчетов о расходах со следующими требованиями.

- Если рабочий процесс связан со списком, администратору предлагается форма связи, в которой он вводит лимит в долларах для отчетов о расходах.

- Сотрудники отправляют свои отчеты о расходах в список "Общие документы", запускают рабочий процесс, а затем вводят итоговые затраты в форме запуска рабочего процесса.

- Если итоговый отчет о расходах сотрудников превышает предопределенное ограничение администратора, то для руководителя сотрудника создается задача по утверждению отчета о расходах. Однако если итоговый отчет о расходах сотрудника меньше или равен лимиту расходов, то в список журнала рабочего процесса записывается автоматическое утвержденное сообщение.

  В данном пошаговом руководстве рассмотрены следующие задачи:

- Создание проекта последовательного рабочего процесса определения списка SharePoint в [!INCLUDE[vsprvs](../sharepoint/includes/vsprvs-md.md)].

- Создание расписания рабочего процесса.

- Обработка событий действий рабочего процесса.

- Создание форм сопоставления и инициации рабочего процесса.

- Связывание рабочего процесса.

- Запуск рабочего процесса вручную.

> [!NOTE]
> Хотя в этом пошаговом руководстве используется проект последовательного рабочего процесса, этот процесс одинаков для рабочих процессов конечного автомата.
>
> Кроме того, на компьютере могут отображаться разные имена или расположения для некоторых [!INCLUDE[vsprvs](../sharepoint/includes/vsprvs-md.md)] элементов пользовательского интерфейса в следующих инструкциях. Эти элементы определяются [!INCLUDE[vsprvs](../sharepoint/includes/vsprvs-md.md)]ным выпуском и параметрами, которые вы используете. Дополнительные сведения см. в разделе [Персонализация интегрированной среды разработки Visual Studio](../ide/personalizing-the-visual-studio-ide.md).

## <a name="prerequisites"></a>Необходимые компоненты
 Ниже приведены компоненты, необходимые для выполнения данного пошагового руководства.

- Поддерживаемые выпуски [!INCLUDE[TLA#tla_win](../sharepoint/includes/tlasharptla-win-md.md)] и SharePoint.

- Visual Studio.

## <a name="create-a-sharepoint-sequential-workflow-project"></a>Создание проекта последовательного рабочего процесса SharePoint
 Сначала создайте проект последовательного рабочего процесса в [!INCLUDE[vsprvs](../sharepoint/includes/vsprvs-md.md)]. Последовательный рабочий процесс — это последовательность шагов, выполняемых по порядку до завершения последнего действия. В этой процедуре будет создан последовательный рабочий процесс, который применяется к списку "Общие документы" в SharePoint. Мастер рабочего процесса позволяет связать рабочий процесс с определением сайта или списка и позволяет определить время запуска рабочего процесса.

#### <a name="to-create-a-sharepoint-sequential-workflow-project"></a>Создание проекта последовательного рабочего процесса SharePoint

1. В строке меню выберите **файл**  > **Новый**  > **проект** , чтобы открыть диалоговое окно **Новый проект** .

2. Разверните узел **SharePoint** в любом **визуальном C#**  элементе или **Visual Basic**, а затем выберите узел **2010** .

3. В области **шаблоны** выберите шаблон проекта проекта **SharePoint 2010** .

4. В поле **имя** введите **експенсерепорт** , а затем нажмите кнопку **ОК** .

     Откроется **Мастер настройки SharePoint** .

5. На странице **Укажите сайт и уровень безопасности для отладки** выберите параметр **Развернуть как решение фермы** , а затем нажмите кнопку **Готово** , чтобы принять уровень доверия и сайт по умолчанию.

     Этот шаг также задает уровень доверия для решения в качестве решения фермы, которое является единственным доступным параметром для проектов рабочих процессов.

6. В области **Обозреватель решений**выберите узел проекта.

7. В строке меню выберите **Проект** > **Добавить новый элемент**.

8. В **визуальном C#**  элементе или **Visual Basic**разверните узел **SharePoint** , а затем выберите узел **2010** .

9. В области **шаблоны** выберите шаблон **последовательного рабочего процесса (только для решения фермы)** , а затем нажмите кнопку **добавить** .

     Откроется **Мастер настройки SharePoint** .

10. На странице **Указание имени рабочего процесса для отладки** примите имя по умолчанию (**експенсерепорт-Workflow1**). Сохраняет значение типа шаблона рабочего процесса по умолчанию (**Рабочий процесс списка)** . Нажмите кнопку **Далее**.

11. Если вы хотите, **чтобы Visual Studio автоматически свяжет рабочий процесс в сеансе отладки?** , снимите флажок, автоматически связывающий шаблон рабочего процесса, если он установлен.

     Этот шаг позволяет вручную связать рабочий процесс со списком "Общие документы" в дальнейшем, в котором отображается форма ассоциации.

12. Нажмите кнопку **Готово** .

## <a name="add-an-association-form-to-the-workflow"></a>Добавление формы ассоциации в рабочий процесс
 Затем создайте. Форма ассоциации ASPX, которая появляется, когда администратор SharePoint сначала связывает рабочий процесс с документом отчета о расходах.

#### <a name="to-add-an-association-form-to-the-workflow"></a>Добавление формы связи в рабочий процесс

1. Выберите узел **Workflow1** в **Обозреватель решений**.

2. В строке меню выберите **проект** > **Добавить новый элемент** , чтобы открыть диалоговое окно **Добавление нового элемента** .

3. В древовидном представлении в диалоговом окне разверните **узел C# Visual** или **Visual Basic** (в зависимости от языка проекта), разверните узел **SharePoint** , а затем выберите узел **2010** .

4. В списке шаблонов выберите шаблон **форма ассоциации рабочего процесса** .

5. В текстовом поле **имя** введите **експенсерепортассокформ. aspx**.

6. Нажмите кнопку **Добавить** , чтобы добавить форму в проект.

## <a name="designing-and-coding-the-association-form"></a>Проектирование и кодирование формы связывания
 В этой процедуре Вы привносите в форму связывания функциональные возможности, добавляя в нее элементы управления и код.

#### <a name="to-design-and-code-the-association-form"></a>Разработка и создание кода для формы ассоциации

1. В форме ассоциации (Експенсерепортассокформ. aspx) выберите элемент `asp:Content` с `ID="Main"`.

2. Сразу после первой строки в этом элементе содержимого добавьте следующий код, чтобы создать метку и текстовое поле с запросом лимита на утверждение расходов (*аутоаппровелимит*):

    ```aspx-csharp
    <asp:Label ID="lblAutoApproveLimit" Text="Auto Approval Limit:" runat="server" />

    <asp:TextBox ID="AutoApproveLimit" runat="server" />
    <br /><br />
    ```

3. Разверните файл **експенсерепортассокформ. aspx** в **Обозреватель решений** , чтобы отобразить его зависимые файлы.

    > [!NOTE]
    > Если проект находится в [!INCLUDE[vbprvb](../sharepoint/includes/vbprvb-md.md)], необходимо нажать кнопку **Просмотреть все файлы** , чтобы выполнить этот шаг.

4. Откройте контекстное меню для файла Експенсерепортассокформ. aspx и выберите пункт **Просмотреть код**.

5. Замените метод `GetAssociationData` следующим:

    ```vb
    Private Function GetAssociationData() As String
        ' TODO: Return a string that contains the association data that
        ' will be passed to the workflow. Typically, this is in XML
        ' format.
        Return Me.AutoApproveLimit.Text
    End Function
    ```

    ```csharp
    private string GetAssociationData()
    {
        // TODO: Return a string that contains the association data that
        // will be passed to the workflow. Typically, this is in XML
        // format.
        return this.AutoApproveLimit.Text;
    }
    ```

## <a name="add-an-initiation-form-to-the-workflow"></a>Добавление формы инициации в рабочий процесс
 Затем создайте форму инициации, которая появляется, когда пользователи запускают рабочий процесс с отчетами о расходах.

#### <a name="to-create-an-initiation-form"></a>Создание формы инициации

1. Выберите узел **Workflow1** в **Обозреватель решений**.

2. В строке меню выберите **проект** > **Добавить новый элемент** открыть диалоговое окно **Добавление нового элемента** .

3. В древовидном представлении в диалоговом окне разверните **узел C# Visual** или **Visual Basic** (в зависимости от языка проекта), разверните узел **SharePoint** , а затем выберите узел **2010** .

4. В списке шаблонов выберите шаблон **форма инициации рабочего процесса** .

5. В текстовом поле **имя** введите **експенсерепортинитформ. aspx**.

6. Нажмите кнопку **Добавить** , чтобы добавить форму в проект.

## <a name="designing-and-coding-the-initiation-form"></a>Проектирование и кодирование формы инициации
 Затем Познакомьтесь с возможностями формы инициации, добавив в нее элементы управления и код.

#### <a name="to-code-the-initiation-form"></a>Код формы инициации

1. В форме инициации (Експенсерепортинитформ. aspx) выберите элемент `asp:Content`, содержащий `ID="Main"`.

2. Сразу после первой строки в этом элементе содержимого добавьте следующий код, чтобы создать метку и текстовое поле, которое отображает ограничение на утверждение расходов (*аутоаппровелимит*), введенное в форму ассоциации, и другую метку и текстовое поле для запроса Итого расходов (*експенсетотал*):

    ```aspx-csharp
    <asp:Label ID="lblAutoApproveLimit" Text="Auto Approval Limit:" runat="server" />

    <asp:TextBox ID="AutoApproveLimit" ReadOnly="true" runat="server" />
    <br /><br />
    <asp:Label ID="lblExpenseTotal" Text="Expense Total:" runat="server" />

    <asp:TextBox ID="ExpenseTotal" runat="server" />
    <br /><br />
    ```

3. Разверните файл **експенсерепортинитформ. aspx** в **Обозреватель решений** , чтобы отобразить его зависимые файлы.

4. Откройте контекстное меню для файла Експенсерепортинитформ. aspx и выберите пункт **Просмотреть код**.

5. Замените метод `Page_Load` следующим примером:

    ```vb
    Protected Sub Page_Load(ByVal sender As Object, ByVal e As
      EventArgs) Handles Me.Load
        InitializeParams()
        Me.AutoApproveLimit.Text = workflowList.WorkflowAssociations(New
          Guid(associationGuid)).AssociationData
        ' Optionally, add code here to pre-populate your form fields.
    End Sub
    ```

    ```csharp
    protected void Page_Load(object sender, EventArgs e)
    {
        InitializeParams();
        this.AutoApproveLimit.Text =
          workflowList.WorkflowAssociations[new
          Guid(associationGuid)].AssociationData;
    }
    ```

6. Замените метод `GetInitiationData` следующим примером:

    ```vb
    ' This method is called when the user clicks the button to start the workflow.
    Private Function GetInitiationData() As String
        Return Me.ExpenseTotal.Text
        ' TODO: Return a string that contains the initiation data that
        ' will be passed to the workflow. Typically, this is in XML
        ' format.
        Return String.Empty
    End Function
    ```

    ```csharp
    // This method is called when the user clicks the button to start the workflow.
    private string GetInitiationData()
    {
        // TODO: Return a string that contains the initiation data that
        // will be passed to the workflow. Typically, this is in XML
        // format.
        return this.ExpenseTotal.Text;
    }
    ```

## <a name="cutomize-the-workflow"></a>Кутомизе рабочего процесса
 Затем настройте рабочий процесс. Позже вы свяжете две формы с рабочим процессом.

#### <a name="to-customize-the-workflow"></a>Настройка рабочего процесса

1. Отобразите рабочий процесс в конструкторе рабочих процессов, открыв в проекте Workflow1.

2. На **панели элементов**разверните узел **Windows Workflow v 3.0** и выберите действие **IfElse** .

3. Добавьте это действие в рабочий процесс, выполнив одно из следующих действий.

    - Откройте контекстное меню действия **IfElse** , выберите команду **Копировать**, откройте контекстное меню для строки под действием **onWorkflowActivated1** в конструкторе рабочих процессов и выберите **Вставить**.

    - Перетащите действие **IfElse** с **панели элементов**и подключите его к строке под действием **onWorkflowActiviated1** в конструкторе рабочих процессов.

4. На панели элементов разверните узел **рабочего процесса SharePoint** и выберите действие **CreateTask** .

5. Добавьте это действие в рабочий процесс, выполнив одно из следующих действий.

    - Откройте контекстное меню для действия **CreateTask** , выберите **Копировать**, откройте контекстное меню для одного из двух **действий перетаскивания** в области **IfElseActivity1** в конструкторе рабочих процессов, а затем выберите **Вставить**.

    - Перетащите действие **CreateTask** с **панели элементов** на одно из двух **действий перетаскивания** в области **IfElseActivity1**.

6. В окне **Свойства** введите значение свойства *Тасктокен* для свойства **CorrelationToken** .

7. Разверните свойство **CorrelationToken** , щелкнув знак «плюс» (![TreeView Plus](../sharepoint/media/plus.gif "Плюс просмотра дерева")) рядом с ним.

8. Щелкните стрелку раскрывающегося свойства подменю **OwnerActivityName** и задайте значение *Workflow1* .

9. Выберите свойство **taskId** , а затем нажмите кнопку с многоточием (![ASP.net Mobile Designer (эллипс](../sharepoint/media/mwellipsis.gif "Эллипс конструктора ASP.NET для мобильных устройств"))), чтобы открыть диалоговое окно **Привязка свойства** .

10. Выберите вкладку **Привязка к новому члену** , нажмите кнопку **создать поле** , а затем нажмите кнопку **ОК** .

11. Выберите свойство **TaskProperties** , а затем нажмите кнопку с многоточием (![ASP.net Mobile Designer (эллипс](../sharepoint/media/mwellipsis.gif "Эллипс конструктора ASP.NET для мобильных устройств"))), чтобы открыть диалоговое окно **Привязка свойства** .

12. Выберите вкладку **Привязка к новому члену** , нажмите кнопку **создать поле** , а затем нажмите кнопку **ОК** .

13. На **панели элементов**разверните узел **рабочего процесса SharePoint** и выберите действие **логтохисторилистактивити** .

14. Добавьте это действие в рабочий процесс, выполнив одно из следующих действий.

    - Откройте контекстное меню для действия **логтохисторилистактивити** , выберите **Копировать**, откройте контекстное меню других **действий перетаскивания** в области **IfElseActivity1** в конструкторе рабочих процессов и выберите **Вставить.** .

    - Перетащите действие **логтохисторилистактивити** из области **элементов**и поместите его в другие **действия перетаскивания в этой** области в **IfElseActivity1**.

## <a name="add-code-to-the-workflow"></a>Добавление кода в рабочий процесс
 Затем добавьте код в рабочий процесс, чтобы предоставить ему функциональные возможности.

#### <a name="to-add-code-to-the-workflow"></a>Добавление кода в рабочий процесс

1. Откройте контекстное меню действия **createTask1** в конструкторе рабочих процессов и выберите пункт **Просмотреть код**.

2. Добавьте следующий метод:

    ```vb
    Private Sub createTask1_MethodInvoking(ByVal sender As
      System.Object, ByVal e As System.EventArgs)
        createTask1_TaskId1 = Guid.NewGuid
        createTask1_TaskProperties1.AssignedTo = "somedomain\\someuser"
        createTask1_TaskProperties1.Description = "Please approve the
          expense report"
        createTask1_TaskProperties1.Title = "Expense Report Approval
          Needed"
    End Sub
    ```

    ```csharp
    private void createTask1_MethodInvoking(object sender, EventArgs e)
    {
        createTask1_TaskId1 = Guid.NewGuid();
        createTask1_TaskProperties1.AssignedTo = "somedomain\\someuser";
        createTask1_TaskProperties1.Description = "Please approve the
          expense report";
        createTask1_TaskProperties1.Title = "Expense Report Approval
          Needed";
    }
    ```

    > [!NOTE]
    > В коде замените `somedomain\\someuser` именем домена и пользователя, для которого будет создана задача, например "`Office\\JoeSch`". Для тестирования проще всего использовать учетную запись, с которой вы работаете.

3. После метода `MethodInvoking` добавьте следующий пример:

    ```vb
    Private Sub checkApprovalNeeded(ByVal sender As Object, ByVal e As
      ConditionalEventArgs)
        Dim approval As Boolean = False
        If (Convert.ToInt32(workflowProperties.InitiationData) >
          Convert.ToInt32(workflowProperties.AssociationData)) Then
            approval = True
        End If
        e.Result = approval
    End Sub
    ```

    ```csharp
    private void checkApprovalNeeded(object sender, ConditionalEventArgs
      e)
    {
        bool approval = false;
        if (Convert.ToInt32(workflowProperties.InitiationData) >
          Convert.ToInt32(workflowProperties.AssociationData))
        {
            approval = true;
        }
        e.Result = approval;
    }
    ```

4. В конструкторе рабочих процессов выберите действие **ifElseBranchActivity1** .

5. В окне **Свойства** выберите стрелку раскрывающегося списка свойства **Condition** , а затем задайте значение *условия кода* .

6. Разверните свойство **Condition** , щелкнув знак «плюс» (![TreeView Plus](../sharepoint/media/plus.gif "Плюс просмотра дерева")) рядом с ним, а затем задайте для него значение *чеккаппровалнидед*.

7. В конструкторе рабочих процессов откройте контекстное меню для действия **logToHistoryListActivity1** , а затем выберите **создать обработчики** , чтобы создать пустой метод для события `MethodInvoking`.

8. Замените код `MethodInvoking` следующим кодом:

    ```vb
    Private Sub logToHistoryListActivity1_MethodInvoking(ByVal sender As
      System.Object, ByVal e As System.EventArgs)
        Me.logToHistoryListActivity1.HistoryOutcome = ("Expense was auto
          approved for " + workflowProperties.InitiationData)
    End Sub
    ```

    ```csharp
    private void logToHistoryListActivity1_MethodInvoking(object sender,
      EventArgs e)
    {
        this.logToHistoryListActivity1.HistoryOutcome = "Expense was
          auto approved for " + workflowProperties.InitiationData;
    }
    ```

9. Нажмите клавишу **F5** , чтобы выполнить отладку программы.

     При этом приложение компилируется, упаковывается, развертывается, активируются его компоненты, перезапускается [!INCLUDE[TLA2#tla_iis5](../sharepoint/includes/tla2sharptla-iis5-md.md)] пул приложений, а затем запускается браузер в расположении, указанном в свойстве **URL-адрес сайта** .

## <a name="associating-the-workflow-to-the-documents-list"></a>Связывание рабочего процесса со списком документов
 Затем отобразите форму сопоставления рабочего процесса, связав рабочий процесс со списком **шареддокументс** на сайте SharePoint.

#### <a name="to-associate-the-workflow"></a>Связывание рабочего процесса

1. На панели быстрого запуска щелкните ссылку **Общие документы** .

2. Выберите ссылку на **библиотеку** на вкладке **средства библиотеки** , а затем нажмите кнопку **Параметры библиотеки** на ленте.

3. В разделе **разрешения и управление** выберите ссылку **Параметры рабочего процесса** , а затем щелкните ссылку **Добавить рабочий процесс** на странице **рабочие процессы** .

4. В верхнем списке на странице Параметры рабочего процесса выберите шаблон **експенсерепорт-Workflow1** .

5. В следующем поле введите **експенсерепортворкфлов** , а затем нажмите кнопку **Далее** .

     При этом рабочий процесс связывается со списком " **Общие документы** " и отображается форма сопоставления рабочего процесса.

6. В текстовом поле **лимит автоматического утверждения** введите **1200** , а затем нажмите кнопку **связать рабочий процесс** .

## <a name="start-the-workflow"></a>Запуск рабочего процесса
 Затем свяжите рабочий процесс с одним из документов в списке " **Общие документы** ", чтобы отобразить форму запуска рабочего процесса.

#### <a name="to-start-the-workflow"></a>Запуск рабочего процесса

1. На странице SharePoint нажмите кнопку **Главная** .

2. На панели быстрого запуска щелкните ссылку **Общие документы** , чтобы открыть список **Общие документы** .

3. Щелкните ссылку **документы** на вкладке **средства библиотеки** в верхней части страницы, а затем нажмите кнопку **Отправить документ** на ленте, чтобы отправить новый документ в список **Общие документы** .

4. В диалоговом окне **Отправка документа** нажмите кнопку **Обзор** , выберите любой файл документа, нажмите кнопку **Открыть** , а затем нажмите кнопку **ОК** .

     В этом диалоговом окне можно изменить параметры документа, но оставить значения по умолчанию, нажав кнопку **сохранить** .

5. Выберите отправленный документ, щелкните появившуюся стрелку раскрывающегося списка, а затем выберите элемент **рабочие процессы** .

6. Выберите изображение рядом с Експенсерепортворкфлов.

     Откроется форма инициации рабочего процесса. (Обратите внимание, что значение, отображаемое в поле **лимит автоматического утверждения** , доступно только для чтения, поскольку оно было указано в форме ассоциации.)

7. В текстовом поле **сумма расходов** введите **1600**, а затем нажмите кнопку **запустить рабочий процесс** .

     После этого снова отобразится список " **Общие документы** ". Новый столбец с именем **експенсерепортворкфлов** и значением **Completed** будет добавлен к элементу, который только что начал рабочий процесс.

8. Щелкните стрелку раскрывающегося списка рядом с отправленным документом, а затем выберите элемент **рабочие процессы** , чтобы отобразить страницу состояние рабочего процесса. Выберите значение **завершено** в разделе **Завершенные рабочие процессы**. Задача отображается в разделе **задачи** .

9. Выберите название задачи, чтобы отобразить ее сведения о задаче.

10. Вернитесь в список **шареддокументс** и перезапустите рабочий процесс, используя один и тот же документ или другой.

11. Введите сумму на странице инициации, которая меньше или равна сумме, указанной на странице Ассоциация (**1200**).

     В этом случае вместо задачи создается запись в списке журнала. Запись отображается в разделе **Журнал рабочего процесса** на странице состояние рабочего процесса. Обратите внимание на сообщение в столбце **результат** события журнал. Он содержит текст, указанный в событии `logToHistoryListActivity1.MethodInvoking`, включающее сумму, которая была утверждена с помощью автоматического утверждения.

## <a name="next-steps"></a>Следующие шаги
 Дополнительные сведения о создании шаблонов рабочих процессов см. в следующих разделах:

- Дополнительные сведения о рабочих процессах SharePoint см. [в статье рабочие процессы в Windows SharePoint Services](/previous-versions/office/developer/sharepoint-2010/ms416312(v=office.14)).

## <a name="see-also"></a>См. также
- [Создание решений для рабочих процессов SharePoint](../sharepoint/creating-sharepoint-workflow-solutions.md)
- [Пошаговое руководство. Добавление страницы приложения в рабочий процесс](../sharepoint/walkthrough-add-an-application-page-to-a-workflow.md)
