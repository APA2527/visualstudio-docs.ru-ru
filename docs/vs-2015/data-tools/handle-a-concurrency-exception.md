---
title: Обработка исключения параллелизма | Документация Майкрософт
ms.date: 11/15/2016
ms.prod: visual-studio-dev14
ms.technology: vs-data-tools
ms.topic: conceptual
dev_langs:
- VB
- CSharp
- C++
- aspx
helpviewer_keywords:
- concurrency control, exceptions
- datasets [Visual Basic], errors
- exception handling, concurrency issues
- data concurrency, walkthroughs
- updating datasets, errors
- concurrency control, walkthroughs
ms.assetid: 73ee9759-0a90-48a9-bf7b-9d6fc17bff93
caps.latest.revision: 27
author: jillre
ms.author: jillfra
manager: jillfra
ms.openlocfilehash: 1b3f9bdaf5107f805100b938212128d42c0263dd
ms.sourcegitcommit: a8e8f4bd5d508da34bbe9f2d4d9fa94da0539de0
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 10/19/2019
ms.locfileid: "72670037"
---
# <a name="handle-a-concurrency-exception"></a>Обработка исключения параллелизма
[!INCLUDE[vs2017banner](../includes/vs2017banner.md)]

Исключения параллелизма (<xref:System.Data.DBConcurrencyException>) возникают, когда два пользователя пытаются одновременно изменить одни и те же данные в базе данных. В этом пошаговом руководстве вы создадите приложение Windows, которое демонстрирует перехват <xref:System.Data.DBConcurrencyException>, поиск строки, вызвавшей ошибку, и изучение стратегии ее решения.

 В этом пошаговом руководстве выполняется следующая процедура:

1. Создайте новый проект **приложения Windows** .

2. Создание нового набора данных на основе таблицы `Customers` "Northwind".

3. Создайте форму с <xref:System.Windows.Forms.DataGridView> для вывода данных.

4. Заполнение набора данных данными из таблицы `Customers` базы данных Northwind.

5. Используйте [визуальные инструменты для баз данных](https://msdn.microsoft.com/6b145922-2f00-47db-befc-bf351b4809a1) в Visual Studio, чтобы получить прямой доступ к `Customers` таблице данных и изменить запись.

6. Измените одну и ту же запись на другое значение, обновите набор данных и попытайтесь записать изменения в базу данных, что приведет к возникновению ошибки параллелизма.

7. Перехватить ошибку, затем отобразить различные версии записи, позволяя пользователю определить, следует ли продолжить и обновить базу данных, или отменить обновление.

## <a name="prerequisites"></a>Необходимые компоненты
 Для выполнения данного пошагового руководства требуется:

- Доступ к образцу базы данных Northwind с разрешением на выполнение обновлений.

> [!NOTE]
> Отображаемые диалоговые окна и команды меню могут отличаться от описанных в справке в зависимости от текущих параметров или используемого выпуска. Чтобы изменить параметры, выберите в меню **Сервис** пункт **Импорт и экспорт параметров** . Дополнительные сведения см. в статье [Настройка параметров разработки в Visual Studio](https://msdn.microsoft.com/22c4debb-4e31-47a8-8f19-16f328d7dcd3).

## <a name="create-a-new-project"></a>Создание нового проекта
 Чтобы начать работу с пошаговым руководством, создайте новое приложение Windows.

#### <a name="to-create-a-new-windows-application-project"></a>Создание нового проекта приложения Windows

1. В меню **файл** создайте новый проект.

2. На панели **типы проектов** выберите язык программирования.

3. В области **шаблоны** выберите **приложение Windows**.

4. Присвойте проекту имя `ConcurrencyWalkthrough` и нажмите кнопку **ОК**.

     Visual Studio добавит проект в **Обозреватель решений** и отобразит в конструкторе новую форму.

## <a name="create-the-northwind-dataset"></a>Создание набора данных Northwind
 В этом разделе вы создадите набор данных с именем `NorthwindDataSet`.

#### <a name="to-create-the-northwinddataset"></a>Создание NorthwindDataSet

1. В меню **данные** выберите команду **Добавить новый источник данных**.

     Открывается [мастер настройки источника данных](https://msdn.microsoft.com/library/c4df7de5-5da0-4064-940c-761dd6d9e28f).

2. На экране **Выбор типа источника данных**выберите **база данных**.

3. Выберите соединение с образцом базы данных Northwind из списка доступных подключений. Если подключение недоступно в списке подключений, выберите**создать подключение** .

    > [!NOTE]
    > Если вы подключаетесь к локальному файлу базы данных, выберите **нет** при появлении запроса на добавление файла в проект.

4. На экране **сохранить строку подключения в файле конфигурации приложения**нажмите кнопку **Далее**.

5. Разверните узел **таблицы** и выберите таблицу `Customers`. Имя по умолчанию для набора данных должно быть `NorthwindDataSet`.

6. Нажмите кнопку **Готово** , чтобы добавить набор данных в проект.

## <a name="create-a-data-bound-datagridview-control"></a>Создание элемента управления DataGridView с привязкой к данным
 В этом разделе вы создадите <xref:System.Windows.Forms.DataGridView>, перетащив элемент **Customers** из окна **Источники данных** на форму Windows Forms.

#### <a name="to-create-a-datagridview-control-that-is-bound-to-the-customers-table"></a>Создание элемента управления DataGridView, привязанного к таблице Customers

1. В меню **данные** выберите команду **отобразить источники данных** , чтобы открыть **окно Источники данных**.

2. В окне **Источники данных** разверните узел **NorthwindDataSet** , а затем выберите таблицу **Клиенты** .

3. Щелкните стрелку вниз в узле Таблица, а затем выберите **элемент DataGridView** в раскрывающемся списке.

4. Перетащите таблицу на пустую область формы.

     Элемент управления <xref:System.Windows.Forms.DataGridView> с именем `CustomersDataGridView` и <xref:System.Windows.Forms.BindingNavigator> с именем `CustomersBindingNavigator` добавляются в форму, привязанную к <xref:System.Windows.Forms.BindingSource>. это в, в свою очередь, привязана к `Customers` таблице в `NorthwindDataSet`.

## <a name="test-the-form"></a>Тестирование формы
 Теперь можно проверить форму, чтобы убедиться, что она ведет себя так, как ожидалось до этого момента.

#### <a name="to-test-the-form"></a>Тестирование формы

1. Нажмите **клавишу F5** , чтобы запустить приложение.

     Форма отображается с элементом управления <xref:System.Windows.Forms.DataGridView>, который заполнен данными из таблицы `Customers`.

2. В меню **Отладка** выберите команду**отменить отладку**.

## <a name="handleconcurrency-errors"></a>Ошибки хандлеконкурренци
 Способ управления ошибками зависит от конкретных бизнес-правил, которые управляют приложением. В этом пошаговом руководстве мы используем следующую стратегию в качестве примера того, как тохандле ошибку параллелизма.

 Аппликатионпресентс пользователя с тремя версиями записи:

- Текущая запись в базе данных

- Исходная запись, которая загружается в набор данных

- Предлагаемые изменения в наборе данных

  Пользователь может либо перезаписать базу данных предложенной версией, либо отменить обновление и обновить набор данных новыми значениями из базы данных.

#### <a name="to-enable-the-handling-of-concurrency-errors"></a>Включение обработки ошибок параллелизма

1. Создайте пользовательский обработчик ошибок.

2. Отображение вариантов выбора для пользователя.

3. Обработка ответа пользователя.

4. Повторно отправьте обновление или сбросьте данные в наборе данных.

### <a name="addcode-to-handle-the-concurrency-exception"></a>Аддкоде для обработки исключения параллелизма
 При попытке выполнить обновление и порождено исключение, как правило, необходимо сделать что-то с информацией, предоставляемой вызванным исключением.

 В этом разделе вы добавите код, который пытается обновить базу данных. Вы также обрабатываете любые <xref:System.Data.DBConcurrencyException>, которые могут быть вызваны, а также любые другие исключения.

> [!NOTE]
> Методы `CreateMessage` и `ProcessDialogResults` будут добавлены далее в этом пошаговом руководстве.

##### <a name="to-add-error-handling-for-the-concurrency-error"></a>Добавление обработки ошибок для ошибки параллелизма

1. Добавьте следующий код под методом `Form1_Load`:

     [!code-csharp[VbRaddataConcurrency#1](../snippets/csharp/VS_Snippets_VBCSharp/VbRaddataConcurrency/CS/Form1.cs#1)]
     [!code-vb[VbRaddataConcurrency#1](../snippets/visualbasic/VS_Snippets_VBCSharp/VbRaddataConcurrency/VB/Form1.vb#1)]

2. Замените метод `CustomersBindingNavigatorSaveItem_Click`, чтобы вызвать метод `UpdateDatabase`, чтобы он выглядел следующим образом:

     [!code-csharp[VbRaddataConcurrency#2](../snippets/csharp/VS_Snippets_VBCSharp/VbRaddataConcurrency/CS/Form1.cs#2)]
     [!code-vb[VbRaddataConcurrency#2](../snippets/visualbasic/VS_Snippets_VBCSharp/VbRaddataConcurrency/VB/Form1.vb#2)]

### <a name="displaychoices-to-the-user"></a>Дисплайчоицес пользователю
 Код, который вы только что написали, вызывает процедуру `CreateMessage` для вывода сведений об ошибке пользователю. В этом пошаговом руководстве используется окно сообщения для вывода различных версий записи пользователю. Это позволяет пользователю выбрать, следует ли перезаписать запись с изменениями, или отменить изменение. Когда пользователь выбирает параметр (нажимает кнопку) в окне сообщения, ответ передается методу `ProcessDialogResult`.

##### <a name="to-create-the-message-to-display-to-the-user"></a>Создание сообщения, отображаемого для пользователя

- Создайте сообщение, добавив следующий код в **Редактор кода**. Введите этот код под методом `UpdateDatabase`.

     [!code-csharp[VbRaddataConcurrency#4](../snippets/csharp/VS_Snippets_VBCSharp/VbRaddataConcurrency/CS/Form1.cs#4)]
     [!code-vb[VbRaddataConcurrency#4](../snippets/visualbasic/VS_Snippets_VBCSharp/VbRaddataConcurrency/VB/Form1.vb#4)]

### <a name="process-the-users-response"></a>Обработка ответа пользователя
 Кроме того, требуется код для обработки ответа пользователя на окно сообщения. Параметры могут либо перезаписать текущую запись в базе данных предложенным изменением, либо отменить локальные изменения и обновить таблицу данных с записью, которая в настоящее время находится в базе данных. Если пользователь выбирает Да, метод <xref:System.Data.DataTable.Merge%2A> вызывается с аргументом *PreserveChanges* , установленным в значение `true`. Это приводит к успешному выполнению попытки обновления, так как исходная версия записи теперь совпадает с записью в базе данных.

##### <a name="to-process-the-user-input-from-the-message-box"></a>Обработка вводимых пользователем данных из окна сообщения

- Добавьте следующий код под кодом, который был добавлен в предыдущем разделе.

     [!code-csharp[VbRaddataConcurrency#3](../snippets/csharp/VS_Snippets_VBCSharp/VbRaddataConcurrency/CS/Form1.cs#3)]
     [!code-vb[VbRaddataConcurrency#3](../snippets/visualbasic/VS_Snippets_VBCSharp/VbRaddataConcurrency/VB/Form1.vb#3)]

## <a name="test-the-form"></a>Тестирование формы
 Теперь можно проверить форму, чтобы убедиться, что она ведет себя так, как ожидалось. Чтобы имитировать нарушение параллелизма, необходимо изменить данные в базе данных после заполнения NorthwindDataSet.

#### <a name="to-test-the-form"></a>Тестирование формы

1. Нажмите **клавишу F5** , чтобы запустить приложение.

2. После появления формы оставьте ее выполняющейся и переключитесь в интегрированную среду разработки Visual Studio.

3. В меню **вид** выберите **Обозреватель сервера**.

4. В **Обозреватель сервера**разверните подключение, которое использует приложение, а затем разверните узел **таблицы** .

5. Щелкните правой кнопкой мыши таблицу **Клиенты** , а затем выберите команду **отобразить данные таблицы**.

6. В первой записи (`ALFKI`) измените `ContactName` на `Maria Anders2`.

    > [!NOTE]
    > Перейдите в другую строку, чтобы зафиксировать изменение.

7. Переключитесь на выполняемую форму `ConcurrencyWalkthrough`.

8. В первой записи в форме (`ALFKI`) измените `ContactName` на `Maria Anders1`.

9. Нажмите кнопку **Сохранить**.

     Возникает ошибка параллелизма, и появляется окно сообщения.

10. При выборе **нет** отменяется обновление, а набор данных обновляется значениями, которые в настоящее время находятся в базе данных. При нажатии кнопки **Да** в базу данных записывается предложенное значение.

## <a name="see-also"></a>См. также раздел

- [Сохранение данных обратно в базу данных](../data-tools/save-data-back-to-the-database.md)