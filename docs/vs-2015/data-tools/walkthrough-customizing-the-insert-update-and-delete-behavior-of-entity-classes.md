---
title: Пошаговое руководство. Настройка поведения вставки, обновления и удаления классов сущностей | Документация Майкрософт
ms.date: 11/15/2016
ms.prod: visual-studio-dev14
ms.technology: vs-data-tools
ms.topic: conceptual
ms.assetid: 03ff1146-706e-4780-91cb-56a83df63eea
caps.latest.revision: 6
author: jillre
ms.author: jillfra
manager: jillfra
ms.openlocfilehash: 9901d917de2babf4992519ffe6b360454542aad1
ms.sourcegitcommit: 6cfffa72af599a9d667249caaaa411bb28ea69fd
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 09/02/2020
ms.locfileid: "72602572"
---
# <a name="walkthrough-customizing-the-insert-update-and-delete-behavior-of-entity-classes"></a>Пошаговое руководство. Настройка поведения вставки, обновления и удаления классов сущностей
[!INCLUDE[vs2017banner](../includes/vs2017banner.md)]

[Средства LINQ to SQL в Visual Studio](../data-tools/linq-to-sql-tools-in-visual-studio2.md) предоставляют визуальную область конструктора для создания и редактирования [!INCLUDE[vbtecdlinq](../includes/vbtecdlinq-md.md)] классов (классов сущностей), основанных на объектах в базе данных. С помощью [LINQ to SQL](https://msdn.microsoft.com/library/73d13345-eece-471a-af40-4cc7a2f11655)можно использовать технологию LINQ для доступа к базам данных SQL. Дополнительные сведения см. в разделе [LINQ (интегрированный в язык запрос)](https://msdn.microsoft.com/library/a73c4aec-5d15-4e98-b962-1274021ea93d).

 По умолчанию логику для выполнения обновлений обеспечивает среда выполнения [!INCLUDE[vbtecdlinq](../includes/vbtecdlinq-md.md)]. Среда выполнения по умолчанию создает инструкции Вставить, Обновить и Удалить, основываясь на схеме таблицы (определения столбцов и информация о первичных ключах). Если вы не хотите использовать поведение по умолчанию, то можно конфигурировать поведение обновления и назначить конкретные сохраненные процедуры для выполнения команд Вставить, Обновить и Удалить, необходимых для работы с данными в базе данных. Можно также сделать это, когда поведение по умолчанию не сгенерировано, например, когда ваши классы сущностей сопоставляются с представлениями. Кроме того, можно отменить поведение обновления по умолчанию, когда база данных требует доступа к таблице через сохраненные процедуры. Дополнительные сведения см. в разделе [Настройка операций с помощью хранимых процедур](https://msdn.microsoft.com/library/aedbecc1-c33c-4fb4-8861-fdf7e1dc6b8a).

> [!NOTE]
> Данное пошаговое руководство требует наличия хранимых процедур **InsertCustomer**, **UpdateCustomer** и **DeleteCustomer** в базе данных Northwind.

 Это пошаговое руководство обеспечивает действия, которые необходимо выполнить, чтобы отменить поведение по умолчанию среды выполнения LINQ to SQL для сохранения данных обратно в базе данных, используя сохраненные процедуры.

 В рамках данного пошагового руководства вы узнаете, как выполнять следующие задачи.

- Создание нового приложения Windows Forms и добавление в него файла [!INCLUDE[vbtecdlinq](../includes/vbtecdlinq-md.md)].

- Создание класса сущностей, который сопоставляется с таблицей Northwind Customers.

- Создание источника данных об объекте, который ссылается на класс LINQ to SQL Customer.

- Создание приложения Windows Form, содержащего <xref:System.Windows.Forms.DataGridView>, которое связано с классом Customer

- Реализуйте для формы функциональные возможности сохранения.

- Создайте методы <xref:System.Data.Linq.DataContext> путем добавления сохраненных процедур в [!INCLUDE[vs_ordesigner_short](../includes/vs-ordesigner-short-md.md)].

- Сконфигурируйте класс Configure так, чтобы он использовал сохраненные процедуры Вставить, Обновить и Удалить.

## <a name="prerequisites"></a>Предварительные требования
 Для выполнения данного пошагового руководства необходимо следующее:

- Доступ к версии SQL Server учебной базы данных "Борей".

- Хранимые процедуры **InsertCustomer**, **упдатекустомер**и **DeleteCustomer** для базы данных Northwind.

## <a name="creating-an-application-and-adding-linq-to-sql-classes"></a>Создание приложения и добавление классов LINQ to SQL
 Поскольку вы будете работать с классами [!INCLUDE[vbtecdlinq](../includes/vbtecdlinq-md.md)] и отображать данные на Windows Form, создайте новой приложение Windows Forms и добавьте файл классов LINQ to SQL.

 [!INCLUDE[note_settings_general](../includes/note-settings-general-md.md)]

#### <a name="to-create-a-new-windows-application-project-that-contains-linq-to-sql-classes"></a>Для создания нового проекта Приложение Windows, которое содержит класса LINQ to SQL

1. В меню **файл** создайте новый проект.

2. Назовите проект **UpdatingwithSProcsWalkthrough**.

    > [!NOTE]
    > [!INCLUDE[vs_ordesigner_short](../includes/vs-ordesigner-short-md.md)] поддерживается в проектах [!INCLUDE[vbprvb](../includes/vbprvb-md.md)] и C#. Поэтому создайте новый проект на одном из этих языков.

3. Щелкните шаблон **приложения Windows Forms** и нажмите кнопку **ОК**. Дополнительные сведения см. в разделе [Client Applications](https://msdn.microsoft.com/library/2dfb50b7-5af2-4e12-9bbb-c5ade0e39a68).

     Проект UpdatingwithSProcsWalkthrough создается и добавляется в **Обозреватель решений**.

4. В меню **Проект** выберите **Добавить новый элемент**.

5. Выберите шаблон **Классы LINQ to SQL** и введите **Northwind.dbml** в поле **Имя**.

6. Нажмите кнопку **Добавить**.

     Пустой файл классов LINQ to SQL Classes (Northwind.dbml) добавляется в проект, и открывается [!INCLUDE[vs_ordesigner_short](../includes/vs-ordesigner-short-md.md)].

## <a name="creating-the-customer-entity-class-and-object-data-source"></a>Создание класса сущностей Customer и источника данных об объекте
 Создайте [!INCLUDE[vbtecdlinq](../includes/vbtecdlinq-md.md)] классы, сопоставленные с таблицами базы данных, перетащив таблицы из **Обозреватель сервера** / **Обозреватель базы данных** в [!INCLUDE[vs_ordesigner_short](../includes/vs-ordesigner-short-md.md)] . В результате получите классы сущностей LINQ to SQL, которые сопоставляются с таблицами базы данных. После создания классов сущностей, их можно использовать в качестве источников данных об объекте точно так же как другие классы, которые имеют общие свойства

#### <a name="to-create-a-customer-entity-class-and-configure-a-data-source-with-it"></a>Для создания класса сущностей Customer и настройки с ним источника данных

1. В **Обозреватель сервера** / **Обозреватель базы данных**выберите таблицу Customer в SQL Server версии образца базы данных Northwind.

2. Перетащите узел **Customers (клиенты** ) из **Обозреватель сервера** / **Обозреватель базы данных** на [!INCLUDE[vs_ordesigner_short](../includes/vs-ordesigner-short-md.md)] поверхность.

     Создастся класс сущностей с именем **Customer**. Он имеет свойства, соответствующие столбцам в таблице Customers. Класс сущностей имеет имя **Customer** (не **Customers**), поскольку он представляет одного клиента из таблицы Customers.

    > [!NOTE]
    > Такой метод переименования называется *преобразованием во множественную форму*. Его можно включить или отключить в [диалоговом окне Параметры](../ide/reference/options-dialog-box-visual-studio.md). Дополнительные сведения см. в разделе [инструкции. Включение и отключение во множественном числе (реляционный конструктор)](../data-tools/how-to-turn-pluralization-on-and-off-o-r-designer.md).

3. В меню **Build** щелкните пункт **Build UpdatingwithSProcsWalkthrough** для создания проекта.

4. В меню **Данные** выберите команду **Показать источники данных**.

5. В окне **Источники данных** выберите **Добавить новый источник данных**.

6. На странице **Выбор типа источника данных** выберите **Объект** и нажмите кнопку **Далее**.

7. Разверните узел **UpdatingwithSProcsWalkthrough** и найдите и выберите класс **Customer**.

    > [!NOTE]
    > Если класс **Customer** недоступен, отмените работу мастера, выполните сборку проекта и снова запустите мастер.

8. Нажмите кнопку **Готово** для создания источника данных и добавления класса сущности **Customer** в окно **Источники данных**.

## <a name="creating-a-datagridview-to-display-the-customer-data-on-a-windows-form"></a>Создание представления DataGridView для отображения данных класса Customer на Windows Form
 Создавайте элементы управления, привязанные к классам сущностей, путем перетаскивания [!INCLUDE[vbtecdlinq](../includes/vbtecdlinq-md.md)] элементов источника данных из окна **Источники данных** в форму Windows Forms.

#### <a name="to-add-controls-that-are-bound-to-the-entity-classes"></a>Для добавления элементов управления, привязанных к классам сущностей

1. Откройте форму Form1 в конструкторе.

2. В окне **Источники данных** перетащите узел **Customer** на форму Form1.

    > [!NOTE]
    > Чтобы открыть окно **Источники данных**, выберите в меню **Данные** команду **Показать источники данных**.

3. Откройте форму Form1 в редакторе кода.

4. Добавьте следующий код в форму, которая является глобальной по отношению к форме, находящейся за пределами любого конкретного метода, но внутри класса Form1:

    ```vb
    Private NorthwindDataContext1 As New NorthwindDataContext
    ```

    ```csharp
    private NorthwindDataContext northwindDataContext1
        = new NorthwindDataContext();

    ```

5. Создайте обработчик события для события `Form_Load` и добавьте в обработчик следующий код:

    ```vb
    CustomerBindingSource.DataSource = NorthwindDataContext1.Customers
    ```

    ```csharp
    customerBindingSource.DataSource
        = northwindDataContext1.Customers;

    ```

## <a name="implementing-save-functionality"></a>Реализация кнопки Save Functionality (Сохранить функциональные возможности)
 По умолчанию опция создания кнопки Сохранить не активизирована и реализовать сохранение функциональных возможностей невозможно. Итак, код для сохранения измененных данных в базе данных, когда создаются привязанные к данным элементы управления для источников данных об объекте, не будет автоматически добавляться. В этом разделе объясняется как включить опцию создания кнопки Сохранить и включить кнопку Сохранить функциональные возможности для объектов [!INCLUDE[vbtecdlinq](../includes/vbtecdlinq-md.md)].

#### <a name="to-implement-save-functionality"></a>Для реализации кнопки Save Functionality (Сохранить функциональные возможности)

1. Откройте форму Form1 в конструкторе.

2. Выберите кнопку Сохранить на **CustomerBindingNavigator** (кнопка, на которой изображена дискета).

3. В окне **Свойства** задайте для свойства **Включено** значение **True**.

4. Дважды щелкните кнопку сохранить, чтобы создать обработчик события и переключиться в редактор кода.

5. Добавьте в обработчик события для кнопки Сохранить следующий код:

    ```vb
    NorthwindDataContext1.SubmitChanges()
    ```

    ```csharp
    northwindDataContext1.SubmitChanges();
    ```

## <a name="overriding-the-default-behavior-for-performing-updates-inserts-updates-and-deletes"></a>Переопределение поведения по умолчанию для выполнения обновлений (Inserts, Updates и Deletes)

#### <a name="to-override-the-default-update-behavior"></a>Для переопределения поведения по умолчанию при обновлении

1. Откройте файл LINQ to SQL в [!INCLUDE[vs_ordesigner_short](../includes/vs-ordesigner-short-md.md)]. (Дважды щелкните по файлу **Northwind.dbml** в **Обозревателе решений**.)

2. В **Обозреватель сервера** / **Обозреватель базы данных**разверните узел **хранимые процедуры** баз данных Northwind и выберите хранимые процедуры **инсерткустомерс**, **коде**и **делетекустомерс** .

3. Перетащите все три сохраненные процедуры на [!INCLUDE[vs_ordesigner_short](../includes/vs-ordesigner-short-md.md)].

     Сохраненные процедуры добавляются в дерево методов как методы <xref:System.Data.Linq.DataContext>. Дополнительные сведения см. в разделе [методы DataContext (реляционный конструктор R)](../data-tools/datacontext-methods-o-r-designer.md).

4. Выберите класс сущности **Customer** в [!INCLUDE[vs_ordesigner_short](../includes/vs-ordesigner-short-md.md)] .

5. В окне **Свойства** выберите свойство **Вставка**.

6. Нажмите кнопку с многоточием (...) рядом с кнопкой **Использовать среду выполнения**, чтобы открыть диалоговое окно **Настройка поведения**.

7. Выберите **Настроить**.

8. Выберите метод **InsertCustomers** в списке **Настроить**.

9. Нажмите кнопку **Применить**, чтобы сохранить конфигурацию для выбранного класса и поведения.

    > [!NOTE]
    > Можно продолжить настройку поведения для каждого сочетания класса и поведения при условии, что после каждого изменения будет производиться нажатие кнопки **Применить**. Если изменить класс или поведение до нажатия кнопки **Применить**, появится диалоговое окно с предупреждением, в котором можно будет применить любые изменения.

10. Выберите **Обновить** в списке **Поведение**.

11. Выберите **Настроить**.

12. Выберите метод **UpdateCustomers** в списке **Настроить**.

     Проверьте список **Аргументы метода** и **Свойства класса** и укажите, что для некоторых столбцов в таблице имеется два списка **Аргументы метода** и два списка **Свойства класса**. Это облегчает возможность прослеживать изменения и создавать инструкции, которые проверяют нарушения параллелизма.

13. Сопоставьте аргумент метода **Original_CustomerID** свойству класса **CustomerID (Original)**.

    > [!NOTE]
    > По умолчанию аргументы метода будут сопоставлены со свойствами класса, если их имена совпадают. Если имена свойств были изменены и больше не совпадают в таблице и в классе сущностей, то может потребоваться выбор эквивалентного свойства класса для сопоставления, если реляционный конструктор объектов не может определить правильное сопоставление. Кроме того, если отсутствуют допустимые свойства класса для сопоставления с аргументами метода, то можно установить **Свойства класса** в значение **(Нет)**.

14. Нажмите кнопку **Применить**, чтобы сохранить конфигурацию для выбранного класса и поведения.

15. Выберите **Удалить** в списке **Поведение**.

16. Выберите **Настроить**.

17. Выберите метод **DeleteCustomers** в списке **Настроить**.

18. Сопоставьте аргумент метода **Original_CustomerID** свойству класса **CustomerID (Original)**.

19. Нажмите кнопку **ОК**.

> [!NOTE]
> Хотя это не повлияет на работу данного пошагового руководства, следует заметить, что [!INCLUDE[vbtecdlinq](../includes/vbtecdlinq-md.md)] автоматически обрабатывает значения, создаваемые в базе данных, для столбцов идентификаторов (с автоматическим приращением), столбцов rowguidcol (идентификатор GUID, создаваемый базой данных) и столбцов timestamp в ходе операций вставки и обновления. Генерируемые базой данных значения в других типах столбцов будут неожиданно давать нулевое значение. Для возврата генерируемых базой данных значений нужно вручную задать <xref:System.Data.Linq.Mapping.ColumnAttribute.IsDbGenerated%2A> в `true` и <xref:System.Data.Linq.Mapping.ColumnAttribute.AutoSync%2A> в одно из следующих: <xref:System.Data.Linq.Mapping.AutoSync>, <xref:System.Data.Linq.Mapping.AutoSync> или <xref:System.Data.Linq.Mapping.AutoSync>.

## <a name="testing-the-application"></a>Тестирование приложения
 Снова запустите приложение, чтобы убедиться, что хранимая процедура **UpdateCustomers** правильно обновляет запись клиента в базе данных.

#### <a name="to-test-the-application"></a>Тестирование приложения

1. Нажмите клавишу F5.

2. Измените запись в таблице, чтобы проверить поведение Обновления.

3. Добавьте новую запись, чтобы проверить поведение Вставки.

4. Нажмите кнопку Сохранить, чтобы сохранить изменения в базе данных.

5. Закройте форму.

6. Нажмите клавишу F5 и убедитесь, что обновленная запись и недавно вставленная запись сохранились.

7. Удалите новую запись, чтобы проверить поведение Удаления.

8. Нажмите кнопку Сохранить, чтобы представить изменения и стереть удаленную запись из базы данных

9. Закройте форму.

10. Нажмите клавишу F5 и убедитесь, что удаленная запись была стерта из базы данных.

    > [!NOTE]
    > Если в приложении используется SQL Server Express Edition, то в зависимости от свойства **Копировать в выходной каталог** файла базы данных изменения могут не отображаться, когда на шаге 10 нажимается клавиша F5.

## <a name="next-steps"></a>Next Steps
 В зависимости от требований приложения есть несколько шагов, которые возможно потребуется выполнить после создания классов сущностей [!INCLUDE[vbtecdlinq](../includes/vbtecdlinq-md.md)]. Ниже приводится перечень рекомендаций, позволяющих улучшить данное приложение.

- Реализуйте конкурентную проверку во время обновлений. Дополнительные сведения см. в разделе [оптимистичный параллелизм: обзор](https://msdn.microsoft.com/library/c2e38512-d0c8-4807-b30a-cb7e30338694).

- Добавьте запросы LINQ в данные фильтра Дополнительные сведения см. [в разделе Введение в запросы LINQ (C#)](https://msdn.microsoft.com/library/37895c02-268c-41d5-be39-f7d936fa88a8).

## <a name="see-also"></a>См. также:
 [Средства LINQ to SQL в Visual studio](../data-tools/linq-to-sql-tools-in-visual-studio2.md) [LINQ to SQL](https://msdn.microsoft.com/library/73d13345-eece-471a-af40-4cc7a2f11655) [LINQ to SQL запросы](https://msdn.microsoft.com/library/f4897aaa-7f44-4c20-a471-b948c2971aae) [методов DataContext (реляционный конструктор r)](../data-tools/datacontext-methods-o-r-designer.md) [инструкции: назначение хранимых процедур для выполнения операций обновления, вставки и удаления (реляционный конструктор r)](../data-tools/how-to-assign-stored-procedures-to-perform-updates-inserts-and-deletes-o-r-designer.md) [Pave новые возможности разработки приложений для работы с данными в Visual Studio 2012](https://msdn.microsoft.com/3d50d68f-5f44-4915-842f-6d42fce793f1)
