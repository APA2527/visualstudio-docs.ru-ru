---
title: Иерархическое обновление | Документация Майкрософт
ms.date: 11/15/2016
ms.prod: visual-studio-dev14
ms.technology: vs-data-tools
ms.topic: conceptual
dev_langs:
- VB
- CSharp
- C++
- aspx
helpviewer_keywords:
- saving data, changed data
- data [Visual Basic], hierarchical update
- saving updated data
- datasets [Visual Basic], hierarchical update
- hierarchical update
- saving data, hierarchical update
- modified data saving
- updated data saving
- related tables, saving
ms.assetid: 68bae3f6-ec9b-45ee-a33a-69395029f54c
caps.latest.revision: 29
author: gewarren
ms.author: gewarren
manager: jillfra
ms.openlocfilehash: 521f878c9d4fafa61f8c717f4c9752622ef339d9
ms.sourcegitcommit: 08fc78516f1107b83f46e2401888df4868bb1e40
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 05/15/2019
ms.locfileid: "65699814"
---
# <a name="hierarchical-update"></a>Иерархическое обновление
[!INCLUDE[vs2017banner](../includes/vs2017banner.md)]

Иерархическое обновление * — это процесс сохранения обновленных данных (из набора данных двух или более связанных таблиц) обратно в базу данных, сохраняя ограничения ссылочной целостности. *Ссылочная целостность* ссылается на правила целостности, заданные с помощью ограничений в базе данных, которые управляют поведением вставки, обновления и удаления связанных записей. Например это целостность данных обеспечивает создание записи клиента перед предоставлением заказы, должен быть создан для этого клиента.  Дополнительные сведения о связях в наборах данных см. в разделе [отношения в наборах данных](../data-tools/relationships-in-datasets.md)  
  
 Использует функцию иерархическое обновление `TableAdapterManager` для управления `TableAdapter`s в типизированный набор данных. `TableAdapterManager` Компонент является [!INCLUDE[vsprvs](../includes/vsprvs-md.md)]-создается класс, так что не является частью [!INCLUDE[dnprdnshort](../includes/dnprdnshort-md.md)]. При перетаскивании таблицы из окна источников данных в форму Windows или WPF страницы Visual Studio добавляет переменную типа TableAdapterManager формы или страницы и см. в конструкторе в области компонентов. Подробные сведения о `TableAdapterManager` класса см. в разделе справочной TableAdapterManager [Общие сведения о компоненте TableAdapterManager](https://msdn.microsoft.com/library/33076d42-6b41-491a-ac11-6c6339aea650).  
  
 По умолчанию набор данных рассматривает связанных таблиц как «только для отношения», это означает, что он не применить ограничения внешнего ключа. Можно изменить эту настройку во время разработки с помощью конструктора наборов данных. Выберите линию связи между двумя таблицами, чтобы открыть **отношения** диалоговое окно. Изменения, внесенные здесь определит как TableAdapterManager ведет себя, если отправить изменения в связанных таблицах в базе данных.  
  
## <a name="enablehierarchical-update-in-a-dataset"></a>Обновление Enablehierarchical в наборе данных  
 По умолчанию иерархическое обновление включено для всех новых наборов данных, которые добавляются или создаются в проекте. Включить иерархическое обновление или отключить, задав **иерархическое обновление** свойство типизированного набора данных в конструкторе наборов данных для **True** или **False**:  
  
 ![Параметр иерархическое обновление](../data-tools/media/hierarchical-update-setting.png "параметр иерархическое обновление")  
  
## <a name="create-a-new-relation-between-tables"></a>Создать новую связь между таблицами  
 Чтобы создать новую связь между двумя таблицами, в конструкторе наборов данных, выберите заголовок каждой таблицы, затем щелкните правой кнопкой мыши и выберите**добавить отношение**.  
  
 ![Иерархическое обновление отношения меню добавления](../data-tools/media/hierarchical-update-add-relation-menu.png "отношения меню добавления иерархическое обновление")  
  
## <a name="understand-foreign-key-constraints-cascading-updates-and-deletes"></a>Понимать ограничения foreign key, каскадные обновления и удаления  
 Важно понимать ограничения как внешнего ключа и каскадное поведения в базе данных создаются в коде созданный набор данных.  
  
 По умолчанию таблиц данных в наборе данных создаются со связями (<xref:System.Data.DataRelation>), которые соответствуют связи в базе данных. Тем не менее как ограничение внешнего ключа связи в наборе данных не создается. <xref:System.Data.DataRelation> Работает в режиме **только связь** без <xref:System.Data.ForeignKeyConstraint.UpdateRule%2A> или <xref:System.Data.ForeignKeyConstraint.DeleteRule%2A> в силе.  
  
 По умолчанию каскадное обновление и удаление отключены даже в том случае, если связь в базе данных, заданный параметром каскадные обновления и/или удалением. Например создание нового клиента и новый заказ, а также последующая попытка сохранения данных может вызвать конфликт с ограничениями внешнего ключа, которые определены в базе данных. Дополнительные сведения см. в разделе [Практическое руководство. Настройка ограничений внешнего ключа в наборе данных](https://msdn.microsoft.com/library/3954c388-e209-4a67-a34e-5ca106282f8e).  
  
## <a name="set-the-order-to-perform-updates"></a>Установить порядок для выполнения обновлений  
 Задание порядка выполнения обновления задает порядок отдельных операций вставки, обновления и удаления, необходимых для сохранения всех измененных данных во всех таблицах набора данных. При включении иерархического обновления операции вставки, выполняются первыми, а затем обновляет, а затем удаляет. `TableAdapterManager` Предоставляет `UpdateOrder` свойство, которое может быть задано для выполнения обновления, во-первых, вставки и удаления.  
  
> [!NOTE]
> Важно понимать, что порядок обновления является полным. То есть при выполнении обновления, вставки и удаления выполняются для всех таблиц в наборе данных.  
  
 Чтобы задать `UpdateOrder` свойства, после перетаскивания элементов из [окна "Источники данных"](https://msdn.microsoft.com/library/0d20f699-cc95-45b3-8ecb-c7edf1f67992) в форму, выберите `TableAdapterManager` в область компонентов, а затем задайте `UpdateOrder` свойство в **свойства** окна. Дополнительные сведения см. в разделе [Практическое руководство. Установка порядка выполнения иерархического обновления](https://msdn.microsoft.com/library/a0734935-78dd-4c0b-80d7-5e7925789c83).  
  
## <a name="create-a-backup-copy-of-a-dataset-before-performing-a-hierarchical-update"></a>Создать резервную копию набора данных перед выполнением иерархического обновления  
 При сохранении данных (путем вызова `TableAdapterManager.UpdateAll()` метод), `TableAdapterManager` пытается обновить данные для каждой таблицы в одной транзакции. В случае сбоя любой части обновление для любой таблицы откат всей транзакции. В большинстве случаев отката возвращает в исходное состояние приложения.  
  
 Тем не менее иногда может потребоваться восстановление из резервной копии набора данных. Примером этого могут возникнуть при использовании значения с автоматическим приращением. Например, если сохранение операция не выполнена успешно, с автоматическим приращением значений не сбрасываются в наборе данных и набора данных продолжает создавать значения заданы с автоматическим приращением. Это оставляет разрыв в нумерации, который не может быть приемлемым в приложении. В ситуациях, где это важно, `TableAdapterManager` предоставляет `BackupDataSetBeforeUpdate` свойство, которое заменяет существующий набор данных резервной копии, если происходит сбой транзакции.  
  
> [!NOTE]
> Резервные копии находятся только в памяти, пока `TableAdapterManager.UpdateAll` выполняется метод. Таким образом, нет программного доступа к этому резервному набору данных, так как он заменяет исходный набор данных либо выходит за пределы области после `TableAdapterManager.UpdateAll` метод завершения работы.  
  
## <a name="modify-the-generated-save-code-to-perform-the-hierarchical-update"></a>Изменение созданного кода сохранения для выполнения иерархического обновления  
 Сохраните изменения из связанных таблиц данных набора данных в базу данных, вызвав метод `TableAdapterManager.UpdateAll` и передав имя набора данных, содержащего связанные таблицы. Например, запустите метод `TableAdapterManager.UpdateAll(NorthwindDataset)` для отправки обновлений из всех таблиц в NorthwindDataset во внутреннюю базу данных.  
  
 После удаления элементов из окна **Источники данных** в событие `Form_Load` автоматически добавляется код для заполнения каждой таблицы (методы `TableAdapter.Fill`). Код также добавляется в событие нажатия кнопки **Сохранить** объекта <xref:System.Windows.Forms.BindingNavigator>, чтобы сохранить данные из набора данных обратно в базу данных (метод `TableAdapterManager.UpdateAll`).  
  
 Сформированный код сохранения также содержит строку, вызывающую метод `CustomersBindingSource.EndEdit`. В частности, он вызывает <xref:System.Windows.Forms.BindingSource.EndEdit%2A> метод первого <xref:System.Windows.Forms.BindingSource>, добавляется в форму. Другими словами, этот код создается только для первой таблицы, которые перетаскиваются из **источников данных** окна в форму. Вызов <xref:System.Windows.Forms.BindingSource.EndEdit%2A> фиксирует все актуальные изменения для всех редактируемых в настоящее время элементов управления с привязкой к данным. Таким образом, если элемент управления с привязкой к данным все еще находится в фокусе и вы нажимаете кнопку **Сохранить**, все ожидающие правки в этом элементе управления фиксируются до фактического сохранения (метод `TableAdapterManager.UpdateAll`).  
  
> [!NOTE]
> Конструктор наборов данных только добавляет `BindingSource.EndEdit` код для первой таблицы, помещенной на форму. Таким образом, вам необходимо добавить строку кода, вызывающую метод `BindingSource.EndEdit` для каждой связанной таблицы на форме. В рамках данного пошагового руководства это означает, что вам нужно добавить вызов метода `OrdersBindingSource.EndEdit`.  
  
#### <a name="to-update-the-code-to-commit-changes-to-the-related-tables-before-saving"></a>Обновление кода для фиксации изменений в связанных таблицах перед сохранением  
  
1. Дважды нажмите кнопку **Сохранить** на <xref:System.Windows.Forms.BindingNavigator>, чтобы открыть **Form1** в редакторе кода.  
  
2. Добавьте строку кода для вызова метода `OrdersBindingSource.EndEdit` после строки, вызывающей метод `CustomersBindingSource.EndEdit`. Код в событии нажатия кнопки **Сохранить** должен выглядеть примерно следующим образом:  
  
    [!code-csharp[VSProDataOrcasHierarchicalUpdate#1](../snippets/csharp/VS_Snippets_VBCSharp/VSProDataOrcasHierarchicalUpdate/CS/Form1.cs#1)]
    [!code-vb[VSProDataOrcasHierarchicalUpdate#1](../snippets/visualbasic/VS_Snippets_VBCSharp/VSProDataOrcasHierarchicalUpdate/VB/Form1.vb#1)]  
  
   Кроме фиксации изменений в связанной дочерней таблице перед сохранением данных в базе данных, вам также может понадобиться фиксировать недавно созданные родительские записи перед добавлением новых дочерних записей в базу данных. Другими словами, вам может понадобиться добавить новую родительскую запись (клиент) в базу данных, прежде чем ограничение внешнего ключа позволит добавить в набор данных дочерние записи (заказы). Для этого можно использовать дочернее событие `BindingSource.AddingNew`.  
  
> [!NOTE]
> Нужно ли Фиксация новых родительских записей зависит от типа элемента управления, который используется для привязки к источнику данных. В этом пошаговом руководстве используйте отдельные элементы управления для привязки к родительской таблице. Для этого дополнительный код для фиксации новой родительской записи. Если бы вместо этого родительские записи отображались в сложном элементе управления, такие как <xref:System.Windows.Forms.DataGridView>, этот дополнительный <xref:System.Windows.Forms.BindingSource.EndEdit%2A> вызов родительской записи не требовался бы. Это вызвано тем, что базовая функциональность привязки к данным элемента управления обрабатывает фиксацию новых записей.  
  
#### <a name="to-add-code-to-commit-parent-records-in-the-dataset-before-adding-new-child-records"></a>Добавление кода для фиксации родительских записей в наборе данных перед добавлением новых дочерних записей  
  
1. Создайте обработчик событий для события `OrdersBindingSource.AddingNew`.  
  
    - Откройте **Form1** в режиме конструктора выберите **OrdersBindingSource** в области компонентов выберите **события** в **свойства** окно, и Дважды щелкните **AddingNew** событий.  
  
2. Добавьте строку кода в обработчик событий, который вызывает `CustomersBindingSource.EndEdit` метод. Код в обработчике событий `OrdersBindingSource_AddingNew` должен выглядеть примерно следующим образом:  
  
     [!code-csharp[VSProDataOrcasHierarchicalUpdate#2](../snippets/csharp/VS_Snippets_VBCSharp/VSProDataOrcasHierarchicalUpdate/CS/Form1.cs#2)]
     [!code-vb[VSProDataOrcasHierarchicalUpdate#2](../snippets/visualbasic/VS_Snippets_VBCSharp/VSProDataOrcasHierarchicalUpdate/VB/Form1.vb#2)]  
  
## <a name="tableadaptermanager-reference"></a>Справочник по TableAdapterManager  
 По умолчанию `TableAdapterManager` класс создается при создании набора данных, содержащего связанные таблицы. Чтобы предотвратить создание класса, измените значение `Hierarchical Update` свойства набора данных значение false. При перетаскивании таблицы, имеющей отношение в область конструктора WPF страницы или формы Windows, Visual Studio объявляет переменную-член класса. Если вы не используете привязки данных, необходимо вручную объявить переменную.  
  
 `TableAdapterManager` Класс не является частью [!INCLUDE[dnprdnshort](../includes/dnprdnshort-md.md)]. Таким образом вы не удается найти в документации. Она создается во время разработки, как часть процесса создания набора данных.  
  
 Ниже перечислены часто используемые методы и свойства `TableAdapterManager` класса:  
  
|Член|Описание|  
|------------|-----------------|  
|Метод `UpdateAll`|Сохраняет все данные из всех таблиц данных.|  
|Свойство `BackUpDataSetBeforeUpdate`|Определяет, следует ли создавать резервную копию набора данных перед выполнением `TableAdapterManager.UpdateAll` метод. Логическое значение.|  
|*tableName* `TableAdapter` свойство|Представляет `TableAdapter`. Созданный `TableAdapterManager` содержит свойство для каждого `TableAdapter` он управляет. Например, набор данных с таблицей Customers и Orders создается с `TableAdapterManager` , содержащий `CustomersTableAdapter` и `OrdersTableAdapter` свойства.|  
|Свойство `UpdateOrder`|Управляет порядком отдельные инструкции insert, update и команд delete. Задайте одно из значений в `TableAdapterManager.UpdateOrderOption` перечисления.<br /><br /> По умолчанию `UpdateOrder` присваивается **InsertUpdateDelete**. Это означает, что операции вставки, а затем обновляет, а затем удаляет выполняются для всех таблиц в наборе данных. Дополнительные сведения см. в разделе [Практическое руководство. Установка порядка выполнения иерархического обновления](https://msdn.microsoft.com/library/a0734935-78dd-4c0b-80d7-5e7925789c83).|  
  
## <a name="see-also"></a>См. также  
 [Сохранение данных обратно в базу данных](../data-tools/save-data-back-to-the-database.md)
