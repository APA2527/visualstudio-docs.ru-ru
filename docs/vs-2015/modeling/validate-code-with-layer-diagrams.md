---
title: Проверка кода с помощью схем слоев | Документация Майкрософт
ms.date: 11/15/2016
ms.prod: visual-studio-dev14
ms.technology: vs-ide-modeling
ms.topic: conceptual
helpviewer_keywords:
- layer diagrams, validating
- validation, layer diagrams
- validation, code
- code exploration, validating
- architecture, validating
- Visual Studio Ultimate, validating code
- validation, architecture
- validation, dependencies
- MSBuild, tasks
- MSBuild, layer diagrams
- MSBuild, validating code
ms.assetid: 70cbe55d-4b33-4355-b0a7-88c770a6f75c
caps.latest.revision: 84
author: jillre
ms.author: jillfra
manager: jillfra
ms.openlocfilehash: 596711c5c59738d5356437bb761e80caeddfbd6b
ms.sourcegitcommit: bad28e99214cf62cfbd1222e8cb5ded1997d7ff0
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 11/21/2019
ms.locfileid: "74301357"
---
# <a name="validate-code-with-layer-diagrams"></a>Проверка кода по схемам слоев
[!INCLUDE[vs2017banner](../includes/vs2017banner.md)]

Чтобы убедиться в том, что код не конфликтует со структурой, проверьте его с помощью схем слоев в Visual Studio. Это может помочь:

- Найти конфликты между зависимостями в коде и зависимостями на схеме слоев.

- Найти зависимости, на которые могут повлиять предложенные изменения.

   Например, можно изменить схему слоев для отображения потенциальных изменений архитектуры, а затем проверить код, чтобы увидеть зависимости, на которые повлияли эти изменения.

- Выполнить рефакторинг или миграцию кода в другую структуру.

   Найти код или зависимости, с которыми потребуется выполнить определенные действия даже после перемещения кода в другую архитектуру.

  **Requirements**

- Visual Studio

- Visual Studio на сервере Team Foundation Build для проверки кода автоматически с помощью Team Foundation Build

- Решение, включающее проект моделирования со схемой слоев. Эта схема слоев должна быть связана с артефактами в проектах Visual C# .NET или Visual Basic .NET, которые необходимо проверить. См. раздел [Создание схем слоев из кода](../modeling/create-layer-diagrams-from-your-code.md).

  Чтобы узнать, какие версии Visual Studio поддерживают эту функцию, см. раздел [Version support for architecture and modeling tools](../modeling/what-s-new-for-design-in-visual-studio.md#VersionSupport).

  Можно проверить код вручную из открытой схемы слоев в Visual Studio или из командной строки. Также код можно проверить автоматически при выполнении локальных сборок или Team Foundation Build. См. [видео Channel 9: проектирование и проверка архитектуры с помощью схем слоев](https://go.microsoft.com/fwlink/?LinkID=252073).

> [!IMPORTANT]
> Если необходимо выполнить проверку слоев в Team Foundation Build, следует также установить ту же версию Visual Studio на сервере сборки.

- [Проверьте, поддерживает ли элемент проверку](#SupportsValidation)

- [Включение других сборок и проектов .NET для проверки](#IncludeReferences)

- [Проверка кода вручную](#ValidateManually)

- [Автоматически проверять код](#ValidateAuto)

- [Устранение проблем при проверке слоев](#TroubleshootingValidation)

- [Изучение и разрешение ошибок проверки слоев](#UnderstandingValidationErrors)

## <a name="SupportsValidation"></a>Проверьте, поддерживает ли элемент проверку
 Можно связать слои с веб-сайтами, документами Office, обычными текстовыми файлами и файлами в проектах, которые являются общими для нескольких приложений, но они не войдут в процесс проверки. Ошибки проверки для ссылок на проекты или сборки, связанные с отдельными слоями, отображаются только в том случае, если между этими слоями отображаются зависимости. Эти ссылки считаются зависимостями, только если используются в коде.

1. На схеме слоев выберите один или несколько слоев, щелкните выделенный фрагмент правой кнопкой мыши и выберите команду **Просмотреть ссылки**.

2. В **обозревателе слоев**просмотрите столбец **поддерживает проверку** . Если значение равно false, элемент не поддерживает проверку.

## <a name="IncludeReferences"></a>Включение других сборок и проектов .NET для проверки
 При перетаскивании элементов на схему слоев ссылки на соответствующие сборки или проекты .NET автоматически добавляются в папку «ссылки на **слой** » в проекте моделирования. Эта папка содержит ссылки на сборки и проекты, которые анализируются во время проверки. Также можно добавить другие сборки и проекты .NET для проверки, не перетаскивая их на схему слоев вручную.

1. В **Обозреватель решений**щелкните правой кнопкой мыши проект моделирования или папку **ссылки на слой** , а затем выберите команду **Добавить ссылку**.

2. В диалоговом окне **Добавление ссылки** выберите сборки или проекты, а затем нажмите кнопку **ОК**.

## <a name="ValidateManually"></a>Проверка кода вручную
 Если имеется открытая схема слоев, связанная с элементами решения, можно выполнить команду **проверить** ярлык на схеме. Можно также использовать командную строку для выполнения команды **MSBuild** с настраиваемым свойством **/p: validatearchitectureonbuild** , установленным в **значение true**. Например, при внесении изменений в код регулярно выполняйте проверку слоев, чтобы заранее обнаруживать конфликты зависимостей.

#### <a name="to-validate-code-from-an-open-layer-diagram"></a>Проверка кода из открытой схемы слоев

1. Щелкните правой кнопкой мыши поверхность схемы и выберите пункт **Проверить архитектуру**.

    > [!NOTE]
    > По умолчанию для свойства **действие сборки** в файле схемы слоев (. LAYERDIAGRAM) задано значение **Проверка** , чтобы схема включалась в процесс проверки.

     Окно **Список ошибок** сообщает о любых произошедших ошибках. Дополнительные сведения об ошибках проверки см. в разделе [изучение и устранение ошибок проверки слоев](#UnderstandingValidationErrors).

2. Чтобы просмотреть источник каждой ошибки, дважды щелкните ошибку в окне **Список ошибок** .

    > [!NOTE]
    > [!INCLUDE[vsprvs](../includes/vsprvs-md.md)] может показывать карту кода вместо источника ошибки. Это происходит, если код имеет зависимость в сборке, не заданной схемой слоев, либо в коде отсутствует зависимость, заданная схемой слоев. Просмотрите карту кода или код, чтобы определить, должна ли существовать зависимость. Дополнительные сведения о картах кода см. в статье [сопоставление зависимостей в решениях](../modeling/map-dependencies-across-your-solutions.md).

3. Сведения об управлении ошибками см. в разделе [Управление ошибками проверки](#ManageErrors).

#### <a name="to-validate-code-at-the-command-prompt"></a>Проверка кода в командной строке

1. Откройте командную строку [!INCLUDE[vsprvs](../includes/vsprvs-md.md)].

2. Выберите один из следующих вариантов.

   - Чтобы проверить код на соответствие конкретному проекту моделирования в решении, запустите [!INCLUDE[vstecmsbuild](../includes/vstecmsbuild-md.md)] со следующим пользовательским свойством.

     ```
     msbuild <FilePath+ModelProjectFileName>.modelproj /p:ValidateArchitecture=true
     ```

     - или

       Откройте папку, в которой находится файл проекта моделирования (MODELPROJ-файл) и схема слоев, и запустите [!INCLUDE[vstecmsbuild](../includes/vstecmsbuild-md.md)] со следующим пользовательским свойством.

     ```
     msbuild /p:ValidateArchitecture=true
     ```

   - Чтобы проверить код на соответствие всем проектам моделирования в решении, запустите [!INCLUDE[vstecmsbuild](../includes/vstecmsbuild-md.md)] со следующим пользовательским свойством.

     ```
     msbuild <FilePath+SolutionName>.sln /p:ValidateArchitecture=true
     ```

     - или

       Откройте папку решения, в которой должен находиться проект моделирования со схемой слоев, и запустите [!INCLUDE[vstecmsbuild](../includes/vstecmsbuild-md.md)] со следующим пользовательским свойством.

     ```
     msbuild /p:ValidateArchitecture=true
     ```

     Отобразятся любые возникающие ошибки. Дополнительные сведения о [!INCLUDE[vstecmsbuild](../includes/vstecmsbuild-md.md)]см. в разделе задача [MSBuild](../msbuild/msbuild.md) и [MSBuild](../msbuild/msbuild-task.md).

   Дополнительные сведения об ошибках проверки см. в разделе [изучение и устранение ошибок проверки слоев](#UnderstandingValidationErrors).

### <a name="ManageErrors"></a>Управление ошибками проверки
 В процессе разработки может понадобиться подавить некоторые конфликты, выявленные в ходе проверки. Например, можно подавлять ошибки, над которыми уже ведется работа, а также ошибки, не имеющие отношения к конкретному сценарию. При подавлении ошибки рекомендуется фиксировать рабочий элемент в журнале в [!INCLUDE[esprfound](../includes/esprfound-md.md)].

> [!WARNING]
> Вы должны быть уже подключены к управлению исходным кодом (SCC) TFS для создания рабочего элемента или связи с ним. При попытке открыть соединение с другим SCC TFS Visual Studio автоматически закрывает текущее решение. Убедитесь, что вы уже подключены соответствующему SCC, перед попыткой создания рабочего элемента или связи с ним. В последних выпусках Visual Studio команды меню недоступны, если вы не подключены к SCC.

##### <a name="to-create-a-work-item-for-a-validation-error"></a>Создание рабочего элемента для ошибки проверки

- В окне **Список ошибок** щелкните ошибку правой кнопкой мыши, наведите указатель на пункт **создать рабочий элемент**, а затем выберите тип рабочего элемента, который требуется создать.

  Используйте эти задачи для управления ошибками проверки в окне **Список ошибок** :

|**Задача**|**Выполните следующие действия**|
|------------|----------------------------|
|Подавить выбранные ошибки во время проверки|Щелкните правой кнопкой мыши одну или несколько выбранных ошибок, наведите указатель на пункт **Управление ошибками проверки**, а затем выберите пункт **подавлять ошибки**.<br /><br /> Отобразятся подавленные ошибки с форматированием в виде зачеркивания. При выполнении проверки в следующий раз эти ошибки отображаться не будут.<br /><br /> Подавленные ошибки отслеживаются в SUPPRESSIONS-файле, относящемся к соответствующему файлу схемы слоев.|
|Остановить подавление выбранных ошибок|Щелкните правой кнопкой мыши выбранную подавленную ошибку или ошибки, наведите указатель на пункт **Управление ошибками проверки**и выберите команду **отменить подавление ошибок**.<br /><br /> При выполнении проверки в следующий раз выбранные подавленные ошибки будут отображаться.|
|Восстановление всех подавленных ошибок в окне **Список ошибок**|Щелкните правой кнопкой мыши в любом месте окна **Список ошибок** , наведите указатель на пункт **Управление ошибками проверки**и выберите команду **отобразить все подавленные ошибки**.|
|Скрыть все подавленные ошибки в окне **Список ошибок**|Щелкните правой кнопкой мыши в любом месте окна **Список ошибок** , наведите указатель на пункт **Управление ошибками проверки**, а затем выберите команду **Скрыть все подавленные ошибки**.|

## <a name="ValidateAuto"></a>Автоматически проверять код
 Проверку слоев можно выполнять при каждом выполнении локальной сборки. Если команда использует Team Foundation Build, можно выполнить проверку слоев с записью с проверкой изменений, которые можно задать путем создания пользовательской задачи MSBuild, и использовать отчеты по сборке для сбора ошибок проверки. Сведения о создании сборок с условным возвратом см. [в разделе Использование процесса сборки с условным возвратом для проверки изменений](https://msdn.microsoft.com/library/9cfc8b9c-1023-40fd-8ab5-1b1bd9c172ec).

#### <a name="to-validate-code-automatically-during-a-local-build"></a>Автоматическая проверка кода во время локальной сборки

- Откройте файл проекта моделирования (.modelproj) в текстовом редакторе и включите следующее свойство.

```
<ValidateArchitecture>true</ValidateArchitecture>
```

 \- или -

1. В **Обозреватель решений**щелкните правой кнопкой мыши проект моделирования, содержащий схему слоев или схемы, и выберите пункт **свойства**.

2. В окне **Свойства** задайте для свойства **Проверить архитектуру** проекта моделирования **значение true**.

    Это позволяет включить проект моделирования в процесс проверки.

3. В **Обозреватель решений**щелкните файл схемы слоев (. LAYERDIAGRAM), который нужно использовать для проверки.

4. В окне **Свойства** убедитесь, что для свойства **действие построения** схемы задано значение **Проверка**.

    Это позволяет включить схему слоев в процесс проверки.

   Сведения об управлении ошибками в окне Список ошибок см. в разделе [Управление ошибками проверки](#ManageErrors).

#### <a name="to-validate-code-automatically-during-a-team-foundation-build"></a>Автоматическая проверка кода во время выполнения Team Foundation Build

1. В **Team Explorer**дважды щелкните определение сборки, а затем нажмите кнопку **обработать**.

2. В разделе **Параметры процесса сборки**разверните узел **Компиляция**и введите в параметре **Аргументы MSBuild** следующую команду:

    `/p:ValidateArchitecture=true`

   Дополнительные сведения об ошибках проверки см. в разделе [изучение и устранение ошибок проверки слоев](#UnderstandingValidationErrors). Дополнительные сведения о [!INCLUDE[esprbuild](../includes/esprbuild-md.md)] см. в разделах:

- [Построение приложения](/azure/devops/pipelines/index)

- [Использование шаблона по умолчанию для процесса сборки](https://msdn.microsoft.com/library/43930b12-c21b-4599-a980-2995e3d16e31)

- [Изменение устаревшей сборки, основанной на Упградетемплате. XAML](https://msdn.microsoft.com/library/ee1a8259-1dd1-4a10-9563-66c5446ef41c)

- [Настройка шаблона процесса сборки](https://msdn.microsoft.com/library/b94c58f2-ae6f-4245-bedb-82cd114f6039)

- [Отслеживание хода выполнения выполняющейся сборки](https://msdn.microsoft.com/library/e51e3bad-2d1d-4b7b-bfcc-c43439c6c8ef)

## <a name="TroubleshootingValidation"></a>Устранение проблем при проверке слоев
 Следующая таблица описывает проблемы проверки слоев и способы их устранения. Эти проблемы отличаются от ошибок, возникающих из-за несоответствия между кодом и структурой. Дополнительные сведения об этих ошибках см. в разделе [изучение и устранение ошибок проверки слоев](#UnderstandingValidationErrors).

|**Проблема**|**Возможная причина**|**Решение**|
|---------------|------------------------|--------------------|
|Ошибки проверки не возникают так, как это ожидается.|Проверка не работает на схемах слоев, которые скопированы из других схем слоев в обозревателе решений и находятся в том же проекте моделирования. Скопированные таким образом схемы слоев содержат те же ссылки, что и исходная схема слоев.|Добавьте новую схему слоев в проект моделирования.<br /><br /> Скопируйте элементы из исходной схемы слоев в новую схему.|

## <a name="UnderstandingValidationErrors"></a>Основные сведения и разрешение ошибок проверки слоев
 При проверке кода с помощью схемы слоев будут происходить ошибки проверки, если код конфликтует со структурой. Например, ошибки проверки могут происходить по следующим причинам:

- Артефакт назначен неправильному слою. В этом случае следует переместить артефакт.

- Способ использования артефактом (например, классом) другого класса конфликтует с имеющейся архитектурой. В этом случае необходимо выполнить рефакторинг кода, чтобы устранить зависимость.

  Для устранения этих ошибок следует обновлять код до тех пор, пока в процессе проверки не перестанут происходить ошибки. Эту процедуру можно выполнить методом итераций.

  В следующем разделе описывается синтаксис, используемый в этих ошибках, объясняется значение этих ошибок и предлагаются пути решения или управления ими.

|**Синтаксис**|**Описание**|
|----------------|---------------------|
|*Артифактн*(*артифакттипен*)|*Артифактн* — это артефакт, связанный с слоем на схеме слоев.<br /><br /> *Артифакттипен* — это тип *Артифактн*, например **класс** или **метод**, например:<br /><br /> MySolution.MyProject.MyClass.MyMethod(Method)|
|*намеспаценамен*|Имя пространства имен.|
|*лайернамен*|Название слоя на диаграмме слоев.|
|*депенденцитипе*|Тип отношения зависимости между *Артефакт1* и *Артефакт2*. Например, метод *Артефакт1* имеет связь с *Артефакт2*.|

|**Синтаксис ошибки**|**Описание ошибки**|
|----------------------|---------------------------|
|AV0001: Недопустимая зависимость: *Артефакт1*(*ArtifactType1*) — > *Артефакт2*(*ArtifactType2*)<br /><br /> Слои: *LayerName1*, *LayerName2* &#124; зависимостей: *депенденцитипе*|Для функции *Артефакт1* в *LayerName1* не должно быть зависимости от *Артефакт2* в *LayerName2* , так как *LayerName1* не имеет прямой зависимости от *LayerName2*.|
|AV1001: Недопустимое пространство имен: *артефакт*<br /><br /> Слой: требуемое пространство имен для *Имя_слоя* &#124; : *NamespaceName1* &#124; текущее пространство имен: *NamespaceName2*|Для *Имя_слоя* необходимо, чтобы связанные с ним артефакты принадлежали *NamespaceName1*. *Артефакт* находится в *NamespaceName2*, а не *NamespaceName1*.|
|AV1002: зависит от запрещенного пространства имен: *Артефакт1*(*ArtifactType1*) &#124; *Артефакт2*(*ArtifactType2*)<br /><br /> Слой: &#124; недоступное пространство имен для недоступного уровня:, &#124; зависимости: *депенденцитипе*|Для *Имя_слоя* необходимо, чтобы связанные с ним артефакты не зависели *от самого себя.* В системе *Артефакт1* не может зависеть от *Артефакт2* , поскольку *Артефакт2* находится в некотором *ходе.*|
|AV1003: в запрещенном пространстве имен: *артефакт*(*ArtifactType*)<br /><br /> Слой: недоступное пространство имен для *Имя_слоя* &#124; .|Для *Имя_слоя* требуется, чтобы *связанные с ним*артефакты не применялись к этому. *Артефакт* принадлежит к *«самое*самое».|
|AV3001: отсутствует ссылка: слой "*Имя_слоя*" ссылается на "*артефакт*", который не удается найти. Отсутствует ссылка на сборку?|*Имя_слоя* связываются с артефактом, который не удается найти. Например, связь с классом может отсутствовать из-за отсутствия в проекте моделирования ссылки на сборку, содержащую этот класс.|
|AV9001: при проверке архитектуры обнаружены внутренние ошибки. Результат может быть неполным. Для получения дополнительных сведений см. подробный журнал событий построения или окно вывода.|Для получения дополнительных сведений см. журнал событий сборки или окно вывода.|

## <a name="security"></a>Безопасность

## <a name="see-also"></a>См. также
 [Проверка системы в ходе разработки](../modeling/validate-your-system-during-development.md)
