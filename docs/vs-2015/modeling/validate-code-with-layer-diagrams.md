---
title: Проверка кода по схемам слоев | Документация Майкрософт
ms.date: 11/15/2016
ms.prod: visual-studio-dev14
ms.technology: vs-ide-modeling
ms.topic: conceptual
helpviewer_keywords:
- layer diagrams, validating
- validation, layer diagrams
- validation, code
- code exploration, validating
- architecture, validating
- Visual Studio Ultimate, validating code
- validation, architecture
- validation, dependencies
- MSBuild, tasks
- MSBuild, layer diagrams
- MSBuild, validating code
ms.assetid: 70cbe55d-4b33-4355-b0a7-88c770a6f75c
caps.latest.revision: 84
author: gewarren
ms.author: gewarren
manager: jillfra
ms.openlocfilehash: 42d7df6e4a4bddc2d3e9bf7ab84375a65a6d2c98
ms.sourcegitcommit: 08fc78516f1107b83f46e2401888df4868bb1e40
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 05/15/2019
ms.locfileid: "65700654"
---
# <a name="validate-code-with-layer-diagrams"></a>Проверка кода по схемам слоев
[!INCLUDE[vs2017banner](../includes/vs2017banner.md)]

Чтобы убедиться в том, что код не конфликтует со структурой, проверьте его с помощью схем слоев в Visual Studio. Это может помочь:  
  
- Найти конфликты между зависимостями в коде и зависимостями на схеме слоев.  
  
- Найти зависимости, на которые могут повлиять предложенные изменения.  
  
   Например, можно изменить схему слоев для отображения потенциальных изменений архитектуры, а затем проверить код, чтобы увидеть зависимости, на которые повлияли эти изменения.  
  
- Выполнить рефакторинг или миграцию кода в другую структуру.  
  
   Найти код или зависимости, с которыми потребуется выполнить определенные действия даже после перемещения кода в другую архитектуру.  
  
  **Требования**  
  
- Visual Studio  
  
- Visual Studio на сервере Team Foundation Build для проверки кода автоматически с помощью Team Foundation Build  
  
- Решение, включающее проект моделирования со схемой слоев. Эта схема слоев должна быть связана с артефактами в проектах Visual C# .NET или Visual Basic .NET, которые необходимо проверить. См. в разделе [Создание схем слоев из кода](../modeling/create-layer-diagrams-from-your-code.md).  
  
  Чтобы узнать, какие версии Visual Studio поддерживают эту функцию, см. раздел [Поддержка версий для инструментов моделирования и архитектуры](../modeling/what-s-new-for-design-in-visual-studio.md#VersionSupport).  
  
  Можно проверить код вручную из открытой схемы слоев в Visual Studio или из командной строки. Также код можно проверить автоматически при выполнении локальных сборок или Team Foundation Build. См. в разделе [видео на Channel 9: Для проектирования и проверки архитектуры с использованием схем слоев](http://go.microsoft.com/fwlink/?LinkID=252073).  
  
> [!IMPORTANT]
> Если необходимо выполнить проверку слоев в Team Foundation Build, следует также установить ту же версию Visual Studio на сервере сборки.  
  
- [См. в разделе, если элемент поддерживает проверку](#SupportsValidation)  
  
- [Включать другие сборки .NET и проекты для проверки](#IncludeReferences)  
  
- [Проверка кода вручную](#ValidateManually)  
  
- [Автоматическая проверка кода](#ValidateAuto)  
  
- [Устранение неполадок проверки слоев](#TroubleshootingValidation)  
  
- [Понимание и устранение ошибок проверки слоев](#UnderstandingValidationErrors)  
  
## <a name="SupportsValidation"></a> См. в разделе, если элемент поддерживает проверку  
 Можно связать слои с веб-сайтами, документами Office, обычными текстовыми файлами и файлами в проектах, которые являются общими для нескольких приложений, но они не войдут в процесс проверки. Ошибки проверки для ссылок на проекты или сборки, связанные с отдельными слоями, отображаются только в том случае, если между этими слоями отображаются зависимости. Эти ссылки считаются зависимостями, только если используются в коде.  
  
1. На схеме слоев, выберите один или несколько слоев, щелкните правой кнопкой мыши выбранные элементы и нажмите кнопку **Просмотр ссылок**.  
  
2. В **обозреватель слоев**, рассмотрим **поддержка проверки** столбца. Если значение равно false, элемент не поддерживает проверку.  
  
## <a name="IncludeReferences"></a> Включать другие сборки .NET и проекты для проверки  
 При перетаскивании элементов на схему слоев ссылки на соответствующие сборки или проекты .NET автоматически добавляются в **ссылки слоя** папки в проекте моделирования. Эта папка содержит ссылки на сборки и проекты, которые анализируются во время проверки. Также можно добавить другие сборки и проекты .NET для проверки, не перетаскивая их на схему слоев вручную.  
  
1. В **обозревателе решений**, щелкните правой кнопкой мыши проект моделирования или **ссылки слоя** папку, а затем щелкните **добавить ссылку**.  
  
2. В **добавить ссылку** диалоговом окне выберите сборки или проекты и нажмите кнопку **ОК**.  
  
## <a name="ValidateManually"></a> Проверка кода вручную  
 При наличии открытой схемы слоев, связанной с элементами решения, можно запустить **Validate** команда быстрого доступа из схемы. Также можно использовать командную строку для запуска **msbuild** с **/p:ValidateArchitecture** пользовательское свойство, значение **True**. Например, при внесении изменений в код регулярно выполняйте проверку слоев, чтобы заранее обнаруживать конфликты зависимостей.  
  
#### <a name="to-validate-code-from-an-open-layer-diagram"></a>Проверка кода из открытой схемы слоев  
  
1. Щелкните правой кнопкой мыши поверхность схемы и нажмите кнопку **проверить архитектуру**.  
  
    > [!NOTE]
    > По умолчанию **действие при построении** присваивается свойству файл схемы (.layerdiagram) уровень **Validate** таким образом, чтобы схема включена в процесс проверки.  
  
     **Список ошибок** окно сообщает обо всех возникающих ошибках. Дополнительные сведения об ошибках проверки см. в разделе [понимание и устранение ошибок проверки слоев](#UnderstandingValidationErrors).  
  
2. Чтобы просмотреть источник каждой ошибки, дважды щелкните ошибку в **список ошибок** окна.  
  
    > [!NOTE]
    > [!INCLUDE[vsprvs](../includes/vsprvs-md.md)] может вместо источника ошибки показывать карту кода. Это происходит, если код имеет зависимость в сборке, не заданной схемой слоев, либо в коде отсутствует зависимость, заданная схемой слоев. Просмотрите карту кода или код, чтобы определить, должна ли существовать зависимость. Дополнительные сведения о картах кода, см. в разделе [сопоставление зависимостей в решениях](../modeling/map-dependencies-across-your-solutions.md).  
  
3. Для управления ошибками, см. в разделе [Управление ошибками проверки](#ManageErrors).  
  
#### <a name="to-validate-code-at-the-command-prompt"></a>Проверка кода в командной строке  
  
1. Откройте командную строку [!INCLUDE[vsprvs](../includes/vsprvs-md.md)].  
  
2. Выберите один из следующих вариантов.  
  
   - Чтобы проверить код на соответствие конкретному проекту моделирования в решении, запустите [!INCLUDE[vstecmsbuild](../includes/vstecmsbuild-md.md)] со следующим пользовательским свойством.  
  
     ```  
     msbuild <FilePath+ModelProjectFileName>.modelproj /p:ValidateArchitecture=true  
     ```  
  
     - или  
  
       Откройте папку, в которой находится файл проекта моделирования (MODELPROJ-файл) и схема слоев, и запустите [!INCLUDE[vstecmsbuild](../includes/vstecmsbuild-md.md)] со следующим пользовательским свойством.  
  
     ```  
     msbuild /p:ValidateArchitecture=true   
     ```  
  
   - Чтобы проверить код на соответствие всем проектам моделирования в решении, запустите [!INCLUDE[vstecmsbuild](../includes/vstecmsbuild-md.md)] со следующим пользовательским свойством.  
  
     ```  
     msbuild <FilePath+SolutionName>.sln /p:ValidateArchitecture=true   
     ```  
  
     - или  
  
       Откройте папку решения, в которой должен находиться проект моделирования со схемой слоев, и запустите [!INCLUDE[vstecmsbuild](../includes/vstecmsbuild-md.md)] со следующим пользовательским свойством.  
  
     ```  
     msbuild /p:ValidateArchitecture=true  
     ```  
  
     Отобразятся любые возникающие ошибки. Дополнительные сведения о [!INCLUDE[vstecmsbuild](../includes/vstecmsbuild-md.md)], см. в разделе [MSBuild](../msbuild/msbuild.md) и [задачи MSBuild](../msbuild/msbuild-task.md).  
  
   Дополнительные сведения об ошибках проверки см. в разделе [понимание и устранение ошибок проверки слоев](#UnderstandingValidationErrors).  
  
### <a name="ManageErrors"></a> Управление ошибками проверки  
 В процессе разработки может понадобиться подавить некоторые конфликты, выявленные в ходе проверки. Например, можно подавлять ошибки, над которыми уже ведется работа, а также ошибки, не имеющие отношения к конкретному сценарию. При подавлении ошибки рекомендуется фиксировать рабочий элемент в журнале в [!INCLUDE[esprfound](../includes/esprfound-md.md)].  
  
> [!WARNING]
> Вы должны быть уже подключены к управлению исходным кодом (SCC) TFS для создания рабочего элемента или связи с ним. При попытке открыть соединение с другим SCC TFS Visual Studio автоматически закрывает текущее решение. Убедитесь, что вы уже подключены соответствующему SCC, перед попыткой создания рабочего элемента или связи с ним. В последних выпусках Visual Studio команды меню недоступны, если вы не подключены к SCC.  
  
##### <a name="to-create-a-work-item-for-a-validation-error"></a>Создание рабочего элемента для ошибки проверки  
  
- В **список ошибок** окно, щелкните ошибку правой кнопкой мыши **Создание рабочего элемента**, а затем выберите тип рабочего элемента, который вы хотите создать.  
  
  Использование этих задач для управления ошибками проверки в **список ошибок** окна:  
  
|**Задача**|**Выполните следующие действия**|  
|------------|----------------------------|  
|Подавить выбранные ошибки во время проверки|Щелкните один или несколько выбранных ошибок правой кнопкой мыши **Управление ошибками проверки**, а затем нажмите кнопку **подавление ошибок**.<br /><br /> Отобразятся подавленные ошибки с форматированием в виде зачеркивания. При выполнении проверки в следующий раз эти ошибки отображаться не будут.<br /><br /> Подавленные ошибки отслеживаются в SUPPRESSIONS-файле, относящемся к соответствующему файлу схемы слоев.|  
|Остановить подавление выбранных ошибок|Щелкните выбранную подавленную ошибку или ошибки правой кнопкой мыши **Управление ошибками проверки**, а затем нажмите кнопку **Отменить подавление ошибок**.<br /><br /> При выполнении проверки в следующий раз выбранные подавленные ошибки будут отображаться.|  
|Восстановить все подавленные ошибки в **список ошибок** окно|Щелкните правой кнопкой мыши **список ошибок** окна **Управление ошибками проверки**, а затем нажмите кнопку **Показать все подавленные ошибки**.|  
|Скрыть все подавленные ошибки в **список ошибок** окно|Щелкните правой кнопкой мыши **список ошибок** окна **Управление ошибками проверки**, а затем нажмите кнопку **скрыть все подавленные ошибки**.|  
  
## <a name="ValidateAuto"></a> Автоматическая проверка кода  
 Проверку слоев можно выполнять при каждом выполнении локальной сборки. Если команда использует Team Foundation Build, можно выполнить проверку слоев с записью с проверкой изменений, которые можно задать путем создания пользовательской задачи MSBuild, и использовать отчеты по сборке для сбора ошибок проверки. Чтобы создать с условным возвратом, см. в разделе [использование процесса сборки с условным возвратом для проверки изменений](https://msdn.microsoft.com/library/9cfc8b9c-1023-40fd-8ab5-1b1bd9c172ec).  
  
#### <a name="to-validate-code-automatically-during-a-local-build"></a>Автоматическая проверка кода во время локальной сборки  
  
- Откройте файл проекта моделирования (.modelproj) в текстовом редакторе и включите следующее свойство.  
  
```  
<ValidateArchitecture>true</ValidateArchitecture>  
```  
  
 \- или -  
  
1. В **обозревателе решений**, щелкните правой кнопкой мыши проект моделирования, который содержит схему или схемы слоев и нажмите кнопку **свойства**.  
  
2. В **свойства** окне задайте проект моделирования **проверить архитектуру** свойства **True**.  
  
    Это позволяет включить проект моделирования в процесс проверки.  
  
3. В **обозревателе решений**, щелкните файл схемы (.layerdiagram) слой, который вы хотите использовать для проверки.  
  
4. В **свойства** окна, убедитесь, что схемы **действие при построении** свойству **Validate**.  
  
    Это позволяет включить схему слоев в процесс проверки.  
  
   Для управления ошибками в окне списка ошибок, см. в разделе [Управление ошибками проверки](#ManageErrors).  
  
#### <a name="to-validate-code-automatically-during-a-team-foundation-build"></a>Автоматическая проверка кода во время выполнения Team Foundation Build  
  
1. В **Team Explorer**, дважды щелкните определение построения и нажмите кнопку **процесс**.  
  
2. В разделе **параметры процесса сборки**, разверните **компиляции**и введите следующую команду в **Аргументы MSBuild** параметр:  
  
    `/p:ValidateArchitecture=true`  
  
   Дополнительные сведения об ошибках проверки см. в разделе [понимание и устранение ошибок проверки слоев](#UnderstandingValidationErrors). Дополнительные сведения о [!INCLUDE[esprbuild](../includes/esprbuild-md.md)] см. в разделах:  
  
- [Построение приложения](https://msdn.microsoft.com/library/a971b0f9-7c28-479d-a37b-8fd7e27ef692)  
  
- [Использование шаблона по умолчанию для рабочего процесса сборки](https://msdn.microsoft.com/library/43930b12-c21b-4599-a980-2995e3d16e31)  
  
- [Изменение прежней сборки, основанный на файле UpgradeTemplate.xaml](https://msdn.microsoft.com/library/ee1a8259-1dd1-4a10-9563-66c5446ef41c)  
  
- [Настройка шаблона процесса сборки](https://msdn.microsoft.com/library/b94c58f2-ae6f-4245-bedb-82cd114f6039)  
  
- [Отслеживание хода выполнения запуска построения](https://msdn.microsoft.com/library/e51e3bad-2d1d-4b7b-bfcc-c43439c6c8ef)  
  
## <a name="TroubleshootingValidation"></a> Устранение неполадок проверки слоев  
 Следующая таблица описывает проблемы проверки слоев и способы их устранения. Эти проблемы отличаются от ошибок, возникающих из-за несоответствия между кодом и структурой. Дополнительные сведения об этих ошибках см. в разделе [понимание и устранение ошибок проверки слоев](#UnderstandingValidationErrors).  
  
|**Проблема**|**Возможная причина**|**Решение**|  
|---------------|------------------------|--------------------|  
|Ошибки проверки не возникают так, как это ожидается.|Проверка не работает на схемах слоев, которые скопированы из других схем слоев в обозревателе решений и находятся в том же проекте моделирования. Скопированные таким образом схемы слоев содержат те же ссылки, что и исходная схема слоев.|Добавьте новую схему слоев в проект моделирования.<br /><br /> Скопируйте элементы из исходной схемы слоев в новую схему.|  
  
## <a name="UnderstandingValidationErrors"></a> Понимание и устранение ошибок проверки слоев  
 При проверке кода с помощью схемы слоев будут происходить ошибки проверки, если код конфликтует со структурой. Например, ошибки проверки могут происходить по следующим причинам:  
  
- Артефакт назначен неправильному слою. В этом случае следует переместить артефакт.  
  
- Способ использования артефактом (например, классом) другого класса конфликтует с имеющейся архитектурой. В этом случае необходимо выполнить рефакторинг кода, чтобы устранить зависимость.  
  
  Для устранения этих ошибок следует обновлять код до тех пор, пока в процессе проверки не перестанут происходить ошибки. Эту процедуру можно выполнить методом итераций.  
  
  В следующем разделе описывается синтаксис, используемый в этих ошибках, объясняется значение этих ошибок и предлагаются пути решения или управления ими.  
  
|**Синтаксис**|**Описание**|  
|----------------|---------------------|  
|*ArtifactN*(*ArtifactTypeN*)|*ArtifactN* — это артефакт, связанный со слоем на схеме слоев.<br /><br /> *ArtifactTypeN* — это тип *ArtifactN*, такие как **класс** или **метод**, например:<br /><br /> MySolution.MyProject.MyClass.MyMethod(Method)|  
|*NamespaceNameN*|Имя пространства имен.|  
|*LayerNameN*|Название слоя на диаграмме слоев.|  
|*Тип_зависимости*|Тип отношения зависимости между *Artifact1* и *Artifact2*. Например *Artifact1* имеет **вызовы** взаимосвязь *Artifact2*.|  
  
|**Синтаксическая ошибка**|**Описание ошибки**|  
|----------------------|---------------------------|  
|AV0001: Недопустимая зависимость: *Artifact1*(*ArtifactType1*) --> *Artifact2*(*ArtifactType2*)<br /><br /> Слои: *LayerName1*, *LayerName2* &#124; зависимости: *Тип_зависимости*|*Artifact1* в *LayerName1* следует не зависят от *Artifact2* в *LayerName2* поскольку *LayerName1* не имеет прямой зависимости на *LayerName2*.|  
|AV1001: Недопустимое пространство имен: *Артефакт*<br /><br /> Слой: *LayerName* &#124; обязательное пространство имен: *NamespaceName1* &#124; Current Namespace: *Имя_пространства_имен2*|*LayerName* , артефакты, связанные должны принадлежать к *NamespaceName1*. *Артефакт* в *Имя_пространства_имен2*, а не *NamespaceName1*.|  
|AV1002: Зависит от запрещенного пространства имен: *Artifact1*(*ArtifactType1*) &#124; *Artifact2*(*ArtifactType2*)<br /><br /> Слой: *LayerName* &#124; запрещенное пространство имен: *Имя пространства имен* &#124; зависимости: *Тип_зависимости*|*LayerName* требует, что артефакты, связанные не должен зависеть *NamespaceName*. *Artifact1* не может зависеть от *Artifact2* поскольку *Artifact2* в *NamespaceName*.|  
|AV1003: Запрещенное пространство имен: *Артефакт*(*ArtifactType*)<br /><br /> Слой: *LayerName* &#124; запрещенное пространство имен: *Имя пространства имен*|*LayerName* , артефакты, связанные не могут принадлежать к *NamespaceName*. *Артефакт* принадлежит *NamespaceName*.|  
|AV3001: Отсутствует ссылка: Уровень "*LayerName*«содержит ссылки на»*артефакта*" который невозможно найти. Отсутствует ссылка на сборку?|*LayerName* связан с артефактом, который не удается найти. Например, связь с классом может отсутствовать из-за отсутствия в проекте моделирования ссылки на сборку, содержащую этот класс.|  
|AV9001: Архитектуры обнаружены внутренние ошибки. Результат может быть неполным. Для получения дополнительных сведений см. подробный журнал событий построения или окно вывода.|Для получения дополнительных сведений см. журнал событий сборки или окно вывода.|  
  
## <a name="security"></a>Безопасность  
  
## <a name="see-also"></a>См. также  
 [Проверка системы в ходе разработки](../modeling/validate-your-system-during-development.md)
