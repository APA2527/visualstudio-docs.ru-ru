---
title: Создание кода во время разработки с помощью текстовых шаблонов T4 | Документация Майкрософт
ms.date: 11/15/2016
ms.prod: visual-studio-dev14
ms.technology: vs-ide-modeling
ms.topic: conceptual
helpviewer_keywords:
- text templates, guidelines for code generation
- text templates, data source model
- TextTemplatingFileGenerator custom tool
- Transform All Templates
- text templates, getting started
- Text Template project item
- text templates, generating code for your application
ms.assetid: 2774b83d-1adb-4c66-a607-746e019b80c0
caps.latest.revision: 40
author: jillre
ms.author: jillfra
manager: jillfra
ms.openlocfilehash: efdbf1b96e1dc49f5b9c48cebe6cededc9ea7c6e
ms.sourcegitcommit: 6cfffa72af599a9d667249caaaa411bb28ea69fd
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 09/02/2020
ms.locfileid: "85534151"
---
# <a name="design-time-code-generation-by-using-t4-text-templates"></a>Создание кода во время разработки с помощью текстовых шаблонов T4
[!INCLUDE[vs2017banner](../includes/vs2017banner.md)]

Текстовые шаблоны времени разработки T4 позволяют создавать программный код и другие файлы в проекте [!INCLUDE[vsprvs](../includes/vsprvs-md.md)]. Как правило, шаблоны создаются таким образом, что они изменяют код, создаваемый в соответствии с данными из *модели*. Модель — это файл или база данных, которая содержит основные сведения о требованиях приложения.

 Например, можно создать модель, которая определяет рабочий процесс как таблицу или схему. На основе модели можно создать программу, выполняющую рабочий процесс. При изменении потребностей пользователей вы сможете обсудить с ними характеристики нового рабочего процесса. Повторное создание кода на основе рабочего процесса надежнее, чем обновление кода вручную.

> [!NOTE]
> *Модель* — это источник данных, описывающий определенный аспект приложения. Она может быть представлена в любой форме, в виде файла или базы данных. Она не должна соответствовать определенной форме, например как модель UML или модель для доменного языка (DSL). Типичные модели создаются в форме таблиц или XML-файлов.

 Вероятно, вы уже знакомы с созданием кода. При определении ресурсов в **RESX** -файле [!INCLUDE[vsprvs](../includes/vsprvs-md.md)] решения набор классов и методов создается автоматически. Файл ресурсов обеспечивает более простое и надежное редактирование ресурсов по сравнению с внесением изменений в классы и методы. Используя текстовые шаблоны, можно создавать код таким же образом на основе вашего собственного источника.

 Текстовый шаблон содержит сочетание текста, который требуется создать, и программного кода, создающего переменные части текста. Программный код позволяет повторять или, при определенных условиях, пропускать части созданного текста. Созданный текст сам по себе может быть программным кодом, который формирует часть вашего приложения.

## <a name="creating-a-design-time-t4-text-template"></a>Создание текстового шаблона времени разработки T4

#### <a name="to-create-a-design-time-t4-template-in-visual-studio"></a>Создание шаблона времени разработки T4 в Visual Studio

1. Создайте [!INCLUDE[vsprvs](../includes/vsprvs-md.md)] проект или откройте существующий.

     Например, в меню **файл** выберите **создать**, **проект**.

2. Добавьте в проект файл текстового шаблона и присвойте ему имя с расширением **TT**.

     Для этого в **Обозреватель решений**в контекстном меню проекта выберите **Добавить**, **новый элемент**. В диалоговом окне **Добавление нового элемента** выберите **текстовый шаблон** в средней области.

     Обратите внимание, что свойство **Custom Tool** файла — **тексттемплатингфилеженератор**.

3. Откройте файл. Он будет содержать следующие директивы:

    ```
    <#@ template hostspecific="false" language="C#" #>
    <#@ output extension=".txt" #>
    ```

     Если вы добавили шаблон в проект [!INCLUDE[vbprvb](../includes/vbprvb-md.md)], для атрибута языка будет задано значение `VB`.

4. Добавьте любой текст в конец файла. Пример:

    ```
    Hello, world!
    ```

5. Сохраните файл.

     Может появиться окно сообщения **системы безопасности** с предложением подтвердить, что вы хотите запустить шаблон. Нажмите кнопку **ОК**.

6. В **Обозреватель решений**разверните узел файла шаблона, и вы увидите файл с расширением **txt**. Файл содержит текст, созданный на основе шаблона.

    > [!NOTE]
    > Если проект является Visual Basic проектом, необходимо щелкнуть **Показать все файлы** , чтобы увидеть выходной файл.

### <a name="regenerating-the-code"></a>Повторное создание кода
 Шаблон выполняется, создавая дочерний файл, в следующих случаях:

- при редактировании шаблона и перемещении фокуса в другое окно [!INCLUDE[vsprvs](../includes/vsprvs-md.md)];

- при сохранении шаблона;

- Выберите **преобразовать все шаблоны** в меню **Сборка** . (это приведет к преобразованию всех шаблонов в решении [!INCLUDE[vsprvs](../includes/vsprvs-md.md)]);

- В **Обозреватель решений**в контекстном меню любого файла выберите пункт **запустить настраиваемый инструмент**. Используйте этот метод для преобразования выбранного набора шаблонов.

  Вы также можете настроить проект [!INCLUDE[vsprvs](../includes/vsprvs-md.md)] так, чтобы шаблоны выполнялись при изменении считываемых ими файлов данных. Дополнительные сведения см. [в разделе Автоматическое повторное создание кода](#Regenerating).

## <a name="generating-variable-text"></a>Создание переменного текста
 Текстовые шаблоны позволяют программному коду изменять содержимое созданного файла.

#### <a name="to-generate-text-by-using-program-code"></a>Создание текста с помощью программного кода

1. Измените содержимое файла `.tt`:

   ```csharp
   <#@ template hostspecific="false" language="C#" #>
   <#@ output extension=".txt" #>
   <#int top = 10;

   for (int i = 0; i<=top; i++)
   { #>
      The square of <#= i #> is <#= i*i #>
   <# } #>
   ```

   ```vb
   <#@ template hostspecific="false" language="VB" #>
   <#@ output extension=".txt" #>
   <#Dim top As Integer = 10

   For i As Integer = 0 To top
   #>
       The square of <#= i #> is <#= i*i #>
   <#
   Next
   #>

   ```

2. Сохраните TT-файл и снова проверьте созданный TXT-файл. В нем перечисляются квадратные корни чисел от 0 до 10.

   Обратите внимание, что операторы заключены в символы `<#...#>`, а отдельные выражения — в символы `<#=...#>`. Дополнительные сведения см. [в разделе Написание текстового шаблона T4](../modeling/writing-a-t4-text-template.md).

   Если вы записываете созданный код в [!INCLUDE[vbprvb](../includes/vbprvb-md.md)], директива `template` должна содержать атрибут `language="VB"`. Значение по умолчанию — `"C#"`.

## <a name="debugging-a-design-time-t4-text-template"></a>Отладка текстового шаблона времени разработки T4
 Отладка текстового шаблона

- Вставьте строку `debug="true"` в директиву `template`. Пример:

   `<#@ template debug="true" hostspecific="false" language="C#" #>`

- Задайте точки останова в шаблоне таким же образом, как для обычного кода.

- Выберите пункт **Отладка шаблона T4** в контекстном меню файла текстового шаблона в Обозреватель решений.

  Шаблон запустится и будет останавливаться в точках останова. Вы можете проверить переменные и выполнить код пошагово в обычном режиме.

> [!TIP]
> `debug="true"` создает более точное соответствие созданного кода шаблону текста, добавляя в созданный код дополнительные директивы нумерации строк. Если опустить эту строку, точки останова могут останавливать выполнение в неверном состоянии.
>
> Однако это выражение можно оставить в директиве шаблона, даже если вы не выполняете отладку. Это приведет к незначительному снижению производительности.

## <a name="generating-code-or-resources-for-your-solution"></a>Создание кода или ресурсов для решения
 Можно создать различающиеся файлы программ в зависимости от модели. Модель представляет собой источник входных данных, такой как база данных, файл конфигурации, модель UML, модель DSL или другой источник. Как правило, на основе одной модели создается несколько файлов программ. Для этого вы создаете файл шаблона для каждого создаваемого файла программы; для всех шаблонов задается чтение одной модели.

#### <a name="to-generate-program-code-or-resources"></a>Создание программного кода или ресурсов

1. Измените директиву output, чтобы создать файл нужного типа, например .CS, .VB, .RESX или .XML.

2. Вставьте код, который создаст нужный вам код решения. Например, если требуется создать три объявления поля Integer в классе, используйте код:

    ```csharp

              <#@ template debug="false" hostspecific="false" language="C#" #>
    <#@ output extension=".cs" #>
    <# var properties = new string [] {"P1", "P2", "P3"}; #>
    // This is generated code:
    class MyGeneratedClass {
    <# // This code runs in the text template:
      foreach (string propertyName in properties)  { #>
      // Generated code:
      private int <#= propertyName #> = 0;
    <# } #>
    }
    ```

    ```vb
    <#@ template debug="false" hostspecific="false" language="VB" #>
    <#@ output extension=".cs" #>
    <# Dim properties = {"P1", "P2", "P3"} #>
    class MyGeneratedClass {
    <#
       For Each propertyName As String In properties
    #>
      private int <#= propertyName #> = 0;
    <#
       Next
    #>
    }

    ```

3. Сохраните файл и проверьте созданный файл, который теперь содержит следующий код:

    ```
    class MyGeneratedClass {
      private int P1 = 0;
      private int P2 = 0;
      private int P3 = 0;
    }
    ```

### <a name="generating-code-and-generated-text"></a>Создающий код и созданный текст
 При создании программного кода самое важное — не путать создающий код, который выполняется в шаблоне, и создаваемый код, который становится частью вашего решения. Языки этих двух частей не обязательно должны совпадать.

 Предыдущий пример имеет две версии. В одной версии создающий код написан на языке C#. В другой версии создающий код написан на языке Visual Basic. Однако создаваемый ими текст одинаков и является классом C#.

 Точно так же можно использовать шаблон [!INCLUDE[csprcs](../includes/csprcs-md.md)] для создания кода на любом языке. Созданный текст не обязательно должен быть на определенном языке и вообще может не быть программным кодом.

### <a name="structuring-text-templates"></a>Структура текстовых шаблонов
 Как правило, рекомендуется разделять код шаблонов на две части.

- Конфигурация или часть, отвечающая за сбор данных, которая задает значения переменных, но не содержит текстовые блоки. В предыдущем примере эта часть представлена кодом, инициализирующим `properties`.

   Ее иногда называют частью "модели", так как она создает хранимую модель и обычно считывает файл модели.

- Часть, создающая текст, (`foreach(...){...}` в примере), которая использует значения переменных.

  Это разделение необязательно, однако оно упрощает чтение шаблона, делая менее сложной часть, которая включает текст.

## <a name="reading-files-or-other-sources"></a>Чтение файлов или других источников
 Чтобы получить доступ к файлу модели или базе данных, код шаблона может использовать сборки, такие как System.XML. Чтобы получить доступ к этим сборкам, необходимо вставить директивы, такие как следующие:

```
<#@ assembly name="System.Xml.dll" #>
<#@ import namespace="System.Xml" #>
<#@ import namespace="System.IO" #>
```

 Директива `assembly` предоставляет коду шаблона доступ к указанной сборке тем же способом, который используется в разделе "Ссылки" проекта [!INCLUDE[vsprvs](../includes/vsprvs-md.md)]. Ссылку не требуется включать в System.dll, так как она создается автоматически. Директива `import` позволяет использовать типы, не используя полные имена, тем же способом, что и директива `using` в обычном файле программы.

 Например, после импорта **System.IO**можно написать:

```csharp

      <# var properties = File.ReadLines("C:\\propertyList.txt");#>
...
<# foreach (string propertyName in properties) { #>
...
```

```vb
<# For Each propertyName As String In
             File.ReadLines("C:\\propertyList.txt")
#>

```

### <a name="opening-a-file-with-a-relative-pathname"></a>Открытие файла с относительным путем
 Чтобы загрузить файл из расположения, относительного для текстового шаблона, можно использовать `this.Host.ResolvePath()`. Для использования this.Host необходимо задать выражение `hostspecific="true"` в `template`:

```
<#@ template debug="false" hostspecific="true" language="C#" #>

```

 Затем можно написать код, например:

```csharp
<# string fileName = this.Host.ResolvePath("filename.txt");
  string [] properties = File.ReadLines(filename);
#>
...
<#  foreach (string propertyName in properties { #>
...

```

```vb
<# Dim fileName = Me.Host.ResolvePath("propertyList.txt")
   Dim properties = File.ReadLines(filename)
#>
...
<#   For Each propertyName As String In properties
...
#>

```

 Кроме того, можно использовать `this.Host.TemplateFile`, определяющий имя текущего файла шаблона.

 Тип `this.Host` (в VB, `Me.Host`) — `Microsoft.VisualStudio.TextTemplating.ITextTemplatingEngineHost`.

### <a name="getting-data-from-vsprvs"></a>Получение данных из [!INCLUDE[vsprvs](../includes/vsprvs-md.md)]
 Для использования служб, предоставляемых в [!INCLUDE[vsprvs](../includes/vsprvs-md.md)], задайте атрибут `hostSpecific` и загрузите сборку `EnvDTE`. Затем можно использовать метод IServiceProvider.GetCOMService() для получения доступа к DTE и другим службам. Пример:

```scr
<#@ template hostspecific="true" language="C#" #>
<#@ output extension=".txt" #>
<#@ assembly name="EnvDTE" #>
<#
  IServiceProvider serviceProvider = (IServiceProvider)this.Host;
  EnvDTE.DTE dte = (EnvDTE.DTE) serviceProvider.GetCOMService(typeof(EnvDTE.DTE));
#>

Number of projects in this VS solution:  <#= dte.Solution.Projects.Count #>

```

> [!TIP]
> Текстовый шаблон выполняется в собственном домене приложений; доступ к службам предоставляется путем маршалинга. В этих обстоятельствах метод GetCOMService() надежнее, чем GetService().

## <a name="regenerating-the-code-automatically"></a><a name="Regenerating"></a> Автоматическое повторное создание кода
 Как правило, несколько файлов в решении [!INCLUDE[vsprvs](../includes/vsprvs-md.md)] создаются с помощью одной модели ввода. Каждый файл создается на основе своего собственного шаблона, но все шаблоны относятся к одной модели.

 Если изменяется исходная модель, необходимо перезапустить все шаблоны в решении. Чтобы сделать это вручную, выберите **преобразовать все шаблоны** в меню **Сборка** .

 Если установлен пакет SDK визуализации и моделирования [!INCLUDE[vsprvs](../includes/vsprvs-md.md)], все шаблоны можно преобразовывать автоматически при выполнении сборки. Для этого внесите изменения в файл проекта (CSPROJ или VBPROJ) в текстовом редакторе и добавьте следующие строки ближе к концу файла после любых других операторов `<import>`:

```
<Import Project="$(MSBuildExtensionsPath)\Microsoft\VisualStudio\v11.0\TextTemplating\Microsoft.TextTemplating.targets" />
<PropertyGroup>
   <TransformOnBuild>true</TransformOnBuild>
   <!-- Other properties can be inserted here -->
</PropertyGroup>
```

 Дополнительные сведения см. [в разделе Создание кода в процессе сборки](../modeling/code-generation-in-a-build-process.md).

## <a name="error-reporting"></a>Отчеты об ошибках
 Чтобы поместить сообщения об ошибках и предупреждения в окно ошибок [!INCLUDE[vsprvs](../includes/vsprvs-md.md)], можно использовать следующие методы:

```
Error("An error message");
Warning("A warning message");
```

## <a name="converting-an-existing-file-to-a-template"></a><a name="Converting"></a> Преобразование существующего файла в шаблон
 Полезной возможностью шаблонов является то, что они очень похожи на создаваемые им файлы и включают некоторую часть программного кода. Это предполагает удобный способ создания шаблона. Сначала создайте обычный файл в качестве прототипа, например [!INCLUDE[csprcs](../includes/csprcs-md.md)] файл, а затем постепенно попытайтесь ввести код поколения, который изменяет результирующий файл.

#### <a name="to-convert-an-existing-file-to-a-design-time-template"></a>Преобразование существующего файла в шаблон времени разработки

1. Добавьте в проект [!INCLUDE[vsprvs](../includes/vsprvs-md.md)] файл того типа, который требуется создать, например `.cs``.vb` или `.resx`.

2. Проверьте созданный файл, чтобы убедиться, что он работает.

3. В обозреватель решений измените расширение имени файла на **TT**.

4. Проверьте следующие свойства файла **. TT** :

    |Свойство|Значение|
    |-|-|
    |**Пользовательский инструмент =**|**TextTemplatingFileGenerator**|
    |**Действие построения =**|**None**|

5. Вставьте следующие строки в начало файла:

    ```
    <#@ template debug="false" hostspecific="false" language="C#" #>
    <#@ output extension=".cs" #>
    ```

     Чтобы написать создающий код шаблона в [!INCLUDE[vbprvb](../includes/vbprvb-md.md)], задайте для атрибута `language` значение `"VB"` вместо `"C#"`.

     Задайте для атрибута `extension` значение расширения файла того типа, который требуется создать, например `.cs``.resx` или `.xml`.

6. Сохраните файл.

     Создается дочерний файл с заданным расширением. Его свойства будут правильными для данного типа файла. Например, свойство **действия сборки** для CS-файла будет **компилироваться**.

     Убедитесь, что созданный файл содержит то же содержимое, что и исходный.

7. Определите часть файла, которую требуется изменять. Например часть, которая отображается только при соблюдении определенных условий, или повторяемая часть, или часть, в которой варьируются определенные значения. Вставьте создающий код. Сохраните файл и убедитесь, что дочерний файл создается правильно. Повторите этот шаг.

## <a name="guidelines-for-code-generation"></a>Рекомендации по созданию кода
 Ознакомьтесь с [рекомендациями по написанию текстовых шаблонов T4](../modeling/guidelines-for-writing-t4-text-templates.md).

## <a name="next-steps"></a>Дальнейшие действия

|Дальнейшие действия|Раздел|
|---------------|-----------|
|Написание и отладка расширенного текстового шаблона с помощью кода, который использует вспомогательные функции, включенные файлы и внешние данные.|[Написание текстового шаблона T4](../modeling/writing-a-t4-text-template.md)|
|Создание документов на основе шаблонов во время выполнения.|[Создание текста во время выполнения с помощью текстовых шаблонов T4](../modeling/run-time-text-generation-with-t4-text-templates.md)|
|Запуск создания текста за пределами [!INCLUDE[vsprvs](../includes/vsprvs-md.md)].|[Создание файлов с помощью служебной программы TextTransform](../modeling/generating-files-with-the-texttransform-utility.md)|
|Преобразование данных в форме доменного языка.|[Создание кода из доменного языка](../modeling/generating-code-from-a-domain-specific-language.md)|
|Написание процессоров директив для преобразования собственных источников данных.|[Настройка преобразования текста T4](../modeling/customizing-t4-text-transformation.md)|

## <a name="see-also"></a>См. также:
 [Рекомендации по написанию текстовых шаблонов T4](../modeling/guidelines-for-writing-t4-text-templates.md)
