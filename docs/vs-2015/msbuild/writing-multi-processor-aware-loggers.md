---
title: Написание средств ведения журнала с поддержкой многопроцессорности | Документы Майкрософт
ms.date: 11/15/2016
ms.prod: visual-studio-dev14
ms.technology: msbuild
ms.topic: conceptual
helpviewer_keywords:
- msbuild, multi-proc aware loggers
- multi-proc loggers
- loggers, multi-proc
ms.assetid: ff987d1b-1798-4803-9ef6-cc8fcc263516
caps.latest.revision: 15
author: mikejo5000
ms.author: mikejo
manager: jillfra
ms.openlocfilehash: 0d2eaf41ac66cd1bdf680145bef43b17cc29a505
ms.sourcegitcommit: 47eeeeadd84c879636e9d48747b615de69384356
ms.translationtype: MTE95
ms.contentlocale: ru-RU
ms.lasthandoff: 04/23/2019
ms.locfileid: "63425883"
---
# <a name="writing-multi-processor-aware-loggers"></a>Написание средств ведения журнала с поддержкой многопроцессорности
[!INCLUDE[vs2017banner](../includes/vs2017banner.md)]

Поддержка нескольких процессоров в [!INCLUDE[vstecmsbuild](../includes/vstecmsbuild-md.md)] позволяет сократить время сборки проекта, но усложняет ведение журнала событий сборки. В среде с одним процессором события, сообщения, предупреждения и ошибки поступают в средство ведения журнала последовательно и вполне предсказуемо. Однако в многопроцессорной среде события из различных источников могут поступать одновременно или не по порядку. Для обеспечения такого сценария платформа [!INCLUDE[vstecmsbuild](../includes/vstecmsbuild-md.md)] предоставляет средство ведения журнала с поддержкой многопроцессорности и новую модель ведения журнала, а также позволяет создавать пользовательские средства ведения журнала с перенаправлением.  
  
## <a name="multi-processor-logging-challenges"></a>Проблемы ведения журналов в многопроцессорной среде  
 Если выполняется сборка одного или нескольких проектов в многопроцессорной или многоядерной системе, в [!INCLUDE[vstecmsbuild](../includes/vstecmsbuild-md.md)] одновременно создаются события сборки для всех проектов. Множество сообщений о событиях может поступать в средство ведения журнала одновременно или не по порядку. Так как средство ведения журнала [!INCLUDE[vstecmsbuild](../includes/vstecmsbuild-md.md)] 2.0 не предназначено для такой ситуации, может произойти его переполнение, что повлечет за собой увеличение времени сборки, появление неверных выходных данных или даже повреждение сборки. Для устранения этих проблем средство ведение журнала (начиная с версии [!INCLUDE[vstecmsbuild](../includes/vstecmsbuild-md.md)] 3.5) может обрабатывать события, поступающие не по порядку, и сопоставлять события с их источниками.  
  
 Чтобы повысить эффективность функции ведения журнала, создайте пользовательское средство ведения журнала с перенаправлением. Оно действует как фильтр, позволяя выбрать перед сборкой только те события, за которыми нужно вести наблюдение. Благодаря пользовательскому средству ведения журнала с перенаправлением можно предотвратить переполнение средства ведения журнала ненужными событиями, загромождение журналов или замедление сборки.  
  
## <a name="multi-processor-logging-models"></a>Модели ведения журналов в многопроцессорной среде  
 Для решения проблем, возникающих при сборке в многопроцессорной среде, [!INCLUDE[vstecmsbuild](../includes/vstecmsbuild-md.md)] поддерживает две модели ведения журналов: централизованную и распределенную.  
  
### <a name="central-logging-model"></a>Централизованная модель ведения журналов  
 В централизованной модели ведения журналов основной экземпляр MSBuild.exe действует как "центральный узел", а дочерние экземпляры центрального узла ("дополнительные узлы") подключаются к нему, чтобы оказать помощь в выполнении задач сборки.  
  
 ![Централизованная модель средства ведения журнала](../msbuild/media/centralnode.png "CentralNode")  
  
 Средства ведения журнала различных типов, подключаемые к центральному узлу, называются "центральными средствами ведения журнала". Только один экземпляр средства ведения журнала каждого типа можно одновременно подключить к центральному узлу.  
  
 В процессе сборки дополнительные узлы перенаправляют события сборки в центральный узел. Центральный узел перенаправляет все свои события, а также события дополнительных узлов в одно или несколько подключенных центральных средств ведения журнала. В средствах ведения журнала создаются файлы журнала на основе входящих данных.  
  
 Несмотря на то, что центральным средством ведения журнала должен реализовываться только интерфейс <xref:Microsoft.Build.Framework.ILogger>, рекомендуется также реализовать интерфейс <xref:Microsoft.Build.Framework.INodeLogger> для инициализации центрального средства ведения журнала с учетом числа узлов, участвующих в сборке. При инициализации средства ведения журнала в системе вызывается следующая перегрузка метода <xref:Microsoft.Build.Framework.ILogger.Initialize%2A>:  
  
```  
public interface INodeLogger: ILogger  
{  
    public void Initialize(IEventSource eventSource, int nodeCount);  
}  
```  
  
 Все ранее существовавшие средства ведения журнала на основе <xref:Microsoft.Build.Framework.ILogger> могут работать в качестве центральных средств ведения журнала и подключаться к сборке. Однако центральные средства ведения журнала, созданные без явной поддержки сценариев ведения журнала в многопроцессорной среде и непоследовательных событий, могут привести к нарушению сборки или появлению бессмысленных выходных данных.  
  
### <a name="distributed-logging-model"></a>Распределенная модель ведения журнала  
 В централизованной модели ведения журналов слишком большой трафик входящих сообщений может вызывать переполнение центрального узла, например, когда одновременно выполняется сборка множества проектов. При этом может увеличиться нагрузка на системные ресурсы и снизиться производительность сборки. Чтобы облегчить эту проблему, [!INCLUDE[vstecmsbuild](../includes/vstecmsbuild-md.md)] поддерживает распределенную модель ведения журналов.  
  
 ![Распределенная модель ведения журналов](../msbuild/media/distnode.png "DistNode")  
  
 Распределенная модель ведения журналов расширяет централизованную модель, позволяя создавать средства ведения журнала с перенаправлением.  
  
#### <a name="forwarding-loggers"></a>Средства ведения журнала с перенаправлением  
 Средство ведения журнала с перенаправлением — это дополнительный, упрощенный вариант средства ведения журнала, содержащий фильтр событий, который подключается к дополнительному узлу и принимает входящие события сборки от него. Это средство фильтрует входящие события и перенаправляет в центральный узел только те из них, которые вы указали. В результате уменьшается трафик сообщений, отправляемых в центральный узел, и повышается общая производительность сборки.  
  
 Существует два способа использования модели распределенного ведения журналов, а именно:  
  
- настройка готового средства ведения журнала с перенаправлением с именем <xref:Microsoft.Build.BuildEngine.ConfigurableForwardingLogger>;  
  
- создание собственного средства ведения журнала с перенаправлением.  
  
  Вы можете изменить средство ConfigurableForwardingLogger в соответствии со своими предпочтениями. Для этого вызовите средство ведения журнала в командной строке с помощью MSBuild.exe и перечислите события сборки, которые средству ведения журнала следует перенаправлять в центральный узел.  
  
  Можно также создать пользовательское средство ведения журнала с перенаправлением. Таким образом можно выполнить точную настройку функций средства ведения журнала. Однако этот способ гораздо сложнее, чем простая настройка готового средства ConfigurableForwardingLogger. Дополнительные сведения см. в разделе [Создание средства ведения журнала переадресации](../msbuild/creating-forwarding-loggers.md).  
  
## <a name="using-the-configurableforwardinglogger-for-simple-distributed-logging"></a>Использование средства ConfigurableForwardingLogger для простого распределенного ведения журналов  
 Чтобы подключить либо средство ConfigurableForwardingLogger, либо пользовательское средство ведения журнала с перенаправлением, используйте параметр `/distributedlogger` (сокращенно `/dl`) в командной строке MSBuild.exe в процессе сборки. Для указания имен типов и классов средства ведения журнала используется тот же формат, что и для параметра `/logger`, с той лишь разницей, что распределенное средство ведения журнала всегда включает два класса: средство ведения журнала с перенаправлением и центральное средство ведения журнала. В приведенном ниже примере показано, как подключить пользовательское средство ведения журнала с перенаправлением с именем XMLForwardingLogger.  
  
```  
msbuild.exe myproj.proj/distributedlogger:XMLCentralLogger,MyLogger,Version=1.0.2,Culture=neutral*XMLForwardingLogger,MyLogger,Version=1.0.2,Culture=neutral  
```  
  
> [!NOTE]
> В параметре `/dl` имена двух средств ведения журнала необходимо отделить звездочкой (*).  
  
 ConfigurableForwardingLogger используется точно так же, как и любое другое средство ведения журнала (см. описание в разделе [Получение журналов сборки](../msbuild/obtaining-build-logs-with-msbuild.md)), с той лишь разницей, что вместо обычного средства ведения журнала [!INCLUDE[vstecmsbuild](../includes/vstecmsbuild-md.md)] подключается средство ведения журнала ConfigurableForwardingLogger и в качестве параметров указываются события, которые ConfigurableForwardingLogger будет передавать в центральный узел.  
  
 Например, чтобы получать уведомления только о начале и окончании сборки, а также сообщения об ошибках, следует передать в качестве параметров события `BUILDSTARTEDEVENT`, `BUILDFINISHEDEVENT` и `ERROREVENT`. Можно передавать несколько параметров, отделяя их друг от друга точкой с запятой. В приведенном ниже примере показано, как использовать ConfigurableForwardingLogger для перенаправления только событий `BUILDSTARTEDEVENT`, `BUILDFINISHEDEVENT` и `ERROREVENT`.  
  
```  
msbuild.exe myproj.proj /distributedlogger:XMLCentralLogger,MyLogger,Version=1.0.2,Culture=neutral*ConfigureableForwardingLogger,C:\My.dll;BUILDSTARTEDEVENT; BUILDFINISHEDEVENT;ERROREVENT  
```  
  
 Ниже представлен список доступных параметров ConfigurableForwardingLogger.  
  
|Параметры ConfigurableForwardingLogger|  
|---------------------------------------------|  
|BUILDSTARTEDEVENT|  
|BUILDFINISHEDEVENT|  
|PROJECTSTARTEDEVENT|  
|PROJECTFINISHEDEVENT|  
|TARGETSTARTEDEVENT|  
|TARGETFINISHEDEVENT|  
|TASKSTARTEDEVENT|  
|TASKFINISHEDEVENT|  
|ERROREVENT|  
|WARNINGEVENT|  
|HIGHMESSAGEEVENT|  
|NORMALMESSAGEEVENT|  
|LOWMESSAGEEVENT|  
|CUSTOMEVENT|  
|COMMANDLINE|  
|PERFORMANCESUMMARY|  
|NOSUMMARY|  
|SHOWCOMMANDLINE|  
  
## <a name="see-also"></a>См. также раздел  
 [Создание средства ведения журнала переадресации](../msbuild/creating-forwarding-loggers.md)
