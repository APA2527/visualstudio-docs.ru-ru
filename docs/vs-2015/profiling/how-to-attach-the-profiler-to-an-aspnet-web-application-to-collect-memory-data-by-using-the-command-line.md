---
title: Практическое руководство. Подключение профилировщика к веб-приложению ASP.NET для сбора данных по использованию памяти с помощью командной строки | Документы Майкрософт
ms.date: 11/15/2016
ms.prod: visual-studio-dev14
ms.technology: vs-ide-debug
ms.topic: conceptual
ms.assetid: d608f85a-41ae-4ca7-85e6-b96624dbc83c
caps.latest.revision: 36
author: MikeJo5000
ms.author: mikejo
manager: jillfra
ms.openlocfilehash: 454bcc4fe8e17530d71927d373a05f5f12beae61
ms.sourcegitcommit: 6cfffa72af599a9d667249caaaa411bb28ea69fd
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 09/02/2020
ms.locfileid: "90843044"
---
# <a name="how-to-attach-the-profiler-to-an-aspnet-web-application-to-collect-memory-data-by-using-the-command-line"></a>Практическое руководство. Присоединение профилировщика к веб-приложению ASP.NET для сбора данных об использовании памяти с помощью командной строки
[!INCLUDE[vs2017banner](../includes/vs2017banner.md)]

В этом разделе описан порядок использования программ командной строки для Средств профилирования [!INCLUDE[vsprvs](../includes/vsprvs-md.md)] с целью подключения профилировщика к веб-приложению [!INCLUDE[vstecasp](../includes/vstecasp-md.md)] и сбора данных по количеству выделений памяти .NET Framework и выделяемых объемах. Кроме того, с помощью этих программ можно собирать данные по времени существования объектов памяти .NET Framework.  

> [!NOTE]
> Программы командной строки средств профилирования расположены в подкаталоге \Team Tools\Performance Tools каталога установки [!INCLUDE[vs_current_short](../includes/vs-current-short-md.md)]. На 64-разрядных компьютерах доступны 64- и 32-разрядные версии этих программ. Для использования программ командной строки профилировщика необходимо добавить путь к программам в переменную среды PATH окна командной строки или в саму команду. Дополнительные сведения см. в статье [Указание пути к средствам командной строки](../profiling/specifying-the-path-to-profiling-tools-command-line-tools.md).  

 Для сбора данных по производительности из веб-приложения [!INCLUDE[vstecasp](../includes/vstecasp-md.md)] необходимо использовать средство [VSPerfCLREnv.cmd](../profiling/vsperfclrenv.md) для инициализации соответствующих переменных среды на компьютере, на котором размещается веб-приложение [!INCLUDE[vstecasp](../includes/vstecasp-md.md)]. Затем необходимо перезагрузить компьютер, чтобы настроить профилирование для веб-сервера.  

 После этого необходимо воспользоваться программой [VSPerfCmd.exe](../profiling/vsperfcmd.md), чтобы подключить профилировщик к рабочему процессу [!INCLUDE[vstecasp](../includes/vstecasp-md.md)], в котором размещается веб-сайт. Пока профилировщик подключен к приложению, сбор данных можно приостанавливать и возобновлять.  

 Чтобы завершить сеанс профилирования, профилировщик следует отключить от приложения и явным образом завершить его работу. В большинстве случаев рекомендуется сбрасывать переменные среды профилирования в конце сеанса.  

## <a name="attaching-the-profiler"></a>Подключение профилировщика  

#### <a name="to-attach-the-profiler-to-an-aspnet-web-application"></a>Подключение профилировщика к веб-приложению ASP.NET  

1. Откройте окно командной строки.  

2. Инициализируйте переменные среды профилирования. Тип:  

    **VSPerfClrEnv** {**/globalsamplegc** &#124; **/globalsamplegclife**} [**/samplelineoff**]  

   - Параметры **/globalsamplegc** и **/globalsamplegclife** задают тип собираемых данных по использованию памяти.  

        Задайте один и только один из указанных ниже параметров.  

       |Параметр|Description|  
       |------------|-----------------|  
       |**/глобалсамплегк**|Включает сбор данных по выделению памяти.|  
       |**/глобалсамплегклифе**|Включает сбор данных по выделению памяти и времени существования объектов.|  

   - Параметр **/samplelineoff** отключает связывание собранных данных с определенными строками исходного кода. Если этот параметр указан, данные назначаются на уровне функции.  

3. Перезагрузите компьютер, чтобы применить новую конфигурацию среды.  

4. Откройте окно командной строки и При необходимости задайте переменную среды, содержащую путь к профилировщику.  

5. Запуск профилировщика. Тип:  

    **VSPerfCmd**  [/Start](../profiling/start.md) **: Sample**  [/Output](../profiling/output.md) **:** `OutputFile` [ `Options` ]  

   - Параметр **/start:sample** инициализирует профилировщик.  

   - Параметр **/output**`OutputFile` является обязательным при использовании параметра **/start**. `OutputFile` указывает имя и расположение файла данных профилирования (VSP-файла).  

     С параметром **/start:sample** можно использовать любой из следующих параметров.  

   > [!NOTE]
   > Параметры **/user** и **/crosssession** обычно являются обязательными для приложений ASP.NET.  

   |                                 Параметр                                  |                                                                                                                                                        Описание                                                                                                                                                        |
   |-------------------------------------------------------------------------|---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
   | [/user](../profiling/user-vsperfcmd.md) **:** [`Domain` **\\** ]`UserName` |                   Указывает домен и имя пользователя учетной записи, которая является владельцем рабочего процесса ASP.NET. Этот параметр является обязательным, если процесс выполняется от имени пользователя, отличного от пользователя, вошедшего в систему. Владелец процесса указан в столбце "Имя пользователя" на вкладке "Процессы" диспетчера задач Windows.                    |
   |              [/crossession](../profiling/crosssession.md)              | Включает профилирование процессов в других сеансах входа. Этот параметр является обязательным, если приложение ASP.NET выполняется в другом сеансе. Идентификатор сеанса указан в столбце "Идентификатор сеанса" на вкладке "Процессы" диспетчера задач Windows. **/CS** можно указать как краткую версию **/crosssession**. |
   |        [/ваитстарт](../profiling/waitstart.md) [**:** `Interval` ]        |                                                      Задает интервал ожидания инициализации профилировщика до возвращения ошибки (в секундах). Если значение `Interval` не указано, профилировщик ожидает в течение неограниченного срока. По умолчанию параметр **/start** возвращает ошибку немедленно.                                                      |
   |    [/wincounter](../profiling/wincounter.md) **:** `WinCounterPath`     |                                                                                                                         Задает счетчик производительности Windows, данные которого будут собираться во время профилирования.                                                                                                                         |
   |         [/automark](../profiling/automark.md) **:** `Interval`          |                                                                                       Используется с только с параметром **/wincounter**. Указывает время (в миллисекундах) между событиями сбора счетчика производительности Windows. Значение по умолчанию — 500 мс.                                                                                       |
   |       [/events](../profiling/events-vsperfcmd.md) **:** `Config`        |                                                                                         Задает события трассировки событий для Windows (ETW), собираемые во время профилирования. События трассировки событий Windows собираются в отдельный ETL-файл.                                                                                          |

6. Запустите приложение [!INCLUDE[vstecasp](../includes/vstecasp-md.md)] обычным образом.  

7. Подключите профилировщик к рабочему процессу [!INCLUDE[vstecasp](../includes/vstecasp-md.md)]. Тип:  

    **VSPerfCmd**[/attach](../profiling/attach.md) **:**{ `PID`&#124;`ProcName` } [[/TargetCLR](../profiling/targetclr.md)**:** `Version` ]    

   - Идентификатор процесса (`(PID)`) задает идентификатор или имя рабочего процесса [!INCLUDE[vstecasp](../includes/vstecasp-md.md)]. Идентификаторы всех запущенных процессов можно просмотреть в диспетчере задач Windows.  

   - **/TargetCLR:** `Version` Указывает версию общеязыковой среды выполнения (CLR) для профилирования, когда в приложении загружается более одной версии среды выполнения.  

## <a name="controlling-data-collection"></a>Управление сбором данных  
 Пока выполняется приложение, вы можете управлять сбором данных, запуская и останавливая процесс записи данных в файл данных профилировщика с помощью параметров **VSPerfCmd.exe**. Управление сбором данных позволяет собирать данные на конкретных этапах выполнения программы, например при запуске или завершении работы приложения.  

#### <a name="to-start-and-stop-data-collection"></a>Запуск и остановка сбора данных  

- Следующие пары параметров **VSPerfCmd** запускают и останавливают сбор данных. Каждый параметр необходимо указывать в отдельной командной строке. Сбор данных можно включать и отключать несколько раз.  

    |Параметр|Описание|  
    |------------|-----------------|  
    |[/globalon /globaloff](../profiling/globalon-and-globaloff.md)|Запускает ( **/globalon**) или останавливает ( **/globaloff**) сбор данных для всех процессов.|  
    |[/processon](../profiling/processon-and-processoff.md) **:** `PID` [/processoff](../profiling/processon-and-processoff.md) **:** `PID`|Запускает (**/processon**) или останавливает (**/processoff**) сбор данных для процесса с указанным идентификатором `PID`.|  
    |**/Attach:**{ `PID`&#124;`ProcName` } [/Detach](../profiling/detach.md)[**:**{ `PID`&#124;: `ProcName` }]|**/attach** запускает сбор данных для процесса, определяемого идентификатором или именем процесса. **/detach** останавливает сбор данных для указанного процесса или для всех процессов, если конкретный процесс не задан.|  

## <a name="ending-the-profiling-session"></a>Завершение сеанса профилирования  
 Чтобы завершить сеанс профилирования следует отключить профилировщик от веб-приложения. Чтобы остановить сбор данных в приложении, для которого выполняется профилирование методом выборки, можно перезапустить рабочий процесс [!INCLUDE[vstecasp](../includes/vstecasp-md.md)] или вызвать параметр **VSPerfCmd /detach**. Затем можно вызвать параметр **VSPerfCmd** [/shutdown](../profiling/shutdown.md), чтобы завершить работу профилировщика и закрыть файл данных профилирования. Команда **VSPerfClrEnv/globaloff** очищает переменные среды профилирования, однако конфигурация системы не сбрасывается до перезагрузки компьютера.  

#### <a name="to-end-a-profiling-session"></a>Завершение сеанса профилирования  

1. Выполните одно из следующих действий, чтобы отключить профилировщик от целевого приложения.  

   - Введите команду **VSPerfCmd** [/detach](../profiling/detach.md)  

      -или-  

   - Завершите рабочий процесс [!INCLUDE[vstecasp](../includes/vstecasp-md.md)]. Тип:  

     **IISReset /stop**  

2. Завершите работу профилировщика. Тип:  

    **VSPerfCmd /shutdown**  

3. (Необязательно) Сбросьте переменные среды профилирования. Тип:  

    **VSPerfCmd /globaloff**  

4. Перезагрузите компьютер. Если требуется, перезапустите службы IIS. Тип:  

    **IISReset /start**  

## <a name="see-also"></a>См. также:  
 [Профилирование веб-приложений ASP.NET](../profiling/command-line-profiling-of-aspnet-web-applications.md)   
 [Представления данных в памяти .NET](../profiling/dotnet-memory-data-views.md)
