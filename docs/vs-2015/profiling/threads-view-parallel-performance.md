---
title: Представление "Потоки" (параллельная производительность) | Документы Майкрософт
ms.date: 11/15/2016
ms.prod: visual-studio-dev14
ms.technology: vs-ide-debug
ms.topic: conceptual
f1_keywords:
- vs.performance.view.threadblocking
helpviewer_keywords:
- Concurrency Visualizer, Threads View (Parallel Performance)
ms.assetid: 2e441103-a266-407b-88c3-fb58716257a3
caps.latest.revision: 26
author: MikeJo5000
ms.author: mikejo
manager: jillfra
ms.openlocfilehash: 0d685dc39f5e07840a5995f7fe67988840c3f50a
ms.sourcegitcommit: 47eeeeadd84c879636e9d48747b615de69384356
ms.translationtype: MTE95
ms.contentlocale: ru-RU
ms.lasthandoff: 04/23/2019
ms.locfileid: "63441653"
---
# <a name="threads-view-parallel-performance"></a>Представление "Потоки" (параллельная производительность)
[!INCLUDE[vs2017banner](../includes/vs2017banner.md)]

Представление "Потоки" является наиболее полным и функциональным представлением визуализатора параллелизма. С помощью этого представления можно определить, выполняются ли потоки или они блокированы в результате синхронизации, ввода-вывода или по какой-либо другой причине.  
  
 Во время профилировки визуализатор параллелизма анализирует все события переключения контекста операционной системы для каждого потока приложения. Переключение контекста может быть вызвано многими причинами, например:  
  
- поток заблокирован примитивом синхронизации;  
  
- истек квант времени потока;  
  
- поток совершает блокирующий запрос ввода-вывода.  
  
  Представление "Потоки" назначает определенную категорию каждому переключению контекста, когда выполнение потока останавливается. Эти категории отображаются в условных обозначениях в левой нижней части представления. Визуализатор параллелизма распределяет события переключения контекста по категориям, выполняя поиск известных блокировок API в стеке вызовов потока. Если в стеке вызовов ничего не найдено, то в качестве причины ожидания устанавливается значение, предоставляемое [!INCLUDE[TLA#tla_mswin](../includes/tlasharptla-mswin-md.md)]. Однако категория [!INCLUDE[TLA#tla_mswin](../includes/tlasharptla-mswin-md.md)] может зависеть от особенностей реализации и не отражать целей пользователя. Например, в качестве причины блокировки собственного компактного модуля чтения и записи [!INCLUDE[TLA#tla_mswin](../includes/tlasharptla-mswin-md.md)] указывает ввод-вывод вместо синхронизации. В большинстве случаев вы можете определить истинную причину блокировки, проанализировав стеки вызовов, относящиеся к событиям переключения контекста.  
  
  Представление "Потоки" также показывает зависимости между потоками. Например, при обнаружении потока, блокируемого объектом синхронизации, можно найти поток, который его разблокировал, а также можно проанализировать, что происходило с заблокированным потоком в то время, когда он разблокировал другой поток.  
  
  Когда потоки выполняются, визуализатор параллелизма собирает образцы. В представлении "Потоки" можно проанализировать, какой код выполнялся одним или несколькими потоками во время выполнения сегмента. Можно также просмотреть отчеты о блокировках и отчеты о профилировании выполнения дерева стека вызовов.  
  
## <a name="usage"></a>Использование  
 Представление "Потоки" можно использовать для разных целей:  
  
- Определение причин, по которым пользовательский интерфейс не отвечает на определенных этапах выполнения.  
  
- Определение количества времени, затраченного на блокировку при синхронизации, вводе-выводе, ошибках страниц и при других событиях.  
  
- Определение степени влияния других процессов, выполняемых в системе.  
  
- Определение проблем балансировки нагрузки для параллельного выполнения.  
  
- Определение причин неоптимальной масштабируемости или ее полного отсутствия (например, причин, по которым производительность параллельно выполняемого приложения не повышается при наличии в системе большего количества логических ядер).  
  
- Определение степени параллелизма приложения для содействия в применении принципа параллелизма.  
  
- Определение зависимостей между рабочими потоками и критическими путями выполнения.  
  
## <a name="examining-specific-time-intervals-and-threads"></a>Определение характерных промежутков времени и потоков  
 Представление "Потоки" содержит временную шкалу. По ней можно перемещаться и увеличивать ее масштаб, чтобы проанализировать определенные промежутки времени и потоки приложения. По оси X отмечается время, а по оси Y — несколько каналов:  
  
- В системе предусмотрены два канала ввода-вывода для каждого жесткого диска: один канал для чтения и один — для записи.  
  
- Канал для каждого потока процесса.  
  
- Каналы маркеров, если в трассировке есть события маркеров. Каналы маркеров изначально отображаются в списке каналов потоков, которые инициировали эти события.  
  
- Каналы GPU.  
  
  Ниже приведен пример представления "Потоки".  
  
  ![Представление "Потоки"](../profiling/media/threadsviewnarrowing.png "ThreadsViewNarrowing")  
  Представление потоков  
  
  Изначально потоки отсортированы в том порядке, в котором они были созданы, так что главный поток приложения будет первым. Чтобы отсортировать потоки по другим критериям (например, по интенсивности выполнения), можно использовать параметр сортировки в левом верхнем углу представления.  
  
  Потоки, не выполняющие работу, можно скрыть, выбрав их имена в столбце слева, а затем нажав кнопку **Скрыть выбранные потоки** на панели инструментов. Рекомендуется скрывать потоки, которые полностью заблокированы, так как статистические данные по ним не актуальны и могут засорить отчеты.  
  
  Чтобы определить потоки, которые еще можно скрыть, на активной ленте условных обозначений выберите отчет **Сводка по потокам** на вкладке **Отчет о профиле**. Отобразится граф схемы выполнения, который показывает состояние потоков в течение выбранного интервала времени. При определенном масштабе некоторые потоки могут не отображаться. Когда это происходит, справа отображаются овалы.  
  
  Выбрав интервал времени и ряд потоков, можно приступить к анализу производительности.  
  
## <a name="analysis-tools"></a>Средства анализа  
 В этом разделе описываются отчеты и другие средства анализа.  
  
### <a name="thread-blocking-details"></a>Сведения о блокировании потока  
 Для получения сведений о событии блокировки в определенной области в потоке наведите указатель на эту область для вывода подсказки. Она содержит определенные сведения, такие как категория, время начала выполнения области, длительность блокировки и блокирующий API, если он существует. При выборе области блокировки стек на данный момент времени будет отображаться на нижней панели вместе с той же информацией, что и в подсказке. Проанализировав стек вызовов, можно определить первопричину возникновения события блокировки потока. Дополнительную информацию о процессах и потоках можно получить, выбрав сегмент и изучив вкладку "Текущий".  
  
 В ходе выполнения может возникнуть несколько событий блокировки. Таким образом, анализируя категории блокировки, можно быстро находить проблемные области. Просто выберите одну из категорий блокировки в условных обозначениях слева.  
  
### <a name="dependencies-between-threads"></a>Зависимости между потоками  
 Визуализатор параллелизма может показывать зависимости между потоками в процессе, благодаря чему можно определить, что пытался сделать заблокированный поток и какой из других потоков возобновил его выполнение. Чтобы определить, какой поток разблокировал другой поток, выберите соответствующий сегмент блокировки. Если визуализатор параллелизма может определить разблокировавший поток, то рисуется линия между разблокировавшим потоком и выполняемым сегментом, который следует за сегментом блокировки. Кроме того, на вкладке **Разблокировка стека** отображается соответствующий стек вызовов.  
  
### <a name="thread-execution-details"></a>Сведения о выполнении потока  
 В графе временной шкалы потока зеленые сегменты указывают на интервалы времени, когда он выполнял код. Вы можете получить более подробные сведения о сегменте выполнения.  
  
 При выборе точки в сегменте выполнения визуализатор параллелизма ищет этот момент времени в соответствующем стеке вызовов, а затем отображает черный курсор над выбранной точкой выполнения сегмента и выводит стек вызовов на вкладке **Текущий стек**. В сегменте выполнения можно выбрать несколько точек.  
  
> [!NOTE]
> В визуализаторе параллелизма может оказаться невозможным выбрать определенную точку в сегменте выполнения. Обычно это происходит, когда длительность сегмента составляет менее одной миллисекунды.  
  
 Чтобы получить профиль выполнения для всех выбранных (не скрытых) в данный момент потоков в заданный диапазон времени, нажмите кнопку **Выполнение** на активной ленте условных обозначений.  
  
### <a name="timeline-graph"></a>Временная шкала  
 На временной шкале отображаются действия для всех потоков процесса и всех физических дисковых устройств на локальном компьютере. На ней также показаны действия GPU и события маркеров.  Вы можете увеличить масштаб для просмотра более подробных сведений или же уменьшить его для просмотра больше интервала времени. Чтобы получить подробные сведения о категориях, времени начала, длительности и состоянии стека вызовов, можно также выбрать точки на диаграмме.  
  
 На временной шкале состояние потока в любой заданный момент времени обозначается цветом. Например, зеленые сегменты выполнялись, красные — были заблокированы для синхронизации, желтые сегменты были вытеснены, а пурпурные были заняты вводом-выводом на устройство. Это представление можно использовать для анализа сбалансированности работы потоков, участвующих в параллельном цикле или параллельно выполняемых задачах. Если поток занимает больше времени, чем другие, работа может быть не сбалансирована. Эти сведения можно использовать для повышения производительности программы и более равномерного распределения работы между потоками.  
  
 Если в определенный момент времени только один поток зеленый (выполняется), то, возможно, приложение не использует все преимущества параллелизма в системе. Кроме того, временной шкалой можно воспользоваться для анализа зависимостей между потоками и для анализа временных отношений между блокирующим и блокируемым потоками. Чтобы изменить порядок потоков, выберите поток, а затем на панели инструментов нажмите кнопку со стрелкой вверх или вниз. Чтобы скрыть потоки, выделите их и нажмите кнопку **Скрыть потоки**.  
  
### <a name="profile-reports"></a>Отчеты о профиле  
 Под временной шкалой располагается профиль временной шкалы и панель с вкладками для разных отчетов. Отчеты автоматически обновляются при изменении представления "Потоки". Для больших трассировок панель отчетов может быть недоступна, пока выполняется расчет. Для каждого отчета доступны две настройки фильтров: "Снижение шума" и "Только мой код". Снижение шума помогает отфильтровать записи дерева вызовов, на которые потрачено мало времени. Значение фильтра по умолчанию — 2 процента, но его можно изменить от 0 до 99 процентов. Чтобы просмотреть дерево вызовов только своего кода, установите флажок **Только мой код**. Чтобы просмотреть все деревья вызовов, снимите его.  
  
#### <a name="profile-report"></a>Отчет о профиле  
 На этой вкладке отображаются отчеты, соответствующие записям на активной ленте условных обозначений. Для вывода отчета выберите одну из записей.  
  
#### <a name="current-stack"></a>Текущий стек  
 На этой вкладке показан стек вызовов для выбранной точки сегмента потока на временной шкале. Стеки вызовов усекаются для того, чтобы отобразить только действия, относящиеся к вашей программе.  
  
#### <a name="unblocking-stack"></a>Разблокировка стека  
 Чтобы увидеть, какой поток разблокировал выбранный поток и в какой строке кода, перейдите на вкладку **Разблокировка стека**.  
  
#### <a name="execution"></a>Выполнение  
 В отчете по выполнению отображаются интервалы времени, в которые приложение выполнялось.  
  
 Чтобы найти строку кода, на которую было затрачено время выполнения, разверните дерево вызовов и в контекстном меню элемента дерева вызовов выберите пункт **Просмотреть исходный код** или **Просмотреть сайты вызовов**. Команда **Просмотреть исходный код** позволяет найти выполненную строку кода. Команда **Просмотреть сайты вызовов** позволяет найти строку кода, в которой была вызвана выполненная строка кода. Если существует только один сайт вызова, то его строка кода будет выделена. Если имеется несколько сайтов вызова, можно выбрать нужный в появившемся диалоговом окне, а затем нажать кнопку **Перейти к источнику** для выделения кода сайта вызова. Зачастую полезнее всего найти сайт вызова либо с наибольшим количеством экземпляров, либо с наибольшим временем выполнения, либо и с тем, и с другим. Дополнительные сведения см. в разделе [Выполнение отчета профилирования](../profiling/execution-profile-report.md).  
  
#### <a name="synchronization"></a>Синхронизация  
 В отчете о синхронизации отображаются вызовы, отвечающие за блокировки синхронизации, с указанием совокупного времени блокировки каждого стека вызовов. Дополнительные сведения см. в разделе [Время синхронизации](../profiling/synchronization-time.md).  
  
#### <a name="io"></a>Ввод-вывод  
 В отчете о вводе-выводе отображаются вызовы, отвечающие за блокировки ввода-вывода, с указанием совокупного времени блокировки каждого стека вызовов. Дополнительные сведения см. в разделе [Время ввода-вывода (представление "Потоки")](../profiling/i-o-time-threads-view.md).  
  
#### <a name="sleep"></a>Sleep  
 В отчете о спящем режиме отображаются вызовы, отвечающие за блокировки спящего режима, с указанием совокупного времени блокировки каждого стека вызовов. Дополнительные сведения см. в разделе [Время ожидания](../profiling/sleep-time.md).  
  
#### <a name="memory-management"></a>Управление памятью  
 В отчете по управлению памятью показаны вызовы, где происходили блокировки управления памятью, а также общее время блокировки каждого стека вызовов. Эти сведения можно использовать для определения областей, которые имеют чрезмерно много проблем с подкачкой или сборкой мусора.  Дополнительные сведения см. в разделе [Время управления памятью](../profiling/memory-management-time.md).  
  
#### <a name="preemption"></a>Вытеснение  
 В отчете по вытеснению показано, какие процессы системы вытесняли текущий процесс и какие потоки заменяли потоки текущего процесса. Эти сведения можно использовать для определения процессов и потоков, которые наиболее часто выполняют вытеснение. Дополнительные сведения см. в разделе [Время вытеснения](../profiling/preemption-time.md).  
  
#### <a name="ui-processing"></a>Обработка UI  
 В отчете об обработке пользовательского интерфейса отображаются вызовы, отвечающие за блокировки обработки пользовательского интерфейса, с указанием совокупного времени блокировки каждого стека вызовов. Дополнительные сведения см. в разделе [Время обработки пользовательского интерфейса](../profiling/ui-processing-time.md).  
  
#### <a name="per-thread-summary"></a>Сводка по потокам  
 На этой вкладке отображаются столбцы с цветовыми обозначениями, содержащие общее время, затраченное каждым потоком на пребывание в состоянии выполнения, блокировки, ввода-вывода или в каком-либо другом состоянии. Метки столбцов расположены внизу. При изменении масштаба временной шкалы эта вкладка автоматически обновляется. При определенном масштабе некоторые потоки могут не отображаться. Когда это происходит, справа отображаются овалы. Если нужный поток не отображается, можно скрыть другие потоки. Дополнительные сведения см. в разделе [Сводный отчет по каждому потоку](../profiling/per-thread-summary-report.md).  
  
#### <a name="disk-operations"></a>Операции диска  
 На этой вкладке показано, какие процессы и потоки использовались для дискового ввода-вывода от имени текущего процесса, какие файлы они затронули (например, библиотеки DLL, которые были загружены), сколько байт было считано, а также другие сведения. Этот отчет можно использовать для оценки времени, затраченного на доступ к файлам во время выполнения приложения, особенно если процесс связан с операциями ввода-вывода. Дополнительные сведения см. в разделе [Отчет операций диска](../profiling/disk-operations-report-threads-view.md).  
  
## <a name="see-also"></a>См. также раздел  
 [Визуализатор параллелизма](../profiling/concurrency-visualizer.md)
