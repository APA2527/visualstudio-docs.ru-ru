---
title: Обзор сборки с помощью инструментов Visual Studio для работы с контейнерами
author: ghogen
description: Обзор процесса сборки с помощью инструментов для работы с контейнерами
ms.author: ghogen
ms.date: 06/06/2019
ms.technology: vs-azure
ms.topic: conceptual
ms.openlocfilehash: edc4674e2468124ecb46b25a1411043ed4b66a2a
ms.sourcegitcommit: e98db44f3a33529b0ba188d24390efd09e548191
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 09/25/2019
ms.locfileid: "71253119"
---
# <a name="building-containerized-apps-using-visual-studio-or-the-command-line"></a>Создание контейнерных приложений с помощью Visual Studio или командной строки

Независимо от того, выполняете ли вы сборку из интегрированной среды разработки Visual Studio или настраиваете сборку из командной строки, необходимо знать, как в Visual Studio используется файл Dockerfile для сборки проектов.  В целях повышения производительности в Visual Studio для контейнерных приложений применяется особый процесс. Особенно важно понимать, как Visual Studio выполняет сборку проектов, когда процесс сборки настраивается путем изменения Dockerfile.

Когда в Visual Studio выполняется сборка проекта, который не использует контейнеры Docker, на локальном компьютере вызывается MSBuild и создаются выходные файлы в папке (обычно `bin`), вложенной в локальную папку решения. Однако для контейнерного проекта в процессе сборки учитываются инструкции из файла Dockerfile. Сборка с помощью Dockerfile в Visual Studio делится на несколько этапов. При этом применяется функция *многоэтапной сборки* Docker.

## <a name="multistage-build"></a>Многоэтапная сборка

Функция многоэтапной сборки повышает эффективность сборки контейнеров и позволяет уменьшить их размер, так как они содержат только тот код, который требуется приложению во время выполнения. Многоэтапная сборка применяется для проектов .NET Core, но не для проектов .NET Framework.

При многоэтапной сборке образы контейнеров создаются в несколько шагов, на каждом из которых формируются промежуточные образы. Возьмем для примера типичный файл Dockerfile, создаваемый Visual Studio. Первый этап — `base`.

```
FROM mcr.microsoft.com/dotnet/core/aspnet:2.2-stretch-slim AS base
WORKDIR /app
EXPOSE 80
EXPOSE 443
```

Сначала в Dockerfile берется образ Nanoserver из реестра контейнеров Майкрософт (mcr.microsoft.com) и создается промежуточный образ `base`, для которого открываются порты 80 и 443 и задается рабочий каталог `/app`.

Следующий этап — `build`. Выглядит он так:

```
FROM mcr.microsoft.com/dotnet/core/sdk:2.2-stretch AS build
WORKDIR /src
COPY ["WebApplication43/WebApplication43.csproj", "WebApplication43/"]
RUN dotnet restore "WebApplication43/WebApplication43.csproj"
COPY . .
WORKDIR "/src/WebApplication43"
RUN dotnet build "WebApplication43.csproj" -c Release -o /app
```

Как вы видите, на этапе `build` вместо продолжения работы с образом base берется другой исходный образ из реестра (`sdk`, а не `aspnet`).  Образ `sdk` содержит все средства сборки и поэтому гораздо больше, чем образ aspnet, который содержит только компоненты времени выполнения. Причина использования отдельного образа становится очевидной, если посмотреть на остальную часть файла Dockerfile:

```
FROM build AS publish
RUN dotnet publish "WebApplication43.csproj" -c Release -o /app

FROM base AS final
WORKDIR /app
COPY --from=publish /app .
ENTRYPOINT ["dotnet", "WebApplication43.dll"]
```

Последний этап снова начинается с образа `base` и включает в себя команду `COPY --from=publish`, которая копирует опубликованные выходные данные в итоговый образ. Это позволяет значительно уменьшить итоговый образ, так как в него не нужно включать все средства сборки, которые имелись в образе `sdk`.

## <a name="faster-builds-for-the-debug-configuration"></a>Ускорение сборки для конфигурации отладки

Visual Studio осуществляет ряд оптимизаций, которые повышают производительность сборки для контейнерных проектов. При запуске отладки (F5) используется ранее созданный образ, если это возможно. Если вы не хотите повторно использовать имеющийся контейнер, можно выбрать в Visual Studio команду **Перестроить** или **Очистить**, чтобы использовался новый контейнер.

Кроме того, в целях повышения производительности процесс сборки контейнерных приложений не просто следует инструкциям в файле Dockerfile. Сборка в контейнере выполняется гораздо медленнее, чем на локальном компьютере.  Поэтому при сборке в конфигурации **отладки** Visual Studio на самом деле выполняет сборку проектов на локальном компьютере, а затем предоставляет доступ к папке с выходными данными контейнеру путем подключения к тому. Сборка с такой оптимизацией называется сборкой в *быстром* режиме.

В **быстром** режиме Visual Studio вызывает `docker build` с аргументом, который предписывает Docker выполнить сборку только образа `base`.  Остальные этапы процесса выполняет сама среда Visual Studio с учетом содержимого Dockerfile. Поэтому, когда вы изменяете файл Dockerfile, например для настройки среды контейнера или установки дополнительных зависимостей, изменения должны вноситься на первом этапе.  Шаги, добавленные в этапы `build`, `publish` и `final` в Dockerfile, выполняться не будут.

Данная оптимизация производительности применяется только при сборке в конфигурации **отладки**. В конфигурации **выпуска** сборка выполняется в контейнере, как указано в Dockerfile.

Чтобы отключить оптимизацию производительности и выполнить сборку, как указано в Dockerfile, присвойте свойству **ContainerDevelopmentMode** значение **Regular** в файле проекта следующим образом:

```xml
<PropertyGroup>
   <ContainerDevelopmentMode>Regular</ContainerDevelopmentMode>
</PropertyGroup>
```

Чтобы снова включить оптимизацию производительности, удалите это свойство из файла проекта.

## <a name="building-from-the-command-line"></a>Сборка из командной строки

Для сборки из командной строки можно использовать `docker build` или `MSBuild`.

### <a name="docker-build"></a>docker build

Для сборки контейнерного решения из командной строки обычно можно использовать команду `docker build <context>` для каждого проекта в решении. Укажите аргумент *build context*. *build context* для Dockerfile — это папка на локальном компьютере, которая служит рабочей папкой для создания образа. Например, из нее копируются файлы в контейнер.  Для проектов .NET Core используйте папку, содержащую файл решения (SLN).  При использовании относительного пути этот аргумент обычно имеет значение ".." для Dockerfile в папке проекта и файла решения в родительской папке.  Для проектов .NET Framework контекст сборки — это папка проекта, а не решения.

```cmd
docker build -f Dockerfile ..
```

### <a name="msbuild"></a>MSBuild

Файлы Dockerfile, создаваемые Visual Studio для проектов .NET Framework (а также для проектов .NET Core, создаваемых с помощью версий Visual Studio до Visual Studio 2017 с обновлением 4), не являются многоэтапными.  Инструкции в этих файлах Dockerfile не компилируют код.  Вместо этого, когда среда Visual Studio выполняет сборку с помощью Dockerfile для .NET Framework, она сначала компилирует проект с помощью MSBuild.  Если компиляция завершилась успешно, Visual Studio выполняет сборку Dockerfile. При этом выходные данные сборки из MSBuild просто копируются в полученный образ Docker.  Так как инструкции по компиляции кода не включаются в Dockerfile, выполнять сборку файлов Dockerfile для .NET Framework с помощью команды `docker build` из командной строки невозможно. Для сборки таких проектов следует использовать MSBuild.

Чтобы выполнить сборку образа для одного проекта контейнера Docker, можно использовать MSBuild с параметром команды `/t:ContainerBuild`. Например:

```cmd
MSBuild MyProject.csproj /t:ContainerBuild /p:Configuration=Release
```

Выходные данные будут аналогичны тем, которые содержатся в окне **Выходные данные** при сборке решения из интегрированной среды разработки Visual Studio. Всегда используйте `/p:Configuration=Release`, так как при применении оптимизации многоэтапной сборки в Visual Studio результаты сборки в конфигурации **отладки** могут отличаться от ожидаемых.

Для проекта Docker Compose используйте команду для сборки образов:

```cmd
msbuild /p:SolutionPath=<solution-name>.sln /p:Configuration=Release docker-compose.dcproj
```

## <a name="next-steps"></a>Следующие шаги

Узнайте, как произвести дальнейшую настройку сборок путем задания дополнительных свойств MSBuild в файлах проекта. См. статью [Свойства MSBuild для проектов контейнеров](container-msbuild-properties.md).

## <a name="see-also"></a>См. также

[MSBuild](../msbuild/msbuild.md)
[Dockerfile в Windows](/virtualization/windowscontainers/manage-docker/manage-windows-dockerfile)
[Контейнеры Linux в Windows](/virtualization/windowscontainers/deploy-containers/linux-containers)
