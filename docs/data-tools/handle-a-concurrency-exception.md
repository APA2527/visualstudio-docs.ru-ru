---
title: Обработка исключения параллелизма
ms.date: 09/11/2017
ms.topic: conceptual
dev_langs:
- VB
- CSharp
helpviewer_keywords:
- concurrency control, exceptions
- datasets [Visual Basic], errors
- exception handling, concurrency issues
- data concurrency, walkthroughs
- updating datasets, errors
- concurrency control, walkthroughs
ms.assetid: 73ee9759-0a90-48a9-bf7b-9d6fc17bff93
author: gewarren
ms.author: gewarren
manager: jillfra
ms.workload:
- data-storage
ms.openlocfilehash: a8e14a53719d4913bcc04bcb2b702ca4ec4a8c55
ms.sourcegitcommit: 94b3a052fb1229c7e7f8804b09c1d403385c7630
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 04/23/2019
ms.locfileid: "62566746"
---
# <a name="handle-a-concurrency-exception"></a>Обработка исключения параллелизма

Исключения параллелизма (<xref:System.Data.DBConcurrencyException?displayProperty=fullName>) вызываются, когда два пользователя пытаются изменить те же данные в базе данных, в то же время. В этом пошаговом руководстве создается приложение Windows, описывается перехват <xref:System.Data.DBConcurrencyException>, найдите строку, которая вызвала ошибку и Узнайте стратегии для его обработки.

В этом пошаговом руководстве описывается процесс:

1. Создайте проект **приложения Windows Forms**.

2. Создаете новый набор данных на основе таблицы Northwind Customers.

3. Создание формы с <xref:System.Windows.Forms.DataGridView> для отображения данных.

4. Заполнить набор данных данными из таблицы Customers в базе данных "Борей".

5. Используйте **Показать таблицу данных** компонент в **обозревателя серверов** для доступа к данным клиентов таблицы и изменения записи.

6. Измените той же записи на другое значение, обновление набора данных и пытаются выполнить запись изменений в базе данных, что приводит к возникновению ошибки параллелизма.

7. Перехватить ошибку, а затем отображают разные версии записей, предоставляя пользователю определить, следует ли продолжить и обновить базу данных или отменить обновление.

## <a name="prerequisites"></a>Предварительные требования

В этом пошаговом руководстве используется SQL Server Express LocalDB и базе данных Northwind.

1. Если у вас нет SQL Server Express LocalDB, установите его из [странице загрузки SQL Server Express](https://www.microsoft.com/sql-server/sql-server-editions-express), либо с помощью **установщик Visual Studio**. В **установщик Visual Studio**, можно установить SQL Server Express LocalDB как часть **хранение и обработка данных** рабочей нагрузки, или в качестве отдельного компонента.

2. Установка образца базы данных "Борей", выполнив следующие действия:

    1. В Visual Studio откройте **обозреватель объектов SQL Server** окна. (Обозреватель объектов SQL Server устанавливается как часть **хранение и обработка данных** рабочей нагрузки в установщике Visual Studio.) Разверните **SQL Server** узла. Щелкните правой кнопкой мыши на локальном экземпляре LocalDB и выберите **новый запрос**.

       Откроется окно редактора запросов.

    2. Копировать [скрипт Northwind Transact-SQL](https://github.com/MicrosoftDocs/visualstudio-docs/blob/master/docs/data-tools/samples/northwind.sql?raw=true) в буфер обмена. Этот сценарий T-SQL создает базу данных "Борей" с нуля и заполняет ее данными.

    3. Вставьте сценарий T-SQL в редакторе запросов, а затем выберите **Execute** кнопки.

       Через некоторое время выполнения запроса отобразятся и создания базы данных Northwind.

## <a name="create-a-new-project"></a>Создание нового проекта

Начните с создания нового приложения Windows Forms:

1. В Visual Studio на **файл** меню, выберите **New** > **проекта**.

2. Разверните **Visual C#** или **Visual Basic** левой панели, а затем выберите **Windows Desktop**.

3. В средней области выберите **приложения Windows Forms** тип проекта.

4. Назовите проект **ConcurrencyWalkthrough**, а затем выберите **ОК**.

     **ConcurrencyWalkthrough** проекта создается и добавляется к **обозревателе решений**, и открывает новую форму в конструкторе.

## <a name="create-the-northwind-dataset"></a>Создание набора данных "Борей"

Создайте набор данных с именем **NorthwindDataSet**:

1. На **данных** меню, выберите **добавить новый источник данных**.

   Открывается мастер настройки источника данных.

2. На **Выбор типа источника данных** выберите **базы данных**.

   ![Мастер настройки источника данных в Visual Studio](media/data-source-configuration-wizard.png)

3. Выберите соединение с образцом базы данных "Борей" в списке доступных подключений. Если подключение недоступно в списке подключений, выберите **новое подключение**.

    > [!NOTE]
    > Если вы подключаетесь к файлу локальной базы данных, выберите **нет** ответ на вопрос о том, как добавить файл в проект.

4. На **сохранение подключения в файле конфигурации приложения** выберите **Далее**.

5. Разверните **таблиц** узел и выберите **клиентов** таблицы. Имя по умолчанию для набора данных должно быть **NorthwindDataSet**.

6. Выберите **Готово** Добавление набора данных в проект.

## <a name="create-a-data-bound-datagridview-control"></a>Создание элемента управления DataGridView с привязкой к данным

В этом разделе описано, как создать <xref:System.Windows.Forms.DataGridView?displayProperty=nameWithType> , перетащив **клиентов** элемент из **источников данных** окна на форму Windows.

1. Чтобы открыть **источников данных** окна на **данных** меню, выберите **Показать источники данных**.

2. В **источников данных** окне разверните **NorthwindDataSet** узел, а затем выберите **клиентов** таблицы.

3. Щелкните стрелку вниз в узле таблицы, а затем выберите **DataGridView** в раскрывающемся списке.

4. Перетащите таблицу в пустую область формы.

     Объект <xref:System.Windows.Forms.DataGridView> управления с именем **CustomersDataGridView**и <xref:System.Windows.Forms.BindingNavigator> с именем **CustomersBindingNavigator**, добавляются в форму, привязанный к <xref:System.Windows.Forms.BindingSource>. Это в свою очередь, привязан к таблице Customers в NorthwindDataSet.

## <a name="test-the-form"></a>Проверить форму

Теперь можно проверить форму, чтобы убедиться, что оно правильно работает до этого момента:

1. Выберите **F5** для запуска приложения.

     Появится форма с <xref:System.Windows.Forms.DataGridView> управления, который заполняется данными из таблицы Customers.

2. На **Отладка** меню, выберите **остановить отладку**.

## <a name="handle-concurrency-errors"></a>Обрабатывают ошибки параллелизма

Порядок обработки ошибок зависит от конкретных бизнес-правила, управляющие приложения. В этом пошаговом руководстве мы используем следующую стратегию в качестве примера для обработки ошибки параллелизма.

Приложение предлагает пользователю три версии записи:

- Текущая запись в базе данных

- Исходная запись, которая загружается в набор данных

- Предложенные изменения в наборе данных

Пользователь будет иметь либо перезаписать базу данных предложенными изменениями или отменить обновление и обновить набор данных с новыми значениями из базы данных.

### <a name="to-enable-the-handling-of-concurrency-errors"></a>Чтобы включить обработку ошибок параллелизма

1. Создание пользовательского обработчика ошибок.

2. Варианты отображения пользователю.

3. Обработка ответа пользователя.

4. Отправьте обновления или сбросить данные в наборе данных.

### <a name="add-code-to-handle-the-concurrency-exception"></a>Добавьте код для обработки исключения параллельности

При попытке выполнить обновление, и возникает исключение, обычно требуется сделать что-то информацией, которая обеспечивается созданное исключение. В этом разделе добавьте код, который пытается обновить базу данных. Можно также обработать какие-либо <xref:System.Data.DBConcurrencyException> , может быть вызвано, а также любые другие исключения.

> [!NOTE]
> `CreateMessage` И `ProcessDialogResults` далее в этом пошаговом руководстве добавляются методы.

1. Добавьте следующий код ниже `Form1_Load` метод:

   [!code-csharp[VbRaddataConcurrency#1](../data-tools/codesnippet/CSharp/handle-a-concurrency-exception_1.cs)]
   [!code-vb[VbRaddataConcurrency#1](../data-tools/codesnippet/VisualBasic/handle-a-concurrency-exception_1.vb)]

2. Замените `CustomersBindingNavigatorSaveItem_Click` метод для вызова `UpdateDatabase` метод, чтобы он выглядел следующим образом:

   [!code-csharp[VbRaddataConcurrency#2](../data-tools/codesnippet/CSharp/handle-a-concurrency-exception_2.cs)]
   [!code-vb[VbRaddataConcurrency#2](../data-tools/codesnippet/VisualBasic/handle-a-concurrency-exception_2.vb)]

### <a name="display-choices-to-the-user"></a>Способ отображения вариантов для пользователя

Написанный код, вы просто вызывает `CreateMessage` процедуру для отображения сведений об ошибке для пользователя. В этом пошаговом руководстве используется окно сообщения для отображения различных версий записи для пользователя. Это позволяет пользователю выбирать, следует ли перезаписать запись с изменениями или отменить изменения. Когда пользователь выбирает параметр (нажимает кнопку) в окне сообщения, ответ передается `ProcessDialogResult` метод.

Создайте сообщение, добавив следующий код, чтобы **редактор кода**. Введите следующий код ниже `UpdateDatabase` метод:

[!code-csharp[VbRaddataConcurrency#4](../data-tools/codesnippet/CSharp/handle-a-concurrency-exception_3.cs)]
[!code-vb[VbRaddataConcurrency#4](../data-tools/codesnippet/VisualBasic/handle-a-concurrency-exception_3.vb)]

### <a name="process-the-users-response"></a>Обработать ответ пользователя

Вам также потребуется код для обработки ответа пользователя в окне сообщения. Параметры, чтобы перезаписать текущую запись в базе данных с помощью предлагаемого изменения, или сбросить локальные изменения и обновить таблицу данных с записью, который используется в настоящий момент в базе данных. Если пользователь выбирает **Да**, <xref:System.Data.DataTable.Merge%2A> метод вызывается с *preserveChanges* аргумент значение **true**. В результате попытки обновления было успешным, поскольку исходная версия записи теперь соответствует записи в базе данных.

Добавьте следующий код после кода, который был добавлен в предыдущем разделе:

[!code-csharp[VbRaddataConcurrency#3](../data-tools/codesnippet/CSharp/handle-a-concurrency-exception_4.cs)]
[!code-vb[VbRaddataConcurrency#3](../data-tools/codesnippet/VisualBasic/handle-a-concurrency-exception_4.vb)]

## <a name="test-the-form"></a>Проверить форму

Теперь можно проверить форму, чтобы убедиться, что она правильно работает. Чтобы смоделировать одновременного нарушения, необходимо внести изменения данных в базе данных после заполнения NorthwindDataSet.

1. Выберите **F5** для запуска приложения.

2. После отображения формы, оставьте ее работающей и перейдите в интегрированной среде разработки Visual Studio.

3. На **представление** меню, выберите **обозревателя серверов**.

4. В **обозревателя серверов**, разверните узел соединения с помощью приложения, а затем разверните **таблиц** узла.

5. Щелкните правой кнопкой мыши **клиентов** таблицы, а затем выберите **Показать таблицу данных**.

6. В первой записи (**ALFKI**), измените **ContactName** для **Anders2 Мария**.

    > [!NOTE]
    > Перейдите в другую строку для фиксации изменений.

7. Переключиться в режим ConcurrencyWalkthrough выполнение формы.

8. В первой записи в форме (**ALFKI**), измените **ContactName** для **Anders1 Мария**.

9. Нажмите кнопку **Сохранить**.

     Возникает ошибка параллелизма, и появится окно сообщения.

   Выбрав **нет** отменяет обновление и обновление набора данных со значениями, которые в настоящее время находятся в базе данных. Выбрав **Да** записывает предложенное значение в базу данных.

## <a name="see-also"></a>См. также

- [Сохранение данных обратно в базу данных](../data-tools/save-data-back-to-the-database.md)