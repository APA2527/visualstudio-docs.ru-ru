---
title: Иерархическое обновление
ms.date: 11/04/2016
ms.topic: conceptual
dev_langs:
- VB
- CSharp
helpviewer_keywords:
- saving data, changed data
- data [Visual Basic], hierarchical update
- saving updated data
- datasets [Visual Basic], hierarchical update
- hierarchical update
- saving data, hierarchical update
- modified data saving
- updated data saving
- related tables, saving
ms.assetid: 68bae3f6-ec9b-45ee-a33a-69395029f54c
author: gewarren
ms.author: gewarren
manager: jillfra
ms.workload:
- data-storage
ms.openlocfilehash: 303c19e8cb02b7c9db78d922f0591cb7ab5f3ed3
ms.sourcegitcommit: 94b3a052fb1229c7e7f8804b09c1d403385c7630
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 04/23/2019
ms.locfileid: "62566807"
---
# <a name="hierarchical-update"></a>Иерархическое обновление

*Иерархическое обновление* — это процесс сохранения обновленных данных (из набора данных двух или более связанных таблиц) обратно в базу данных, сохраняя ограничения ссылочной целостности. *Ссылочная целостность* ссылается на правила целостности, заданные с помощью ограничений в базе данных, которые управляют поведением вставки, обновления и удаления связанных записей. Например это целостность данных обеспечивает создание записи клиента перед предоставлением заказы, должен быть создан для этого клиента.  Дополнительные сведения о связях в наборах данных см. в разделе [отношения в наборах данных](../data-tools/relationships-in-datasets.md).

Использует функцию иерархическое обновление `TableAdapterManager` для управления `TableAdapter`s в типизированный набор данных. `TableAdapterManager` Компонентом является класс создаются в Visual Studio, поэтому не входит [!INCLUDE[dnprdnshort](../code-quality/includes/dnprdnshort_md.md)]. При перетаскивании таблицы из **источников данных** окна на форму Windows или WPF страницу, в Visual Studio добавляет переменную типа TableAdapterManager формы или страницы, а также см. в конструкторе в области компонентов. Подробные сведения о `TableAdapterManager` класса см. в разделе справочной TableAdapterManager [TableAdapters](../data-tools/create-and-configure-tableadapters.md).

По умолчанию набор данных рассматривает связанных таблиц как «только для отношения», это означает, что он не применить ограничения внешнего ключа. Можно изменить эту настройку во время разработки с помощью **конструктор наборов данных**. Выберите линию связи между двумя таблицами, чтобы открыть **отношения** диалоговое окно. Определяет изменения, внесенные здесь как `TableAdapterManager` ведет себя, если отправить изменения в связанных таблицах в базе данных.

## <a name="enable-hierarchical-update-in-a-dataset"></a>Включить иерархическое обновление в наборе данных

По умолчанию иерархическое обновление включено для всех новых наборов данных, которые добавляются или создаются в проекте. Включить иерархическое обновление или отключить, задав **иерархическое обновление** свойство типизированного набора данных в наборе данных для **True** или **False**:

![Параметр иерархическое обновление](../data-tools/media/hierarchical-update-setting.png)

## <a name="create-a-new-relation-between-tables"></a>Создать новую связь между таблицами

Чтобы создать новую связь между двумя таблицами, в конструкторе наборов данных, выберите заголовок каждой таблицы, затем щелкните правой кнопкой мыши и выберите **добавить отношение**.

![Отношение меню добавления иерархическое обновление](../data-tools/media/hierarchical-update-add-relation-menu.png)

## <a name="understand-foreign-key-constraints-cascading-updates-and-deletes"></a>Понимать ограничения foreign key, каскадные обновления и удаления

Важно понимать ограничения как внешнего ключа и каскадное поведения в базе данных создаются в коде созданный набор данных.

По умолчанию таблиц данных в наборе данных создаются со связями (<xref:System.Data.DataRelation>), которые соответствуют связи в базе данных. Тем не менее как ограничение внешнего ключа связи в наборе данных не создается. <xref:System.Data.DataRelation> Работает в режиме **только связь** без <xref:System.Data.ForeignKeyConstraint.UpdateRule%2A> или <xref:System.Data.ForeignKeyConstraint.DeleteRule%2A> в силе.

По умолчанию каскадное обновление и удаление отключены даже в том случае, если связь в базе данных, заданный параметром каскадные обновления и/или удалением. Например создание нового клиента и новый заказ, а также последующая попытка сохранения данных может вызвать конфликт с ограничениями внешнего ключа, которые определены в базе данных. Дополнительные сведения см. в разделе [отключение ограничений при заполнении набора данных](turn-off-constraints-while-filling-a-dataset.md).

## <a name="set-the-order-to-perform-updates"></a>Установить порядок для выполнения обновлений

Задание порядка выполнения обновления задает порядок отдельных операций вставки, обновления и удаления, необходимых для сохранения всех измененных данных во всех таблицах набора данных. При включении иерархического обновления операции вставки, выполняются первыми, а затем обновляет, а затем удаляет. `TableAdapterManager` Предоставляет `UpdateOrder` свойство, которое может быть задано для выполнения обновления, во-первых, вставки и удаления.

> [!NOTE]
> Важно понимать, что порядок обновления является полным. То есть при выполнении обновлений, вставок и удалений выполняются для всех таблиц в наборе данных.

Чтобы задать `UpdateOrder` свойства, после перетаскивания элементов из [окна "Источники данных"](add-new-data-sources.md#data-sources-window) в форму, выберите `TableAdapterManager` в область компонентов, а затем задайте `UpdateOrder` свойство в **свойства** окна.

## <a name="create-a-backup-copy-of-a-dataset-before-performing-a-hierarchical-update"></a>Создать резервную копию набора данных перед выполнением иерархического обновления

При сохранении данных (путем вызова `TableAdapterManager.UpdateAll()` метод), `TableAdapterManager` пытается обновить данные для каждой таблицы в одной транзакции. В случае сбоя любой части обновление для любой таблицы откат всей транзакции. В большинстве случаев отката возвращает в исходное состояние приложения.

Тем не менее иногда может потребоваться восстановление из резервной копии набора данных. Примером этого могут возникнуть при использовании значения с автоматическим приращением. Например, если сохранение операция не выполнена успешно, с автоматическим приращением значений не сбрасываются в наборе данных и набора данных продолжает создавать значения заданы с автоматическим приращением. Это оставляет разрыв в нумерации, который не может быть приемлемым в приложении. В ситуациях, где это важно, `TableAdapterManager` предоставляет `BackupDataSetBeforeUpdate` свойство, которое заменяет существующий набор данных резервной копии, если происходит сбой транзакции.

> [!NOTE]
> Резервные копии находятся только в памяти, пока `TableAdapterManager.UpdateAll` выполняется метод. Таким образом, нет программного доступа к этому резервному набору данных, так как он заменяет исходный набор данных либо выходит за пределы области после `TableAdapterManager.UpdateAll` метод завершения работы.

## <a name="modify-the-generated-save-code-to-perform-the-hierarchical-update"></a>Изменение созданного кода сохранения для выполнения иерархического обновления

Сохраните изменения из связанных таблиц данных набора данных в базу данных, вызвав метод `TableAdapterManager.UpdateAll` и передав имя набора данных, содержащего связанные таблицы. Например, запустите метод `TableAdapterManager.UpdateAll(NorthwindDataset)` для отправки обновлений из всех таблиц в NorthwindDataset во внутреннюю базу данных.

После удаления элементов из окна **Источники данных** в событие `Form_Load` автоматически добавляется код для заполнения каждой таблицы (методы `TableAdapter.Fill`). Код также добавляется в событие нажатия кнопки **Сохранить** объекта <xref:System.Windows.Forms.BindingNavigator>, чтобы сохранить данные из набора данных обратно в базу данных (метод `TableAdapterManager.UpdateAll`).

Сформированный код сохранения также содержит строку, вызывающую метод `CustomersBindingSource.EndEdit`. В частности, он вызывает <xref:System.Windows.Forms.BindingSource.EndEdit%2A> метод первого <xref:System.Windows.Forms.BindingSource>, добавляется в форму. Другими словами, этот код создается только для первой таблицы, которые перетаскиваются из **источников данных** окна в форму. Вызов <xref:System.Windows.Forms.BindingSource.EndEdit%2A> фиксирует все актуальные изменения для всех редактируемых в настоящее время элементов управления с привязкой к данным. Таким образом, если элемент управления с привязкой к данным все еще находится в фокусе и вы нажимаете кнопку **Сохранить**, все ожидающие правки в этом элементе управления фиксируются до фактического сохранения (метод `TableAdapterManager.UpdateAll`).

> [!NOTE]
> **Конструктор наборов данных** только добавляет `BindingSource.EndEdit` код для первой таблицы, помещенной на форму. Таким образом, вам необходимо добавить строку кода, вызывающую метод `BindingSource.EndEdit` для каждой связанной таблицы на форме. В рамках данного пошагового руководства это означает, что вам нужно добавить вызов метода `OrdersBindingSource.EndEdit`.

### <a name="to-update-the-code-to-commit-changes-to-the-related-tables-before-saving"></a>Обновление кода для фиксации изменений в связанных таблицах перед сохранением

1. Дважды нажмите кнопку **Сохранить** на <xref:System.Windows.Forms.BindingNavigator>, чтобы открыть **Form1** в редакторе кода.

2. Добавьте строку кода для вызова метода `OrdersBindingSource.EndEdit` после строки, вызывающей метод `CustomersBindingSource.EndEdit`. Код в событии нажатия кнопки **Сохранить** должен выглядеть примерно следующим образом:

     [!code-vb[VSProDataOrcasHierarchicalUpdate#1](../data-tools/codesnippet/VisualBasic/hierarchical-update_1.vb)]
     [!code-csharp[VSProDataOrcasHierarchicalUpdate#1](../data-tools/codesnippet/CSharp/hierarchical-update_1.cs)]

Кроме фиксации изменений в связанной дочерней таблице перед сохранением данных в базе данных, вам также может понадобиться фиксировать недавно созданные родительские записи перед добавлением новых дочерних записей в базу данных. Другими словами, может потребоваться добавить новую родительскую запись (`Customer`) в набор данных, прежде чем ограничение внешнего ключа позволит новых дочерних записей (`Orders`) для добавления к набору данных. Для этого можно использовать дочернее событие `BindingSource.AddingNew`.

> [!NOTE]
> Нужно ли Фиксация новых родительских записей зависит от типа элемента управления, который используется для привязки к источнику данных. В этом пошаговом руководстве используйте отдельные элементы управления для привязки к родительской таблице. Для этого дополнительный код для фиксации новой родительской записи. Если бы вместо этого родительские записи отображались в сложном элементе управления, такие как <xref:System.Windows.Forms.DataGridView>, этот дополнительный <xref:System.Windows.Forms.BindingSource.EndEdit%2A> вызов родительской записи не требовался бы. Это вызвано тем, что базовая функциональность привязки к данным элемента управления обрабатывает фиксацию новых записей.

### <a name="to-add-code-to-commit-parent-records-in-the-dataset-before-adding-new-child-records"></a>Добавление кода для фиксации родительских записей в наборе данных перед добавлением новых дочерних записей

1. Создайте обработчик событий для события `OrdersBindingSource.AddingNew`.

    - Откройте **Form1** в режиме конструктора выберите **OrdersBindingSource** в области компонентов выберите **события** в **свойства** окно, и Дважды щелкните **AddingNew** событий.

2. Добавьте строку кода в обработчик событий, который вызывает `CustomersBindingSource.EndEdit` метод. Код в обработчике событий `OrdersBindingSource_AddingNew` должен выглядеть примерно следующим образом:

     [!code-vb[VSProDataOrcasHierarchicalUpdate#2](../data-tools/codesnippet/VisualBasic/hierarchical-update_2.vb)]
     [!code-csharp[VSProDataOrcasHierarchicalUpdate#2](../data-tools/codesnippet/CSharp/hierarchical-update_2.cs)]

## <a name="tableadaptermanager-reference"></a>Справочник по TableAdapterManager

По умолчанию `TableAdapterManager` класс создается при создании набора данных, содержащего связанные таблицы. Чтобы предотвратить создание класса, измените значение `Hierarchical Update` свойства набора данных значение false. При перетаскивании таблицы, имеющей отношение в область конструктора WPF страницы или формы Windows, Visual Studio объявляет переменную-член класса. Если вы не используете привязки данных, необходимо вручную объявить переменную.

`TableAdapterManager` Класс не является частью [!INCLUDE[dnprdnshort](../code-quality/includes/dnprdnshort_md.md)]. Таким образом вы не удается найти в документации. Она создается во время разработки, как часть процесса создания набора данных.

Ниже перечислены часто используемые методы и свойства `TableAdapterManager` класса:

|Член|Описание|
|------------|-----------------|
|Метод `UpdateAll`|Сохраняет все данные из всех таблиц данных.|
|Свойство `BackUpDataSetBeforeUpdate`|Определяет, следует ли создавать резервную копию набора данных перед выполнением `TableAdapterManager.UpdateAll` метод. Логическое значение.|
|*tableName* `TableAdapter` свойство|Представляет `TableAdapter`. Созданный `TableAdapterManager` содержит свойство для каждого `TableAdapter` он управляет. Например, набор данных с таблицей Customers и Orders создается с `TableAdapterManager` , содержащий `CustomersTableAdapter` и `OrdersTableAdapter` свойства.|
|Свойство `UpdateOrder`|Управляет порядком отдельные инструкции insert, update и команд delete. Задайте одно из значений в `TableAdapterManager.UpdateOrderOption` перечисления.<br /><br /> По умолчанию `UpdateOrder` присваивается **InsertUpdateDelete**. Это означает, что операции вставки, а затем обновляет, а затем удаляет выполняются для всех таблиц в наборе данных.|

## <a name="see-also"></a>См. также

- [Сохранение данных обратно в базу данных](../data-tools/save-data-back-to-the-database.md)
