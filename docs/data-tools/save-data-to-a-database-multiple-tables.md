---
title: Сохранение данных в базе данных (несколько таблиц)
ms.date: 11/04/2016
ms.topic: conceptual
dev_langs:
- VB
- CSharp
helpviewer_keywords:
- updating datasets, walkthroughs
- data [Visual Studio], saving
- saving data, walkthroughs
- data [Visual Studio], updating
ms.assetid: 7ebe03da-ce8c-4cbc-bac0-a2fde4ae4d07
author: gewarren
ms.author: gewarren
manager: jillfra
ms.workload:
- data-storage
ms.openlocfilehash: 9e4a30c3aa85969a4cbf712f2f4018c24169ff6d
ms.sourcegitcommit: 94b3a052fb1229c7e7f8804b09c1d403385c7630
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 04/23/2019
ms.locfileid: "62565903"
---
# <a name="save-data-to-a-database-multiple-tables"></a>Сохранение данных в базе данных (несколько таблиц)

Одним из наиболее распространенных сценариев в разработке приложений является отображение данных на форме в приложении Windows, изменение этих данных и отправка обновленных данных обратно в базу данных. Это пошаговое руководство описывает создание формы, отображающей данные из двух связанных таблиц, правку записей и сохранение изменений в базе данных. В данном примере используются таблицы `Customers` и `Orders` из учебной базы данных "Борей".

Вы можете сохранить данные из приложения в базе данных, вызвав метод `Update` адаптера таблицы. При перетаскивании таблиц из **источников данных** окна в форму, код, необходимый для сохранения данных автоматически добавляется. Дополнительные таблицы, которые добавляются в форму требуется Ручное добавление этого кода. Это пошаговое руководство описывает добавление кода для сохранения обновлений из нескольких таблиц.

В данном пошаговом руководстве представлены следующие задачи.

- Создание и настройка источника данных в приложении с помощью [мастер настройки источника данных](../data-tools/media/data-source-configuration-wizard.png).

- Настройка элементов управления из элементов в [окна "Источники данных"](add-new-data-sources.md#data-sources-window). Дополнительные сведения см. в разделе [задать для элемента управления создается при перетаскивании из окна источников данных](../data-tools/set-the-control-to-be-created-when-dragging-from-the-data-sources-window.md).

- Создание элементов управления с привязкой к данным с помощью перетаскивания элементов из окна **Источники данных** на форму.

- Изменение нескольких записей в каждой таблице в наборе данных.

- Изменение кода для отправки обновленных данных в наборе данных обратно в базу данных.

## <a name="prerequisites"></a>Предварительные требования

В этом пошаговом руководстве используется SQL Server Express LocalDB и базе данных Northwind.

1. Если у вас нет SQL Server Express LocalDB, установите его из [странице загрузки SQL Server Express](https://www.microsoft.com/sql-server/sql-server-editions-express), либо с помощью **установщик Visual Studio**. В **установщик Visual Studio**, можно установить SQL Server Express LocalDB как часть **хранение и обработка данных** рабочей нагрузки, или в качестве отдельного компонента.

2. Установка образца базы данных "Борей", выполнив следующие действия:

    1. В Visual Studio откройте **обозреватель объектов SQL Server** окна. (Обозреватель объектов SQL Server устанавливается как часть **хранение и обработка данных** рабочей нагрузки в установщике Visual Studio.) Разверните **SQL Server** узла. Щелкните правой кнопкой мыши на локальном экземпляре LocalDB и выберите **новый запрос**.

       Откроется окно редактора запросов.

    2. Копировать [скрипт Northwind Transact-SQL](https://github.com/MicrosoftDocs/visualstudio-docs/blob/master/docs/data-tools/samples/northwind.sql?raw=true) в буфер обмена. Этот сценарий T-SQL создает базу данных "Борей" с нуля и заполняет ее данными.

    3. Вставьте сценарий T-SQL в редакторе запросов, а затем выберите **Execute** кнопки.

       Через некоторое время выполнения запроса отобразятся и создания базы данных Northwind.

## <a name="create-the-windows-forms-application"></a>Создание приложения Windows Forms

Создайте новый **приложения Windows Forms** проекта либо C# или Visual Basic. Присвойте проекту имя **UpdateMultipleTablesWalkthrough**.

## <a name="create-the-data-source"></a>Создание источника данных

На этом шаге **Мастер настройки источника данных** используется для создания источника данных из базы данных Northwind. Для создания подключения необходимо иметь доступ к учебной базе данных "Борей". Сведения о настройке учебной базе данных Northwind, см. в разделе [как: Установка образцов баз данных](../data-tools/installing-database-systems-tools-and-samples.md).

1. На **данных** меню, выберите **Показать источники данных**.

   Открывается окно **Источники данных**.

2. В окне **Источники данных** выберите **Добавить новый источник данных**, чтобы запустить **Мастер настройки источника данных**.

3. На **Выбор типа источника данных** выберите **базы данных**, а затем выберите **Далее**.

4. На **Выбор подключения базы данных** экрана, выполните одно из следующих:

    - Если подключение к учебной базе данных Northwind доступно в раскрывающемся списке, то выберите его.

         -или-

    - Выберите **Новое подключение** для открытия диалогового окна **Добавить/изменить подключение**.

5. Если для базы данных требуется пароль, выберите параметр для включения конфиденциальных данных, а затем выберите **Далее**.

6. На **сохранение подключения в файле конфигурации приложения**выберите **Далее**.

7. На **Выбор объектов базы данных** экрана, разверните узел **таблиц** узла.

8. Выберите **клиентов** и **заказы** таблиц, а затем выберите **Готово**.

     Объект **NorthwindDataSet** добавляется в проект, и таблицы отображаются в окне **Источники данных**.

## <a name="set-the-controls-to-be-created"></a>Настройка элементов управления должен быть создан

В этом пошаговом руководстве данные в `Customers` таблица находится в **сведения** макета, где данные отображаются в отдельных элементах управления. Данные из `Orders` таблица находится в **сетки** макет, который отображается в <xref:System.Windows.Forms.DataGridView> элемента управления.

### <a name="to-set-the-drop-type-for-the-items-in-the-data-sources-window"></a>Установка типа удаления для элементов в окне "Источники данных"

1. В **источников данных** окне разверните **клиентов** узла.

2. На **клиентов** выберите **сведения** в списке элементов управления, чтобы изменить контроль **клиентов** таблицы на отдельные элементы управления. Дополнительные сведения см. в разделе [задать для элемента управления создается при перетаскивании из окна источников данных](../data-tools/set-the-control-to-be-created-when-dragging-from-the-data-sources-window.md).

## <a name="create-the-data-bound-form"></a>Создание формы с привязкой к данным

Вы можете создавать элементы управления с привязкой к данным с помощью перетаскивания элементов из окна **Источники данных** на форму.

1. Перетащите главный узел **Customers** из окна **Источники данных** на форму **Form1**.

     Привязанные к данным элементы управления с метками описания отображаются на форме вместе с панелью инструментов (<xref:System.Windows.Forms.BindingNavigator>) для перемещения по записям. Объект [NorthwindDataSet](../data-tools/dataset-tools-in-visual-studio.md), `CustomersTableAdapter`, <xref:System.Windows.Forms.BindingSource>, и <xref:System.Windows.Forms.BindingNavigator> отображаются в области компонентов.

2. Перетащите связанный узел **Заказы** из окна **Источники данных** на **Form1**.

    > [!NOTE]
    > Связанный узел **Заказы** расположен под столбцом **Факс** и является дочерним для узла **Клиенты**.

     На форме появляется элемент <xref:System.Windows.Forms.DataGridView> и панель инструментов (<xref:System.Windows.Forms.BindingNavigator>) для перемещения по записям. `OrdersTableAdapter` И <xref:System.Windows.Forms.BindingSource> отображаются в области компонентов.

## <a name="add-code-to-update-the-database"></a>Добавление кода для обновления базы данных

Вы можете обновить базу данных, вызвав методы `Update` адаптеров таблицы **Клиенты** и **Заказы**. По умолчанию, обработчик событий для **Сохранить** кнопки<xref:System.Windows.Forms.BindingNavigator> добавляется в код формы для отправки обновлений в базу данных. Эта процедура изменяет код для отправки обновлений в правильном порядке. Это исключает вероятность возникновения ошибок целостности данных. Этот код также реализует обработку ошибок, упаковывая вызов обновления в блок try-catch. Вы можете изменить этот код в соответствии с потребностями своего приложения.

> [!NOTE]
> Для ясности в этом пошаговом руководстве используется транзакция. Тем не менее если вы обновляете двух или нескольких связанных таблицах, включать всю логику обновления в рамках транзакции. Транзакция — это процесс, который гарантирует, что все связанные изменения в базу данных выполнены успешно, прежде чем изменения будут зафиксированы. Дополнительные сведения см. в разделе [транзакции и параллельность](/dotnet/framework/data/adonet/transactions-and-concurrency).

### <a name="to-add-update-logic-to-the-application"></a>Добавление логики обновления в приложение

1. Выберите **Сохранить** кнопку <xref:System.Windows.Forms.BindingNavigator>. Откроется редактор кода для `bindingNavigatorSaveItem_Click` обработчик событий.

2. Замените код в обработчике событий на вызов методов `Update` связанных адаптеров таблицы. Следующий код сначала создает три временные таблицы данных для хранения обновленной информации для каждого <xref:System.Data.DataRowState> (<xref:System.Data.DataRowState.Deleted>, <xref:System.Data.DataRowState.Added> и <xref:System.Data.DataRowState.Modified>). Обновления выполняются в правильном порядке. Код должен выглядеть следующим образом:

     [!code-vb[VbRaddataSaving#10](../data-tools/codesnippet/VisualBasic/save-data-to-a-database-multiple-tables_1.vb)]
     [!code-csharp[VbRaddataSaving#10](../data-tools/codesnippet/CSharp/save-data-to-a-database-multiple-tables_1.cs)]

## <a name="test-the-application"></a>Тестирование приложения

1. Нажмите клавишу **F5**.

2. Внесите изменения в данные одной или нескольких записей в каждой таблице.

3. Нажмите кнопку **Сохранить**.

4. Проверьте значения в базе данных и убедитесь, что изменения были сохранены.

## <a name="see-also"></a>См. также

- [Сохранение данных обратно в базу данных](../data-tools/save-data-back-to-the-database.md)