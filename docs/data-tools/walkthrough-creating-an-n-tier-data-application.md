---
title: Пошаговое руководство. Создание многоуровневого приложения для работы с данными
ms.date: 09/08/2017
ms.topic: conceptual
dev_langs:
- VB
- CSharp
helpviewer_keywords:
- n-tier applications, creating
- n-tier applications, walkthroughs
ms.assetid: d15e4d31-2839-48d9-9e0e-2e73404d82a2
author: jillre
ms.author: jillfra
manager: jillfra
ms.workload:
- data-storage
ms.openlocfilehash: 944825c00e55fcdb3a1a8f1f0c11d3a37a25025c
ms.sourcegitcommit: a8e8f4bd5d508da34bbe9f2d4d9fa94da0539de0
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 10/19/2019
ms.locfileid: "72639403"
---
# <a name="walkthrough-create-an-n-tier-data-application"></a>Пошаговое руководство. Создание n-уровневого приложения для данных
*N-уровневые* приложения для обработки данных — это приложения, которые осуществляют доступ к данным и разделены на несколько логических слоев или *уровней*. Разделение компонентов приложения на несколько отдельных уровней повышает удобство обслуживания и масштабируемость приложения. Это обеспечивается за счет упрощения внедрения новых технологий, которые можно применить к отдельному уровню без пересмотра всего решения. N-уровневая архитектура включает в себя уровень представления, средний уровень и уровень данных. Средний уровень обычно содержит слой доступа к данным, слой бизнес-логики и общие компоненты, такие как аутентификация и проверка. Уровень данных содержит реляционную базу данных. N-уровневые приложения обычно хранят конфиденциальную информацию на слое доступа к данным среднего уровня, чтобы обеспечить изоляцию от конечных пользователей, работающих с уровнем представления. Дополнительные сведения см. в статье [Общие сведения о N-уровневых приложениях данных](../data-tools/n-tier-data-applications-overview.md).

Один из способов разделения разных уровней в n-уровневом приложении заключается в создании отдельных проектов для каждого уровня, который требуется включить в приложение. Типизированные наборы данных содержат свойство `DataSet Project`, определяющее, в какие проекты следует передать созданный набор данных и код `TableAdapter`.

В данном пошаговом руководстве демонстрируется, как разделить набор данных и код `TableAdapter` по отдельным проектам библиотеки классов с помощью **конструктора наборов данных**. После разделения набора данных и кода TableAdapter вы создадите [Windows Communication Foundation служб и WCF Data Services в службе Visual Studio](../data-tools/windows-communication-foundation-services-and-wcf-data-services-in-visual-studio.md) для вызова уровня доступа к данным. Наконец, вы создадите Windows Forms приложение в качестве уровня представления. Этот уровень осуществляет доступ к данным из службы данных.

В этом пошаговом руководстве вы выполните следующие действия:

- Создание n-уровневого решения, содержащего несколько проектов.

- Добавление в n-уровневое решение двух проектов библиотеки классов.

- Создание типизированного набора данных с помощью **мастера настройки источника данных**.

- Разделите созданные [TableAdapter](create-and-configure-tableadapters.md) и код набора данных на отдельные проекты.

- Создание службы WCF для вызова уровня доступа к данным.

- Создание функций в службе для извлечения данных из уровня доступа к данным.

- Создание приложения Windows Forms для использования в качестве уровня представления.

- Создание элементов управления Windows Forms с привязкой к источнику данных.

- Написание кода для заполнения таблиц данных.

![ссылка на видео](../data-tools/media/playvideo.gif) видеоверсию этого раздела, см. в разделе [Video How to: Создание n-уровневого приложения для работы с данными](http://go.microsoft.com/fwlink/?LinkId=115188).

## <a name="prerequisites"></a>Необходимые компоненты
В этом пошаговом руководстве используется SQL Server Express LocalDB и образец базы данных Northwind.

1. Если у вас нет SQL Server Express LocalDB, установите его на [странице загрузки SQL Server Express](https://www.microsoft.com/sql-server/sql-server-editions-express)или с помощью **Visual Studio Installer**. В **Visual Studio Installer**можно установить SQL Server Express LocalDB как часть рабочей нагрузки **разработки классических приложений .NET** или как отдельный компонент.

2. Установите учебную базу данных Northwind, выполнив следующие действия.

    1. В Visual Studio откройте окно **Обозреватель объектов SQL Server** . (**Обозреватель объектов SQL Server** устанавливается как часть рабочей нагрузки **хранения и обработки данных** в Visual Studio Installer.) Разверните узел **SQL Server** . Щелкните правой кнопкой мыши экземпляр LocalDB и выберите **создать запрос**.

       Откроется окно редактора запросов.

    2. Скопируйте [скрипт Transact-SQL Northwind](https://github.com/MicrosoftDocs/visualstudio-docs/blob/master/docs/data-tools/samples/northwind.sql?raw=true) в буфер обмена. Этот сценарий T-SQL создает базу данных Northwind с нуля и заполняет ее данными.

    3. Вставьте скрипт T-SQL в редактор запросов, а затем нажмите кнопку **выполнить** .

       По истечении короткого времени выполнение запроса завершается и создается база данных Northwind.

## <a name="create-the-n-tier-solution-and-class-library-to-hold-the-dataset-dataentitytier"></a>Создание n-уровневого решения и библиотеки классов для хранения набора данных (DataEntityTier)
Первым шагом данного руководства является создание решения и двух проектов библиотеки классов. Первая библиотека классов содержит набор данных (созданный типизированный `DataSet` класс и DataTables, которые содержат данные приложения). Этот проект используется в качестве слоя сущностей данных приложения и обычно находится в среднем уровне. Набор данных создает исходный набор данных и автоматически разделяет код на две библиотеки классов.

> [!NOTE]
> Обязательно присвойте проекту и решению правильные имена перед нажатием кнопки **ОК**. Это облегчит выполнение данного пошагового руководства.

### <a name="to-create-the-n-tier-solution-and-dataentitytier-class-library"></a>Создание n-уровневого решения и библиотеки классов DataEntityTier

1. В Visual Studio в меню **файл** выберите пункт **создать**  > **проект**.

2. Разверните **визуальный C#**  элемент или **Visual Basic** на левой панели, а затем выберите **Windows Desktop**.

3. В средней области выберите тип проекта **Библиотека классов** .

4. Присвойте проекту имя **DataEntityTier**.

5. Присвойте решению имя **NTierWalkthrough**и нажмите кнопку **ОК**.

     Создается решение NTierWalkthrough, содержащее проект DataEntityTier, которое добавляется в **Обозреватель решений**.

## <a name="create-the-class-library-to-hold-the-tableadapters-dataaccesstier"></a>Создание библиотеки классов для хранения адаптеров таблиц (DataAccessTier)
Следующий наг после создания проекта DataEntityTier заключается в создании другого проекта библиотеки классов. Этот проект содержит созданные адаптеры таблиц и называется *уровнем доступа к данным* приложения. Уровень доступа к данным содержит информацию, необходимую для подключения к базе данных, и обычно находится на среднем уровне.

### <a name="to-create-a-separate-class-library-for-the-tableadapters"></a>Создание отдельной библиотеки классов для адаптеров таблиц TableAdapter

1. В **обозревателе решений** щелкните решение правой кнопкой мыши и выберите **Добавить** > **Создать проект**.

2. В средней области диалогового окна **Новый проект** выберите пункт **Библиотека классов**.

3. Назовите проект **DataAccessTier** и нажмите кнопку **ОК**.

     Создается проект DataAccessTier, который добавляется в решение NTierWalkthrough.

## <a name="create-the-dataset"></a>Создание набора данных
Следующим шагом является создание типизированного набора данных. Типизированные наборы данных создаются с помощью класса DataSet (включая `DataTables` классы) и классов `TableAdapter` в одном проекте. (Все классы создаются в одном файле.) Если набор данных и адаптеры таблиц разделяются на разные проекты, то это класс набора данных, который перемещается в другой проект, в результате чего `TableAdapter` классы в исходном проекте. Поэтому создайте набор данных в проекте, который в конечном итоге будет содержать адаптеры таблиц (проект DataAccessTier). Набор данных создается с помощью **мастера настройки источника данных**.

> [!NOTE]
> Для создания подключения необходимо иметь доступ к учебной базе данных "Борей". Дополнительные сведения о настройке образца базы данных Northwind см. [в разделе как установить образцы баз](../data-tools/installing-database-systems-tools-and-samples.md)данных.

### <a name="to-create-the-dataset"></a>Создание набора данных

1. Выберите **DataAccessTier** в **Обозреватель решений**.

2. В меню **данные** выберите команду **отобразить источники данных**.

   Открывается окно **Источники данных**.

3. В окне **Источники данных** выберите **Добавить новый источник данных**, чтобы запустить **Мастер настройки источника данных**.

4. На странице **Выбор типа источника данных** выберите **база данных** , а затем нажмите кнопку **Далее**.

5. На странице **Выбор подключения к базе данных** выполните одно из следующих действий:

     Если подключение к учебной базе данных Northwind доступно в раскрывающемся списке, то выберите его.

     \- или -

     Выберите **создать соединение** , чтобы открыть диалоговое окно **Добавление соединения** .

6. Если базе данных требуется пароль, выберите параметр, чтобы включить конфиденциальные данные, а затем нажмите кнопку **Далее**.

    > [!NOTE]
    > Если вы выбрали файл локальной базы данных (вместо подключения к SQL Server), может отображаться запрос о том, требуется ли включить этот файл в проект. Нажмите кнопку **Да** , чтобы добавить файл базы данных в проект.

7. Нажмите кнопку **Далее** на странице **Сохранение строки подключения в файле конфигурации приложения** .

8. Разверните узел **Таблицы** на странице **Выбор объектов базы данных** .

9. Установите флажки для таблиц **Customers** и **Orders** , а затем нажмите кнопку **Готово**.

     NorthwindDataSet добавляется в проект DataAccessTier и отображается в окне **Источники данных**.

## <a name="separate-the-tableadapters-from-the-dataset"></a>Отделение адаптеров таблиц от набора данных
После создания набора данных отделите сформированный класс набора данных от адаптеров таблицы. Для этого задайте для свойства **Проект DataSet** имя проекта, в котором требуется хранить отделенный класс набора данных.

### <a name="to-separate-the-tableadapters-from-the-dataset"></a>Порядок отделения адаптеров таблиц от набора данных

1. Дважды щелкните **NorthwindDataSet.xsd** в **обозревателе решений**, чтобы открыть набор данных в **конструкторе наборов данных**.

2. Выберите пустую область в конструкторе.

3. Найдите узел **Проект DataSet** в окне **Свойства**.

4. В списке **проект набора данных** выберите **DataEntityTier**.

5. В меню **Сборка** выберите команду **Собрать решение**.

   Набор данных и адаптеры таблицы делятся на два проекта библиотеки классов. Проект, изначально содержащий весь набор данных (`DataAccessTier`), теперь содержит только адаптеры таблиц. Проект, указанный в свойстве **проекта набора данных** (`DataEntityTier`), содержит типизированный набор данных: *NorthwindDataSet. DataSet. Designer. vb* (или *NorthwindDataSet.DataSet.Designer.CS*).

> [!NOTE]
> При разделении наборов данных и адаптеров таблиц (посредством установки свойства **Проект DataSet**) существующие разделяемые классы наборов данных в проекте не перемещаются автоматически. Их необходимо переместить в проект набора данных вручную.

## <a name="create-a-new-service-application"></a>Создание нового приложения службы
В этом пошаговом руководстве показано, как получить доступ к уровню доступа к данным с помощью службы WCF, поэтому создадим новое приложение службы WCF.

### <a name="to-create-a-new-wcf-service-application"></a>Создание нового приложения службы WCF

1. В **обозревателе решений** щелкните решение правой кнопкой мыши и выберите **Добавить** > **Создать проект**.

2. В диалоговом окне **Новый проект** в области слева выберите **WCF**. В средней области выберите пункт **Библиотека службы WCF**.

3. Назовите **службу** Project и нажмите кнопку **ОК**.

     Создается проект DataService, который добавляется в решение NTierWalkthrough.

## <a name="create-methods-in-the-data-access-tier-to-return-the-customers-and-orders-data"></a>Создание методов на уровне доступа к данным для получения данных о клиентах и заказах
Служба данных должна вызывать два метода на уровне доступа к данным: `GetCustomers` и `GetOrders`. Эти методы возвращают `Customers` и `Orders` таблицы Northwind. Создайте методы `GetCustomers` и `GetOrders` в проекте `DataAccessTier`.

### <a name="to-create-a-method-in-the-data-access-tier-that-returns-the-customers-table"></a>Создание метода на уровне доступа к данным, возвращающего таблицу клиентов

1. В **Обозреватель решений**дважды щелкните **NorthwindDataSet. xsd** , чтобы открыть набор данных.

2. Щелкните правой кнопкой мыши **CustomersTableAdapter** и выберите команду **Добавить запрос**.

3. На странице **Выбор типа команды** оставьте значение по умолчанию для параметра **Использовать инструкции SQL** и нажмите кнопку **Далее**.

4. На странице **Выбор типа запроса** оставьте значение по умолчанию для параметра **Инструкция SELECT, возвращающая строки** и нажмите кнопку **Далее**.

5. На странице **Укажите SQL-инструкцию SELECT** оставьте запрос по умолчанию и нажмите кнопку **Далее**.

6. На странице **Выбор методов для автоматического создания** введите **GetCustomers** для параметра **Имя метода** в разделе **Вернуть таблицу данных (DataTable)** .

7. Нажмите кнопку **Готово**.

### <a name="to-create-a-method-in-the-data-access-tier-that-returns-the-orders-table"></a>Создание метода на уровне доступа к данным, возвращающего таблицу заказов

1. Щелкните правой кнопкой мыши элемент **OrdersTableAdapter** и выберите пункт **Добавить запрос**.

2. На странице **Выбор типа команды** оставьте значение по умолчанию для параметра **Использовать инструкции SQL** и нажмите кнопку **Далее**.

3. На странице **Выбор типа запроса** оставьте значение по умолчанию для параметра **Инструкция SELECT, возвращающая строки** и нажмите кнопку **Далее**.

4. На странице **Укажите SQL-инструкцию SELECT** оставьте запрос по умолчанию и нажмите кнопку **Далее**.

5. На странице **Выбор методов для автоматического создания** введите **GetOrders** для параметра **Имя метода** в разделе **Вернуть таблицу данных (DataTable)** .

6. Нажмите кнопку **Готово**.

7. В меню **Сборка** выберите **Собрать решение**.

## <a name="add-a-reference-to-the-data-entity-and-data-access-tiers-to-the-data-service"></a>Добавление в службу данных ссылок на сущности данных и уровни доступа к данным
Так как службе данных нужна информация из набора данных и адаптеров таблицы, добавьте ссылки на проекты **DataEntityTier** и **DataAccessTier**.

### <a name="to-add-references-to-the-data-service"></a>Добавление ссылок в службу данных

1. Щелкните правой кнопкой мыши **DataService** в **обозревателе решений** и выберите команду **Добавить ссылку**.

2. Откройте вкладку **Проекты** в диалоговом окне **Добавление ссылки**.

3. Выберите проекты **DataAccessTier** и **DataEntityTier**.

4. Нажмите кнопку **ОК**.

## <a name="add-functions-to-the-service-to-call-the-getcustomers-and-getorders-methods-in-the-data-access-tier"></a>Добавление функций в службу для вызова методов Customers и Methods уровня доступа к данным
Теперь, когда уровень доступа к данным содержит методы для возврата данных, создайте в службе данных методы для вызова методов на уровне доступа к данным.

> [!NOTE]
> Для проектов C# необходимо добавить ссылку на сборку `System.Data.DataSetExtensions`, чтобы следующий код прошел компиляцию.

### <a name="to-create-the-getcustomers-and-getorders-functions-in-the-data-service"></a>Создание функций GetCustomers и GetOrders в службе данных

1. В проекте **DataService** дважды щелкните **IService1.vb** или **IService1.cs**.

2. Добавьте следующий код под комментарием **Добавьте здесь операции служб**:

    ```vb
    <OperationContract()> _
    Function GetCustomers() As DataEntityTier.NorthwindDataSet.CustomersDataTable

    <OperationContract()> _
    Function GetOrders() As DataEntityTier.NorthwindDataSet.OrdersDataTable
    ```

    ```csharp
    [OperationContract]
    DataEntityTier.NorthwindDataSet.CustomersDataTable GetCustomers();

    [OperationContract]
    DataEntityTier.NorthwindDataSet.OrdersDataTable GetOrders();
    ```

3. В проекте DataService дважды щелкните **Service1.vb** (или **Service1.cs**).

4. Добавьте следующий код в класс **Service1**:

    ```vb
    Public Function GetCustomers() As DataEntityTier.NorthwindDataSet.CustomersDataTable Implements IService1.GetCustomers
        Dim CustomersTableAdapter1 As New DataAccessTier.NorthwindDataSetTableAdapters.CustomersTableAdapter
        Return CustomersTableAdapter1.GetCustomers()
    End Function

    Public Function GetOrders() As DataEntityTier.NorthwindDataSet.OrdersDataTable Implements IService1.GetOrders
        Dim OrdersTableAdapter1 As New DataAccessTier.NorthwindDataSetTableAdapters.OrdersTableAdapter
        Return OrdersTableAdapter1.GetOrders()
    End Function
    ```

    ```csharp
    public DataEntityTier.NorthwindDataSet.CustomersDataTable GetCustomers()
    {
        DataAccessTier.NorthwindDataSetTableAdapters.CustomersTableAdapter
             CustomersTableAdapter1
            = new DataAccessTier.NorthwindDataSetTableAdapters.CustomersTableAdapter();
        return CustomersTableAdapter1.GetCustomers();
    }
    public DataEntityTier.NorthwindDataSet.OrdersDataTable GetOrders()
    {
        DataAccessTier.NorthwindDataSetTableAdapters.OrdersTableAdapter
             OrdersTableAdapter1
            = new DataAccessTier.NorthwindDataSetTableAdapters.OrdersTableAdapter();
        return OrdersTableAdapter1.GetOrders();
    }
    ```

5. В меню **Сборка** выберите **Собрать решение**.

## <a name="create-a-presentation-tier-to-display-data-from-the-data-service"></a>Создание уровня представления для отображения данных из службы данных
Теперь, когда решение содержит службу данных, содержащую методы, которые вызывают уровень доступа к данным, создайте другой проект, который вызывает службу данных и предоставляет пользователям данные. В рамках данного руководства создайте приложение Windows Forms — это уровень представления n-уровневого приложения.

### <a name="to-create-the-presentation-tier-project"></a>Создание проекта уровня представления

1. В **обозревателе решений** щелкните решение правой кнопкой мыши и выберите **Добавить** > **Создать проект**.

2. В диалоговом окне **Новый проект** в области слева выберите **Рабочий стол Windows**. В средней области выберите **Windows Forms приложение**.

3. Присвойте проекту имя **PresentationTier** и нажмите кнопку **ОК**.

    Создается проект PresentationTier, который добавляется в решение NTierWalkthrough.

## <a name="set-the-presentationtier-project-as-the-startup-project"></a>Задание проекта PresentationTier в качестве запускаемого проекта
Мы установим проект **PresentationTier** в качестве запускаемого проекта для решения, так как это реальное клиентское приложение, которое представляет и взаимодействует с данными.

### <a name="to-set-the-new-presentation-tier-project-as-the-startup-project"></a>Порядок настройки нового проекта уровня представления в качестве запускаемого

- В **обозревателе решений** щелкните правой кнопкой мыши **PresentationTier** и выберите команду **Назначить запускаемым проектом**.

## <a name="add-references-to-the-presentation-tier"></a>Добавление ссылок на уровень представления
Клиентскому приложению PresentationTier требуется ссылка на службу в службе данных для получения доступа к методам в этой службе. Кроме того, требуется ссылка на набор данных для обеспечения совместного использования типов службой WCF. Пока вы не включите совместное использование типов через службу данных, код, добавленный в класс частичного набора данных, недоступен для уровня представления. Так как обычно добавляется код, например код проверки, в события изменения строк и столбцов таблицы данных, скорее всего, вам потребуется получить доступ к этому коду из клиента.

### <a name="to-add-a-reference-to-the-presentation-tier"></a>Добавление ссылки на уровень представления

1. В **Обозреватель решений**щелкните правой кнопкой мыши узел **PresentationTier** и выберите команду **Добавить ссылку**.

2. В диалоговом окне **Добавление ссылки** перейдите на вкладку **проекты** .

3. Выберите **DataEntityTier** и нажмите кнопку **ОК**.

### <a name="to-add-a-service-reference-to-the-presentation-tier"></a>Добавление ссылки на службу на уровень представления

1. В **Обозреватель решений**щелкните правой кнопкой мыши узел **PresentationTier** и выберите **Добавление ссылки на службу**.

2. В диалоговом окне **Добавление ссылки на службу** выберите **Обнаружение**.

3. Выберите **Service1** и нажмите кнопку **ОК**.

    > [!NOTE]
    > Если на текущем компьютере имеется несколько служб, выберите службу, созданную ранее в этом пошаговом руководстве (служба, которая содержит методы `GetCustomers` и `GetOrders`).

## <a name="add-datagridviews-to-the-form-to-display-the-data-returned-by-the-data-service"></a>Добавление в форму элементов GridView для вывода данных, возвращаемых службой данных
После добавления ссылки на службу в службу данных окно **Источники данных** автоматически заполняется возвращенными службой данными.

### <a name="to-add-two-data-bound-datagridviews-to-the-form"></a>Создание двух элементов DataGridView с привязкой к данным на форме

1. Выберите проект **PresentationTier** в **обозревателе решений**.

2. В окне **Источники данных** разверните **NorthwindDataSet** и найдите узел **Customers**.

3. Перетащите узел **Customers** на форму Form1.

4. В окне **Источники данных** разверните узел **Customers** и найдите связанный узел **Orders** (узел **Orders** вложен в узел **Customers**).

5. Перетащите связанный узел **Orders** на форму Form1.

6. Создайте обработчик событий `Form1_Load`, дважды щелкнув пустую область на форме.

7. Добавьте следующий код в обработчик событий `Form1_Load`.

    ```vb
    Dim DataSvc As New ServiceReference1.Service1Client
    NorthwindDataSet.Customers.Merge(DataSvc.GetCustomers)
    NorthwindDataSet.Orders.Merge(DataSvc.GetOrders)
    ```

    ```csharp
    ServiceReference1.Service1Client DataSvc =
        new ServiceReference1.Service1Client();
    northwindDataSet.Customers.Merge(DataSvc.GetCustomers());
    northwindDataSet.Orders.Merge(DataSvc.GetOrders());
    ```

## <a name="increase-the-maximum-message-size-allowed-by-the-service"></a>Увеличение максимального размера сообщения, разрешенного службой
Значение по умолчанию для `maxReceivedMessageSize` недостаточно велико для хранения данных, полученных из `Customers` и `Orders` таблиц. В следующих шагах вы увеличите значение до 6553600. Вы изменяете значение на клиенте, которое автоматически обновляет ссылку на службу.

> [!NOTE]
> Меньший размер по умолчанию призван ограничить уязвимость для атак типа "отказ в обслуживании" (DoS). Для получения дополнительной информации см. <xref:System.ServiceModel.WSHttpBindingBase.MaxReceivedMessageSize%2A>.

### <a name="to-increase-the-maxreceivedmessagesize-value"></a>Увеличение значения maxReceivedMessageSize

1. В **обозревателе** решений дважды щелкните файл **app.config** в проекте **PresentationTier**.

2. Найдите атрибут размера **maxReceivedMessage** и измените его значение на `6553600`.

## <a name="test-the-application"></a>Тестирование приложения
Запустите приложение, нажав клавишу **F5**. Данные из таблиц `Customers` и `Orders` извлекаются из службы данных и отображаются в форме.

## <a name="next-steps"></a>Следующие шаги
В зависимости от требований приложения существуют несколько шагов, которые, возможно, потребуется выполнить после сохранения связанных данных в приложении Windows. Ниже приводится перечень рекомендаций, позволяющих улучшить данное приложение.

- Добавьте проверку в набор данных.

- Добавьте в службу дополнительные методы для обновления данных в базе данных.

## <a name="see-also"></a>См. также

- [Работа с наборами данных в N-уровневых приложениях](../data-tools/work-with-datasets-in-n-tier-applications.md)
- [Иерархическое обновление](../data-tools/hierarchical-update.md)
- [Доступ к данным в Visual Studio](../data-tools/accessing-data-in-visual-studio.md)