---
title: Настройка поведения вставки, обновления и удаления классов сущностей
ms.date: 11/04/2016
ms.topic: conceptual
dev_langs:
- VB
- CSharp
ms.assetid: 03ff1146-706e-4780-91cb-56a83df63eea
author: gewarren
ms.author: gewarren
manager: jillfra
ms.workload:
- data-storage
ms.openlocfilehash: cb6bbde145317d737afdbf819dba8ee53f805f72
ms.sourcegitcommit: e98db44f3a33529b0ba188d24390efd09e548191
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 09/25/2019
ms.locfileid: "71252969"
---
# <a name="walkthrough-customize-the-insert-update-and-delete-behavior-of-entity-classes"></a>Пошаговое руководство. Настройка операций вставки, обновления и удаления в классах сущностей

[Средства LINQ to SQL в Visual Studio](../data-tools/linq-to-sql-tools-in-visual-studio2.md) предоставляют визуальную область конструктора для создания и редактирования классов LINQ to SQL (классов сущностей), основанных на объектах в базе данных. С помощью [LINQ to SQL](/dotnet/framework/data/adonet/sql/linq/index)можно использовать технологию LINQ для доступа к базам данных SQL. Дополнительные сведения см. в разделе [Встроенный язык запросов LINQ](/dotnet/csharp/linq/).

По умолчанию логика для выполнения обновлений предоставляется средой выполнения LINQ to SQL. Среда выполнения создает по `Insert`умолчанию инструкции `Delete` , `Update`и, основанные на схеме таблицы (определения столбцов и сведения о первичном ключе). Если вы не хотите использовать поведение по умолчанию, то можно настроить поведение обновления и назначить конкретные сохраненные процедуры для выполнения команд "Вставить", "Обновить" и "Удалить", необходимых для работы с данными в базе данных. Можно также сделать это, когда поведение по умолчанию не сгенерировано, например, когда ваши классы сущностей сопоставляются с представлениями. Кроме того, можно отменить поведение обновления по умолчанию, когда база данных требует доступа к таблице через сохраненные процедуры. Дополнительные сведения см. в разделе [Настройка операций с помощью хранимых процедур](/dotnet/framework/data/adonet/sql/linq/customizing-operations-by-using-stored-procedures).

> [!NOTE]
> Данное пошаговое руководство требует наличия хранимых процедур **InsertCustomer**, **UpdateCustomer** и **DeleteCustomer** в базе данных Northwind.

В этом пошаговом руководстве описаны действия, которые необходимо выполнить, чтобы переопределить поведение по умолчанию LINQ to SQL времени выполнения для сохранения данных обратно в базу данных с помощью хранимых процедур.

В ходе этого пошагового руководства вы узнаете, как выполнять следующие задачи:

- Создайте новое приложение Windows Forms и добавьте в него файл LINQ to SQL.

- Создайте класс сущности, сопоставленный с таблицей `Customers` Northwind.

- Создайте источник данных объекта, который ссылается на класс `Customer` LINQ to SQL.

- Создайте форму Windows Forms, которая <xref:System.Windows.Forms.DataGridView> содержит объект, привязанный `Customer` к классу.

- Реализуйте для формы функциональные возможности сохранения.

- Создайте <xref:System.Data.Linq.DataContext> методы, добавив хранимые процедуры в **конструктор O/R**.

- `Customer` Настройте класс для использования хранимых процедур для выполнения операций вставки, обновления и удаления.

## <a name="prerequisites"></a>Предварительные требования

В этом пошаговом руководстве используется SQL Server Express LocalDB и образец базы данных Northwind.

1. Если у вас нет SQL Server Express LocalDB, установите его на [странице загрузки SQL Server Express](https://www.microsoft.com/sql-server/sql-server-editions-express)или с помощью **Visual Studio Installer**. В **Visual Studio Installer**можно установить SQL Server Express LocalDB как часть рабочей нагрузки **хранения и обработки данных** или как отдельный компонент.

2. Установите учебную базу данных Northwind, выполнив следующие действия.

    1. В Visual Studio откройте окно **Обозреватель объектов SQL Server** . (**Обозреватель объектов SQL Server** устанавливается как часть рабочей нагрузки **хранения и обработки данных** в **Visual Studio Installer**.) Разверните узел **SQL Server** . Щелкните правой кнопкой мыши экземпляр LocalDB и выберите **создать запрос**.

       Откроется окно редактора запросов.

    2. Скопируйте [скрипт Transact-SQL Northwind](https://github.com/MicrosoftDocs/visualstudio-docs/blob/master/docs/data-tools/samples/northwind.sql?raw=true) в буфер обмена. Этот сценарий T-SQL создает базу данных Northwind с нуля и заполняет ее данными.

    3. Вставьте скрипт T-SQL в редактор запросов, а затем нажмите кнопку **выполнить** .

       По истечении короткого времени выполнение запроса завершается и создается база данных Northwind.

## <a name="creating-an-application-and-adding-linq-to-sql-classes"></a>Создание приложения и добавление классов LINQ to SQL

Поскольку вы работаете с LINQ to SQL классами и отображением данных в Windows Forms, создайте новое приложение Windows Forms и добавьте файл LINQ to SQL Classes.

[!INCLUDE[note_settings_general](../data-tools/includes/note_settings_general_md.md)]

### <a name="to-create-a-new-windows-forms-application-project-that-contains-linq-to-sql-classes"></a>Создание нового проекта Windows Forms приложения, содержащего классы LINQ to SQL

1. В Visual Studio в меню **файл** выберите пункт **создать** > **проект**.

2. Разверните **визуальный C#**  элемент или **Visual Basic** на левой панели, а затем выберите **Windows Desktop**.

3. В средней области выберите тип проекта **приложения Windows Forms** .

4. Назовите проект **UpdatingWithSProcsWalkthrough**и нажмите кнопку **ОК**.

     Проект **UpdatingwithSProcsWalkthrough** создается и добавляется в **Обозреватель решений**.

4. В меню **Проект** выберите пункт **Добавить новый элемент**.

5. Выберите шаблон **Классы LINQ to SQL** и введите **Northwind.dbml** в поле **Имя**.

6. Нажмите кнопку **Добавить**.

     В проект добавляется пустой файл LINQ to SQL Classes (**Northwind. dbml**), и открывается **конструктор O/R** .

## <a name="create-the-customer-entity-class-and-object-data-source"></a>Создание класса сущности Customer и источника данных объекта

Создайте LINQ to SQL классы, сопоставленные с таблицами базы данных, перетащив таблицы из **Обозреватель сервера** или **Обозреватель базы данных** в **конструктор O/R**. В результате получите классы сущностей LINQ to SQL, которые сопоставляются с таблицами базы данных. После создания классов сущностей, их можно использовать в качестве источников данных об объекте точно так же как другие классы, которые имеют общие свойства

### <a name="to-create-a-customer-entity-class-and-configure-a-data-source-with-it"></a>Для создания класса сущностей Customer и настройки с ним источника данных

1. В **Обозреватель сервера** или **Обозреватель базы данных**выберите таблицу **Customer** в SQL Server версии образца базы данных Northwind.

2. Перетащите узел **Customers (клиенты** ) из **Обозреватель сервера** или **Обозреватель базы данных** в область **конструктор O/R* .

     Создастся класс сущностей с именем **Customer**. Он имеет свойства, соответствующие столбцам в таблице Customers. Класс сущностей имеет имя **Customer** (не **Customers**), поскольку он представляет одного клиента из таблицы Customers.

    > [!NOTE]
    > Такой метод переименования называется *преобразованием во множественную форму*. Его можно включить или отключить в [диалоговом окне Параметры](../ide/reference/options-dialog-box-visual-studio.md). Дополнительные сведения см. в разделе [Практическое руководство. включить и отключить преобразование во множественную форму (реляционный конструктор объектов)](../data-tools/how-to-turn-pluralization-on-and-off-o-r-designer.md).

3. В меню **Build** щелкните пункт **Build UpdatingwithSProcsWalkthrough** для создания проекта.

4. Чтобы открыть окно **Источники данных** , в меню **данные** выберите команду **отобразить источники данных**.

5. В окне **Источники данных** выберите **Добавить новый источник данных**.

6. На странице **Выбор типа источника данных** выберите **Объект** и нажмите кнопку **Далее**.

7. Разверните узел **UpdatingwithSProcsWalkthrough** и найдите и выберите класс **Customer**.

    > [!NOTE]
    > Если класс **Customer** недоступен, отмените работу мастера, выполните сборку проекта и снова запустите мастер.
8. Нажмите кнопку **Готово** для создания источника данных и добавления класса сущности **Customer** в окно **Источники данных**.

## <a name="create-a-datagridview-to-display-the-customer-data-on-a-windows-form"></a>Создание элемента DataGridView для вывода данных о клиентах в Windows Forms

Создавайте элементы управления, привязанные к классам сущностей, перетаскивая LINQ to SQL элементы источника данных из окна **Источники данных** в форму Windows Forms.

### <a name="to-add-controls-that-are-bound-to-the-entity-classes"></a>Для добавления элементов управления, привязанных к классам сущностей

1. Откройте форму **Form1** в конструкторе.

2. Из окна **Источники данных** перетащите узел **Customer** на форму **Form1**.

    > [!NOTE]
    > Чтобы открыть окно **Источники данных**, выберите в меню **Данные** команду **Показать источники данных**.

3. Откройте форму **Form1** в редакторе кода.

4. Добавьте следующий код в форму Global для формы за пределами какого бы то `Form1` ни было конкретного метода, но внутри класса:

    ```vb
    Private NorthwindDataContext1 As New NorthwindDataContext
    ```

    ```csharp
    private NorthwindDataContext northwindDataContext1
        = new NorthwindDataContext();
    ```

5. Создайте обработчик события для события `Form_Load` и добавьте в обработчик следующий код:

    ```vb
    CustomerBindingSource.DataSource = NorthwindDataContext1.Customers
    ```

    ```csharp
    customerBindingSource.DataSource
        = northwindDataContext1.Customers;
    ```

## <a name="implement-save-functionality"></a>Реализация функции сохранения

По умолчанию опция создания кнопки Сохранить не активизирована и реализовать сохранение функциональных возможностей невозможно. Итак, код для сохранения измененных данных в базе данных, когда создаются привязанные к данным элементы управления для источников данных об объекте, не будет автоматически добавляться. В этом разделе объясняется, как включить кнопку Сохранить и реализовать функции сохранения для LINQ to SQL объектов.

### <a name="to-implement-save-functionality"></a>Для реализации кнопки Save Functionality (Сохранить функциональные возможности)

1. Откройте форму **Form1** в конструкторе.

2. Выберите кнопку Сохранить на **CustomerBindingNavigator** (кнопка, на которой изображена дискета).

3. В окне **Свойства** задайте для свойства **Включено** значение **True**.

4. Дважды щелкните кнопку сохранить, чтобы создать обработчик события и переключиться в редактор кода.

5. Добавьте в обработчик события для кнопки Сохранить следующий код:

    ```vb
    NorthwindDataContext1.SubmitChanges()
    ```

    ```csharp
    northwindDataContext1.SubmitChanges();
    ```

## <a name="override-the-default-behavior-for-performing-updates-inserts-updates-and-deletes"></a>Переопределение поведения по умолчанию для выполнения обновлений (вставки, обновления и удаления)

### <a name="to-override-the-default-update-behavior"></a>Для переопределения поведения по умолчанию при обновлении

1. Откройте файл LINQ to SQL в **конструкторе O/R**. (Дважды щелкните по файлу **Northwind.dbml** в **Обозревателе решений**.)

2. В **Обозревателе сервера** или **Обозревателе базы данных** разверните узел баз данных Northwind **Хранимые процедуры** найдите хранимые процедуры **InsertCustomers**, **UpdateCustomers** и **DeleteCustomers**.

3. Перетащите все три хранимые процедуры в **конструктор O/R**.

     Сохраненные процедуры добавляются в дерево методов как методы <xref:System.Data.Linq.DataContext>. Дополнительные сведения см. в разделе [методы DataContext (реляционный конструктор R)](../data-tools/datacontext-methods-o-r-designer.md).

4. Выберите класс сущности **Customer** в **конструкторе объектов O/R**.

5. В окне **Свойства** выберите свойство **Вставка**.

6. Нажмите кнопку с многоточием ( **...** ) рядом с кнопкой **Использовать среду выполнения**, чтобы открыть диалоговое окно **Настройка поведения**.

7. Выберите **Настроить**.

8. Выберите метод **InsertCustomers** в списке **Настроить**.

9. Нажмите кнопку **Применить**, чтобы сохранить конфигурацию для выбранного класса и поведения.

    > [!NOTE]
    > Можно продолжить настройку поведения для каждого сочетания класса и поведения при условии, что после каждого изменения будет производиться нажатие кнопки **Применить**. Если изменить класс или поведение до нажатия кнопки **Применить**, появится диалоговое окно с предупреждением, в котором можно будет применить любые изменения.

10. Выберите **Обновить** в списке **Поведение**.

11. Выберите **Настроить**.

12. Выберите метод **UpdateCustomers** в списке **Настроить**.

     Проверьте список **Аргументы метода** и **Свойства класса** и укажите, что для некоторых столбцов в таблице имеется два списка **Аргументы метода** и два списка **Свойства класса**. Это облегчает возможность прослеживать изменения и создавать инструкции, которые проверяют нарушения параллелизма.

13. Сопоставьте аргумент метода **Original_CustomerID** свойству класса **CustomerID (Original)** .

    > [!NOTE]
    > По умолчанию аргументы метода будут сопоставлены со свойствами класса, если их имена совпадают. Если имена свойств были изменены и больше не совпадают в таблице и в классе сущностей, то может потребоваться выбор эквивалентного свойства класса для сопоставления, если **реляционный конструктор объектов** не может определить правильное сопоставление. Кроме того, если отсутствуют допустимые свойства класса для сопоставления с аргументами метода, то можно установить **Свойства класса** в значение **(Нет)** .

14. Нажмите кнопку **Применить**, чтобы сохранить конфигурацию для выбранного класса и поведения.

15. Выберите **Удалить** в списке **Поведение**.

16. Выберите **Настроить**.

17. Выберите метод **DeleteCustomers** в списке **Настроить**.

18. Сопоставьте аргумент метода **Original_CustomerID** свойству класса **CustomerID (Original)** .

19. Нажмите кнопку **ОК**.

> [!NOTE]
> Хотя это и не является проблемой в этом конкретном пошаговом руководстве, стоит отметить, что LINQ to SQL обрабатывает значения, сформированные базой данных, автоматически для идентификации (автоприращения), ROWGUIDCOL (идентификатор GUID, сформированный базой данных) и столбцов меток времени во время вставки и обновляем. Генерируемые базой данных значения в других типах столбцов будут неожиданно давать нулевое значение. Чтобы возвращать значения, создаваемые базой данных, следует вручную установить свойство <xref:System.Data.Linq.Mapping.ColumnAttribute.IsDbGenerated%2A> в значение `true`, а свойство <xref:System.Data.Linq.Mapping.ColumnAttribute.AutoSync%2A> — в одно из следующих значений: [Автосинхронизация. всегда](<xref:System.Data.Linq.Mapping.AutoSync.Always>), [Автосинхронизация. OnInsert](<xref:System.Data.Linq.Mapping.AutoSync.OnInsert>)или [Автосинхронизация. OnInsert](<xref:System.Data.Linq.Mapping.AutoSync.OnUpdate>).

## <a name="test-the-application"></a>Тестирование приложения

Снова запустите приложение, чтобы убедиться, что хранимая процедура **UpdateCustomers** правильно обновляет запись клиента в базе данных.

1. Нажмите клавишу **F5**.

2. Измените запись в таблице, чтобы проверить поведение обновления.

3. Добавьте новую запись, чтобы проверить поведение вставки.

4. Нажмите кнопку Сохранить, чтобы сохранить изменения в базе данных.

5. Закройте форму.

6. Нажмите клавишу **F5** и убедитесь, что обновленная запись и недавно вставленная запись сохранились.

7. Удалите новую запись, созданную в шаге 3, чтобы проверить поведение удаления.

8. Нажмите кнопку "Сохранить", чтобы представить изменения и стереть удаленную запись из базы данных.

9. Закройте форму.

10. Нажмите клавишу **F5** и убедитесь, что удаленная запись была стерта из базы данных.

    > [!NOTE]
    > Если в приложении используется SQL Server Express Edition, то в зависимости от свойства **Копировать в выходной каталог** файла базы данных изменения могут не отображаться, когда на шаге 10 нажимается клавиша **F5**.

## <a name="next-steps"></a>Следующие шаги

В зависимости от требований приложения существует несколько шагов, которые может потребоваться выполнить после создания LINQ to SQL классов сущностей. Ниже приводится перечень рекомендаций, позволяющих улучшить данное приложение.

- Реализуйте конкурентную проверку во время обновлений. Дополнительные сведения см. в разделе [оптимистичный параллелизм: обзор](/dotnet/framework/data/adonet/sql/linq/optimistic-concurrency-overview).

- Добавьте запросы LINQ в данные фильтра Дополнительные сведения см. [в разделе Введение в запросыC#LINQ ()](/dotnet/csharp/programming-guide/concepts/linq/introduction-to-linq-queries).

## <a name="see-also"></a>См. также

- [Средства LINQ to SQL в Visual Studio](../data-tools/linq-to-sql-tools-in-visual-studio2.md)
- [Методы DataContext](../data-tools/datacontext-methods-o-r-designer.md)
- [Практическое руководство. Назначение хранимых процедур для выполнения обновлений, вставок и удалений](../data-tools/how-to-assign-stored-procedures-to-perform-updates-inserts-and-deletes-o-r-designer.md)
- [LINQ to SQL](/dotnet/framework/data/adonet/sql/linq/index)
- [Запросы LINQ to SQL](/dotnet/framework/data/adonet/sql/linq/linq-to-sql-queries)