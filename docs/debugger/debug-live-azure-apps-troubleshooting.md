---
title: Устранение неполадок отладки моментальных снимков | Документация Майкрософт
ms.custom: ''
ms.date: 04/24/2019
ms.topic: troubleshooting
helpviewer_keywords:
- debugger
ms.assetid: 511a0697-c68a-4988-9e29-8d0166ca044a
author: mikejo5000
ms.author: mikejo
manager: jillfra
ms.workload:
- multiple
ms.openlocfilehash: 1ee8633a9ad58981297f00338cd6c375c5cf721e
ms.sourcegitcommit: ea182703e922c74725045afc251bcebac305068a
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 09/24/2019
ms.locfileid: "71211239"
---
# <a name="troubleshooting-and-known-issues-for-snapshot-debugging-in-visual-studio"></a>Устранение неполадок и известные проблемы отладки моментальных снимков в Visual Studio

Если действия, описанные в этой статье, не помогли устранить проблему, выполните поиск проблемы в [сообществе разработчиков](https://developercommunity.visualstudio.com/spaces/8/index.html) или сообщите о новой проблеме, выбрав **Справка** > **Отправить отзыв** > **сообщить о проблеме** в Visual Studio.

## <a name="issue-attach-snapshot-debugger-encounters-an-http-status-code-error"></a>Проблема. "Attach Snapshot Debugger" обнаруживает ошибку кода состояния HTTP

Если во время попытки присоединения в окне **вывода** отображается следующая ошибка, это может быть известной проблемой, приведенной ниже. Попробуйте предлагаемые решения, и если проблема сохраняется, обратитесь к предыдущему псевдониму.

`[TIMESTAMP] Error --- Unable to Start Snapshot Debugger - Attach Snapshot Debugger failed: System.Net.WebException: The remote server returned an error: (###) XXXXXX`

### <a name="401-unauthorized"></a>(401) не санкционировано

Эта ошибка означает, что вызов RESTFUL, выданный Visual Studio в Azure, использует недопустимые учетные данные. Известная ошибка в модуле Azure Active Directory Easy OAuth может вызвать эту ошибку.

Выполните следующие шаги.

* Убедитесь, что учетная запись персонализации Visual Studio имеет разрешения на доступ к подписке Azure и ресурсу, к которому вы присоединяетесь. Чтобы быстро определить это, проверьте, доступен ли ресурс в диалоговом окне из раздела **Отладка** > **snapshot Debugger...** Выберите существующий **ресурс** > Azure или в Cloud Explorer.  > 
* Если эта ошибка продолжает сохраняться, используйте один из каналов обратной связи, описанных в начале этой статьи.

### <a name="403-forbidden"></a>(403) запрещено

Эта ошибка означает, что разрешение отклонено. Это может быть вызвано многими разными проблемами.

Выполните следующие шаги.

* Убедитесь, что ваша учетная запись Visual Studio имеет допустимую подписку Azure с необходимыми для ресурса разрешениями управления доступом на основе ролей (RBAC). Для AppService проверьте наличие разрешений на [запрос](https://docs.microsoft.com/rest/api/appservice/appserviceplans/get) к плану службы приложений, в котором размещается приложение.
* Проверьте правильность и актуальность метки времени на клиентском компьютере. Эта ошибка обычно возникает на серверах с отметками времени более чем за 15 минут с отметкой времени запроса.
* Если эта ошибка продолжает сохраняться, используйте один из каналов обратной связи, описанных в начале этой статьи.

### <a name="404-not-found"></a>(404) не найдено

Эта ошибка означает, что не удалось найти веб-сайт на сервере.

Выполните следующие шаги.

* Убедитесь, что веб-сайт развернут и работает в ресурсе службы приложений, к которому вы подключаетесь.
* Убедитесь, что сайт доступен по адресу\<HTTPS://\>Resource. azurewebsites.NET
* Если эта ошибка продолжает сохраняться, используйте один из каналов обратной связи, описанных в начале этой статьи.

### <a name="406-not-acceptable"></a>(406) неприемлемо

Эта ошибка означает, что сервер не может ответить на тип, заданный в заголовке Accept запроса.

Выполните следующие шаги.

* Убедитесь, что сайт доступен по адресу\<HTTPS://\>Resource. azurewebsites.NET
* Убедитесь, что сайт не перенесен на новые экземпляры. Snapshot Debugger использует понятие Арраффинити для маршрутизации запросов к конкретным экземплярам, которые могут периодически вызывать эту ошибку.
* Если эта ошибка продолжает сохраняться, используйте один из каналов обратной связи, описанных в начале этой статьи.

### <a name="409-conflict"></a>(409) конфликт

Эта ошибка означает, что запрос конфликтует с текущим состоянием сервера.

Это известная проблема, возникающая, когда пользователь пытается присоединить Snapshot Debugger к AppService с включенной ApplicationInsights. ApplicationInsights устанавливает для AppSettings регистр, отличный от регистра Visual Studio, что приводит к возникновению этой проблемы.

::: moniker range=">= vs-2019"
Мы разрешили это в Visual Studio 2019.
::: moniker-end

Выполните следующие шаги.

::: moniker range="vs-2017"

* Проверьте в портал Azure, что параметр AppSettings для подключении моментальных снимков (SNAPSHOTDEBUGGER_EXTENSION_VERSION) и Инструментатионенгине (INSTRUMENTATIONENGINE_EXTENSION_VERSION) имеют прописные буквы. В противном случае обновите параметры вручную, что приведет к перезапуску сайта.
::: moniker-end
* Если эта ошибка продолжает сохраняться, используйте один из каналов обратной связи, описанных в начале этой статьи.

### <a name="500-internal-server-error"></a>(500) Внутренняя ошибка сервера

Эта ошибка означает, что сайт полностью отключен или сервер не может выполнить запрос. Snapshot Debugger только функции в выполняющихся приложениях. [Application Insights snapshot Debugger](https://docs.microsoft.com/azure/azure-monitor/app/snapshot-debugger) предоставляет значит на исключениях и может быть лучшим средством для ваших нужд.

### <a name="502-bad-gateway"></a>(502) неверный шлюз

Эта ошибка указывает на проблемы с сетью на стороне сервера и может быть временной.

Выполните следующие шаги.

* Попробуйте подождать несколько минут, прежде чем присоединить Snapshot Debugger снова.
* Если эта ошибка продолжает сохраняться, используйте один из каналов обратной связи, описанных в начале этой статьи.

## <a name="issue-snappoint-does-not-turn-on"></a>Проблема. Точка прикрепления не включается

Если со своей точкой моментальных снимков вместо обычного значка точки моментальных снимков отображается значок предупреждения ![значок предупреждения точки моментальных снимков](../debugger/media/snapshot-troubleshooting-snappoint-warning-icon.png "значок предупреждения точки моментальных снимков"), в таком случае точка моментальных снимков не включается.

![Точка моментальных снимков не включается](../debugger/media/snapshot-troubleshooting-dont-turn-on.png "Точка моментальных снимков не включается")

Выполните следующие шаги.

1. Убедитесь, что у вас есть та же версия исходного кода, которая использовалась для сборки и развертывания приложения. Убедитесь, что вы загружаете правильные символы для развертывания. Для выполнения этого действия во время отладки моментальных снимков откройте окно **Модули** и убедитесь, что в столбце "Файл символов" отображается PDB-файл, загруженный для модуля, который вы отлаживаете. Snapshot Debugger попытается загрузить и использовать символы для вашего развертывания автоматически.

## <a name="issue-symbols-do-not-load-when-i-open-a-snapshot"></a>Проблема. Символы не загружаются при открытии моментального снимка

Если отображается следующее окно, это означает, что символы не загрузились.

![Символы не загружаются](../debugger/media/snapshot-troubleshooting-symbols-wont-load.png "Символы не загружаются")

Выполните следующие шаги.

- Щелкните ссылку **Изменить параметры символов...** на этой странице. В параметрах **Отладка > Символ** добавьте каталог кэша символов. Перезапустите отладку моментального снимка после задания пути к символам.

   Символы или PDB-файлы, доступные в вашем проекте, должны соответствовать развертыванию Службы приложений. Большинство развертываний (развертывание через Visual Studio, CI/CD с помощью Azure Pipelines или Kudu и т. д.) опубликует ваши файлы символов вместе со Службой приложений. Установка каталога кэша символов позволяет Visual Studio использовать эти символы.

   ![Параметры символов](../debugger/media/snapshot-troubleshooting-symbol-settings.png "Параметры символов")

- В качестве альтернативы, если организация использует сервер символов или удаляет символы в другом пути, используйте параметры символов, чтобы загрузить правильные символы для своего развертывания.

## <a name="issue-i-cannot-see-the-attach-snapshot-debugger-option-in-the-cloud-explorer"></a>Проблема. Я не вижу параметр "присоединить Snapshot Debugger" в Cloud Explorer

Выполните следующие шаги.

- Убедитесь, что компонент Snapshot Debugger установлен. Откройте Visual Studio Installer и проверьте компонент **Snapshot Debugger** в рабочей нагрузке Azure.
::: moniker range="< vs-2019"
- Убедитесь, что ваше приложение поддерживается. В настоящее время поддерживаются только приложения ASP.NET (4.6.1+) и ASP.NET Core (2.0+), развернутые в Службах приложений Azure.
::: moniker-end
::: moniker range=">= vs-2019"
- Убедитесь, что ваше приложение поддерживается.
  - Служба приложений Azure. Приложения ASP.NET, выполняющиеся на платформе .NET Framework 4.6.1 или более поздней версии.
  - Служба приложений Azure. Приложения ASP.NET Core, выполняющиеся на платформе .NET Core 2.0 или более поздней версии под управлением Windows.
  - Виртуальные машины Azure (и масштабируемый набор виртуальных машин). Приложения ASP.NET, выполняющиеся на платформе .NET Framework 4.6.1 или более поздней версии.
  - Виртуальные машины Azure (и масштабируемый набор виртуальных машин). Приложения ASP.NET, выполняющиеся на платформе .NET Core 2.0 или более поздней версии под управлением Windows.
  - Служба Azure Kubernetes. Приложения ASP.NET Core, выполняющиеся на платформе .NET Core 2.2 или более поздней версии под управлением Debian 9.
  - Служба Azure Kubernetes. Приложения ASP.NET Core, выполняющиеся на платформе .NET Core 2.2 или более поздней версии под управлением Alpine 3.8.
  - Служба Azure Kubernetes. Приложения ASP.NET Core, выполняющиеся на платформе .NET Core 2.2 или более поздней версии под управлением Ubuntu 18.04.
::: moniker-end

## <a name="issue-i-only-see-throttled-snapshots-in-the-diagnostic-tools"></a>Проблема. В Средства диагностики отображаются только регулируемые моментальные снимки

![Регулируемый моментальный снимок](../debugger/media/snapshot-troubleshooting-throttled-snapshots.png "Регулируемый моментальный снимок")

Выполните следующие шаги.

- Моментальные снимки занимают мало памяти, но для них выделяется фиксированное количество памяти. Если Snapshot Debugger обнаружит, что ваш сервер находится под большой нагрузкой памяти, он не будет делать снимки. Вы можете удалить уже полученные снимки, остановив сеанс Snapshot Debugger и повторив попытку.

::: moniker range=">= vs-2019"
## <a name="issue-snapshot-debugging-with-multiple-versions-of-the-visual-studio-gives-me-errors"></a>Проблема. Отладка моментальных снимков с несколькими версиями Visual Studio дает мне ошибки

Для Visual Studio 2019 требуется более новая версия расширения Snapshot Debugger сайта в службе приложений Azure.  Эта версия несовместима с более старой версией расширения Snapshot Debugger site, используемой в Visual Studio 2017.  При попытке присоединить Snapshot Debugger в Visual Studio 2019 к службе приложений Azure, которая ранее была отлажена Snapshot Debugger в Visual Studio 2017, появится следующее сообщение об ошибке:

![Несовместимое расширение сайта snapshot Debugger Visual Studio 2019](../debugger/media/snapshot-troubleshooting-incompatible-vs2019.png "Несовместимое расширение сайта snapshot Debugger Visual Studio 2019")

И наоборот, если вы используете Visual Studio 2017 для подключения Snapshot Debugger к службе приложений Azure, которая ранее была отлажена Snapshot Debugger в Visual Studio 2019, вы получите следующее сообщение об ошибке:

![Несовместимое расширение сайта snapshot Debugger Visual Studio 2017](../debugger/media/snapshot-troubleshooting-incompatible-vs2017.png "Несовместимое расширение сайта snapshot Debugger Visual Studio 2017")

Чтобы устранить эту проблему, удалите следующие параметры приложения на портале Azure и подключите Snapshot Debugger повторно.

- INSTRUMENTATIONENGINE_EXTENSION_VERSION
- SNAPSHOTDEBUGGER_EXTENSION_VERSION
::: moniker-end

## <a name="issue-i-am-having-problems-snapshot-debugging-and-i-need-to-enable-more-logging"></a>Проблема. У меня возникают проблемы при отладке моментальных снимков, и мне нужно включить дополнительное ведение журнала

### <a name="enable-agent-logs"></a>Включение журналов агента

Чтобы включить и отключить ведение журнала агента, откройте Visual Studio и выберите *Средства > Параметры > Snapshot Debugger > Включить ведение журнала агента*. Обратите внимание, что если функция *Удалять старые журналы агента при запуске сеанса* также включена, каждое успешное вложение Visual Studio будет удалять предыдущие журналы агента.

Журналы агентов можно найти в следующей папке.

- Службы приложений.
  - Перейдите на сайт Kudu Службы приложений (то есть yourappservice.**scm**.azurewebsites.net), а затем на консоль отладки.
  - Журналы агента хранятся в следующем каталоге:  D:\home\LogFiles\SiteExtensions\DiagnosticsAgentLogs\
- Виртуальная машина / Масштабируемые наборы виртуальных машин.
  - Войдите в свою виртуальную машину, чтобы сохранить журналы агента следующим образом:  C:\WindowsAzure\Logs\Plugins\Microsoft.Azure.Diagnostics.IaaSDiagnostics\<версия > \SnapshotDebuggerAgent_ *. txt
- AKS
  - Перейдите к следующему каталогу: /tmp/diag/AgentLogs/*

### <a name="enable-profilerinstrumentation-logs"></a>Включите Profiler / Instrumentation Logs (журналы инструментирования)

Журналы инструментирования можно найти в следующей папке.

- Службы приложений.
  - Журнал ошибок автоматически отправляется в д:\хоме\логфилес\евентлог.ксмл, события помечаются `<Provider Name="Instrumentation Engine" />` с помощью или "рабочие точки останова".
- Виртуальная машина / Масштабируемые наборы виртуальных машин.
  - Войдите на виртуальную машину и откройте "Просмотр событий".
  - Откройте следующее представление: *Журнал Windows > приложение*.
  - *Отфильтруйте текущий журнал* по *источнику события*, используя *производственные точки останова* или *ядро инструментирования*.
- AKS
  - Ведение журнала ядра инструментария происходит на /tmp/diag/log.txt (задается MicrosoftInstrumentationEngine_FileLogPath в DockerFile)
  - Ведение журнала ProductionBreakpoint происходит в /tmp/diag/shLog.txt

## <a name="known-issues"></a>Известные проблемы

- Отладка моментальных снимков с несколькими клиентами Visual Studio в одной и той же Службе приложений в настоящее время не поддерживается.
- Оптимизации Roslyn IL поддерживаются в проектах ASP.NET Core не полностью. В некоторых проектах ASP.NET Core вы не сможете увидеть некоторые переменные или использовать их в условных выражениях.
- Специальные переменные, такие как *$FUNCTION* или *$CALLER*, не могут выполняться в условных операторах или точках ведения журнала для проектов ASP.NET Core.
- Отладка моментальных снимков не работает в службах приложений, в которых включено [локальное кэширование](/azure/app-service/app-service-local-cache).
- Отладка моментальных снимков приложений API в настоящее время не поддерживается.

## <a name="site-extension-upgrade"></a>Обновление расширения сайта

Отладка моментальных снимков и Application Insights зависит от ICorProfiler, который загружается в процесс сайта и вызывает проблемы, состоящие в блокировке файлов во время обновления. Мы рекомендуем выполнить этот процесс, чтобы избежать простоя на производственном сайте.

- Создайте [слот развертывания](/azure/app-service/web-sites-staged-publishing) в Службе приложений и разверните свой сайт в слоте.
- Переключите слот с рабочей средой из Cloud Explorer в Visual Studio или с портала Azure.
- Остановите сайт слота. Завершение процесса сайта w3wp.exe во всех экземплярах займет несколько секунд.
- Обновите расширение сайта слота с сайта Kudu или портала Azure (*колонка "Служба приложений" > Средства разработки > Расширения > Обновление*).
- Запустите сайт слота. Мы рекомендуем посетить сайт, чтобы снова его подготовить.
- Переключите слот с рабочей средой.

## <a name="see-also"></a>См. также

- [Отладка в Visual Studio](../debugger/index.yml)
- [Отладка динамических ASP.NET приложений с помощью Snapshot Debugger](../debugger/debug-live-azure-applications.md)
- [Отладка динамических масштабируемых наборов ASP.NET Azure Virtual Мачинес\виртуал с помощью Snapshot Debugger](../debugger/debug-live-azure-virtual-machines.md)
- [Отладка Live ASP.NET Azure Kubernetes с помощью Snapshot Debugger](../debugger/debug-live-azure-kubernetes.md)
- [Ответы на часто задаваемые вопросы по отладке моментальных снимков](../debugger/debug-live-azure-apps-faq.md)
