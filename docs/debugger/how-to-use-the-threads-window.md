---
title: Отладка многопоточного приложения
description: Отладка с помощью окна "потоки" и панели инструментов "место отладки" в Visual Studio
ms.date: 02/14/2020
ms.topic: conceptual
dev_langs:
- CSharp
- VB
- FSharp
- C++
helpviewer_keywords:
- multithreaded debugging, tutorial
- tutorials, multithreaded debugging
ms.assetid: adfbe002-3d7b-42a9-b42a-5ac0903dfc25
author: mikejo5000
ms.author: mikejo
manager: jillfra
ms.workload:
- multiple
ms.openlocfilehash: eb7b7850d8d7582110152d248683f89981933215
ms.sourcegitcommit: 6ef52c2030b37ea7a64fddb32f050ecfb77dd918
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 02/17/2020
ms.locfileid: "77416377"
---
# <a name="walkthrough-debug-a-multithreaded-app-using-the-threads-window-c-visual-basic-c"></a>Пошаговое руководство. Отладка многопоточного приложения с помощью окнаC#"потоки" C++(, Visual Basic,)

Несколько элементов пользовательского интерфейса Visual Studio позволяют отлаживать многопоточные приложения. В этой статье представлены функции многопотоковой отладки в окне редактора кода, на панели инструментов **Расположение отладки** и в окне **потоки** . Дополнительные сведения о других средствах отладки многопоточных приложений см. в статье Приступая к [отладке многопоточных приложений](../debugger/get-started-debugging-multithreaded-apps.md).

Выполнение этого руководства занимает всего несколько минут, и вы ознакомитесь с основами отладки многопоточных приложений.

## <a name="create-a-multithreaded-app-project"></a>Создание проекта многопоточного приложения

Создайте следующий проект многопоточного приложения для использования в этом руководстве:

1. Откройте Visual Studio и создайте новый проект.

   ::: moniker range=">=vs-2019"

   Если окно запуска не открыто, выберите **Файл** > **Окно запуска**.

   На начальном экране выберите **Создать проект**.

   В поле поиска окна **Создание проекта** введите *консоль*. Затем выберите **C#** или **C++** из списка языков, а затем выберите **Windows** из списка платформа. 

   После применения фильтров языка и платформы выберите **консольное приложение (.NET Core)** или, для C++, шаблон **консольного приложения** , а затем нажмите кнопку **Далее**.

   > [!NOTE]
   > Если нужный шаблон не отображается, перейдите в **меню сервис** > **получить средства и компоненты...** , после чего откроется Visual Studio Installer. Выберите рабочую нагрузку **Разработка классических приложений .NET** или **Разработка классических приложений на C++** , а затем нажмите кнопку **Изменить**.

   В окне **Настройка нового проекта** введите или введите *мисреадвалксраугхапп* в поле **имя проекта** . Затем нажмите **Создать**.

   ::: moniker-end
   ::: moniker range="vs-2017"
   В верхней строке меню выберите **Файл** > **Создать** > **Проект**. В левой области диалогового окна **Новый проект** выберите следующие действия.

   - Для приложения C# в разделе **визуальный C#** элемент выберите **Рабочий стол Windows**, а затем в средней области выберите **консольное приложение (.NET Framework)** .
   - Для приложения C++ в разделе **визуальный C++** элемент выберите **Рабочий стол Windows**, а затем выберите **консольное приложение Windows**.

   Если **консольное приложение (.NET Core)** не отображается C++или для шаблона проекта **консольного приложения** , выберите **Сервис** > **получить средства и компоненты...** , открывающий Visual Studio Installer. Выберите рабочую нагрузку **Разработка классических приложений .NET** или **Разработка классических приложений на C++** , а затем нажмите кнопку **Изменить**.

   Затем введите имя, например *мисреадвалксраугхапп* , и нажмите кнопку **ОК**.

   Нажмите кнопку **ОК**.
   ::: moniker-end

   Появится новый проект консольного приложения. После создания проекта появится исходный файл. В зависимости от выбранного языка исходный файл может называться *Program.CS*, *мисреадвалксраугхапп. cpp*или *Module1. vb*.

1. Замените код в исходном файле на C# C++ пример кода, начиная с начала [отладки многопоточных приложений](../debugger/get-started-debugging-multithreaded-apps.md).

1. Нажмите **Файл** > **Сохранить все**.

## <a name="start-debugging"></a>Начать отладку

1. Найдите в исходном коде следующие строки:

   ```csharp
   Thread.Sleep(3000);
   Console.WriteLine();
   ```

   ```C++
   Thread::Sleep(3000);
   Console.WriteLine();
   ```

1. Установите точку останова на `Console.WriteLine();` строке, щелкнув в левом поле или выбрав линию и нажав клавишу **F9**.

   Точка останова отображается как красный кружок в левом поле рядом с строкой кода.

1. Выберите **отладка** > **начать отладку**или нажмите клавишу **F5**.

   Приложение запускается в режиме отладки и останавливается в точке останова.

1. В режиме приостановки откройте окно **потоки** , выбрав **Отладка** > **Windows** > **потоки**. Чтобы открыть или просмотреть **потоки** и другие окна отладки, необходимо находиться в сеансе отладки.

## <a name="examine-thread-markers"></a>Проверка маркеров потоков

1. В исходном коде выберите строку `Console.WriteLine();`.

   1. Щелкните правой кнопкой мыши в окне **потоки** **и выберите в меню пункт показывать потоки** в исходном виде ![отобразить потоки из исходного кода](../debugger/media/dbg-multithreaded-show-threads.png "среадмаркер") .

   Переплет рядом с строкой исходного кода теперь отображает ![маркер потока](../debugger/media/dbg-thread-marker.png "Метка потока")значка *маркера* . маркер потока указывает, что некий поток остановлен в этом месте. Если в расположении больше одного остановленного потока, появляется значок ![несколько потоков](../debugger/media/dbg-multithreaded-show-threads.png "несколько потоков") .

1. Наведите указатель мыши на маркер потока. Отобразится подсказка, в которой отображается имя и идентификатор потока остановленного потока или потоков. Имена потоков могут быть `<No Name>`.

   >[!TIP]
   >Чтобы определить бесименные потоки, их можно переименовать в окне **потоки** . Щелкните поток правой кнопкой мыши и выберите команду **Переименовать**.

1. Щелкните правой кнопкой мыши маркер потока в исходном коде, чтобы просмотреть доступные параметры в контекстном меню.

## <a name="flag-and-unflag-threads"></a>Установка и снятие отметки для потока

Вы можете пометить потоки, чтобы следить за потоками, к которым нужно уделить особое внимание.

Помечать и отмечать потоки из редактора исходного кода или из окна **потоков** . Выберите, следует ли отображать только отмеченные потоки или все потоки на панелях инструментов **Расположение отладки** или окна **потоков** . Выбор, сделанный из любого расположения, влияет на все расположения.

### <a name="flag-and-unflag-threads-in-source-code"></a>Флаг и снятие флажка для потоков в исходном коде

1. Откройте панель инструментов **место отладки** , выбрав **вид** > **панели инструментов** > **Расположение отладки**. Можно также щелкнуть правой кнопкой мыши в области панели инструментов и выбрать пункт **Расположение отладки**.

1. На панели инструментов **место отладки** есть три поля: **процесс**, **поток**и **кадр стека**. Расположите список потоков и обратите внимание на **количество потоков.** В списке **потоков** выполняющийся в данный момент поток помечается символом **>** .

1. В окне исходного кода наведите указатель мыши на значок маркера потока во внутренней области и выберите значок флага (или один из пустых значков флагов) в подсказке. Значок флага становится красным.

   Можно также щелкнуть правой кнопкой мыши значок маркера потока, выбрать пункт **отметить**, а затем выбрать поток для пометки в контекстном меню.

1. На панели инструментов **место отладки** выберите значок **Показывать только помеченные потоки** ![Показывать помеченные потоки](../debugger/media/dbg-threads-show-flagged.png "Показывать помеченные потоки")справа от поля **поток** . Значок неактивен, пока не помечается один или несколько потоков.

   Теперь в раскрывающемся списке **потоков** на панели инструментов отображается только отмеченный поток. Чтобы снова отобразить все потоки, щелкните значок **Показывать только отмеченные потоки** еще раз.

   >[!TIP]
   >После пометки некоторых потоков можно поместить курсор в редактор кода, щелкнуть правой кнопкой мыши и выбрать пункт **выполнять помеченные потоки до курсора**. Обязательно выберите код, к которому будут обращаться все отмеченные потоки. **Запуск помеченных потоков до курсора** приостанавливает потоки в выбранной строке кода, упрощая управление порядком выполнения путем [замораживания и размораживание потоков](#bkmk_freeze).

1. Чтобы переключить состояние пометки или без отметки для текущего выполняющегося потока, установите флажок один флаг **Переключить текущее состояние помечено** на панели инструментов, расположенный слева от кнопки **Показывать только помеченные потоки** . Пометка текущего потока полезна для поиска текущего потока, когда отображаются только отмеченные потоки.

1. Чтобы снять пометку с потока, наведите указатель мыши на маркер потока в исходном коде и выберите красный значок флага, чтобы очистить его, или щелкните правой кнопкой мыши маркер потока и выберите снять **пометку**.

### <a name="flag-and-unflag-threads-in-the-threads-window"></a>Флаг и снятие флажка для потоков в окне "потоки"

В окне **потоки** отмеченные потоки имеют красные значки флагов рядом с ними, а непомеченные потоки, если они показаны, имеют пустые значки.

![Окно потоков](../debugger/media/dbg-threads-window.png "Окно потоков")

Выберите значок флага, чтобы изменить состояние потока на "помечено" или "не помечено" в зависимости от его текущего состояния.

Можно также щелкнуть строку правой кнопкой мыши и выбрать **флаг**, снять **пометку**или снять **пометку со всех потоков** в контекстном меню.

На панели инструментов окна **потоков** также имеется кнопка **Показывать только помеченные потоки** , то есть ригхсанд один из двух значков флагов. Она работает так же, как кнопка на панели инструментов **место отладки** , и одна из кнопок управляет отображением в обоих расположениях.

### <a name="other-threads-window-features"></a>Другие функции окна "потоки"

В окне **потоки** выберите заголовок любого столбца, чтобы отсортировать потоки по этому столбцу. Щелкните еще раз, чтобы изменить порядок сортировки. Если отображаются все потоки, то при выборе столбца значок флага выполняется сортировка потоков по состоянию с пометкой или без отметки состояния.

Второй столбец в окне **потоков** (без заголовка) — это **текущий столбец потока** . Желтая стрелка в этом столбце отмечает текущую точку выполнения.

В столбце **Расположение** отображается место, где каждый поток отображается в исходном коде. Щелкните стрелку развертывания рядом с записью **расположения** или наведите указатель мыши на запись, чтобы отобразить частичный стек вызова для этого потока.

>[!TIP]
>Для графического представления стеков вызовов для потоков используйте окно [Параллельные стеки](../debugger/using-the-parallel-stacks-window.md) . Чтобы открыть окно во время отладки, выберите **отладка**> **Windows** > **Параллельные стеки**.

В дополнение к **флагам, снять** **пометку**и **снять пометку для всех потоков**контекстное меню для элементов окна **потока** , которое имеет следующие права, —

- Кнопка " **отобразить потоки в исходном** данных".
- **Шестнадцатеричное отображение**, которое изменяет **идентификатор потока**в окне **потоки** из десятичного в шестнадцатеричный формат.
- [Переключитесь на поток](#switch-to-another-thread), который сразу же переключается на выполнение этого потока.
- **Rename**, который позволяет изменить имя потока.
- [Заморозить и разморозить](#bkmk_freeze) команды.

## <a name="bkmk_freeze"></a>Замораживание и разморозка выполнения потоков

Можно заморозить и разморозить, а также приостанавливать и возобновлять потоки для управления порядком, в котором потоки выполняют работу. Замораживание и размораживание потоков может помочь в устранении проблем с параллелизмом, таких как взаимоблокировки и состояния гонки.

> [!TIP]
> Для выполнения одного потока без замораживания других потоков, что также является распространенным сценарием отладки, см. раздел Начало [отладки многопоточных приложений](../debugger/get-started-debugging-multithreaded-apps.md#bkmk_follow_a_thread).

**Закрепление и снятие закрепления потоков:**

1. В окне **потоки** щелкните правой кнопкой мыши любой поток и выберите команду **заморозить**. Значок **паузы** в столбце **текущий поток** указывает на то, что поток заморожен.

1. Выберите **столбцы** на панели инструментов окна **потоки** , а затем выберите **приостановленный счетчик** , чтобы отобразить столбец **приостановленный счетчик** . Значение счетчика приостановства для замороженного потока равно **1**.

1. Щелкните правой кнопкой мыши замороженный поток и выберите команду **разморозить**.

   Значок **приостановки** исчезает, а значение **счетчика приостанова** изменяется на **0**.

## <a name="switch-to-another-thread"></a>Переключиться на другой поток

При попытке переключения на другой поток приложение может находиться **в окне режима приостановки выполнения** . В этом окне сообщается, что у потока нет кода, который может быть отображен текущим отладчиком. Например, вы можете выполнять отладку управляемого кода, но поток является машинным кодом. В окне предлагаются предложения по устранению проблемы.

**Чтобы переключиться на другой поток, выполните следующие действия.**

1. В окне **потоки** запишите идентификатор текущего потока, который является потоком с желтой стрелкой в столбце **текущий поток** . Необходимо переключиться обратно на этот поток, чтобы продолжить работу приложения.

1. Щелкните другой поток правой кнопкой мыши и выберите в контекстном меню команду **переключиться на поток** .

1. Обратите внимание, что в окне **потоки** изменилось положение желтой стрелки. Исходный маркер текущего потока также остается в виде структуры.

   Взгляните на подсказку маркера потока в редакторе исходного кода и список в раскрывающемся списке **обсуждения** на панели инструментов **место отладки** . Обратите внимание, что в текущем потоке также изменилось.

1. На панели инструментов **место отладки** выберите другой поток из списка **потоков** . Обратите внимание, что текущий поток изменяется и в других двух расположениях.

1. В редакторе исходного кода щелкните правой кнопкой мыши маркер потока, выберите команду **Переключиться в поток**и выберите другой поток из списка. Обратите внимание, что текущий поток изменяется во всех трех расположениях.

С помощью маркера потока в исходном коде можно переключиться только на потоки, остановленные в этом расположении. С помощью окна **Потоки** и панели инструментов **Место отладки** можно переключиться на любой поток.

Теперь вы узнали основы отладки многопоточных приложений. Вы можете наблюдать, помечать и отмечать потоки, а также закреплять и разморозить их с помощью окна **потоки** , списка **потоков** на панели инструментов **место отладки** или маркеров потоков в редакторе исходного кода.

## <a name="see-also"></a>См. также раздел
- [Отладка многопоточных приложений](../debugger/debug-multithreaded-applications-in-visual-studio.md)
- [Практическое руководство. Переключение на другой поток при отладке](../debugger/how-to-switch-to-another-thread-while-debugging.md)
