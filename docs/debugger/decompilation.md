---
title: Декомпиляция кода .NET во время отладки | Документация Майкрософт
ms.date: 2/2/2020
ms.topic: conceptual
dev_langs:
- CSharp
helpviewer_keywords:
- decompilation, debugger, exception
- debugging [Visual Studio], decompilation, source not found
author: mikejo5000
ms.author: mikejo
manager: jillfra
ms.workload:
- multiple
monikerRange: '>= vs-2019'
ms.openlocfilehash: d63c05120842d52dd54359e128d0cc5f2a195817
ms.sourcegitcommit: cc841df335d1d22d281871fe41e74238d2fc52a6
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/18/2020
ms.locfileid: "79508749"
---
# <a name="generate-source-code-from-net-assemblies-while-debugging"></a>Создание исходного кода из сборок .NET во время отладки

При отладке приложения .NET вам может потребоваться просмотреть исходный код, которого у вас нет. Например, происходит прерывание в исключении, или стек вызовов используется для перехода к исходному расположению.

> [!NOTE]
> * Создание исходного кода (декомпиляция) возможно только для приложений .NET и построено на проекте [ILSpy](https://github.com/icsharpcode/ILSpy) с открытым кодом.
> * Декомпиляция доступна только в Visual Studio 2019 версии 16.5 и более поздних версий.
> * Атрибут [SuppressIldasmAttribute](https://docs.microsoft.com/dotnet/api/system.runtime.compilerservices.suppressildasmattribute), примененный к сборке или модулю, не позволит Visual Studio выполнить декомпиляцию.

## <a name="generate-source-code"></a>Создание исходного кода

Если при выполнении отладки исходный код недоступен, в Visual Studio отображается документ **Исходный код не найден**, а если отсутствуют символы для сборки, отображается документ **Символы не загружены**. Оба документа имеют параметр **Декомпилировать исходный код**, который создает код C# для текущего расположения. Созданный код C# можно использовать так же, как любой другой исходный код. Можно просматривать этот код, проверять переменные, устанавливать точки останова и т. д.

### <a name="no-symbols-loaded"></a>Символы не загружены

На следующем рисунке показано сообщение **Символы не загружены**.

![Снимок экрана: документ "Символы не загружены"](media/decompilation-no-symbol-found.png)

### <a name="source-not-found"></a>Исходный код не найден

На следующем рисунке показано сообщение **Исходный код не найден**.

![Снимок экрана: документ "Исходный код не найден"](media/decompilation-no-source-found.png)

## <a name="generate-and-embed-sources-for-an-assembly"></a>Создание и внедрение исходного кода для сборки

Можно создать не только исходный код для определенного расположения, но и весь исходный код для конкретной сборки .NET. Для этого перейдите в окно **Модули** и в контекстном меню сборки .NET выберите команду **Декомпилировать исходный код**. Visual Studio создает файл символов для сборки, а затем внедряет исходный код в файл символов. На последующем этапе можно [извлечь](#extract-and-view-the-embedded-source-code) внедренный исходный код.

![Снимок экрана: контекстное меню сборки в окне "Модули" с командой "Декомпилировать исходный код".](media/decompilation-decompile-source-code.png)

## <a name="extract-and-view-the-embedded-source-code"></a>Извлечение и просмотр внедренного исходного кода

Исходные файлы, внедренные в файл символов, можно извлечь с помощью команды **Извлечь исходный код** в контекстном меню окна **Модули**.

![Снимок экрана: контекстное меню сборки в окне "Модули" с командой "Извлечь исходный код".](media/decompilation-extract-source-code.png)

Извлеченные исходные файлы добавляются в решение как [прочие файлы](../ide/reference/miscellaneous-files.md). В Visual Studio функция "Прочие файлы" по умолчанию отключена. Чтобы включить эту функцию, установите флажок **Инструменты** > **Параметры** > **Среда** > **Документы** > **Показывать прочие файлы в Обозревателе решений**. Без включения этой функции вы не сможете открыть извлеченный исходный код.

![Снимок экрана: страница параметров инструментов с установленным флажком для включения прочих файлов.](media/decompilation-tools-options-misc-files.png)

Извлеченные исходные файлы отображаются в разделе прочих файлов в **Обозревателе решений**.

![Снимок экрана. Обозреватель решений с прочими файлами.](media/decompilation-solution-explorer.png)

## <a name="known-limitations"></a>Известные ограничения

### <a name="requires-break-mode"></a>Требуется режим прерывания выполнения

Создание исходного кода с помощью декомпиляции возможно только в том случае, если отладчик находится в режиме прерывания выполнения и приложение приостановлено. Например, Visual Studio переходит в режим прерывания, попадая в точку останова или в исключение. Вы можете легко активировать прерывание выполнения Visual Studio при следующем запуске кода с помощью команды **Прервать все** (![значок "Прервать все"](media/decompilation-break-all.png)).

### <a name="decompilation-limitations"></a>Ограничения декомпиляции

Создание исходного кода из промежуточного языка (IL), используемого в сборках .NET, имеет некоторые внутренние ограничения. Поэтому созданный исходный код не выглядит в точности как оригинальный исходный код. Большая часть различий сосредоточена в тех местах, где информация в оригинальном исходном коде не нужна во время выполнения. Например, во время выполнения не нужна такая информация, как пробелы, комментарии и имена локальных переменных. Рекомендуется использовать созданный исходный код, чтобы понять, как выполняется программа, а не в качестве замены оригинального исходного кода.

### <a name="debug-optimized-or-release-assemblies"></a>Отладка оптимизированных сборок или сборок выпуска

При отладке кода, декомпилированного из сборки, которая была скомпилирована с использованием оптимизаций компилятора, вы можете столкнуться со следующими проблемами:
- точки останова могут не всегда быть привязаны к соответствующим исходным расположениям;
- при пошаговом выполнении шаг может не всегда переходить в правильное место;
- имена локальных переменных могут быть неточными;
- некоторые переменные могут быть недоступны для оценки.

Дополнительные сведения можно найти в описании проблемы GitHub [Интеграция ICSharpCode.Decompiler с отладчиком VS](https://github.com/icsharpcode/ILSpy/issues/1901).

### <a name="decompilation-reliability"></a>Надежность декомпиляции

Относительно небольшой процент попыток декомпиляции может привести к сбою. Это происходит из-за ошибки пустой ссылки точки последовательности в ILSpy.  Мы устранили этот сбой путем перехвата таких проблем и корректного завершения попытки декомпиляции.

Дополнительные сведения можно найти в описании проблемы GitHub [Интеграция ICSharpCode.Decompiler с отладчиком VS](https://github.com/icsharpcode/ILSpy/issues/1901).

### <a name="limitations-with-async-code"></a>Ограничения при работе с асинхронным кодом

Результаты декомпиляции модулей с шаблонами кода async/await могут быть неполными или неудачными в целом. Шаблоны кода async/await и машины состояния yield state-machine в ILSpy реализованы только частично. 

Дополнительные сведения можно найти в описании проблемы GitHub [Состояние генератора PDB](https://github.com/icsharpcode/ILSpy/issues/1422).

### <a name="just-my-code"></a>Только мой код

Параметры режима [Только мой код (JMC)](https://docs.microsoft.com/visualstudio/debugger/just-my-code) позволяют Visual Studio выполнять шаг с обходом системы, платформы, библиотеки и других вызовов непользовательского кода. Во время сеанса отладки в окне **Модули** отображаются модули кода, которые отладчик воспринимает как "Мой код" (т. е. пользовательский код).

При декомпиляции оптимизированных модулей или модулей выпуска создается непользовательский код. Если отладчик прерывается в декомпилированном непользовательском коде, появляется окно **Отсутствует источник**. Чтобы отключить режим "Только мой код", перейдите в раздел **Инструменты** > **Параметры** (или **Отладка** > **Параметры**) > **Отладка** > **Общие** и снимите флажок **Включить только мой код.** .

### <a name="extracted-sources"></a>Извлеченный исходный код

Исходный код, извлеченный из сборки, имеет следующие ограничения.
- Имена и расположение созданных файлов нельзя настроить.
- Файлы являются временными и будут удалены Visual Studio.
- Файлы помещаются в одну папку без использования какой-либо иерархии, которая была в оригинальных исходных файлах.
- Имя каждого файла содержит хэш контрольной суммы файла.

### <a name="generated-code-is-c-only"></a>Создается только код C#
При декомпиляции создаются только файлы исходного кода на C#. Возможность создавать файлы на каком-либо другом языке отсутствует.
