---
title: Отладка вычислительного шейдера с помощью диагностики графики
description: Изучите пример устранения неполадок с вычислительным шейдером. В этом руководстве показано, как использовать список событий графики, стек вызовов событий графики и окно "Этапы графического конвейера".
ms.custom: SEO-VS-2020
ms.date: 11/04/2016
ms.topic: conceptual
ms.assetid: 69287456-644b-4aff-bd03-b1bbb2abb82a
author: mikejo5000
ms.author: mikejo
manager: jmartens
ms.workload:
- multiple
ms.openlocfilehash: 184e009c870e6a15ce61ed14dcb8b6916e293728
ms.sourcegitcommit: ae6d47b09a439cd0e13180f5e89510e3e347fd47
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 02/08/2021
ms.locfileid: "99908515"
---
# <a name="walkthrough-using-graphics-diagnostics-to-debug-a-compute-shader"></a>Пошаговое руководство. Использование диагностики графики для отладки вычислительного шейдера
В этом пошаговом руководстве демонстрируется использование инструментов диагностики графики Visual Studio для анализа вычислительного шейдера, который выдает неверные результаты.

 В данном пошаговом руководстве рассмотрены следующие задачи:

- Использование **списка событий графики** для обнаружения возможных источников проблем.

- Использование **стека вызовов событий графики** для определения того, какой вычислительный шейдер выполняется по событию DirectCompute `Dispatch`.

- Использование окна **Этапы графического конвейера** и отладчика HLSL для просмотра вычислительного шейдера, который является источником проблемы.

## <a name="scenario"></a>Сценарий
 В этом сценарии вы написали гидродинамический симулятор, который использует DirectCompute для выполнения тех частей обновления симулятора, которые требуют наибольшего объема вычислений. При запуске приложения отрисовка набора данных и пользовательского интерфейса выглядит правильно, но симулятор работает некорректно. С помощью диагностики графики можно записать данные о проблеме в журнал графики, чтобы можно было выполнить отладку приложения. Проблема в приложении выглядит следующим образом:

 ![Имитация жидкости ведет себя неправильно.](media/gfx_diag_demo_compute_shader_fluid_problem.png "gfx_diag_demo_compute_shader_fluid_problem")

 Сведения о том, как записывать проблемы с графикой в журнал графики, см. в статье [Capturing Graphics Information](capturing-graphics-information.md).

## <a name="investigation"></a>Исследование
 Вы можете использовать инструменты диагностики графики для загрузки файла журнала графики, чтобы можно было просмотреть записанные кадры.

#### <a name="to-examine-a-frame-in-a-graphics-log"></a>Анализ кадра в журнале графики

1. В Visual Studio загрузите журнал графики, содержащий кадр, который выдает неверные результаты моделирования. В Visual Studio отображается новая вкладка диагностики графики. В верхней части этой вкладки находится вывод целевого объекта отрисовки для выбранного кадра. В нижней части находится **Список кадров**, в котором отображается эскиз каждого захваченного кадра.

2. В области **Список кадров** выберите кадр, который демонстрирует неправильное поведение симулятора. Несмотря на то, что ошибка находится в коде симулятора, а не в коде отрисовки, все равно необходимо выбрать кадр, поскольку события DirectCompute записываются покадрово вместе с событиями Direct3D. В этом сценарии вкладка журнала графики выглядит следующим образом:

    ![Документ журнала графики в Visual Studio.](media/gfx_diag_demo_compute_shader_fluid_step_1.png "gfx_diag_demo_compute_shader_fluid_step_1")

   После выбора кадра, который демонстрирует проблему, можно воспользоваться окном **Список событий графики** для ее диагностики. **Список событий графики** содержит событие для каждого вызова DirectCompute и вызова Direct3D API, сделанного во время активного кадра, например вызовы API для выполнения вычислений на GPU либо для отрисовки набора данных или пользовательского интерфейса. В этом случае нас интересуют события `Dispatch`, представляющие части симуляции, которые выполняются в GPU.

#### <a name="to-find-the-dispatch-event-for-the-simulation-update"></a>Поиск события Dispatch для обновления симулятора

1. На панели инструментов **Диагностика графики** выберите **Список событий**, чтобы открыть окно **Список событий графики**.

2. Просмотрите **Список событий графики** для поиска события Draw, которое выполняет отрисовку набора данных. Чтобы упростить эту задачу, введите `Draw` в поле **Поиск** в верхнем правом углу окна **Список событий графики**. Список будет отфильтрован и будет содержать только события, в названиях которых присутствует слово «Draw». В этом сценарии вы выясняете, что эти события Draw произошли:

    ![Список событий &#40;EL&#41;, содержащий события рисования.](media/gfx_diag_demo_compute_shader_fluid_step_2.png "gfx_diag_demo_compute_shader_fluid_step_2")

3. Перейдите к каждому событию Draw, следя за целевым объектом отрисовки на вкладке документа журнала графики.

4. Остановитесь, когда целевой объект отрисовки сначала отображает визуализированный набор данных. В этом случае набор данных визуализируется в первом событии Draw. Отображается ошибка в симуляторе:

    ![Это событие рисования отрисовывает набор данных имитации.](media/gfx_diag_demo_compute_shader_fluid_step_3.png "gfx_diag_demo_compute_shader_fluid_step_3")

5. Просмотрите **Список событий графики** для поиска события `Dispatch`, которое обновляет симулятор. Поскольку вполне вероятно, что симулятор обновляется до отрисовки, вы можете сначала сосредоточиться на событиях `Dispatch`, возникающих до события Draw, которое выполняет отрисовку результатов. Чтобы облегчить эту задачу, измените значение в поле **Поиск** на следующее: `Draw;Dispatch;CSSetShader(`. При этом список отфильтровывается так, что содержит события `Dispatch` и `CSSetShader` в дополнение к событиям Draw. В этом сценарии вы выясняете, что несколько событий `Dispatch` произошли до события Draw:

    ![Список событий, содержащий события рисования, Dispatch и CSSetShader](media/gfx_diag_demo_compute_shader_fluid_step_4.png "gfx_diag_demo_compute_shader_fluid_step_4")

   Теперь, когда известно, что несколько из возможного множества событий `Dispatch` могут быть связаны с проблемой, их можно изучить более подробно.

#### <a name="to-determine-which-compute-shader-a-dispatch-call-executes"></a>Определение вычислительного шейдера, выполняемого вызовом Dispatch

1. На панели инструментов **Диагностика графики** выберите **Стек вызовов событий**, чтобы открыть окно **Стек вызовов событий графики**.

2. Начиная с события Draw, которое выполняет отрисовку результатов симуляции, перемещайтесь назад по каждому предыдущему событию `CSSetShader`. Затем в окне **Стек вызовов событий графики** выберите самую верхнюю функцию для перехода к месту вызова. В месте вызова можно использовать первый параметр функции [CSSetShader](/windows/desktop/api/d3d11/nf-d3d11-id3d11devicecontext-cssetshader), чтобы определить, какой вычислительный шейдер выполняется следующим событием `Dispatch`.

   В этом сценарии в каждом кадре существует три пары событий `CSSetShader` и `Dispatch`. При обходе в обратном направлении третья пара представляет этап интеграции (где происходит фактическое перемещение частиц жидкости), вторая пара представляет этап вычисления сил (где вычисляются силы, влияющие на каждую частицу), а первая пара представляет этап вычисления плотности.

#### <a name="to-debug-the-compute-shader"></a>Отладка вычислительного шейдера

1. На панели инструментов **Диагностики графики** выберите **Этапы конвейера**, чтобы открыть окно **Этапы графического конвейера**.

2. Выберите третье событие `Dispatch` (то, которое находится непосредственно перед событием Draw), а затем в окне **Этапы графического конвейера** в области **Вычислительный шейдер** выберите **Начать отладку**.

    ![Выбор третьего события Dispatch в списке событий.](media/gfx_diag_demo_compute_shader_fluid_step_6.png "gfx_diag_demo_compute_shader_fluid_step_6")

    Отладчик HLSL запускается для шейдера, который выполняет этап интеграции.

3. Изучите исходный код вычислительного шейдера для этапа интеграции, чтобы найти источник ошибки. При использовании диагностики графики для отладки кода вычислительного шейдера HLSL можно осуществлять пошаговое выполнение кода и использовать другие привычные инструменты отладки, например окна контрольных значений. В этом сценарии вы определяете, что в вычислительном шейдере, который выполняет шаг интеграции, ошибка, видимо, отсутствует.

    ![Отладка вычислительного шейдера IntegrateCS.](media/gfx_diag_demo_compute_shader_fluid_step_7.png "gfx_diag_demo_compute_shader_fluid_step_7")

4. Чтобы остановить отладку вычислительного шейдера, на панели инструментов **Отладка** выберите **Остановить отладку** (сочетание клавиш SHIFT+F5).

5. Затем выберите второе событие `Dispatch` и запустите отладку вычислительного шейдера точно также, как это было сделано на ранее.

    ![Выбор второго события Dispatch в списке событий.](media/gfx_diag_demo_compute_shader_fluid_step_8.png "gfx_diag_demo_compute_shader_fluid_step_8")

    Отладчик HLSL запускается для шейдера, который вычисляет силы, воздействующие на каждую частицу жидкости.

6. Изучите исходный код вычислительного шейдера для этапа вычисления сил. В этом сценарии вы определяете, что источник ошибки находится здесь.

    ![Отладка вычислительного шейдера ForceCS&#95;Simple.](media/gfx_diag_demo_compute_shader_fluid_step_9.png "gfx_diag_demo_compute_shader_fluid_step_9")

   После определения местоположения ошибки можно остановить отладку и изменить исходный код вычислительного шейдера, чтобы обеспечить правильное вычисление расстояния между взаимодействующими частицами. В этом сценарии вы просто меняете строку `float2 diff = N_position + P_position;` на `float2 diff = N_position - P_position;`:

   ![Исправленный код&#45;вычислительного шейдера.](media/gfx_diag_demo_compute_shader_fluid_step_10.png "gfx_diag_demo_compute_shader_fluid_step_10")

   В этом сценарии, поскольку вычислительные шейдеры компилируются во время выполнения, можно просто перезапустить приложение после внесения изменений, чтобы посмотреть, как они влияют на симуляцию. Повторять сборку приложения не нужно. При запуске приложения выясняется, что теперь симуляция работает правильно.

   ![Имитация жидкости ведет себя правильно.](media/gfx_diag_demo_compute_shader_fluid_resolution.png "gfx_diag_demo_compute_shader_fluid_resolution")