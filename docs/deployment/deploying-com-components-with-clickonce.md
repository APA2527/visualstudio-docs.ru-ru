---
title: Развертывание компонентов COM с помощью ClickOnce | Документация Майкрософт
ms.date: 11/04/2016
ms.topic: conceptual
dev_langs:
- VB
- CSharp
- C++
helpviewer_keywords:
- registration-free COM deployment
- ClickOnce deployment, COM components
- COM components, deploying
- deploying applications [ClickOnce], COM components
- components, deploying
ms.assetid: 1a4c7f4c-7a41-45f2-9af4-8b1666469b89
author: mikejo5000
ms.author: mikejo
manager: jillfra
ms.workload:
- multiple
ms.openlocfilehash: 7032ec5ae03febf6c54978020379769ac742a136
ms.sourcegitcommit: 47eeeeadd84c879636e9d48747b615de69384356
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 04/23/2019
ms.locfileid: "63406625"
---
# <a name="deploy-com-components-with-clickonce"></a>Развертывание компонентов COM с помощью ClickOnce
Развертывание старыми COM-компонентами традиционно трудной задачей. Компоненты должны быть глобально зарегистрированы и таким образом может привести к нежелательным побочным эффектам между перекрывающимися приложениями. Такой ситуации, обычно не проблема в приложениях .NET Framework, так как компоненты полностью изолированы в приложение или side-by-side совместимы. Visual Studio позволяет развертывать изолированные компоненты COM в Windows XP или более поздней версии операционной системы.

 [!INCLUDE[ndptecclick](../deployment/includes/ndptecclick_md.md)] обеспечивает простой и безопасный механизм для развертывания приложений .NET. Тем не менее если приложения используют старыми COM-компонентами, необходимо будет выполнить дополнительные действия для его развертывания. В этом разделе описывается, как развертывать изолированные компоненты COM и ссылаться на собственные компоненты (например, из Visual Basic 6.0 или Visual C++).

 Дополнительные сведения о развертывании изолированные компоненты COM, см. в разделе [упрощают развертывание приложений с помощью ClickOnce и COM без регистрации](https://web.archive.org/web/20050326005413/msdn.microsoft.com/msdnmag/issues/05/04/RegFreeCOM/default.aspx).

## <a name="registration-free-com"></a>Не требующий регистрации COM
 Без регистрации COM — это новая технология развертывания и активации изолированных COM-компонентов. Технологии библиотеки типов компонента и сведения о регистрации, обычно устанавливается в системном реестре в XML-файл, называемый манифестом, хранящихся в той же папке, что и приложение.

 Изолированного компонента COM требует, что он был зарегистрирован на компьютере разработчика, но его не должны быть зарегистрированы на компьютере конечного пользователя. Чтобы изолировать компонент COM, все что нужно сделать задается его ссылку **Isolated** свойства **True**. По умолчанию это свойство имеет значение **False**, указывающее, что он должен рассматриваться как ссылку на зарегистрированный COM. Если это свойство имеет **True**, это вызывает создание манифеста будет создан для этого компонента во время сборки. Она вызывает соответствующие файлы копируются в папку приложения во время установки.

 Когда генератор манифеста встречает изолированную ссылку COM, он перечисляет все `CoClass` записей в библиотеке типов компонента, сопоставляя каждый элемент с соответствующими данными регистрации и создавая определения манифеста для COM классы в файле библиотеки типов.

## <a name="deploy-registration-free-com-components-using-clickonce"></a>Развертывание компонентов COM без регистрации с помощью ClickOnce
 [!INCLUDE[ndptecclick](../deployment/includes/ndptecclick_md.md)] Технология развертывания хорошо подходит для развертывания изолированных компонентов COM, так как оба [!INCLUDE[ndptecclick](../deployment/includes/ndptecclick_md.md)] и COM без регистрации требуют наличия манифеста для развертывания компонентов.

 Как правило автор компонента должен предоставлять манифест. Если нет, однако Visual Studio способен создать манифест автоматически для COM-компонента. Создание манифеста выполняется во время [!INCLUDE[ndptecclick](../deployment/includes/ndptecclick_md.md)] процесс публикации; Дополнительные сведения см. в разделе [публикация приложений ClickOnce](../deployment/publishing-clickonce-applications.md). Эта функция также позволяет использовать устаревшие компоненты, созданные в предыдущих средах разработки, таких как Visual Basic 6.0.

 Существует два способа, [!INCLUDE[ndptecclick](../deployment/includes/ndptecclick_md.md)] развертывание компонентов COM:

- Использование загрузчика для развертывания компонентов COM; Это работает на всех поддерживаемых платформах.

- Используйте собственный компонент развертывания изоляции (также известный как требующий регистрации COM). Тем не менее это будет работать только на Windows XP или более поздней версии операционной системы.

### <a name="example-of-isolating-and-deploying-a-simple-com-component"></a>Пример изоляции и развертывания простого компонента COM
 Чтобы продемонстрировать развертывание компонента COM без регистрации, в этом примере будет создание приложения на основе Windows в Visual Basic, который ссылается на собственный изолированный компонент COM, созданных с помощью Visual Basic 6.0 и развертывания с помощью [!INCLUDE[ndptecclick](../deployment/includes/ndptecclick_md.md)].

 Сначала необходимо создать собственный компонент COM:

##### <a name="to-create-a-native-com-component"></a>Чтобы создать собственный компонент COM

1. С помощью Visual Basic 6.0, из **файл** меню, щелкните **New**, затем **проекта**.

2. В **новый проект** выберите **Visual Basic** узел и выберите **ActiveX DLL** проекта. В поле **Имя файла** введите `VB6Hello`.

    > [!NOTE]
    > Поддерживаются только типы проектов ActiveX DLL и элемент управления ActiveX с COM без регистрации; Типы проектов ActiveX EXE и документ ActiveX не поддерживаются.

3. В **обозревателе решений**, дважды щелкните **Class1.vb** для открытия текстового редактора.

4. В Class1.vb добавьте следующий код после созданного кода для `New` метод:

    ```vb
    Public Sub SayHello()
       MsgBox "Message from the VB6Hello COM component"
    End Sub
    ```

5. Выполнить сборку компонента. Из **построения** меню, щелкните **построить решение**.

> [!NOTE]
> Типы проектов, элементов управления COM без регистрации COM поддерживает только библиотеки DLL EXE-файлы нельзя использовать с объектов COM без регистрации

 Теперь можно создать приложение на основе Windows и добавьте ссылку на COM-компонента к нему.

##### <a name="to-create-a-windows-based-application-using-a-com-component"></a>Создание приложения на базе Windows, с помощью COM-компонент

1. С помощью Visual Basic из **файл** меню, щелкните **New**, затем **проекта**.

2. В **новый проект** выберите **Visual Basic** узел и выберите **приложения Windows**. В поле **Имя файла** введите `RegFreeComDemo`.

3. В **обозревателе решений**, нажмите кнопку **Показать все файлы** кнопку, чтобы отобразить ссылки проекта.

4. Щелкните правой кнопкой мыши **ссылки** узел и выберите **добавить ссылку** в контекстном меню.

5. В **добавить ссылку** диалоговом окне щелкните **Обзор** , перейдите к библиотеке VB6Hello.dll, а затем установите его.

    Объект **VB6Hello** ссылка появится в списке ссылок.

6. Пункты **элементов**выберите **кнопку** и перетащите его в **Form1** формы.

7. В **свойства** окна, задайте **текст** свойства **Hello**.

8. Дважды щелкните кнопку, чтобы добавить код обработчика и в файле кода добавьте код, чтобы обработчик выглядит следующим образом:

   ```vb
   Private Sub Button1_Click(ByVal sender As System.Object, ByVal e As System.EventArgs) Handles Button1.Click
       Dim VbObj As New VB6Hello.Class1
       VbObj.SayHello()
   End Sub
   ```

9. Запустите приложение. Из **Отладка** меню, щелкните **начать отладку**.

   Далее необходимо изолировать элемент. Каждый компонент COM, который приложение использует представляется в проекте как ссылку COM. Эти ссылки отображаются в разделе **ссылки** узел в **обозревателе решений** окна. (Обратите внимание, что можно добавлять ссылки непосредственно с помощью **добавить ссылку** команды **проекта** меню или косвенно перетащите на форму элемент управления ActiveX.)

   Ниже показано, как изолировать компонент COM и опубликовать обновленное приложение, содержащее изолированный элемент управления:

##### <a name="to-isolate-a-com-component"></a>Чтобы изолировать COM-компонент

1. В **обозревателе решений**в **ссылки** выберите **VB6Hello** ссылки.

2. В **свойства** окна, измените значение свойства **Isolated** свойства из **False** для **True**.

3. Из **построения** меню, щелкните **построить решение**.

   Теперь при нажатии клавиши F5, приложение работает, как ожидалось, но теперь он работает в объектов COM без регистрации Чтобы проверить это, попробуйте отменить регистрацию компонента VB6Hello.dll и под управлением RegFreeComDemo1.exe вне Интегрированной среды разработки Visual Studio. Это время, при нажатии кнопки, он по-прежнему работает. Если временно переименовать манифест приложения, он снова завершится ошибкой.

> [!NOTE]
> Вы можете смоделировать отсутствие компонента COM, временно при отмене регистрации. Откройте командную строку, перейдите в системную папку, введя `cd /d %windir%\system32`, затем отменить регистрацию компонента, введя `regsvr32 /u VB6Hello.dll`. Можно зарегистрировать его снова, введя `regsvr32 VB6Hello.dll`.

 Последним шагом является публикация приложения с помощью [!INCLUDE[ndptecclick](../deployment/includes/ndptecclick_md.md)]:

##### <a name="to-publish-an-application-update-with-an-isolated-com-component"></a>Чтобы опубликовать обновления приложения с помощью изолированного компонента COM.

1. Из **построения** меню, щелкните **публикации RegFreeComDemo**.

    Откроется Мастер публикации.

2. В мастере публикации укажите расположение на диске локального компьютера, где можно получить доступ к и проверить опубликованные файлы.

3. Нажмите кнопку **Готово**, чтобы опубликовать приложение.

   Если посмотреть на опубликованные файлы, можно заметить, что файл sysmon.ocx включен. Элемент управления полностью изолирован данного приложения, это означает, что если на компьютере конечного пользователя установлено другое приложение, с помощью другой версии элемента управления, он не влияет на это приложение.

## <a name="reference-native-assemblies"></a>Справочник по машинные сборки
 Visual Studio поддерживает ссылки на машинном коде Visual Basic 6.0 или сборки C++; такие ссылки называются собственных ссылок. Чтобы узнать, является ли ссылка собственного путем проверки, что его **тип файла** свойству **собственного** или **ActiveX**.

 Чтобы добавить собственную ссылку, используйте **добавить ссылку** команды, а затем перейдите в манифесте. Некоторые компоненты помещают манифест внутри библиотеки DLL. В этом случае можно просто выбрать самой библиотеки DLL, и Visual Studio добавит ее как собственную ссылку, если он обнаруживает, что компонент содержит внедренный манифест. Visual Studio также автоматически включит зависимые файлы или сборки, перечисленные в манифесте, если они находятся в той же папке, что указанный компонент.

 Изоляция элемента управления COM облегчает развертывание компонентов COM, на которые у вас нет манифестов. Тем не менее если компонент предоставляется с манифестом, манифест можно ссылаться непосредственно. На самом деле, следует всегда использовать манифест, предоставляемый автором компонента, по возможности вместо использования **Isolated** свойство.

## <a name="limitations-of-registration-free-com-component-deployment"></a>Ограничения развертывания без регистрации COM-компонентов
 COM без регистрации имеет явные преимущества перед традиционных методов развертывания. Тем не менее существует ряд ограничений и пояснения, которые следует также обратить внимание. Самое большое ограничение заключается в том, что он работает только в Windows XP или более поздней версии. Реализация COM без регистрации необходимые изменения в работе, в котором загружаются компоненты в базовой операционной системе. К сожалению нет ни один уровень поддержки нижнего уровня для объектов COM без регистрации

 Не каждый компонент является подходящий кандидат для объектов COM без регистрации Компонент не подходит, если выполняется любое из следующих условий:

- Компонент — это сервер вне процесса. EXE-серверы не поддерживаются; поддерживаются только библиотеки DLL.

- Компонент является частью операционной системы или является компонентом системы, таких как XML, Internet Explorer или Microsoft Data Access Components (MDAC). Соблюдайте политику распространения автор компонента; Обратитесь к поставщику.

- Компонент является частью приложения, например Microsoft Office. Например не следует пытаться изолировать объектной модели Microsoft Excel. Это является частью Office и может использоваться только на компьютере с полной версией продукта Office установлены.

- Компонент предназначен для использования как надстройка, например надстройка Office или элемент управления в веб-браузере. Такие компоненты обычно требуют какой-то регистрации схемы, определенной средой размещения, выходит за пределы самого манифеста.

- Физические или виртуальные устройства для системы, например, драйвер устройства для диспетчера очереди печати управляет компонент.

- Компонент — распространяемый компонент доступа к данным. Данные приложения обычно требуется отдельный доступ к данным распространяемый должны быть установлены до их выполнения. Не следует пытаться изолировать компоненты, такие как элемент управления данными Microsoft ADO, OLE DB для Microsoft или Microsoft Data Access Components (MDAC). Вместо этого Если приложение использует компоненты MDAC или SQL Server Express, необходимо устанавливать их как необходимые компоненты; см. в разделе [как: Установка необходимых компонентов для приложения ClickOnce](../deployment/how-to-install-prerequisites-with-a-clickonce-application.md).

  В некоторых случаях возможно для разработчика компонента, изменить его для объектов COM без регистрации Если это невозможно, можно по-прежнему создавать и публиковать приложения, зависящие от них через стандартную схему регистрации с помощью загрузчика. Дополнительные сведения см. в разделе [создание пакетов загрузчика](../deployment/creating-bootstrapper-packages.md).

  COM-компонент может быть только один раз изолированной для каждого приложения. Например, нельзя изолировать один и тот же компонент COM из двух разных **библиотеки классов** проекты, которые являются частью того же приложения. Это вызовет предупреждение сборки и приложение не сможет загрузить во время выполнения. Чтобы избежать этой проблемы, корпорация Майкрософт рекомендует инкапсулировать COM-компонентов в единую библиотеку классов.

  Существует несколько сценариев, в которой COM-необходима регистрация на компьютере разработчика, несмотря на то, что регистрация не требуется для развертывания приложения. `Isolated` Свойство требует, чтобы COM-компонент был зарегистрирован на компьютере разработчика, чтобы автоматически создавать манифест во время сборки. Нет возможности определения регистрации, которые вызывают самостоятельную регистрацию во время сборки. Кроме того любые классы, не определенный явным образом в библиотеке типов, не будут отражены в манифесте. При использовании COM-компонент с уже существующим манифестом, такие как собственную ссылку, компонент может не должны быть зарегистрированы во время разработки. Тем не менее, регистрации является обязательным, если компонент является элементом управления ActiveX и вы хотите включить ее в **элементов** и в конструкторе Windows Forms.

## <a name="see-also"></a>См. также
- [Развертывание и безопасность технологии ClickOnce](../deployment/clickonce-security-and-deployment.md)