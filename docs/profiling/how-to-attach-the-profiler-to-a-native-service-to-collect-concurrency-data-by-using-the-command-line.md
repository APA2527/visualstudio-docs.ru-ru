---
title: Присоединение профилировщика к собственной службе для получения данных о параллелизме
description: Используйте Средства профилирования Visual Studio из командной строки для сбора данных параллелизма из собственной службы (C/C++).
ms.custom: SEO-VS-2020
ms.date: 11/04/2016
ms.topic: how-to
ms.assetid: 283a1ee1-b43e-4daf-95ae-1311925a42a8
author: mikejo5000
ms.author: mikejo
manager: jmartens
monikerRange: vs-2017
ms.workload:
- cplusplus
ms.openlocfilehash: 301e507e7debb04aab25b30e0a4e8f234f57a46b
ms.sourcegitcommit: ae6d47b09a439cd0e13180f5e89510e3e347fd47
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 02/08/2021
ms.locfileid: "99881637"
---
# <a name="how-to-attach-the-profiler-to-a-native-service-to-collect-concurrency-data-by-using-the-command-line-vsperfcmd"></a>Практическое руководство. Присоединение профилировщика к собственной службе для сбора данных параллелизма с помощью командной строки (VSPerfCmd)
В этой статье описывается использование программ командной строки средств профилирования [!INCLUDE[vsprvs](../code-quality/includes/vsprvs_md.md)] для подключения профилировщика к собственной службе (C/C++) и сбора данных о параллелизме потоков и процессов с помощью метода выборки.

> [!NOTE]
> Возможности расширенной безопасности в Windows 8 и Windows Server 2012 требовали значительных изменений в способе, которым профилировщик Visual Studio собирает данные на этих платформах. Для приложений универсальной платформы Windows также требуются новые методы сбора. См. раздел [Средства производительности в приложениях Windows 8 и Windows Server 2012](../profiling/performance-tools-on-windows-8-and-windows-server-2012-applications.md).

> [!NOTE]
> Сведения о пути к средствам профилирования см. в статье [Указание пути к программам командной строки средств профилирования](../profiling/specifying-the-path-to-profiling-tools-command-line-tools.md). На 64-разрядных компьютерах доступны 64- и 32-разрядные версии этих программ. Для использования программ командной строки профилировщика необходимо добавить путь к программам в переменную среды PATH окна командной строки или в саму команду.

 Когда профилировщик будет подключен к службе, можно будет приостанавливать и возобновлять сбор данных. Для завершения сеанса профилирования профилировщик следует отключить от службы и явным образом завершить его работу.

## <a name="attach-the-profiler"></a>Присоединение профилировщика
 Чтобы подключить профилировщик к собственной службе, используйте параметры **VSPerfCmd/start** и **/attach** для инициализации профилировщика и подключения его к целевому приложению. Параметры **/start** и **/attach** с соответствующими параметрами можно указать в одной командной строке. Можно также добавить параметр **/globaloff** для приостановки сбора данных при запуске целевого приложения. Затем используйте параметр **/globalon** для запуска сбора данных.

#### <a name="to-attach-the-profiler-to-a-native-service"></a>Подключение профилировщика к собственной службе

1. Если служба не запущена, запустите службу.

2. Запустите профилировщик. Для этого введите следующую команду в командной строке:

    [VSPerfCmd](../profiling/vsperfcmd.md) **/start:concurrency   /output:** `OutputFile` [`Options`]

   - Параметр [/output](../profiling/output.md) **:** `OutputFile` является обязательным для параметра **/start**. `OutputFile` указывает имя и расположение файла данных профилирования (VSP-файла).

     С параметром **/start** можно использовать любой из параметров, приведенных в следующей таблице.

   > [!NOTE]
   > Большинство служб требует указания параметров **/user** и **/crosssession**.

   | Параметр | Описание |
   | - | - |
   | [/user](../profiling/user-vsperfcmd.md) **:** [`Domain\`]`UserName` | Задает необязательные домен и имя пользователя учетной записи, которой будет предоставлен доступ к профилировщику. |
   | [/crosssession](../profiling/crosssession.md) | Включает профилирование процессов в других сеансах входа. |
   | [/wincounter](../profiling/wincounter.md) **:** `WinCounterPath` | Задает счетчик производительности Windows, данные которого будут собираться во время профилирования. |
   | [/automark](../profiling/automark.md) **:** `Interval` | Используется с только с параметром **/wincounter**. Указывает время (в миллисекундах) между событиями сбора счетчика производительности Windows. Значение по умолчанию — 500. |
   | [/events](../profiling/events-vsperfcmd.md) **:** `Config` | Задает события трассировки событий для Windows (ETW), собираемые во время профилирования. События трассировки событий Windows собираются в отдельный ETL-файл. |

3. Подключите профилировщик к службе. Для этого введите в командной строке следующую команду:

    **VSPerfCmd /attach:** `PID`

    `PID` указывает идентификатор процесса или имя процесса целевого приложения. Идентификаторы всех запущенных процессов можно просмотреть в диспетчере задач Windows.

## <a name="control-data-collection"></a>Управление сбором данных
 Пока целевое приложение выполняется, вы можете управлять сбором данных путем запуска и остановки записи данных в файл, используя параметры *VSPerfCmd.exe*. Управляя сбором данных, вы можете собирать данные на конкретных этапах выполнения программы, например при запуске или завершении работы приложения.

#### <a name="to-start-and-stop-data-collection"></a>Запуск и остановка сбора данных

- Пары параметров в следующей таблице запускают и останавливают сбор данных. Каждый параметр необходимо указывать в отдельной командной строке. Сбор данных можно включать и отключать несколько раз.

    |Параметр|Описание|
    |------------|-----------------|
    |[/globalon /globaloff](../profiling/globalon-and-globaloff.md)|Запускает (**/globalon**) или останавливает (**/globaloff**) сбор данных для всех процессов.|
    |[/processon](../profiling/processon-and-processoff.md) **:** `PID` [/processoff](../profiling/processon-and-processoff.md) **:** `PID`|Запускает ( **/processon**) или останавливает ( **/processoff**) сбор данных для процесса с указанным идентификатором процесса (`PID`).|
    |[/attach](../profiling/attach.md) **:**{`PID`&#124;`ProcName`} [/detach](../profiling/detach.md)[**:**{`PID`&#124;`ProcName`}]|**/attach** запускает сбор данных для процесса с указанным идентификатором (`PID`) или именем (*ProcName*) процесса. **/detach** останавливает сбор данных для указанного процесса или для всех процессов, если конкретный процесс не задан.|

## <a name="end-the-profiling-session"></a>Завершение сеанса профилирования
 Для завершения сеанса профилирования профилировщик не должен выполнять сбор данных. Вы можете остановить сбор данных из собственной службы, профилируемой с помощью метода параллелизма, остановив службу или вызвав параметр **VSPerfCmd /detach**. Затем можно вызвать параметр **VSPerfCmd/shutdown**, чтобы завершить работу профилировщика и закрыть файл данных профилирования.

#### <a name="to-end-a-profiling-session"></a>Завершение сеанса профилирования

1. Отключите профилировщик от целевого приложения. Для этого остановите службу или введите следующую команду в командной строке:

     Введите команду **VSPerfCmd /detach**.

2. Завершите работу профилировщика. Для этого введите следующую команду в командной строке:

     **VSPerfCmd**  [/shutdown](../profiling/shutdown.md)
