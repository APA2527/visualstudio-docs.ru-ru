---
title: Выполнение средств профилирования с отладчиком и без него | Документация Майкрософт
ms.date: 5/26/2020
ms.topic: conceptual
ms.assetid: 3fcdccad-c1bd-4c67-bcec-bf33a8fb5d63
author: mikejo5000
ms.author: mikejo
manager: jillfra
ms.workload:
- multiple
ms.openlocfilehash: 45632967c39348e8dc78dc3e2fb95227dcd86d7d
ms.sourcegitcommit: 1d4f6cc80ea343a667d16beec03220cfe1f43b8e
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 06/23/2020
ms.locfileid: "85285925"
---
# <a name="run-profiling-tools-with-or-without-the-debugger"></a>Запуск средств профилирования с отладчиком или без него

Visual Studio предлагает различные средства для измерения производительности и профилирования. Некоторые средства, такие как "Загрузка ЦП" и "Использование памяти", можно запустить с отладчиком или без него, а также с конфигурациями сборок отладки или выпуска. Средства Профилировщика производительности, такие как "Временная шкала приложения", могут выполняться для сборок отладки или выпуска. Встроенные в отладчик средства, такие как окно "Средства диагностики" и вкладка "События", выполняются только во время сеансов отладки.

>[!NOTE]
>Вы можете использовать средства оценки производительности, не относящиеся к отладчику, в Windows 7 и более поздних версий. Для выполнения интегрированных в отладчик средств профилирования требуется Windows 8 или более поздней версии.

Не связанный с отладчиком Профилировщик производительности и встроенные в отладчик Средства диагностики предоставляют разные сведения и интерфейсы. Интегрированные в отладчик средства показывают точки останова и значения переменных. Не связанные с отладчиком средства дают результаты, которые ближе к взаимодействию с конечным пользователем.

Чтобы определить, какие средства и результаты для этого нужно использовать, примите во внимание следующее:

- Внешние проблемы производительности, например проблемы файлового ввода-вывода или скорости реагирования сети, не слишком различаются в средствах, связанных и не связанных с отладчиком.
- Для проблем с вызовами, которые приводят к высокой загрузке ЦП, возможны значительные различия по производительности между сборками отладки и выпуска. Проверьте, существует ли проблема в сборках выпуска.
- Если проблема возникает только в сборках отладки, скорее всего, запускать средства, не связанные с отладчиком, не требуется. При проблемах со сборками выпуска определите, поспособствуют ли средства отладчика дальнейшему изучению проблемы.
- В сборках выпуска присутствуют такие оптимизации, как встраивание вызовов функций и констант, удаление путей кода, способы хранения переменных, которые не могут использоваться отладчиком. Показатели производительности в средствах, встроенных в отладчик, менее точны, так как в сборках отладки нет подобных оптимизаций.
- Отладчик сам изменяет время производительности по мере того, как он выполняет необходимые операции отладки (например, перехват исключений и события загрузки модулей).
- Показатели производительности сборки выпуска в средствах Профилировщика производительности являются наиболее точными и достоверными. Результаты средств, встроенных в отладчик, наиболее удобны для сравнения с другими измерениями, связанными с отладкой.

## <a name="collect-profiling-data-while-debugging"></a><a name="BKMK_Quick_start__Collect_diagnostic_data"></a> Сбор данных профилирования во время отладки

Если запустить отладку в Visual Studio, выбрав элементы **Отладка** > **Начать отладку** или нажав клавишу **F5**, по умолчанию отображается окно **Средства диагностики**. Чтобы открыть его вручную, выберите **Отладка** > **Окна** > **Отображение средств диагностики**. Окно **Средства диагностики** содержит сведения о событиях, памяти процессов и загрузке ЦП.

![Моментальный снимок в окне Средства диагностики](../profiling/media/diagnostictoolswindow.png "Окно "Средства диагностики"")

- Используйте значок **Параметры** на панели инструментов, чтобы указать, требуется ли просматривать показатели **Использование памяти**, **Анализ пользовательского интерфейса** и **Загрузка ЦП**.

- В раскрывающемся списке **Параметры** выберите пункт **Параметры**, чтобы открыть **страницы свойств Средств диагностики** с дополнительными параметрами.

- В Visual Studio Enterprise можно включить или отключить IntelliTrace, последовательно выбрав пункты **Сервис** > **Параметры** > **IntelliTrace**.

Сеанс диагностики закончится при остановке отладки.

### <a name="the-events-tab"></a>Вкладка "События"

Во время сеанса отладки на вкладке "События" окна "Средства диагностики" отображаются возникающие диагностические события. Префиксы категории *Точка останова*, *Файл* и другие позволяют быстро просмотреть список в поисках нужной категории или пропустить категории, которые вас не интересуют.

Для фильтрации событий в представлении можно использовать раскрывающийся список **Фильтр**, выбирая определенные категории событий или отменяя их выбор.

![Снимок экрана фильтра диагностических событий](../profiling/media/diagnosticeventfilter.png "Фильтр событий диагностики")

Чтобы найти определенную строку в списке событий, используйте поле поиска. Здесь показаны результаты поиска строки *name*, которой соответствуют четыре события:

![Снимок экрана поиска диагностических событий](../profiling/media/diagnosticseventsearch.png "Поиск событий диагностики")

Дополнительные сведения см. в разделе [Поиск и фильтрация на вкладке "События" окна "Средства диагностики"](https://devblogs.microsoft.com/devops/searching-and-filtering-the-events-tab-of-the-diagnostic-tools-window/).

## <a name="collect-profiling-data-without-debugging"></a>Сбор данных профилирования без отладки

Для сбора данных о производительности без отладки можно запустить средства Профилировщика производительности.

1. В открытом проекте в Visual Studio установите для решения конфигурацию  **Выпуск** и выберите цель развертывания  **Локальный отладчик Windows**  (или  **Локальный компьютер**).

1. Выберите **Отладка** > **Профилировщик производительности** или нажмите сочетание клавиш **ALT**+**F2**.

1. На странице запуска средств диагностики выберите режим запуска одного или нескольких средств. Отображаются только те средства, которые применимы к типу проекта, операционной системе и языку программирования. Выберите **Показать все инструменты**, чтобы просмотреть средства, отключенные для этого диагностического сеанса.

   ![Снимок экрана средств диагностики](../profiling/media/diaghubsummarypage.png "DIAG_SelectTool")

1. Для запуска диагностического сеанса нажмите кнопку **Запуск**.

   Во время выполнения сеанса некоторые средства отображают на странице средств диагностики графы данных в режиме реального времени, а также элементы управления для приостановки и возобновления сбора данных.

    ![Снимок экрана сбора данных в концентраторе производительности и диагностики](../profiling/media/diaghubcollectdata.png "Сбор данных в центре")

1. Для завершения диагностического сеанса выберите команду **Остановить сбор**.

   Проанализированные данные отображаются на странице **Отчет**.

Вы также можете сохранить отчеты и открыть их из списка **Последние сеансы** на странице запуска Средств диагностики.

![Снимок экрана списка последних сеансов на странице запуска Средств диагностики](../profiling/media/diaghubopenexistingdiagsession.png "PDHUB_OpenExistingDiagSession")

## <a name="collect-profiling-data-from-the-command-line"></a>Сбор данных профилирования из командной строки

Для измерения данных производительности из командной строки можно использовать файл VSDiagnostics.exe, который содержится в Visual Studio или в Инструментах удаленной отладки. Это полезно для записи трассировок производительности в системах, где не установлена служба Visual Studio, или для создания скриптов сбора трассировок производительности. При использовании файла VSDiagnostics.exe начинается сеанс диагностики, который сканирует и сохраняет данные профилирования до тех пор, пока средство не будет остановлено. На этом этапе данные экспортируются в файл DIAGSESSION, который можно открыть в Visual Studio для анализа результатов.

### <a name="launch-an-application"></a>Запуск приложения

1. Откройте командную строку и перейдите в каталог с помощью VSDiagnostics.exe:

   ```
   <Visual Studio Install Folder>\Team Tools\DiagnosticsHub\Collector\
   ```

2. Запустите файл VSDiagnostics.exe, введя следующую команду:

   ```
   VSDiagnostics.exe start <id> /launch:<appToLaunch> /loadConfig:<configFile>
   ```

   Необходимо включить следующие аргументы:

   - \<id\>. Определяет сеанс сбора. Идентификатор должен быть числом от 1 до 255.
   - \<appToLaunch\>. Исполняемый файл для запуска и профилирования.
   - \<configFile\>. Файл конфигурации для агента сбора данных, который необходимо запустить.

3. Чтобы остановить сбор данных и просмотреть результаты, выполните действия, описанные в разделе об остановке сбора далее в этой статье.

### <a name="attach-to-an-existing-application"></a>Присоединение к существующему приложению

1. Откройте приложение, например "Блокнот", а затем откройте **диспетчер задач**, чтобы получить идентификатор процесса (PID). В диспетчере задач на вкладке  **Сведения**  найдите PID.
2. Откройте командную строку и перейдите в каталог с помощью исполняемого агента сбора. Как правило, здесь:

   ```
   <Visual Studio installation folder>\2019\Preview\Team Tools\DiagnosticsHub\Collector\
   ```

3. Запустите файл VSDiagnostics.exe, введя следующую команду:

   ```
   VSDiagnostics.exe start <id> /attach:<pid> /loadConfig:<configFile>
   ```

   Необходимо включить следующие аргументы:

   - \<id\>. Определяет сеанс сбора. Идентификатор должен быть числом от 1 до 255.
   - \<pid\>. Идентификатор процесса, для которого вы будете выполнять профилирование. В этом случае — идентификатор процесса, найденный на шаге 1.
   - \<configFile\>. Файл конфигурации для агента сбора данных, который необходимо запустить. Дополнительные сведения см. в разделе  [Файлы конфигурации агента](../profiling/profile-apps-from-command-line.md).

4. Чтобы прервать сбор и просмотреть результаты, выполните действия, описанные в следующем разделе.

### <a name="stop-collection"></a>Остановка сбора

1. Остановите сеанс сбора и отправьте выходные данные в файл, введя следующую команду:

   ```
   VSDiagnostics.exe stop <id> /output:<path to file>
   ```

2. Перейдите в выходной файл из предыдущей команды и откройте его в Visual Studio, чтобы изучить собранные сведения.

## <a name="agent-configuration-files"></a>Файлы конфигурации агента

Агенты сбора являются взаимозаменяемыми компонентами, которые собирают различные типы данных в зависимости от того, что вы пытаетесь измерить.
Для удобства можно хранить эту информацию в файле конфигурации агента. Файл конфигурации — это JSON-файл, содержащий как минимум имя DLL-файла и его CLSID COM. Вот пример файлов конфигурации, которые находятся в следующей папке:

```
<Visual Studio installation folder>\Team Tools\DiagnosticsHub\Collector\AgentConfigs\
```

Скачать и просмотреть файлы конфигурации агента можно по следующим ссылкам:

- https://aka.ms/vs/diaghub/agentconfig/cpubase
- https://aka.ms/vs/diaghub/agentconfig/cpuhigh
- https://aka.ms/vs/diaghub/agentconfig/cpulow
- https://aka.ms/vs/diaghub/agentconfig/database
- https://aka.ms/vs/diaghub/agentconfig/dotnetasyncbase
- https://aka.ms/vs/diaghub/agentconfig/dotnetallocbase
- https://aka.ms/vs/diaghub/agentconfig/dotnetalloclow

Конфигурации CpuUsage (базовая/низкая/высокая) соответствуют данным, собранным для инструмента профилирования  [Загрузка ЦП](../profiling/cpu-usage.md).
Конфигурации DotNetObjectAlloc (базовая/низкая) соответствуют данным, собранным для  [инструмента .NET Object Allocation](../profiling/dotnet-alloc-tool.md) (Выделение объектов .NET).

Базовая/низкая/высокая конфигурации означают частоту выборки. Например, "Низкая" означает 100 выборок в секунду, а "Высокая" — 4000 выборок в секунду.
Чтобы средство VSDiagnostics.exe работало с агентом сбора, ему требуется DLL-файл и CLSID COM для соответствующего агента. Агент также может иметь дополнительные параметры конфигурации. Если вы применяете агент без файла конфигурации, используйте формат в следующей команде:

```
VSDiagnostics.exe start <id> /attach:<pid> /loadAgent:<agentCLSID>;<agentName>[;<config>]
```
