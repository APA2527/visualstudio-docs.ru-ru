---
title: Анализ использования памяти в Профилировщике производительности
ms.custom: ''
ms.date: 04/02/2020
ms.topic: how-to
dev_langs:
- CSharp
- VB
- FSharp
- C++
author: mikejo5000
ms.author: mikejo
manager: jillfra
ms.workload:
- multiple
ms.openlocfilehash: e6e1bd3d38e6303f11ec5da0e88816d56dd43d98
ms.sourcegitcommit: ae9145b32fc8e1e663e504c315a5df5dd302fee9
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 10/29/2020
ms.locfileid: "92918231"
---
# <a name="analyze-memory-usage-without-debugging-in-the-performance-profiler"></a>Анализ использования памяти без использования отладки в Профилировщике производительности

Средство **Использование памяти** отслеживает использование памяти в приложении. Вы можете использовать его для изучения воздействия сценариев, разрабатываемых в Visual Studio, на память в режиме реального времени. Можно создавать подробные моментальные снимки состояния памяти приложения и сравнивать их для выявления первопричин проблем с памятью. Средство использования памяти поддерживается в приложениях .NET, ASP.NET, C++ и смешанных приложениях (на основе .NET и машинного кода).

Средство Использование памяти можно запускать [с отладчиком или без него](../profiling/running-profiling-tools-with-or-without-the-debugger.md). Из этой статьи вы узнаете, как в **Профилировщике производительности** Visual Studio использовать средство "Использование памяти" без отладчика (рекомендуется для сборок выпусков).

## <a name="memory-usage-diagnostic-sessions"></a>Диагностические сеансы по использованию памяти

**Запуск диагностического сеанса по использованию памяти:**

1. Откройте проект в Visual Studio.

   Средство использования памяти поддерживает приложения .NET, ASP.NET, C++ и смешанные приложениях (на основе .NET и машинного кода).

1. В меню "Отладка" установите для решения конфигурацию **Выпуск** и выберите цель развертывания **Локальный отладчик Windows** (или **Локальный компьютер** ).

1. В строке меню выберите **Отладка** >  **Профилировщик производительности**.

1. В разделе **Доступные инструменты** выберите **Использование памяти** и затем щелкните **Запустить**.

   ![Запуск сеанса диагностики использования памяти](../profiling/media/memuse_start_diagnosticssession.png "Запуск сеанса диагностики использования памяти")

### <a name="monitor-memory-use"></a>Контроль использования памяти

При запуске диагностического сеанса запускается ваше приложение, а в окне **Средства диагностики** отображается график использования памяти приложением.

![Страница обзора использования памяти](../profiling/media/memuse__reportoverview.png "MEMUSE__ReportOverview")

График временной шкалы показывает колебания объема памяти по мере выполнения приложения. Пики на графике обычно указывают на то, что некоторый код собирает или создает данные, а после обработки удаляет их. Крупные пики обозначают области, которые вы, вероятно, сможете оптимизировать. Особое внимание следует уделять использованию памяти без ее возвращения, так как это может указывать на неэффективное использование памяти и даже ее утечку.

### <a name="take-snapshots-of-app-memory-states"></a>Создание моментальных снимков с состояний памяти приложения

Приложение использует большое количество объектов, поэтому вам может потребоваться сосредоточить анализ на одном сценарии. Либо вы можете найти проблемы с памятью для дальнейшего изучения. Вы можете создать моментальные снимки во время диагностического сеанса, чтобы зафиксировать использование памяти в определенный момент времени. Рекомендуется получить базовый снимок приложения до возникновения проблем с памятью, другой снимок — при первом возникновении проблемы, а также дополнительные снимки, если вы в состоянии повторить этот сценарий.

Чтобы сделать моментальные снимки, когда вы захотите зафиксировать данные о памяти, выберите **Сделать снимок**.

### <a name="close-the-diagnostic-session"></a><a name="BKMK_Close_a_monitoring_session"></a> Закрытие диагностического сеанса

Чтобы остановить сеанс мониторинга без создания отчета, просто закройте окно диагностики. Чтобы создать отчет после сбора данных или создания моментальных снимков, выберите **Остановить сбор данных**.

![Остановить сбор](../profiling/media/memuse__stopcollection.png "Остановить сбор")

## <a name="memory-usage-reports"></a>Отчеты об использовании памяти

После остановки сбора данных инструмент **Использование памяти** останавливает приложение и отображает обзорную страницу **Использование памяти**.

![Страница обзора использования памяти](../profiling/media/memuse__reportoverview1.png "Страница обзора инструмента Использование памяти")

### <a name="memory-usage-snapshots"></a><a name="BKMK_Memory_Usage_snapshot_views"></a> Моментальные снимки использования памяти

Числа на панелях **Моментальный снимок** показывают байты и объекты в памяти при создании каждого моментального снимка, а также разницу между данным и предыдущим снимками.

Эти числа являются ссылками, открывающими подробные представления отчетов **Использование памяти** в новых окнах Visual Studio. [Подробный отчет о снимках](#snapshot-details-reports) отображает типы и экземпляры в одном моментальном снимке. [Разностный отчет по снимкам (diff)](#snapshot-difference-diff-reports) показывает сравнение типов и экземпляров на двух моментальных снимках.

  ![Ссылки для просмотра снимков](../profiling/media/memuse__snapshotview_numbered.png "Ссылки для просмотра снимков")

|Изображение|Описание|
|-|-|
|![Шаг 1](../profiling/media/procguid_1.png "ProcGuid_1")|Общее число байт в памяти на момент получения снимка.<br /><br /> Выберите эту ссылку, чтобы отобразить подробный отчет о снимках с сортировкой по общему размеру экземпляров типов.|
|![Шаг 2](../profiling/media/procguid_2.png "ProcGuid_2")|Общее число объектов в памяти на момент получения снимка.<br /><br /> Выберите эту ссылку, чтобы отобразить подробный отчет о снимках с сортировкой по числу экземпляров типов.|
|![Шаг 3](../profiling/media/procguid_3.png "ProcGuid_3")|Разница между общим размером объектов в памяти для данного и предыдущего снимков. <br /><br /> Положительное число означает, что размер памяти этого снимка больше размера памяти предыдущего снимка, если же первый размер меньше второго, отображается отрицательное число. **Базовый** означает, что моментальный снимок является первым в диагностическом сеансе. **Нет различий** означает, что разница равна нулю.<br /><br /> Выберите эту ссылку, чтобы отобразить разностный отчет о снимках с сортировкой по разности общих размеров экземпляров типов.|
|![Шаг 4](../profiling/media/procguid_4.png "ProcGuid_4")|Разница между общим числом объектов в памяти для данного и предыдущего снимков.<br /><br /> Выберите эту ссылку, чтобы отобразить разностный отчет о снимках с сортировкой по разности общих количеств экземпляров типов.|

## <a name="memory-usage-snapshot-reports"></a>Отчеты о снимках "Использование памяти"

<a name="BKMK_Snapshot_report_trees"></a> Если выбрать одну из ссылок моментального снимка на обзорной странице **Использование памяти** , на новой странице открывается отчет о снимках.

![Моментальный отчет "Использование памяти"](../profiling/media/memuse_snapshotreport_all.png "Моментальный отчет Использование памяти")

В отчете о снимках можно развернуть записи **Тип объекта** , чтобы отобразить дочерние записи. В качестве имен экземпляров используются уникальные идентификаторы, создаваемые инструментом "Использование памяти".

Если текст **Тип объекта** выделен голубым цветом, его можно выбрать для перехода к соответствующему объекту в исходном коде в отдельном окне.

Если вы не можете идентифицировать какие-либо типы или не понимаете, для чего они используются в коде, вероятно, что они относятся к объектам .NET, операционной системы или компилятора. Средство **Использование памяти** отображает эти объекты, если они входят в состав цепочек владения ваших объектов.

В отчете о снимках:

- Дерево **Управляемая куча** показывает типы и экземпляры в отчете. При выборе типа или экземпляра отображаются деревья **Пути к корню** и **Объекты, на которые указывает ссылка** для выбранного элемента.

- Дерево **Пути к корню** показывает цепочку объектов, ссылающихся на тип или экземпляр. Сборщик мусора .NET очищает память для объекта только после освобождения всех ссылок на него.

- Дерево **Типы, на которые указывает ссылка** или **Объекты, на которые указывает ссылка** показывает объекты, на которые ссылается выбранный тип или экземпляр.

### <a name="report-tree-filters"></a><a name="BKMK_Report_tree_filters_"></a> Фильтры деревьев отчетов

Многие типы в приложениях мало интересуют разработчиков приложений. Фильтры отчетов о снимках позволяют скрыть большинство таких типов в деревьях **Управляемая куча** и **Пути к корню**.

![Параметры сортировки и фильтрации](../profiling/media/memuse_sortandfilter.png "MEMUSE_SortAndFilter")

- <a name="BKMK_Filter"></a> Чтобы отфильтровать дерево по имени типа, введите имя в поле **Фильтр**. Этот фильтр не учитывает регистр и распознает введенную строку в любой части имени типа.

- <a name="BKMK_Collapse_Small_Objects"></a> Выберите **Свернуть маленькие объекты** в раскрывающемся списке **Фильтр** , чтобы скрыть все типы, у которых **Размер (байт)** меньше 0,5 процента от общего объема памяти.

- <a name="BKMK_Just_My_Code"></a> Выберите **Только мой код** в раскрывающемся списке **Фильтр** , чтобы скрыть большинство экземпляров, созданных внешним кодом. Внешние типы принадлежат операционной системе или компонентам платформы либо создаются компилятором.

## <a name="snapshot-details-reports"></a>Подробные отчеты о снимках

 Подробный отчет о снимках описывает один снимок из диагностического сеанса. Чтобы открыть отчет, выберите ссылку размера или объектов в области моментального снимка.

 ![Ссылки на моментальный отчет на панели снимка](../profiling/media/memuse_snapshotview_snapshotdetailslinks.png "Ссылки на моментальный отчет на панели снимка")

Обе ссылки открывают один и тот же отчет. Единственное различие заключается в начальном порядке сортировки дерева **Управляемая куча**. Ссылка размера сортирует отчет по столбцу **Инклюзивный размер (байт)** . Ссылка объектов сортирует отчет по столбцу **Количество**. Вы можете изменить порядок или столбец сортировки после открытия отчета.

### <a name="managed-heap-tree-snapshot-details-reports"></a><a name="BKMK_Managed_Heap_tree__Snapshot_details_"></a> Дерево "Управляемая куча" (подробные отчеты о снимках)
 Дерево **Управляемая куча** перечисляет типы объектов, которые хранятся в памяти. Вы можете развернуть имя типа, чтобы просмотреть десять самых крупных экземпляров этого типа, отсортированных по размеру. При выборе типа или экземпляра отображаются деревья **Пути к корню** и **Объекты, на которые указывает ссылка** для выбранного элемента.

 ![Дерево "Управляемая куча"](../profiling/media/memuse__snapshotdetails_managedheaptree.png "Дерево Управляемая куча")

Дерево **Управляемая куча** в подробном отчете о снимках содержит следующие столбцы:

|name|Описание|
|-|-|
|**Тип объекта**|Имя типа или экземпляра объекта.|
|**Количество**|Число экземпляров объекта типа. Для экземпляра **Количество** всегда равно 1.|
|**Размер (байт)**|Для типа — это размер всех экземпляров типа в снимке без учета размера объектов, содержащихся в этих экземплярах.<br /><br /> Для экземпляра — это размер объекта без учета размера объектов, содержащихся в экземпляре. |
|**Инклюзивный размер (байт)**|Размер экземпляров типа или размер отдельного экземпляра, включая размер содержащихся внутри объектов.|
|**Модуль**|Модуль, содержащий объект.|

### <a name="paths-to-root-tree-snapshot-details-reports"></a><a name="BKMK_Paths_to_Root_tree__Snapshot_details_"></a> Дерево "Пути к корню" (подробные отчеты о снимках)
Дерево **Пути к корню** показывает цепочку объектов, ссылающихся на тип или экземпляр. Сборщик мусора .NET очищает память для объекта только после освобождения всех ссылок на него.

Для типа в дереве **Пути к корню** число объектов, которые содержат ссылки на этот тип, отображается в столбце **Количество ссылок**.

![Дерево "Пути к корню" для типов](../profiling/media/memuse_snapshotdetails_type_pathstoroottree.png "Дерево Пути к корню для типов")

### <a name="referenced-types-or-referenced-objects-tree-snapshot-details-reports"></a><a name="BKMK_Referenced_Objects_tree__Snapshot_details_"></a> Дерево "Типы, на которые указывает ссылка" или "Объекты, на которые указывает ссылка" (подробные отчеты о снимках)
Дерево **Типы, на которые указывает ссылка** или **Объекты, на которые указывает ссылка** показывает объекты, на которые ссылается выбранный тип или экземпляр.

![Дерево "Объекты со ссылками" для экземпляров](../profiling/media/memuse_snapshotdetails_referencedobjects_instance.png "Дерево Объекты со ссылками для экземпляров")

Дерево **Типы, на которые указывает ссылка** в подробном отчете о снимках содержит следующие столбцы: Дерево **Объекты, на которые указывает ссылка** не содержит столбец **Количество ссылок**.

|name|Описание|
|-|-|
|**Тип объекта** или **Экземпляр**|Имя типа или экземпляра.|
|**Количество ссылок**|Для типов это число экземпляров объекта типа.|
|**Размер (байт)**|Для типа — это размер всех экземпляров типа без учета размера объектов, содержащихся в этом типе.<br /><br /> Для экземпляра — это размер объекта без учета размера объектов, содержащихся в объекте.|
|**Инклюзивный размер (байт)**|Размер экземпляров типа или размер экземпляра, включая размер содержащихся внутри объектов.|
|**Модуль**|Модуль, содержащий объект.|

## <a name="snapshot-difference-diff-reports"></a>Разностные отчеты по снимкам (diff)

Разностный отчет по снимкам (diff) показывает изменения между основным и предыдущим снимками. Чтобы открыть разностный отчет, выберите одну из ссылок различия в области снимка.

Обе ссылки открывают один и тот же отчет. Единственное различие заключается в начальном порядке сортировки дерева **Управляемая куча** в этом отчете. Ссылка размера сортирует отчет по столбцу **Разница инклюзивного размера (байт)** . Ссылка объектов сортирует отчет по столбцу **Разница по количеству**. Вы можете изменить порядок или столбец сортировки после открытия отчета.

 ![Ссылки на отчет о различиях на панели снимка](../profiling/media/memuse_snapshotview_snapshotdifflinks.png "Ссылки на отчет о различиях на панели снимка")

### <a name="managed-heap-tree-snapshot-diff-reports"></a><a name="BKMK_Managed_Heap_tree__Snapshot_diff_"></a> Дерево "Управляемая куча" (отчеты о разнице между снимками)

 Дерево **Управляемая куча** перечисляет типы объектов, которые хранятся в памяти. Вы можете развернуть имя типа, чтобы просмотреть десять самых крупных экземпляров этого типа, отсортированных по размеру. При выборе типа или экземпляра отображаются деревья **Пути к корню** и **Объекты, на которые указывает ссылка** для выбранного элемента.

 ![Дерево "Управляемая куча" для типа в отчете о различиях](../profiling/media/memuse_snapshotdiff_type_heap.png "Дерево Управляемая куча для типа в отчете о различиях")

Дерево **Управляемая куча** в отчете о различиях снимков содержит следующие столбцы:

|name|Описание|
|-|-|
|**Тип объекта**|Имя типа или экземпляра объекта.|
|**Количество**|Число экземпляров типа в основном снимке. Для экземпляра **Количество** всегда равно 1.|
|**Разница количества**|Для типа разница в количестве экземпляров типа между основным и предыдущим снимками. Для экземпляра это поле отображается пустым.|
|**Размер (байт)**|Размер объектов в основном снимке без учета размера объектов, содержащихся в этих объектах. Для типа **Размер (байт)** и **Инклюзивный размер (байт)**  — это общие размеры экземпляров типа.|
|**Разница общего размера (байт)**|Для типа — это разница в общем размере экземпляров типа между основным снимком и предыдущим снимком без учета размера объектов, содержащихся в этих экземплярах. Для экземпляра это поле отображается пустым.|
|**Инклюзивный размер (байт)**|Размер объектов в основном снимке без учета размера объектов, содержащихся в этих объектах.|
|**Разница инклюзивного размера (байт)**|Для типа — это разница в размере всех экземпляров типа между основным снимком и предыдущим снимком с учетом размера объектов, содержащихся в этих объектах. Для экземпляра это поле отображается пустым.|
|**Модуль**|Модуль, содержащий объект.|

### <a name="paths-to-root-tree-snapshot-diff-reports"></a><a name="BKMK_Paths_to_Root_tree__Snapshot_diff_"></a> Дерево "Пути к корню" (отчеты о разнице между снимками)

Дерево **Пути к корню** показывает цепочку объектов, ссылающихся на тип или экземпляр. Сборщик мусора .NET очищает память для объекта только после освобождения всех ссылок на него.

Для типа в дереве **Пути к корню** число объектов, которые содержат ссылки на этот тип, отображается в столбце **Количество ссылок**. Разница по количеству от предыдущего снимка указана в столбце в **Reference Diff** (Разница по ссылкам).

 ![Дерево "Пути к корню" в отчете о различиях](../profiling/media/memuse_snapshotdiff_pathstoroot_instance_all.png "Дерево Пути к корню в отчете о различиях")

### <a name="referenced-types-or-referenced-objects-tree-snapshot-diff-reports"></a><a name="BKMK_Referenced_Objects_tree__Snapshot_diff_"></a> Дерево "Типы, на которые указывает ссылка" или "Объекты, на которые указывает ссылка" (отчеты о различиях снимков)

Дерево **Типы, на которые указывает ссылка** или **Объекты, на которые указывает ссылка** показывает объекты, на которые ссылается выбранный тип или экземпляр.

![Ссылочные типы в отчете о различиях](../profiling/media/memuse_snapshotdiff_referencedtypes.png "Ссылочные типы в отчете о различиях")

Дерево **Типы, на которые указывает ссылка** в отчете о различиях снимков содержит следующие столбцы: Дерево **Объекты, на которые указывает ссылка** имеет столбцы **Экземпляр** , **Размер (байт)** , **Инклюзивный размер (байт)** и **Модуль**.

|name|Описание|
|-|-|
|**Тип объекта** или **Экземпляр**|Имя типа или экземпляра объекта.|
|**Количество ссылок**|Число экземпляров типа в основном снимке.|
|**Разница числа ссылок**|Для типа разница в количестве экземпляров типа между основным и предыдущим снимками.|
|**Размер (байт)**|Размер объектов в основном снимке без учета размера объектов, содержащихся в этих объектах. Для типа **Размер (байт)** и **Инклюзивный размер (байт)**  — это общие размеры экземпляров типа.|
|**Разница общего размера (байт)**|Для типа — это разница в общем размере экземпляров типа между основным снимком и предыдущим снимком без учета размера объектов, содержащихся в этих экземплярах. |
|**Инклюзивный размер (байт)**|Размер объектов в основном снимке без учета размера объектов, содержащихся в этих объектах.|
|**Разница инклюзивного размера (байт)**|Для типа — это разница в размере всех экземпляров типа между основным снимком и предыдущим снимком с учетом размера объектов, содержащихся в этих объектах.|
|**Модуль**|Модуль, содержащий объект.|

## <a name="see-also"></a>См. также
- [Память JavaScript](../profiling/javascript-memory.md)
- [Профилирование в Visual Studio](../profiling/index.yml)
- [Первое знакомство со средствами профилирования](../profiling/profiling-feature-tour.md)
- [Рекомендации по повышению производительности для приложений универсальной платформы Windows на C++, C# и Visual Basic](/previous-versions/windows/apps/hh750313\(v\=win.10\))
- [Диагностика проблем, связанных с памятью, с помощью нового средства "Использование памяти" в Visual Studio](https://devblogs.microsoft.com/devops/diagnosing-memory-issues-with-the-new-memory-usage-tool-in-visual-studio/)