---
title: Анализ использования памяти для объектов .NET | Документация Майкрософт
ms.date: 12/9/2019
ms.topic: conceptual
helpviewer_keywords:
- memory allocation, memory usage
author: Sagar-S-S
ms.author: sashe
manager: AndSter
ms.workload:
- multiple
ms.openlocfilehash: 2a812ea3dcddc2fa6093b2b5b99684d1d5194654
ms.sourcegitcommit: 1d4f6cc80ea343a667d16beec03220cfe1f43b8e
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 06/23/2020
ms.locfileid: "85280039"
---
# <a name="analyze-memory-usage-by-using-the-net-object-allocation-tool"></a>Анализ использования памяти с помощью средства выделения объектов .NET

С помощью средства выделения объектов .NET можно узнать, сколько памяти использует приложение и для каких путей к коду выделяется наибольший ее объем.

После запуска средства можно увидеть пути выполнения функций, для которых выделяются объекты. Затем можно проследить путь к корню дерева вызовов, который использует больше всего памяти.

## <a name="setup"></a>Установка

1. Откройте профилировщик производительности (**ALT+F2**) в Visual Studio.

1. Установите флажок **.NET Object Allocation Tracking** (Отслеживание выделения объектов .NET).

   ![Выбранное средство отслеживания выделения объектов Dotnet](../profiling/media/dotnetalloctoolselected.png "Выбранное средство отслеживания выделения объектов Dotnet")

1. Нажмите кнопку **Пуск**, чтобы запустить средство.

1. После его запуска просмотрите сценарий, который вы хотите профилировать в приложении. Затем выберите **Остановить сбор** или закройте приложение, чтобы просмотреть данные.

   ![Окно с параметром "Остановить сбор"](../profiling/media/stopcollectionlighttheme.png "Окно с параметром "Остановить сбор"")

1. Щелкните вкладку **Выделение**. Теперь содержимое окна должно выглядеть как на снимке экрана ниже.

   ![Вкладка "Выделение"](../profiling/media/allocationview.png "Вкладка "Выделение"")

Теперь вы можете проанализировать выделение памяти объектам.

Во время сбора средство отслеживания может замедлить работу профилированного приложения. Если производительность средства отслеживания или приложения замедлена и если не требуется отслеживать каждый объект, можно настроить частоту выборки. Для этого на странице сводки профилировщика рядом со средством отслеживания щелкните значок шестеренки.

![Параметры для средства выделения Dotnet](../profiling/media/dotnetallocsettings.png "Параметры для средства выделения Dotnet")

Настройте необходимую частоту выборки. Такое изменение улучшит производительность приложения во время сбора и анализа.

![Настройка частоты выборки](../profiling/media/adjustedsamplingratedotnetalloctool.png "Настройка частоты выборки")

Дополнительные сведения о том, как сделать средство более эффективным, см. в статье [Оптимизация параметров профилировщика](../profiling/optimize-profiler-settings.md).

## <a name="understand-your-data"></a>Анализ данных

![Граф для средства выделения Dotnet](../profiling/media/graphdotnetalloc.png "Граф для средства выделения Dotnet")

В предыдущем графическом представлении на верхнем графе показано количество активных объектов в приложении. На нижнем графе **Object delta** (Изменение объекта) показано процентное изменение объектов приложения. Красные столбцы обозначают, что была проведена сборка мусора.

![Отфильтрованный граф по времени выделения Dotnet](../profiling/media/graphdotnetalloctimefiltered.png "Отфильтрованный граф по времени выделения Dotnet")

Можно отфильтровать табличные данные, чтобы отображать действия только для указанного диапазона времени. Можно также увеличивать или уменьшать граф.

### <a name="allocation"></a>Выделение

![Развернутое представление "Выделение"](../profiling/media/allocationexpandedlight.png "Развернутое представление "Выделение"")

В представлении **Выделение** показано местонахождение объектов, которым выделена память, и объем выделенной им памяти.

- Столбец **Тип** содержит список классов и структур, занимающих память. Дважды щелкните тип, чтобы просмотреть его обратную трассировку в виде инвертированного дерева вызовов. Только в представлении **Выделение** можно просмотреть элементы в выбранной категории, занимающей память.

- В столбце **Выделения** показано количество занимающих память объектов, относящихся к определенному типу выделения или функции. Этот столбец отображается только в представлениях **Выделение**, **Дерево вызовов** и **Функции**.

- Столбцы **Байт** и **Average Size (Bytes)**  (Средний размер (байт)) по умолчанию скрыты. Чтобы их отобразить, щелкните правой кнопкой мыши столбец **Type** (Тип) или **Выделения**, а затем выберите параметры **Байт** и **Average Size (Bytes)**  (Средний размер (байт)), чтобы добавить их в диаграмму. 

   Эти два столбца похожи на **Total (Allocations)** (Всего (выделения)) и **Self (Allocations)** (Собственные (выделения)) за тем исключением, что вместо количества объектов, занимающих память, в них показан общий объем занимаемой памяти. Эти столбцы отображаются только в представлении **Выделение**.

- В столбце **Имя модуля** показан модуль, содержащий вызывающую функцию или процесс.

Все эти столбцы можно сортировать. Для столбцов **Тип** и **Имя модуля** можно сортировать элементы в алфавитном порядке по возрастанию или убыванию. Для столбцов **Выделения**, **Байт** и **Average Size (Bytes)** (Средний размер (байт)) можно сортировать элементы по увеличению или уменьшению числовых значений.

#### <a name="symbols"></a>Символы

На вкладках **Выделение**, **Дерево вызовов** и **Функции** отображаются следующие символы:

- ![Символ типа значения](../profiling/media/valuetypeicon.png "Символ типа значения") — тип значения, например целое число.

- ![Символ коллекции типа значения](../profiling/media/valuetypecollectionicon.png "Символ коллекции типа значения") — коллекция типа значения, например массив целых чисел.

- ![Символ ссылочного типа](../profiling/media/referencetypeicon.png "Символ ссылочного типа") — ссылочный тип, например строка.

- ![Символ коллекции ссылочного типа](../profiling/media/referencetypecollectionicon.png "Символ коллекции ссылочного типа") — коллекция ссылочного типа, например массив строк.

### <a name="call-tree"></a>Дерево вызовов

![Представление "Дерево вызовов"](../profiling/media/calltreelight.png "Представление "Дерево вызовов"")

В представлении **Дерево вызовов** отображаются пути выполнения функций, содержащие объекты, для которых выделяется много памяти.

- В столбце **Имя функции** показан процесс или имя функции, содержащей объекты, для которых выделяется память. Отображение зависит от уровня проверяемого узла.
- В столбцах **Total (Allocations)** (Всего (выделения)) и **Общий размер (байт)**  отображается количество выделенных объектов и объем памяти, используемые функцией и всеми другими функциями, которые она вызывает.
- В столбцах **Self (Allocations)** (Собственные (выделения)) и **Self-Size (Bytes)** (Собственный размер (байт)) отображается количество выделенных объектов и объем памяти, используемый одной выбранной функцией или типом выделения.
- В столбце **Average Size (Bytes)** (Средний размер (байт)) отображаются те же сведения, что и в представлении **Выделения**.
- В столбце **Имя модуля** показан модуль, содержащий вызывающую функцию или процесс.

   ![Развернутый критический путь](../profiling/media/hotpathlight.png "Развернутый критический путь")

- При нажатии кнопки **Развернуть критический путь** высвечивается путь выполнения функции, содержащий множество объектов, для которых выделяется память. Алгоритм высвечивает путь с наибольшим количеством выделений, начиная с выбранного узла, помогая изучать использование памяти.
- Кнопка **Показать критический путь** отображает или скрывает значки пламени, указывающие, какие узлы входят в критический путь.

### <a name="functions"></a>Функции

![Представление "Функции"](../profiling/media/functionslight.png "Представление "Функции"")

В представлении **Функции** показаны процессы, модули и функции, для которых выделяется память.

- В столбце **Имя** отображаются процессы в качестве узлов верхнего уровня. Под процессами располагаются модули, а под ними — функции.
- В этих столбцах приводятся те же сведения, что и в представлениях **Выделение** и **Дерево вызовов**:

   - **Total (Allocations)** (Всего (выделения));
   - **Self (Allocations)** (Собственные (выделения));
   - **Общий размер (байт)** ;
   - **Self-Size (Bytes)** (Собственный размер (байт));
   - **Average Size (Bytes)** (Средний размер (байт)).

### <a name="collection"></a>Collection

![Представление "Коллекция"](../profiling/media/collectionlight.png "Представление "Коллекция"")

В представлении **Коллекция** показано, сколько объектов было собрано или осталось во время сборки мусора. В нем также имеются круговые диаграммы для визуализации собранных и сохранившихся объектов по типу.

- В столбце **Собрано** показано количество объектов, собранных сборщиком мусора.
- В столбце **Осталось** показано количество объектов, сохранившихся после работы сборщика мусора.

### <a name="filtering-tools"></a>Средства фильтрации

В каждом из представлений **Выделения**, **Дерево вызовов** и **Функции** есть параметры **Показать только мой код** и **Show Native Code** (Показать машинный код), а также поле фильтра.

- Параметр **Показать только мой код** сворачивает системный код, код платформ и другой код, не написанный пользователем, во фреймы **[Внешний код]** , чтобы можно было сосредоточиться только на пользовательском коде. Дополнительные сведения см. в статье [Отладка пользовательского кода с использованием параметра "Только мой код"](../debugger/just-my-code.md).
- Параметр **Show Native Code** (Показать машинный код) отображает машинный код целевого объекта анализа и может содержать код, не являющийся пользовательским.
- Поле фильтра позволяет отфильтровать столбец **Имя** или **Имя функции** по указанному значению. Введите в поле строковое значение. Затем в таблице отобразятся только типы, содержащие эту строку.
