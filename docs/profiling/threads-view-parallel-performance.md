---
title: Представление "Потоки" в визуализаторе параллелизма | Документация Майкрософт
ms.date: 11/04/2018
ms.topic: conceptual
f1_keywords:
- vs.performance.view.threadblocking
helpviewer_keywords:
- Concurrency Visualizer, Threads View (Parallel Performance)
ms.assetid: 2e441103-a266-407b-88c3-fb58716257a3
author: mikejo5000
ms.author: mikejo
manager: jillfra
ms.workload:
- multiple
ms.openlocfilehash: 4382a21a68848a758f3d4cd37a8528722927691c
ms.sourcegitcommit: cc841df335d1d22d281871fe41e74238d2fc52a6
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 03/18/2020
ms.locfileid: "62973762"
---
# <a name="threads-view-in-the-concurrency-visualizer"></a>Представление "Потоки" в визуализаторе параллелизма

Представление **Потоки** является наиболее полным и функциональным представлением визуализатора параллелизма. В представлении **Потоки** можно определить, какие потоки выполняют код во время сегмента выполнения, и проанализировать, выполняются ли потоки или они блокированы в результате синхронизации, ввода-вывода или по какой-либо другой причине. В отчетах представления **Потоки** также профилируется выполнение дерева стека вызовов и разблокировка потоков.

Во время выполнения потоков визуализатор параллелизма собирает образцы. Когда выполнение потока останавливается, визуализатор анализирует все события переключения контекста операционной системы для потока. Переключение контекста может быть вызвано многими причинами, например:

- поток заблокирован примитивом синхронизации;
- истек квант времени потока;
- поток совершает блокирующий запрос ввода-вывода.

Визуализатор параллелизма распределяет потоки и события переключения контекста по категориям и выполняет поиск известных блокировок API в стеке вызовов потока. Он отображает категории потоков в активной легенде в нижней левой части представления **Потоки**. В большинстве случаев вы можете определить истинную причину блокировки, проанализировав стеки вызовов, относящиеся к событиям переключения контекста.

Если совпадения для стека вызовов отсутствуют, визуализатор параллелизма использует причину ожидания, предоставленную [!INCLUDE[TLA#tla_mswin](../code-quality/includes/tlasharptla_mswin_md.md)]. Однако категория [!INCLUDE[TLA#tla_mswin](../code-quality/includes/tlasharptla_mswin_md.md)] может зависеть от особенностей реализации и не отражать намерений пользователя. Например, в качестве причины состояния ожидания блокировки собственного компактного модуля чтения и записи [!INCLUDE[TLA#tla_mswin](../code-quality/includes/tlasharptla_mswin_md.md)] указывает ввод-вывод вместо синхронизации.

Представление **Потоки** также показывает зависимости между потоками. Например, при обнаружении потока, блокируемого объектом синхронизации, можно найти поток, который его разблокировал. Можно проанализировать стек вызовов и узнать, что происходило с разблокирующим потоком в то время, когда он разблокировал другой поток.

Представление **Потоки** можно использовать для следующих целей.

- Определение причин, по которым пользовательский интерфейс не отвечает на определенных этапах выполнения.
- Определение количества времени, затраченного на блокировку при синхронизации, вводе-выводе, ошибках страниц и при других событиях.
- Определение степени влияния других процессов, выполняемых в системе.
- Определение проблем балансировки нагрузки для параллельного выполнения.
- Определение причин неоптимальной масштабируемости или ее полного отсутствия. Например, причин, по которым производительность параллельно выполняемого приложения не повышается при наличии в системе большего количества логических ядер.
- Определение степени параллелизма приложения для содействия в применении принципа параллелизма.
- Определение зависимостей между рабочими потоками и критическими путями выполнения.

## <a name="use-threads-view"></a>Использование представления "Потоки"

Чтобы запустить визуализатор параллелизма, выберите **Анализ** > **Визуализатор параллелизма**, а затем выберите параметр, например **Запустить новый процесс**.

Визуализатор параллелизма запускает приложение и собирает данные трассировки, пока вы не щелкните **Остановить сбор данных**. Затем визуализатор анализирует данные трассировки и отображает результаты на странице отчета трассировки.

Чтобы открыть представление **Потоки**, перейдите в представление **Потоки** в верхней левой части отчета.

![Представление "Потоки"](../profiling/media/threadsviewnarrowing.png "Представление "Потоки"")

Выберите промежутки времени и потоки, чтобы начать анализ производительности.

## <a name="timeline-analysis"></a>Анализ временной шкалы

В верхней части представления **Потоки** находится временная шкала. На временной шкале отображаются действия для всех потоков процесса и всех физических дисковых устройств на главном компьютере. На ней также показаны действия GPU и события маркеров.

На временной шкале по оси X отмечается время, а по оси Y — несколько каналов:

- В системе предусмотрены два канала ввода-вывода для каждого жесткого диска: один канал для чтения и один — для записи.
- Канал для каждого потока процесса.
- Каналы маркеров, если в трассировке есть события маркеров. Каналы маркеров изначально отображаются в списке каналов потоков, которые инициировали эти события.
- Каналы GPU.

Изначально потоки отсортированы в том порядке, в котором они были созданы, так что главный поток приложения будет первым. Чтобы отсортировать потоки по другим критериям, например по **интенсивности выполнения**, можно выбрать другой параметр в раскрывающемся списке **Сортировка**.

На временной шкале состояние потока в любой заданный момент времени обозначается определенным цветом. Зеленые сегменты выполняются, красные заблокированы для синхронизации, желтые сегменты вытеснены, а пурпурные заняты вводом-выводом на устройстве.

Вы можете увеличить масштаб для просмотра более подробных сведений или уменьшить его для просмотра более длительного интервала времени. Чтобы получить подробные сведения о категориях, времени начала, задержках и состояниях стека вызовов, выберите сегменты и точки на диаграмме.

Временную шкалу можно использовать для анализа сбалансированности работы потоков, участвующих в параллельном цикле или параллельно выполняемых задачах. Если один поток занимает больше времени, чем другие, работа может быть не сбалансирована. Чтобы повысить производительность приложения, можно более равномерно распределить работу между потоками.

Если в определенный момент времени выполняется только один поток, возможно, приложение не использует все преимущества параллелизма в системе. Кроме того, временной шкалой можно воспользоваться для анализа зависимостей между потоками и для анализа временных отношений между блокирующим и заблокированными потоками. Чтобы изменить порядок потоков, выберите поток, а затем на панели инструментов щелкните значок с изображением стрелки вверх или вниз.

Можно скрыть потоки, которые не выполняют работу или полностью заблокированы, так как статистические данные по ним не актуальны и могут засорить отчеты. Чтобы скрыть потоки, выделите их имена, а затем на панели инструментов щелкните значок **Скрыть выбранные потоки** или **Скрыть все потоки, кроме выбранных**. Чтобы определить потоки, которые нужно скрыть, в нижнем левом углу щелкните ссылку **Сводка по потокам**. Можно скрыть неактивные потоки в диаграмме **Сводка по потокам**.

### <a name="thread-execution-details"></a>Сведения о выполнении потока
Чтобы получить более подробные сведения о сегменте выполнения, выберите точку в зеленом сегменте на временной шкале. Визуализатор параллелизма отображает черный курсор над выбранной точкой и выводит стек вызовов на вкладке **Текущий** на нижней панели. В сегменте выполнения можно выбрать несколько точек.

>[!NOTE]
>В визуализаторе параллелизма может оказаться невозможным выбрать определенную точку в сегменте выполнения, если длительность сегмента составляет менее одной миллисекунды.

Чтобы получить профиль выполнения для всех не скрытых в данный момент потоков в заданный диапазон времени, выберите **Выполнение** на ленте условных обозначений в левом нижнем углу.

### <a name="thread-blocking-details"></a>Сведения о блокировании потока
Для получения сведений об определенной области в потоке наведите на нее указатель для вывода подсказки. Подсказка содержит такие сведения, как категории, время начала и задержка. Выберите область для отображения стека вызова в определенный момент времени на вкладке **Текущий** на нижней панели. На ней отображается категория, задержка, API блокировки (если таковой имеется) и разблокирующий поток (если он имеется). Проанализировав стек вызовов, можно определить первопричины возникновения событий блокировки потока.

Путь выполнения может иметь несколько блокирующих событий. Чтобы изучить их по категории блокировки и быстрее определить проблемные области, выберите категорию блокировки на ленте условных обозначений в левой части.

### <a name="dependencies-between-threads"></a>Зависимости между потоками
Визуализатор параллелизма показывает зависимости между потоками, благодаря чему можно определить, что пытался сделать заблокированный поток и какой из других потоков возобновил его выполнение.

Чтобы определить, какой поток разблокировал другой поток, выберите блокирующий сегмент на временной шкале. Если визуализатор параллелизма может определить разблокировавший поток, то рисуется линия между разблокировавшим потоком и выполняемым сегментом, который следует за сегментом блокировки. Чтобы просмотреть соответствующий стек вызовов, откройте вкладку **Разблокировка стека** в нижней области.

## <a name="profile-reports"></a>Отчеты о профиле
Под временной шкалой располагается панель с вкладками для отчетов **Отчет о профиле**, **Текущий** и **Разблокировка стека**. Отчеты автоматически обновляются при изменении выбора данных на временной шкале и выбора потоков. Для больших трассировок панель отчетов может быть временно недоступна, пока выполняется расчет.

### <a name="profile-report-tab"></a>Вкладка "Отчет о профиле"

Для **отчета о профиле** доступно два фильтра.

- Чтобы отфильтровать записи дерева вызовов, на которые потрачено мало времени, в поле **Снижение шума** введите значение фильтра в диапазоне от 0 до 99 процентов. Значение по умолчанию — 2 процента.
- Чтобы просмотреть деревья вызовов только своего кода, установите флажок **Только мой код**. Чтобы просмотреть все деревья вызовов, снимите флажок.

На вкладке **Отчет о профиле** отображаются отчеты для категорий и ссылки в ленте условных обозначений. Для вывода отчета выберите одну из записей в левой части.

- **Выполнение**. В отчете **Выполнение** отображаются интервалы времени, в которые выполнялось приложение.

  Чтобы найти строку кода, на которую было затрачено время выполнения, разверните дерево вызовов и в контекстном меню элемента дерева вызовов выберите пункт **Просмотреть исходный код** или **Просмотреть сайты вызовов**. Команда **Просмотреть исходный код** позволяет найти выполненную строку кода. Команда **Просмотреть сайты вызовов** позволяет найти строку кода, в которой была вызвана выполненная строка. Если существует строка только одного сайта вызова, то его код будет выделен. Если существует несколько сайтов вызова, выберите нужный в диалоговом окне, а затем щелкните **Перейти к источнику**. Зачастую полезнее всего найти сайт вызова либо с наибольшим количеством экземпляров, либо с наибольшим временем выполнения, либо и с тем, и с другим. Дополнительные сведения см. в разделе [Выполнение отчета профилирования](../profiling/execution-profile-report.md).

- **Синхронизация**. В отчете **Синхронизация** отображаются вызовы, отвечающие за блокировки синхронизации, с указанием общего времени блокировки каждого стека вызовов. Дополнительные сведения см. в статье [Время синхронизации](../profiling/synchronization-time.md).

- **Ввод-вывод**. В отчете **Ввод-вывод** отображаются вызовы, отвечающие за блокировки ввода-вывода, с указанием общего времени блокировки каждого стека вызовов. Дополнительные сведения см. в статье [Время ввода-вывода (представление "Потоки")](../profiling/i-o-time-threads-view.md).

- **Спящий режим**. В отчете **Спящий режим** отображаются вызовы, отвечающие за блокировки спящего режима, с указанием общего времени блокировки каждого стека вызовов. Дополнительные сведения см. в статье [Время ожидания](../profiling/sleep-time.md).

- **Управление памятью**. В отчете **Управление памятью** отображаются вызовы, где происходили блокировки управления памятью, с указанием общего времени блокировки каждого стека вызовов. Эти сведения можно использовать для определения областей, в которых чрезмерно много проблем с подкачкой или сборкой мусора.  Дополнительные сведения см. в статье [Время управления памятью](../profiling/memory-management-time.md).

- **Вытеснение**. В отчете **Вытеснение** показано, какие процессы системы вытесняли текущий процесс и какие потоки заменяли потоки текущего процесса. Эти сведения можно использовать для определения процессов и потоков, которые наиболее часто выполняют вытеснение. Дополнительные сведения см. в статье [Время вытеснения](../profiling/preemption-time.md).

- **Обработка пользовательского интерфейса**. В отчете **Обработка пользовательского интерфейса** отображаются вызовы, отвечающие за блокировки обработки пользовательского интерфейса, с указанием общего времени блокировки каждого стека вызовов. Дополнительные сведения см. в статье [Время обработки пользовательского интерфейса](../profiling/ui-processing-time.md).

- **Сводка по потокам**. Выберите **Сводка по потокам** для отображения диаграммы, показывающей состояние потоков в течение выбранного интервала времени. Столбцы с цветовыми обозначениями показывают общее время, затраченное каждым потоком на пребывание в состоянии выполнения, блокировки, ввода-вывода или в каком-либо другом состоянии. Метки потоков расположены внизу. При изменении масштаба временной шкалы эта диаграмма автоматически обновляется.

  При определенном масштабе некоторые потоки могут не отображаться на диаграмме. В этом случае справа отображается кнопка с многоточием ( **…** ). Если нужный поток не отображается, можно скрыть другие потоки. Дополнительные сведения см. в разделе [Сводный отчет по каждому потоку](../profiling/per-thread-summary-report.md).

- **Операции диска**. На вкладке **Операции диска** показано, какие процессы и потоки использовались для дискового ввода-вывода для текущего процесса, какие файлы они затронули (например, библиотеки DLL, которые были загружены), сколько байт они считали, а также другие сведения. Этот отчет можно использовать для оценки времени, затраченного на доступ к файлам во время выполнения, особенно если процесс связан с операциями ввода-вывода. Дополнительные сведения см. в разделе [Отчет операций диска](../profiling/disk-operations-report-threads-view.md).

### <a name="current-tab"></a>Вкладка "Текущий"
На этой вкладке показан стек вызовов для выбранной точки сегмента потока на временной шкале. Стеки вызовов усекаются для того, чтобы отображать только действия, относящиеся к вашему приложению.

### <a name="unblocking-stack-tab"></a>Вкладка "Разблокировка стека"
На этой вкладке показано, какой поток разблокировал выбранный поток, а также стек разблокирующих вызовов.

## <a name="see-also"></a>См. также раздел
- [Визуализатор параллелизма](../profiling/concurrency-visualizer.md)
