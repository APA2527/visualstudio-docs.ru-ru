---
title: Удаленные рабочие области для R
description: Узнайте, как настраивать удаленные рабочие области R и подключаться к ним из Visual Studio.
ms.date: 12/04/2017
ms.topic: conceptual
author: kraigb
ms.author: kraigb
manager: jmartens
ms.workload:
- data-science
ms.openlocfilehash: 96078d1b2fdb5a54c912cbf214024726ce102e4e
ms.sourcegitcommit: ae6d47b09a439cd0e13180f5e89510e3e347fd47
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 02/08/2021
ms.locfileid: "99851846"
---
# <a name="set-up-remote-workspaces"></a>Настройка удаленных рабочих областей

Эта статья описывает настройку удаленного сервера с помощью SSL и соответствующей службы R. Это позволяет инструментам R для Visual Studio (RTVS) подключиться к удаленной рабочей области на этом сервере.

## <a name="remote-computer-requirements"></a>Требования к удаленному компьютеру

- Windows 10, Windows Server 2016 или Windows Server 2012 R2. Также требуется RTVS
- [.NET Framework 4.6.1](https://www.microsoft.com/download/details.aspx?id=49981) или более поздней версии

## <a name="install-an-ssl-certificate"></a>Установка SSL-сертификата

Для использования RTVS необходимо, чтобы все взаимодействие с удаленным сервером осуществлялось по протоколу HTTP, для чего на сервер необходимо установить SSL-сертификат. Можно использовать сертификат, подписанный доверенным центром сертификации (рекомендуется), или самозаверяющий сертификат. (Самозаверяющий сертификат приведет к появлению в RTVS предупреждений при подключении.) Любой из этих сертификатов необходимо установить на компьютер и разрешить доступ к его закрытому ключу.

### <a name="obtain-a-trusted-certificate"></a>Получение доверенного сертификата

Доверенный сертификат выдается центром сертификации (дополнительные сведения см. в [статье Википедии, посвященной центрам сертификации](https://en.wikipedia.org/wiki/Certificate_authority)). Как и в случае получения удостоверения личности, выпуск доверенного сертификата включает в себя дополнительную обработку и возможную плату, но также включает проверку подлинности запроса и запрашивающего.

Ключевым полем в сертификате является полное доменное имя компьютера, на котором установлен сервер R. Центр сертификации требует доказательства того, что вы уполномочены создавать сервер для домена, к которому принадлежит ваш сервер.

Дополнительные сведения см. в статье, посвященной [сертификатам открытого ключа](https://en.wikipedia.org/wiki/Public_key_certificate), в Википедии.

## <a name="install-an-ssl-certificate-on-windows"></a>Установка SSL-сертификата в Windows

В Windows SSL-сертификат необходимо устанавливать вручную. Для этого выполните приведенные ниже инструкции.

### <a name="obtain-a-self-signed-certificate-windows"></a>Получение самозаверяющего сертификата (Windows)

Пропустите этот раздел, если у вас есть доверенный сертификат. По сравнению с сертификатом от доверенного центра сертификации, получение самозаверяющего сертификата аналогично созданию удостоверения для самого себя. Это, конечно, гораздо проще, чем обращаться в доверенный центр сертификации, однако такой способ не обеспечивает строгую проверку подлинности, а это означает, что злоумышленник может заменить неподписанный сертификат своим собственным и захватить весь трафик между клиентом и сервером. Таким образом, *самозаверяющий сертификат следует использовать только для целей тестирования, в доверенной сети и никогда в рабочей среде тестирования.*

По этой причине RTVS всегда выдает следующее предупреждение при подключении к серверу с использованием самозаверяющего сертификата.

![Диалоговое окно предупреждения самозаверяющего сертификата](media/workspaces-remote-self-signed-certificate-warning.png)

Выдача самозаверяющего сертификата

1. Войдите на компьютер, где установлен сервер R, используя учетную запись администратора.
1. Откройте новую командную строку PowerShell администратора и выполните следующую команду, заменив `"remote-machine-name"` на полное доменное имя компьютера сервера.

    ```ps
    New-SelfSignedCertificate -CertStoreLocation Cert:\LocalMachine\My -DnsName "remote-machine-name"
    ```

1. Если вы ранее не работали с PowerShell на компьютере с сервером R, выполните следующую команду, чтобы команды выполнялись явным образом:

    ```ps
    Set-ExecutionPolicy -ExecutionPolicy RemoteSigned
    ```

Дополнительные сведения см. в статье, посвященной [самозаверяющим сертификатам](https://en.wikipedia.org/wiki/Self-signed_certificate), в Википедии.

### <a name="install-the-certificate"></a>Установка сертификата

Чтобы установить сертификат на удаленном компьютере, запустите *certlm.msc* (диспетчер сертификатов) из командной строки. Щелкните правой кнопкой мыши папку **Личные** и выберите команду **Все задачи** > **Импорт**.

![Команда импорта сертификата](media/workspaces-remote-certificate-import.png)

### <a name="grant-permissions-to-read-the-ssl-certificates-private-key"></a>Предоставление разрешений на чтение закрытого ключа SSL-сертификата

После импорта сертификата предоставьте учетной записи `NETWORK SERVICE` разрешения на чтение закрытого ключа, как описано ниже. Учетная запись `NETWORK_SERVICE` используется для запуска брокера служб R Services, который представляет собой службу для завершения входящих SSL-соединений с сервером.

1. Запустите *certlm.msc* (диспетчер сертификатов) из командной строки администратора.
1. Разверните папку **Личные** > **Сертификаты**, щелкните сертификат правой кнопкой мыши и выберите **Все задачи** > **Управление закрытыми ключами**.
1. Щелкните сертификат правой кнопкой мыши и выберите команду **Управление закрытыми ключами** в списке **Все задачи**.
1. В появившемся диалоговом окне выберите **Добавить** и введите `NETWORK SERVICE` в качестве имени учетной записи.

    ![Диалоговое окно управления закрытыми ключами, добавление NETWORK_SERVICE](media/workspaces-remote-manage-private-key-dialog.png)

1. Дважды нажмите кнопку **ОК**, чтобы закрыть диалоговое окно и сохранить изменения.

## <a name="install-an-ssl-certificate-on-ubuntu"></a>Установка SSL-сертификата в Ubuntu

По умолчанию при установке пакет `rtvs-daemon` устанавливает самозаверяющий сертификат.

### <a name="obtain-a-self-signed-certificate-ubuntu"></a>Получение самозаверяющего сертификата (Ubuntu)

Преимущества и риски, связанные с использованием самозаверяющего сертификата, см. в описании для Windows. При установке пакет `rtvs-daemon` создает и настраивает самозаверяющий сертификат. Это потребуется сделать, только если вы хотите заменить самозаверяющий сертификат, созданный автоматически.

Самостоятельная выдача самозаверяющего сертификата:

1. Войдите на компьютер Linux через протокол SSH или обычным образом.
2. Установите пакет `ssl-cert`:

    ```sh
    sudo apt-get install ssl-cert
    ```

3. Запустите `make-ssl-cert`, чтобы создать самозаверяющий SSL-сертификат по умолчанию:

    ```sh
    sudo make-ssl-cert generate-default-snakeoil --force-overwrite
    ```

4. Преобразуйте созданный ключ и PEM-файлы в PFX. Созданный PFX-файл должен находиться в домашней папке:

    ```sh
    openssl pkcs12 -export -out ~/ssl-cert-snakeoil.pfx -inkey /etc/ssl/private/ssl-cert-snakeoil.key -in /etc/ssl/certs/ssl-cert-snakeoil.pem -password pass:SnakeOil
    ```

### <a name="configure-rtvs-daemon"></a>Настройка управляющей программы RTVS

Путь к файлу SSL-сертификата (путь к PFX-файлу) должен быть задан в */etc/rtvs/rtvsd.config.json*. Внесите в `X509CertificateFile` и `X509CertificatePassword` соответственно путь к файлу и пароль.

```json
{
  "logging": { "logFolder": "/tmp" },
  "security": {
    "allowedGroup": "",
    "X509CertificateFile": "/etc/rtvs/ssl-cert-snakeoil.pfx",
    "X509CertificatePassword": "SnakeOil"
  },
  "startup": { "name": "rtvsd" },
  "urls": "https://0.0.0.0:5444"
}
```

Сохраните файл и перезапустите управляющую программу `sudo systemctl restart rtvsd`.

## <a name="install-r-services-on-windows"></a>Установка служб R в Windows

Для запуска кода R на удаленном компьютере должен быть установлен интерпретатор R, как описано ниже.

1. Скачайте и установите один из следующих интерпретаторов.

   - [Microsoft R Open](https://mran.microsoft.com/open/)
   - [CRAN R для Windows](https://cran.r-project.org/bin/windows/base/)

     Оба интерпретатора имеют одинаковые функциональные возможности, в Microsoft R Open используется [библиотека Intel Math Kernel](https://software.intel.com/intel-mkl), обеспечивающая дополнительные библиотеки линейной алгебры с аппаратным ускорением.

2. Запустите [Установщик служб R](https://github.com/Microsoft/RTVS/blob/master/doc/rtvsd/rtvs-remote-downloads.md) и перезагрузите компьютер, когда будет предложено. Установщик выполняет следующие действия.

    - Создайте папку в каталоге *%PROGRAMFILES%\Инструменты R для Visual Studio\1.0\\* и скопируйте все необходимые двоичные файлы.
    - Устанавливает `RHostBrokerService` и `RUserProfileService` и настраивает их на автоматический запуск.
    - Настраивает службу `seclogon` на автоматический запуск.
    - Добавьте файлы *Microsoft.R.Host.exe* и *Microsoft.R.Host.Broker.exe* в правила брандмауэра для входящего трафика в порт 5444 по умолчанию.

После перезапуска компьютера службы R запускаются автоматически.

- **Служба брокера узла R** обрабатывает весь трафик HTTPS между Visual Studio и процессом, в котором код R выполняется на компьютере.
- **Служба профилей пользователей R** — это привилегированный компонент, который обрабатывает создание профиля пользователя Windows. Служба вызывается при первом входе нового пользователя на компьютер с сервером R.

Эти службы можно просмотреть в консоли управления службами (*compmgmt.msc*).

## <a name="install-r-services-on-linux"></a>Установка служб R в Linux

Для запуска кода R на удаленном компьютере должен быть установлен интерпретатор R, как описано ниже.

1. Скачайте и установите один из следующих интерпретаторов.

   - [Microsoft R Open](https://mran.microsoft.com/open/)
   - [CRAN R для Windows](https://cran.r-project.org/bin/linux/ubuntu/)

     Оба интерпретатора имеют одинаковые функциональные возможности, в Microsoft R Open используется [библиотека Intel Math Kernel](https://software.intel.com/intel-mkl), обеспечивающая дополнительные библиотеки линейной алгебры с аппаратным ускорением.

2. Следуйте инструкциям в разделе [Удаленная служба R для Linux](setting-up-remote-r-service-on-linux.md), в котором охватываются физические компьютеры под управлением Ubuntu, виртуальные машины Azure под управлением Ubuntu, подсистема Windows для Linux (WSL), а также контейнеры Docker, в том числе выполняющиеся в репозитории контейнеров Azure.

## <a name="configure-r-services"></a>Настройка служб R

После запуска служб R на удаленном компьютере также потребуется создать учетные записи пользователей, настроить правила брандмауэра, настроить сеть Azure, а также настроить SSL-сертификат.

1. Учетные записи пользователей: создайте учетную запись для каждого пользователя, обращающегося к удаленному компьютеру. Можно либо создать стандартные (непривилегированные) локальные учетные записи пользователей, либо присоединить компьютер с сервером R к домену и добавить соответствующие группы безопасности в группу безопасности `Users`.

1. Правила брандмауэра: по умолчанию `R Host Broker` прослушивает TCP-порт 5444. Поэтому необходимо убедиться в том, что правила брандмауэра Windows включены и для входящего, и для исходящего трафика (исходящий трафик необходим для установки пакетов и в аналогичных сценариях).  Установщик служб R настраивает эти правила автоматически для встроенного брандмауэра Windows. Если используется сторонний брандмауэр, вручную откройте порт 5444 для `R Host Broker`.

1. Конфигурация Azure: если удаленный компьютер является виртуальной машиной в Azure, нужно также открыть порт 5444 для входящего трафика в сети Azure, которая не зависит от брандмауэра Windows. Дополнительные сведения см. в разделе [Фильтрация сетевого трафика с помощью групп безопасности сети](/azure/virtual-network/virtual-networks-nsg) в документации по Azure.

1. Указание брокеру узла R SSL-сертификата для скачивания: при установке сертификата на сервер в интрасети может оказаться, что полное доменное имя сервера совпадает с NetBIOS-именем. В этом случае ничего не нужно делать, так как этот сертификат загружается по умолчанию.

    Однако при установке сертификата на сервер, подключенный к Интернету (например, на виртуальную машину Azure), используйте полное доменное имя (FQDN) сервера, так как FQDN сервера, подключенного к Интернету, никогда не совпадает с NetBIOS-именем.

    Чтобы использовать полное доменное имя, перейдите к папке, где установлены службы R (по умолчанию *%PROGRAM FILES%\Удаленная служба R для Visual Studio\1.0*), откройте файл *Microsoft.R.Host.Broker.Config.json* в текстовом редакторе и замените его содержимое следующим кодом, назначив CN полное доменное имя своего сервера, например `foo.westus.cloudapp.azure.com`.

    ```json
    {
      "server.urls": "https://0.0.0.0:5444",
      "security": {
        "X509CertificateName": "CN=your-server-fully-qualified-domain-name"
      }
    }
    ```

    Сохраните файл и перезапустите компьютер, чтобы применить изменения.

## <a name="troubleshooting"></a>Устранение неполадок

**В. Компьютер с сервером R не отвечает. Что мне делать?**

Проверьте связь с удаленным компьютером из командной строки: `ping remote-machine-name`. Если проверка завершилась неудачно, убедитесь, что компьютер включен.

**В. В интерактивном окне R указано, что удаленный компьютер включен, однако служба не работает. Почему?**

Этому могут быть три причины:

- На компьютере не установлен компонент [.NET Framework 4.6.1](https://www.microsoft.com/download/details.aspx?id=49981) или более поздней версии.
- Правила брандмауэра для `Microsoft.R.Host.Broker` и `Microsoft.R.Host` не включены для входящих и исходящих подключений через порт 5444.
- Не установлен SSL-сертификат с `CN=<remote-machine-name>`.

Перезагрузите компьютер после внесения любого из указанных выше изменений. Затем убедитесь, что службы `RHostBrokerService` и `RUserProfileService` выполняются, воспользовавшись диспетчером задач (вкладка "Службы") или *services.msc*.

**В. Почему при попытке подключиться к серверу R в интерактивном окне R появляется сообщение "401 Нет доступа"?**

Существуют две возможные причины этой ошибки.

- Весьма вероятно, что учетная запись `NETWORK SERVICE` не имеет доступа к закрытому ключу SSL-сертификата. Следуйте приведенным ранее инструкциям, чтобы предоставить `NETWORK SERVICE` доступ к закрытому ключу.
- Убедитесь, что служба `seclogon` запущена. Используйте *services.msc*, чтобы настроить автоматический запуск `seclogon`.

**В. Почему при попытке подключиться к серверу R в интерактивном окне R появляется сообщение "404 Не найдено"?**

Причиной ошибки, возможно, является отсутствие необходимых распространяемых библиотек Visual C++. Проверьте, имеются ли в интерактивном окне R сообщения об отсутствующих библиотеках (DLL). Проверьте, что установлен распространяемый пакет VS 2015, а также что установлен R.

**В. Не удается получить доступ к Интернету или ресурсу из интерактивного окна R. Что мне делать?**

Убедитесь, что правила брандмауэра для `Microsoft.R.Host.Broker` и `Microsoft.R.Host` разрешают исходящий доступ через порт 5444. Перезагрузите компьютер после применения изменений.

**В. После применения всех описанных выше решений сервер по-прежнему не работает. Что делать?**

Просмотрите файлы журналов в папке *C:\Windows\ServiceProfiles\NetworkService\AppData\Local\Temp*. Эта папка содержит отдельный файл журнала для каждого запущенного экземпляра брокера службы R. При каждом перезапуске службы создается новый файл журнала. Просмотрите самый последний новый файл журнала, чтобы понять, что может работать неправильно.
