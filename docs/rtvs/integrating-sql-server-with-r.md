---
title: Интеграция SQL Server с R
description: Visual Studio поддерживает создание и выполнение запросов SQL из R, а также возможность R работать с хранимыми процедурами.
ms.date: 06/25/2018
ms.topic: conceptual
author: kraigb
ms.author: kraigb
manager: jillfra
ms.workload:
- data-science
ms.openlocfilehash: 2d1eb4cc53b6123acbba9741d33d3401d44cf6d7
ms.sourcegitcommit: 4b29efeb3a5f05888422417c4ee236e07197fb94
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 09/11/2020
ms.locfileid: "90011883"
---
# <a name="work-with-sql-server-and-r"></a>Работа с SQL Server и R

Отличная поддержка SQL Server в Visual Studio позволяет специалистам по анализу и обработке данных работать с базами данных SQL и R благодаря возможности создавать и выполнять SQL-запросы и использовать хранимые процедуры.

> [!Note]
> Для интеграции SQL с R необходимо установить SQL Server Data Tools.
> - Visual Studio 2017: запустите установщик Visual Studio и выберите рабочую нагрузку "Хранение и обработка данных", которая включает SQL Server Data Tools.
> - Visual Studio 2015: следуйте инструкциям в разделе [SQL Server Data Tools](/sql/ssdt/download-sql-server-data-tools-ssdt).

:::row:::
    :::column:::
        ![Значок кинокамеры для видео](../install/media/video-icon.png "Просмотр видео")
    :::column-end:::
    :::column:::
        [Посмотрите видео (youtube.com)](https://www.youtube.com/watch?v=n4AYr0QIwdQ) с обзором SQL Server и R (3 мин 3 с).
    :::column-end:::
:::row-end:::

## <a name="create-and-run-sql-queries"></a>Создание и выполнение запросов SQL

RTVS поддерживает добавление SQL-запросов в проекты R, позволяя итеративно разрабатывать SQL-запросы в отдельном контексте, пока не будут получены требуемые результаты.

Чтобы добавить файл запроса SQL, щелкните правой кнопкой мыши проект в обозревателе решений, выберите **Добавить** > **Новый элемент**, а затем выберите тип файла **SQL-запрос**:

![Добавление элемента "SQL-запрос" в проект](media/sql-add-item.png)

Эта команда открывает файл в редакторе Transact-SQL в Visual Studio, где реализована полная поддержка технологии IntelliSense для SQL и возможность выполнения запросов. Для работы этих функций нужно подключиться к базе данных с помощью кнопки подключения в панели инструментов редактора или попытаться выполнить запрос (нажать клавиши **Ctrl**+**Shift**+**E**, которые также можно использовать для выделенной области). В любом случае появляется диалоговое окно подключения.

![Диалоговое окно подключения SQL](media/sql-connection-dialog.png)

После установления соединения можно выполнять запросы и просматривать результаты.

![Окно с результатами выполнения SQL-запроса](media/sql-query-results.png)

Редактор Transact-SQL поддерживает множество других функций, таких как просмотр плана выполнения запроса и отладчик запросов.
Дополнительные сведения см. в статье [Использование редактора Transact-SQL для изменения и выполнения скриптов](/previous-versions/sql/sql-server-data-tools/hh272706(v=vs.103)).

## <a name="work-with-sql-server-stored-procedures"></a>Работа с хранимыми процедурами SQL Server

[Службы SQL Server R Services](/sql/advanced-analytics/r/sql-server-r-services) (SQL Server 2016 и более поздние версии) позволяют внедрять и выполнять код R из хранимых процедур T-SQL. Вы можете выполнять код R на компьютере с SQL Server, работать с данными, возвращаемыми SQL-запросом, а также создавать наборы результатов SQL, которые можно далее обработать в SQL или возвратить клиенту.

RTVS упрощает громоздкий и подверженный ошибкам процесс объединения SQL с кодом R, используя вместо него одну инструкцию SQL, как описано в следующих разделах.

- [Добавление подключения к базе данных](#add-a-database-connection)
- [Написание и тестирование хранимой процедуры SQL](#write-and-test-a-sql-stored-procedure)
- [Публикация хранимой процедуры SQL](#publish-a-sql-stored-procedure)

:::row:::
    :::column:::
        ![Значок кинокамеры для видео](../install/media/video-icon.png "Просмотр видео")
    :::column-end:::
    :::column:::
        [Посмотрите видео (youtube.com)](https://www.youtube.com/watch?v=dFKIT2OitWQ) с обзором хранимых процедур SQL Server и R (6 мин 9 с).
    :::column-end:::
:::row-end:::

### <a name="add-a-database-connection"></a>Добавление подключения к базе данных

1. Выберите **Инструменты R** > **Данные** > **Добавить подключение к базе данных**, чтобы отобразить диалоговое окно **Свойства подключения**. В нем укажите имя источника данных (в данном случае — SQL Server), имя сервера, режим проверки подлинности и имя базы данных. Выберите **Проверить подключение** для проверки введенных данных, прежде чем закрывать диалоговое окно.

    ![Диалоговое окно подключения SQL](media/sql-connection-string-dialog.png)

1. После указания правильных параметров подключения и нажатия кнопки **ОК** Visual Studio создает строку подключения именем `dbConnection` в новом файле *settings.R*. RTVS автоматически выполняет этот файл, чтобы это подключение можно было сразу использовать в скриптах R.

![Файл Settings.R для SQL](media/sql-settings-dot-r.png)

### <a name="write-and-test-a-sql-stored-procedure"></a>Написание и тестирование хранимой процедуры SQL

Чтобы добавить новую хранимую процедуру SQL, щелкните проект правой кнопкой мыши, выберите **Добавить** > **Новый элемент**, выберите в списке шаблонов пункт **Хранимая процедура SQL с R**, присвойте файлу имя и нажмите кнопку **ОК**. Имя файла по умолчанию — *SqlSProc.R*; для простоты чтения в остальной части раздела используется имя файла *StoredProcedure.R*. Если имеется несколько хранимых процедур, каждый файл должен иметь уникальное имя.

Инструменты R для Visual Studio (RTVS) создают три файла для хранимой процедуры: файл *.R* для кода R, файл *.Query.sql* для кода SQL и файл *.Template.sql*, в котором объединены эти два кода. Последние два файла отображаются в обозревателе решений как дочерние элементы файла *.R*.

![Развернутое окно обозревателя решений с хранимой процедурой SQL с R](media/sql-solution-explorer-expanded.png)

В файле *.R* (в данном примере *StoredProcedure.R*) пишется код R. Содержимое по умолчанию выглядит следующим образом:

```R
# @InputDataSet: input data frame, result of SQL query execution
# @OutputDataSet: data frame to pass back to SQL

# Test code
# library(RODBC)
# channel <- odbcDriverConnect(dbConnection)
# InputDataSet <- sqlQuery(channel, )
# odbcClose(channel)

OutputDataSet <- InputDataSet
```

Проще говоря, код получает кадр данных R, который называется `InputDataSet`, и возвращает свои результаты в `OutputDataSet`, а код шаблона просто копирует входные данные в вывод.

> [!Note]
> Для управления именами этих кадров данных используются параметры `@input_data_1_name` и `@output_data_1_name` в вызове системной хранимой процедуры `sp_execute_external_script`. Дополнительные сведения о проектировании этого соглашения о вызовах и некоторые примеры его использования см. в разделе [sp_execute_external_script (Transact-SQL)](/sql/relational-databases/system-stored-procedures/sp-execute-external-script-transact-sql).

Другой сгенерированный код (в заметках) предоставляет небольшой скрипт теста, который использует [пакет RODBC](https://cran.r-project.org/web/packages/RODBC/index.html) для передачи инструкции SQL в SQL Server, ее запуска и получения результирующего набора в виде кадра данных R. Можно раскомментировать этот код теста для интерактивного создания собственного кода R на основе результирующего набора, полученного от SQL Server.

В файле *.Query.sql* (в данном примере *StoredProcedure.Query.sql*) пишется и тестируется SQL-запрос, который создает данные для `InputDataSet`. С этим *SQL-файлом* редактор предоставляет все обычные функции Transact-SQL.

Когда вы будете удовлетворены своим SQL-кодом, интегрируйте его с кодом R, перетащив *SQL-файл* в редактор, где открыт *R-файл*. На следующем рисунке файл *StoredProcedure.Query.sql* перетаскивается в файл *StoredProcedure.R* в место после запятой в `sqlQuery(channel, )`:

![Считывание содержимого файла SQL в строковую переменную R](media/sql-reference-sql-file-from-r.png)

Как видно, при выполнении этого простого действия автоматически создается код R для открытия *SQL-файла*, считывания его содержимого в строку и передачи этой строки в пакет RODBC для отправки на SQL Server.

Теперь можно в интерактивном режиме написать код R, который управляет кадром данных `InputDataSet` требуемым образом. Не забывайте, что можно просто выбрать код R в редакторе и отправить его в [интерактивное окно](interactive-repl-for-r-in-visual-studio.md) нажатием клавиш **CTRL**+**ВВОД**.

Теперь в файле *. Template.SQL* (в данном примере *StoredProcedure.Template.sql*) содержится шаблон для создания хранимой процедуры SQL:

```sql
CREATE PROCEDURE [StoredProcedure]
AS
BEGIN
EXEC sp_execute_external_script @language = N'R'
    , @script = N'_RCODE_'
    , @input_data_1 = N'_INPUT_QUERY_'
--- Edit this line to handle the output data frame.
    WITH RESULT SETS (([MYNEWCOLUMN] NVARCHAR(max)));
END;
```

- Заполнитель `_RCODE_` заменяется содержимым *R-файла* (например, *StoredProcedure.R*).
- Заполнитель `_INPUT_QUERY_` заменяется содержимым файла *.Query.sql* (например, *StoredProcedure.Query.sql*).
- Измените предложение `WITH RESULT SETS`, чтобы описать схему результирующего набора, который возвращается из хранимой процедуры. В частности, необходимо определить столбцы из кадра данных `OutputDataSet`, которые требуется вернуть вызывающему хранимую процедуру.

Например, для следующего запроса:

```sql
SELECT TOP 100 medallion, hack_license FROM nyctaxi_sample
```

Необходимо использовать следующее предложение `WITH RESULT SETS` для указания типов данных возвращаемых значений.

```sql
WITH RESULT SETS ((medallion NVARCHAR(max), hack_license NVARCHAR(max)));
```

### <a name="publish-a-sql-stored-procedure"></a>Публикация хранимой процедуры SQL

1. Выберите в меню команду **Инструменты R** > **Данные** > **Опубликовать с параметрами**.
1. В появившемся диалоговом окне выберите для параметра **Публикация в:** значение **База данных**, укажите целевой объект, нажмите **Опубликовать**, после чего RTVS создают и публикуют хранимую процедуру.

    ![Диалоговое окно публикации хранимой процедуры](media/sql-publish-with-options.png)

1. Чтобы опубликовать все хранимые процедуры в проекте, можно использовать команду **Инструменты R** > **Данные** > **Опубликовать хранимые процедуры**, которая также доступна в контекстном меню проекта в обозревателе решений.

> [!Tip]
> Если в Visual Studio открыт обозреватель объектов SQL Server, опубликованная хранимая процедура отображается в папке **Программирование** > **Хранимые процедуры** базы данных. Эту процедуру также можно выполнить в обозревателе объектов, щелкнув ее правой кнопкой мыши и выбрав **Выполнить процедуру** либо вызвав ее интерактивно из вызова в окне запроса *SQL*.