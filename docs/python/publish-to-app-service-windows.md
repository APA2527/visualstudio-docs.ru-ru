---
title: Публикация приложения Python в службе приложений Azure на платформе Windows
description: Публикация веб-приложения Python напрямую в Службу приложений Azure на платформе Windows из Visual Studio, в том числе необходимого содержимого файла web.config.
ms.date: 01/07/2019
ms.topic: how-to
author: JoshuaPartlow
ms.author: joshuapa
manager: jillfra
ms.custom: seodec18
ms.workload:
- python
- data-science
- azure
ms.openlocfilehash: 649d40a3b95f9e3d4df51cc4ab22a3fb79ac1498
ms.sourcegitcommit: b885f26e015d03eafe7c885040644a52bb071fae
ms.translationtype: HT
ms.contentlocale: ru-RU
ms.lasthandoff: 06/30/2020
ms.locfileid: "85531850"
---
# <a name="publishing-to-azure-app-service-on-windows"></a>Публикация в службу приложений Azure на платформе Windows

> [!Note]
> Это содержимое и описанные функции являются устаревшими, но по-прежнему работают. Разработчикам Python рекомендуется по возможности перейти на [Службу приложений на платформе Linux](publishing-python-web-applications-to-azure-from-visual-studio.md).

Visual Studio предоставляет возможность опубликовать веб-приложение Python в Службе приложений Azure на платформе Windows. Публикация в службе приложений Azure на платформе Windows означает копирование необходимых файлов на сервер и настройку соответствующего файла `web.config`, который определяет способ запуска приложения веб-сервером.

В Visual Studio 2017 и более поздних версий и в Visual Studio 2015 процесс публикации различается. В частности, в Visual Studio 2015 автоматизирован ряд действий, включая создание файла `web.config`, однако в долгосрочной перспективе эта автоматизация ограничивает гибкость и возможности управления. В Visual Studio 2017 и более поздних версий нужно выполнять больше действий вручную, но обеспечивается более точный контроль над средой Python. В этой статье описываются оба варианта.

> [!Note]
> Общие сведения об изменениях, произошедших в Visual Studio 2017 и более поздних версий по сравнению с Visual Studio 2015, см. в записи блога [Публикация в Azure в Visual Studio 2017](https://devblogs.microsoft.com/python/publish-to-azure-in-vs-2017/).

## <a name="prerequisites"></a>Предварительные требования

При работе с этим пошаговым руководством вам потребуется проект веб-приложения на основе платформы Bottle, Flask или Django. Если у вас еще нет проекта, но вы хотите испытать процесс публикации, создайте простой тестовый проект, как описано ниже.

1. В Visual Studio выберите пункт меню **Файл > Создать > Проект**, выполните поиск по запросу "Bottle", выберите **Веб-проект Bottle**, укажите имя проекта и путь к нему, а затем нажмите кнопку **ОК**. (Шаблон Bottle включен в рабочую нагрузку разработки для Python; см. раздел [Установка](installing-python-support-in-visual-studio.md).)

1. Следуйте инструкциям на экране, чтобы установить внешние пакеты. Выберите параметр **Установить в виртуальном окружении** и предпочтительный базовый интерпретатор для виртуальной среды. Как правило, он должен соответствовать версии Python, установленной в службе приложений.

1. Протестируйте проект локально, нажав клавишу F5 или выбрав пункт меню **Отладка > Начать отладку**.

## <a name="create-an-azure-app-service"></a>Создание службы приложений Azure

Для публикации в Azure требуется целевая служба приложений. Вы можете создать службу приложений с помощью подписки Azure или воспользоваться временным сайтом.

Если у вас еще нет подписки, начните со страницы [Создайте бесплатную учетную запись Azure уже сегодня](https://azure.microsoft.com/free/), где вы сможете получить большой кредит на использование служб Azure. Кроме того, вы можете [присоединиться к Visual Studio Dev Essentials](https://azure.microsoft.com/pricing/member-offers/vs-dev-essentials/) и в течение целого года ежемесячно получить кредит на сумму 25 долларов США.

> [!Tip]
> Хотя в Azure запрашиваются данные кредитной карты для проверки счета, деньги с этой карты не взимаются. Чтобы избежать дополнительной платы, можно также установить [предельную сумму расходов](/azure/billing/billing-spending-limit) равной бесплатному кредиту. Кроме того, Azure предоставляет бесплатный план службы приложений, который идеально подходит для простых тестовых приложений, как описано в следующем разделе.

### <a name="using-a-subscription"></a>Использование подписки

Используя активную подписку Azure, создайте службу приложений с пустым веб-приложением, как описано ниже.

1. Выполните вход на странице [portal.azure.com](https://portal.azure.com).
1. Последовательно выберите элементы **+Создать**, **Интернет+мобильные устройства** и **Веб-приложение**.
1. Укажите имя веб-приложения, в поле **Группа ресурсов** оставьте значение "Создать" и выберите **Windows** в качестве операционной системы.
1. Выберите **Расположение или план службы приложений**, выберите **Создать** и укажите имя и расположение. Затем выберите **Ценовая категория**, прокрутите список вниз и выберите план **Бесплатный F1**, нажмите кнопку **Выбрать**, кнопку **ОК**, а затем — кнопку **Создать**.
1. (Необязательно) После создания службы приложений перейдите в нее, щелкните **Скачать профиль публикации** и сохраните файл на компьютере.

### <a name="using-a-temporary-app-service"></a>Использование временной службы приложений

Создайте временную службу приложений без подписки Azure, как описано ниже.

1. Откройте в браузере [https://azure.microsoft.com/try/app-service/web/](https://azure.microsoft.com/try/app-service/web/).
1. Выберите тип приложения **Веб-приложение**, затем нажмите **Далее**.
1. Выберите **Пустой сайт** и нажмите кнопку **Создать**.
1. Выполните вход через любую социальную сеть, и через некоторое время ваш сайт будет готов к работе по указанному URL-адресу.
1. Выберите **Скачать профиль публикации** и сохраните файл `.publishsettings`, который вам понадобится позднее.

## <a name="configure-python-on-azure-app-service"></a>Настройка Python в Службе приложений Azure

Создав службу приложений с запущенным пустым веб-приложением (в подписке или на бесплатном сайте), установите выбранную версию Python, как описано в статье [Работа с Python в службе приложений Azure](managing-python-on-azure-app-service.md). Для публикации из Visual Studio 2017 и более поздних версий запишите точный путь к интерпретатору Python, установленному с расширением сайта, как описано в этой статье.

При необходимости можно также установить пакет `bottle`, используя эти инструкции. Этот пакет устанавливается в процессе выполнения других действий в данном руководстве.

## <a name="publish-to-app-service---visual-studio-2017-and-later"></a>Публикация в службе приложений — Visual Studio 2017 и более поздних версий

При публикации в Службе приложений Azure из Visual Studio 2017 и более поздних версий на сервер копируются только файлы проекта. Поэтому необходимо создать файлы, требуемые для настройки серверной среды.

1. В **обозревателе решений** Visual Studio щелкните проект правой кнопкой мыши и выберите пункты **Добавить > Новый элемент**. В открывшемся диалоговом окне выберите шаблон "Azure web.config (Fast CGI)" и нажмите кнопку "ОК". В корне проекта будет создан файл `web.config`.

1. Измените запись `PythonHandler` в `web.config` таким образом, чтобы путь соответствовал установке Python на сервере (точные сведения см. в [справочнике по настройке IIS](https://www.iis.net/configreference) (iis.net)). Например, для 64-разрядной версии Python 3.6.1 эта запись должна выглядеть так:

    ```xml
    <system.webServer>
      <handlers>
        <add name="PythonHandler" path="*" verb="*" modules="FastCgiModule"
            scriptProcessor="D:\home\Python361x64\python.exe|D:\home\Python361x64\wfastcgi.py"
            resourceType="Unspecified" requireAccess="Script"/>
      </handlers>
    </system.webServer>
    ```

1. Задайте запись `WSGI_HANDLER` в файле `web.config` в соответствии с используемой платформой:

    - **Bottle**: добавьте скобки после `app.wsgi_app`, как показано ниже. Это необходимо по той причине, что объект является функцией (см. `app.py`), а не переменной.

        ```xml
        <!-- Bottle apps only -->
        <add key="WSGI_HANDLER" value="app.wsgi_app()"/>
        ```

    - **Flask**: измените значение `WSGI_HANDLER` на `<project_name>.app`, где `<project_name>` соответствует имени проекта. Узнать точный идентификатор можно в операторе `from <project_name> import app` в файле `runserver.py`. Например, если проект имеет имя FlaskAzurePublishExample, эта запись будет выглядеть так:

        ```xml
        <!-- Flask apps only: change the project name to match your app -->
        <add key="WSGI_HANDLER" value="FlaskAzurePublishExample.app"/>
        ```

    - **Django**: для проектов Django необходимо внести два изменения в файл `web.config`. Во-первых, измените значение `WSGI_HANDLER` на `django.core.wsgi.get_wsgi_application()` (объект находится в файле `wsgi.py`).

        ```xml
        <!-- Django apps only -->
        <add key="WSGI_HANDLER" value="django.core.wsgi.get_wsgi_application()"/>
        ```

        Во-вторых, добавьте следующую запись под записью `WSGI_HANDLER`, заменив `DjangoAzurePublishExample` на имя проекта:

        ```xml
        <add key="DJANGO_SETTINGS_MODULE" value="DjangoAzurePublishExample.settings" />
        ```

1. **Только для приложений Django**: в файле `settings.py` проекта Django добавьте домен URL-адреса сайта в массив `ALLOWED_HOSTS`, как показано ниже, заменив "vspython-test-02.azurewebsites.net" на собственный URL-адрес:

    ```python
    # Change the URL to your specific site
    ALLOWED_HOSTS = ['vspython-test-02.azurewebsites.net']
    ```

    Если не добавить URL-адрес в массив, возникнет ошибка "Запрещенный узел в / Недопустимый заголовок HTTP_HOST: \<site URL\>. Возможно, необходимо добавить \<site URL\> в ALLOWED_HOSTS".

    Обратите внимание, что если массив пуст, Django автоматически разрешает localhost. Но при добавлении URL-адреса рабочего развертывания эта возможность становится недоступной. Поэтому, возможно, потребуется создать отдельные копии `settings.py` для разработки и рабочей среды или использовать переменные среды, чтобы контролировать значения времени выполнения.

1. В **обозревателе решений** разверните папку с именем проекта, щелкните папку `static` правой кнопкой мыши, выберите пункты **Добавить > Новый элемент...** , выберите шаблон "Файл web.config статических файлов Azure" и нажмите кнопку **ОК**. В результате в папке `static` будет создан еще один файл `web.config`, который отключает для нее обработку Python. В такой конфигурации вместо использования приложения Python запросы к статическим файлам отправляются на веб-сервер по умолчанию.

1. Сохраните проект, а затем в **обозревателе решений** Visual Studio щелкните проект правой кнопкой мыши и выберите команду **Опубликовать**.

    ![Команда публикации в контекстном меню проекта](media/template-web-publish-command.png)

1. На появившейся вкладке **Публикация** выберите назначение публикации.

    1\. Собственная подписка Azure: последовательно выберите элементы **Служба приложений Microsoft Azure**, **Выбрать существующее**, **Опубликовать**. Появится диалоговое окно, в котором можно выбрать подходящую подписку и службу приложений. Если служба приложений не отображается, используйте скачанный профиль публикации для временной службы приложений, как описано ниже.

    ![Публикация в Azure, шаг 1, Visual Studio 2017 и более поздних версий, существующие подписки](media/tutorials-common-publish-1a-2017.png)

    2\. Если вы используете временную службу приложений на сайте try.azurewebsites.net или хотите использовать профиль публикации по иным причинам, нажимайте элемент управления **>** , пока не увидите вариант **Импорт профиля**, выберите его, а затем нажмите кнопку **Опубликовать**. Будет запрошено расположение файла `.publishsettings`, который был скачан ранее.

    ![Публикация Azure, шаг 1, Visual Studio 2017 и более поздних версий, временная служба приложений](media/tutorials-common-publish-1b-2017.png)

1. Visual Studio показывает состояние публикации в окнах "Действие веб-публикации" и "Публикация". После завершения публикации URL-адрес сайта откроется в браузере по умолчанию. URL-адрес также отображается в окне "Публикация".

1. Когда откроется браузер, может появиться сообщение "Невозможно отобразить эту страницу ввиду того, что произошла внутренняя ошибка сервера". Оно означает, что среда Python на сервера настроена не полностью. В этом случае выполните указанные ниже действия.

    1\. Снова обратитесь к разделу [Работа с Python в службе приложений Azure](managing-python-on-azure-app-service.md) и убедитесь в том, что установлено соответствующее расширение сайта для Python.

    2\. Внимательно проверьте путь к интерпретатору Python в файле `web.config`. Он должен в точности совпадать с местом установки выбранного расширения сайта.

    В. С помощью консоли Kudu обновите все пакеты, перечисленные в файле `requirements.txt` приложения: перейдите в папку Python, которая используется в файле `web.config`, например `/home/python361x64`, и выполните следующую команду, как описано в разделе [Консоль Kudu](managing-python-on-azure-app-service.md#azure-app-service-kudu-console):

    ```command
    python -m pip install --upgrade -r /home/site/wwwroot/requirements.txt
    ```

    Если при выполнении этой команды возникают ошибки, связанные с разрешениями, убедитесь в том, что команда выполняется в папке расширения сайта, а *не* в папке одной из установок Python по умолчанию в службе приложений. Так как эти среды по умолчанию нельзя изменять, попытка установить пакеты завершается сбоем.

    Г. Чтобы получить более подробные сведения об ошибках, добавьте в файл `web.config` в узле `<system.webServer>` следующую строку:

    ```xml
    <httpErrors errorMode="Detailed"></httpErrors>
    ```

    Д. После установки новых пакетов попробуйте перезапустить службу приложений. После изменения файла `web.config` перезапускать службу приложений необязательно, так как при каждом изменении `web.config` она перезапускается автоматически.

    > [!Tip]
    > После внесения любых изменений в файл `requirements.txt` приложения обязательно снова воспользуйтесь консолью Kudu для установки новых пакетов, перечисленных в этом файле.

1. Полностью настроив серверную среду, обновите страницу в браузере. Веб-приложение должно появиться.

    ![Результаты публикации приложений Bottle, Flask и Django в службе приложений](media/azure-publish-results.png)

## <a name="publishing-to-app-service---visual-studio-2015"></a>Публикация в службе приложений — Visual Studio 2015

> [!Note]
> На сайте youtube.com можно просмотреть краткое видео об этом процессе: [Руководство по Python для Visual Studio. Создание веб-сайта](https://www.youtube.com/watch?v=FJx5mutt1uk&list=PLReL099Y5nRdLgGAdrb_YeTdEnd23s6Ff&index=6) (длительность — 3 мин 10 с).

1. В **Обозревателе решений** щелкните проект правой кнопкой мыши и выберите действие **Публикация**.

1. В диалоговом окне **Публикация** выберите вариант **Служба приложений Microsoft Azure**.

  ![Публикация в Azure, шаг 1](media/tutorials-common-publish-1.png)

1. Выберите цель публикации.

    - Если у вас есть подписка Azure, выберите в качестве цели публикации **Служба приложений Microsoft Azure**, и в следующем диалоговом окне выберите существующую службу приложений или нажмите **Создать**, чтобы создать новую службу.
    - Если вы используете временный сайт, созданный на странице try.azurewebsites.net, выберите в качестве цели публикации **Импорт**, затем перейдите к файлу `.publishsettings`, который вы скачали с сайта ранее, и выберите **ОК**.

1. Сведения о службе приложения отображаются в диалоговом окне **Публиковать**, на вкладке **Подключение**, как показано ниже.

  ![Публикация в Azure, шаг 2](media/tutorials-common-publish-2.png)

1. Выберите действие **Далее >** и просмотрите дополнительные параметры.

1. Нажмите **Публиковать**. Когда вы закончите развертывать приложение в Azure, созданный сайт откроется в браузере по умолчанию.

В рамках этого процесса Visual Studio также выполняет следующие действия:

- создает на сервере файл `web.config`, который содержит соответствующие указатели на функцию `wsgi_app` приложения и интерпретатор Python 3.4 по умолчанию для службы приложений;
- отключает обработку файлов в папке `static` проекта (соответствующие правила определены в файле `web.config`);
- публикует виртуальную среду на сервере;
- добавляет файл `web.debug.config` и средства отладки для возможности удаленной отладки. В Visual Studio 2019 версии 16.4 и предшествующих это отладчик ptvsd. В Visual Studio 2019 версии 16.5 и последующих это отладчик debugpy.

Как отмечалось ранее, эти автоматические действия упрощают процесс публикации, но усложняют управление средой Python. Например, файл `web.config` создается только на сервере, но не добавляется в проект. Кроме того, процесс публикации занимает больше времени, так как вместо использования конфигурации сервера с компьютера разработки копируется вся виртуальная среда.

Со временем может потребоваться вести собственный файл `web.config` и использовать файл `requirements.txt` для управления пакетами на сервере напрямую. Файл `requirements.txt`, в частности, гарантирует постоянное соответствие среды разработки и серверной среды.
