---
title: Проверка кода по схемам зависимостей
ms.date: 09/28/2018
ms.topic: conceptual
helpviewer_keywords:
- dependency diagrams, validating
- validation, dependency diagrams
- validation, code
- code exploration, validating
- architecture, validating
- Visual Studio Ultimate, validating code
- validation, architecture
- validation, dependencies
- MSBuild, tasks
- MSBuild, dependency diagrams
- MSBuild, validating code
author: JoshuaPartlow
ms.author: joshuapa
manager: jillfra
ms.workload:
- multiple
ms.openlocfilehash: 975fe8eac5657e245027a4811e50bbc93528cfe5
ms.sourcegitcommit: 273b657e115c1756adb84e0e56b6f2c709bcee76
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 04/07/2020
ms.locfileid: "80759698"
---
# <a name="validate-code-with-dependency-diagrams"></a>Проверка кода по схемам зависимостей

## <a name="why-use-dependency-diagrams"></a>Зачем использовать диаграммы зависимостей?

Чтобы убедиться, что код не противоречит его дизайну, проверьте код с диаграммами зависимости в Visual Studio. Это может помочь:

- Поиск конфликтов между зависимостями в коде и зависимостями на диаграмме зависимости.

- Найти зависимости, на которые могут повлиять предложенные изменения.

   Например, можно отсеить диаграмму зависимости, чтобы показать потенциальные изменения архитектуры, а затем проверить код, чтобы увидеть затронутые зависимости.

- Выполнить рефакторинг или миграцию кода в другую структуру.

   Найти код или зависимости, с которыми потребуется выполнить определенные действия даже после перемещения кода в другую архитектуру.

**Требования**

- Visual Studio

  Чтобы создать диаграмму зависимости для проекта .NET Core, необходимо иметь версию Visual Studio 2019 2019 или позже.

- Решение с проектом моделирования с диаграммой зависимости. Эта диаграмма зависимости должна быть связана с артефактами в проектах C- или Visual Basic, которые необходимо проверить. Просчитайте [диаграммы зависимости от вашего кода.](../modeling/create-layer-diagrams-from-your-code.md)

Чтобы узнать, какие издания Visual Studio [Edition support for architecture and modeling tools](../modeling/what-s-new-for-design-in-visual-studio.md#VersionSupport)поддерживают эту функцию, см.

Вы можете проверить код вручную с диаграммы открытой зависимости в Visual Studio или с запроса команды. Вы также можете автоматически проверять код при запуске локальных сборок или построений Azure Pipelines. Смотрите [видео Channel 9: Проектируйте и проверяйте архитектуру с помощью диаграмм зависимости.](https://channel9.msdn.com/Series/Visual-Studio-2012-Premium-and-Ultimate-Overview/Visual-Studio-Ultimate-2012-Using-layer-diagrams-to-design-and-validate-your-architecture)

> [!IMPORTANT]
> Если вы хотите запустить проверку слоя с помощью Team Foundation Server (TFS), необходимо также установить ту же версию Visual Studio на сервер сборки.

## <a name="live-dependency-validation"></a>Проверка живой зависимости

Проверка зависимости происходит в режиме реального времени, и ошибки сразу же отображаются в **списке ошибок.**

* Проверка в реальном времени поддерживается для C и Visual Basic.

* Для обеспечения полного анализа решений при использовании живой проверки зависимости откройте параметры из золотого слитка, который отображается в **списке ошибок.**

  - Вы можете навсегда уволить золотой слиток, если вы не заинтересованы в том, чтобы все архитектурные вопросы в вашем решении.
  - Если вы не включаете полный анализ решений, анализ выполняется только для редактируемых файлов.

* При обновлении проектов для включения живой проверки диалог показывает ход преобразования.

* При обновлении проекта для проверки живой зависимости версия пакета NuGet обновляется до одинаковой для всех проектов и является самой высокой в использовании.

* Добавление нового проекта проверки зависимости запускает обновление проекта.

## <a name="see-if-an-item-supports-validation"></a>Определение, поддерживает ли элемент проверку

Вы можете связывать слои с веб-сайтами, документами Office, простыми текстовыми файлами и файлами в проектах, которые используются в нескольких приложениях, но процесс проверки не будет включать их. Ошибки проверки для ссылок на проекты или сборки, связанные с отдельными слоями, отображаются только в том случае, если между этими слоями отображаются зависимости. Эти ссылки считаются зависимостями, только если используются в коде.

1. На диаграмме зависимости выберите один или несколько слоев, щелкните вправо, щелкните ваш выбор, а затем нажмите **Просмотр ссылки**.

2. В **колонке Layer Explorer**посмотрите на столбец **проверки поддерживает.** Если значение равно false, элемент не поддерживает проверку.

## <a name="include-other-net-assemblies-and-projects-for-validation"></a>Включение других сборок и проектов .NET для проверки

При перетаскивании элементов на диаграмму зависимости ссылки на соответствующие сборки или проекты .NET автоматически добавляются в папку **«Ссылки на слой»** в проекте моделирования. Эта папка содержит ссылки на сборки и проекты, которые анализируются во время проверки. Можно включить другие сборки и проекты .NET для проверки без ручного перетаскивания их на диаграмму зависимости.

1. В **Solution Explorer**, правой кнопкой мыши моделирования проекта или папки Layer **Ссылки,** а затем нажмите **Добавить Ссылки**.

2. В диалоговом окне **Добавления** выберите сборки или проекты, а затем нажмите **OK**.

## <a name="validate-code-manually"></a>Проверка кода вручную

Если у вас есть диаграмма открытой зависимости, которая связана с элементами решения, можно выполнить команду **шорт-краток проверки** из диаграммы. Вы также можете использовать запрос команды для выполнения команды **msbuild** с пользовательским свойством **/p:ValidateArchitecture,** установленным на **True.** Например, при внесении изменений в код регулярно выполняйте проверку слоев, чтобы заранее обнаруживать конфликты зависимостей.

### <a name="validate-code-from-an-open-dependency-diagram"></a>Проверка кода с диаграммы открытой зависимости

1. Нажмите правой щелкните поверхность диаграммы, а затем нажмите **Validate Architecture.**

    > [!NOTE]
    > По умолчанию свойство **действий сборки** на диаграмме зависимости (.layerdiagram) настроено на **проверку,** чтобы диаграмма была включена в процесс проверки.

     Окно **списка ошибок** сообщает о любых возникающих ошибках. Для получения дополнительной информации [Troubleshoot layer validation issues](#troubleshoot-layer-validation-issues)об ошибках проверки см.

2. Чтобы просмотреть источник каждой ошибки, дважды щелкните ошибку в окне **списка ошибок.**

    > [!NOTE]
    > Visual Studio может отображать кодовую карту вместо источника ошибки. Это происходит, когда либо код имеет зависимость от сборки, не указанной диаграммой зависимости, или код отсутствует зависимость, указанная диаграммой зависимости. Просмотрите карту кода или код, чтобы определить, должна ли существовать зависимость. Для получения дополнительной информации о кодовых картах смотрите [зависимости карты в решениях.](../modeling/map-dependencies-across-your-solutions.md)

3. Для управления ошибками [см.](#resolve-layer-validation-errors)

### <a name="validate-code-at-the-command-prompt"></a>Проверка кода в запросе команды

1. Откройте запрос команды Visual Studio.

2. Выберите один из следующих вариантов.

   - Чтобы проверить код в отношении конкретного проекта моделирования в решении, запустите MSBuild со следующим пользовательским свойством.

       ```
       msbuild <FilePath+ModelProjectFileName>.modelproj /p:ValidateArchitecture=true
       ```

     - или -

       Просмотрите папку, содержащую файл проекта моделирования (.modelproj) и диаграмму зависимости, а затем запустите MSBuild со следующим пользовательским свойством:

       ```
       msbuild /p:ValidateArchitecture=true
       ```

   - Чтобы проверить код в отношении всех проектов моделирования в решении, запустите MSBuild со следующим пользовательским свойством:

       ```
       msbuild <FilePath+SolutionName>.sln /p:ValidateArchitecture=true
       ```

     - или -

       Просмотрите папку решения, которая должна содержать проект моделирования, содержащую диаграмму зависимости, а затем запустите MSBuild со следующим пользовательским свойством:

       ```
       msbuild /p:ValidateArchitecture=true
       ```

     Отобразятся любые возникающие ошибки. Для получения дополнительной информации о MSBuild, см [MSBuild](../msbuild/msbuild.md) и [MSBuild задачи](../msbuild/msbuild-task.md).

   Для получения дополнительной информации [Troubleshoot layer validation issues](#troubleshoot-layer-validation-issues)об ошибках проверки см.

### <a name="manage-validation-errors"></a>Управление ошибками проверки

В процессе разработки может понадобиться подавить некоторые конфликты, выявленные в ходе проверки. Например, можно подавлять ошибки, над которыми уже ведется работа, а также ошибки, не имеющие отношения к конкретному сценарию. При подавлении ошибки необходимо регистрировать рабочий элемент в Team Foundation.

> [!WARNING]
> Вы должны быть уже подключены к управлению исходным кодом (SCC) TFS для создания рабочего элемента или связи с ним. При попытке открыть соединение с другим SCC TFS Visual Studio автоматически закрывает текущее решение. Убедитесь, что вы уже подключены соответствующему SCC, перед попыткой создания рабочего элемента или связи с ним. В последних выпусках Visual Studio команды меню недоступны, если вы не подключены к SCC.

#### <a name="create-a-work-item-for-a-validation-error"></a>Создание элемента работы для ошибки проверки

- В окне **списка ошибок** нажмите справа на кнопку «Ошибка», укажите на **создание рабочего элемента,** а затем нажмите на тип рабочего элемента, который вы хотите создать.

Используйте эти задачи для управления ошибками проверки в окне **списка ошибок:**

|**Кому**|**Выполните следующие действия**|
|-|-|
|Подавить выбранные ошибки во время проверки|Нажмите правой кнопкой один или несколько выбранных ошибок, указать **на управление ошибками проверки,** а затем нажмите **Подавить ошибки**.<br /><br /> Отобразятся подавленные ошибки с форматированием в виде зачеркивания. При выполнении проверки в следующий раз эти ошибки отображаться не будут.<br /><br /> Подавленные ошибки отслеживаются в файле .suppressions для соответствующего файла диаграммы зависимости.|
|Остановить подавление выбранных ошибок|Нажмите правой кнопкой выбранной подавленной ошибки или ошибки, укажите **на управление ошибками проверки,** а затем нажмите **Stop Suppressing Errors.**<br /><br /> При выполнении проверки в следующий раз выбранные подавленные ошибки будут отображаться.|
|Восстановить все подавленные ошибки в окне **списка ошибок**|Нажмите справа в любом месте в окне **списка ошибок,** укажите на **управление ошибками проверки,** а затем нажмите **Показать все подавленные ошибки.**|
|Скрыть все подавленные ошибки из окна **списка ошибок**|Нажмите справа в любом месте в окне **списка ошибок,** укажите на **управление ошибками проверки,** а затем нажмите **Скрыть все подавленные ошибки.**|

## <a name="validate-code-automatically"></a>Автоматическая проверка кода

Проверку слоев можно выполнять при каждом выполнении локальной сборки. Если ваша команда использует Azure DevOps, можно выполнить проверку уровня с помощью закрытых чеков, которые можно указать, создав пользовательскую задачу MSBuild, и использовать отчеты сборки для сбора ошибок проверки. Для создания закрытых сборок регистрации [см.](/azure/devops/pipelines/build/triggers)

### <a name="to-validate-code-automatically-during-a-local-build"></a>Автоматическая проверка кода во время локальной сборки

Откройте файл проекта моделирования (.modelproj) в текстовом редакторе и включите следующее свойство.

```xml
<ValidateArchitecture>true</ValidateArchitecture>
```

\- или -

1. В **Solution Explorer**, правой кнопкой мыши моделирования проекта, который содержит диаграммы зависимости или диаграммы, а затем нажмите **Свойства**.

2. В окне **Свойств** установить свойство **проверки архитектуры** проекта моделирования на **True.**

    Это позволяет включить проект моделирования в процесс проверки.

3. В **Solution Explorer**щелкните файл диаграммы зависимости (.layerdiagram), который требуется использовать для проверки.

4. В окне **Свойств** убедитесь, что свойство **«Действие** сборки» настроено на **проверку.**

    Это включает диаграмму зависимости в процессе проверки.

Для управления ошибками в окне списка ошибок [см.](#resolve-layer-validation-errors)

## <a name="troubleshoot-layer-validation-issues"></a>Устранение неполадок проверки слоев

Следующая таблица описывает проблемы проверки слоев и способы их устранения. Эти проблемы отличаются от ошибок, возникающих из-за несоответствия между кодом и структурой. Для получения дополнительной информации [Troubleshoot layer validation issues](#troubleshoot-layer-validation-issues)об этих ошибках см.

|**Проблема**|**Возможная причина**|**Решение**|
|-|-|-|
|Ошибки проверки не возникают так, как это ожидается.|Проверка не работает на диаграммах зависимостей, которые копируются с других диаграмм зависимостей в Solution Explorer и которые находятся в том же проекте моделирования. диаграммы зависимости, копированные таким образом, содержат те же ссылки, что и исходная диаграмма зависимости.|Добавьте новую диаграмму зависимости в проект моделирования.<br /><br /> Копирование элементов из диаграммы зависимости источника на новую диаграмму.|

## <a name="resolve-layer-validation-errors"></a>Устранение ошибок проверки слоя

При проверке кода на диаграмме зависимости возникают ошибки проверки, когда код противоречит проекту. Например, ошибки проверки могут происходить по следующим причинам:

- Артефакт назначен неправильному слою. В этом случае следует переместить артефакт.

- Способ использования артефактом (например, классом) другого класса конфликтует с имеющейся архитектурой. В этом случае необходимо выполнить рефакторинг кода, чтобы устранить зависимость.

Для устранения этих ошибок следует обновлять код до тех пор, пока в процессе проверки не перестанут происходить ошибки. Эту процедуру можно выполнить методом итераций.

В следующем разделе описывается синтаксис, используемый в этих ошибках, объясняется значение этих ошибок и предлагаются пути решения или управления ими.

|**Синтаксис**|**Описание**|
|-|-|
|*ArtifactN*(*ArtifactTypeN*)|*ArtifactN* — артефакт, связанный со слоем диаграммы зависимости.<br /><br /> *ArtifactTypeN* — это тип *ArtifactN,* **например, класс** или **метод:**<br /><br /> MySolution.MyProject.MyClass.MyMethod(Method)|
|*NamespaceNameN*|Имя пространства имен.|
|*LayerNameN*|Название слоя на диаграмме зависимости.|
|*DependencyType*|Тип зависимости между *Artifact1* и *Artifact2*. Например, *Artifact1* имеет отношение **вызовов** с *Artifact2*.|

| **Синтаксис ошибки** | **Описание ошибки** |
|-|-|
| DV0001: **Недействительная зависимость** | Эта проблема регистрируется, когда элемент кода (пространство имени, тип, элемент) отображается на уровне слоя, ссылается на элемент кода, отображаемый на другой слой, но нет стрелки зависимости между этими слоями в диаграмме проверки зависимости, содержащей этот слой. Это нарушение ограничения зависимости. |
| DV1001: **Недействительное имя** | Эта проблема сообщается о элементе кода, связанном с слоем, свойством которого "Разрешенные имена имен" не содержит пространство имен, в котором этот элемент кода определен. Это нарушение ограничения именования. Обратите внимание, что синтаксис "Разрешенные имена имен" должен быть полуколонный список имен, в которых кодовые элементы, связанные с слой, могут быть определены. |
| DV1002: **Зависимость от неоплачиваемого пространства имен** | Эта проблема сообщается о элементе кода, связанном с слоем и ссылаясь на другой элемент кода, определенный в пространстве имен, который определяется в свойстве "Неопределяемое пространство имен" слоя. Это нарушение ограничения именования. Обратите внимание, что свойство "Нессылканые именные пространства" определяется как разделенный список разделенных пространств имен, на который не следует ссылаться в кодовых элементах, связанных с этим слоем. |
| DV1003: **Запрещено имя** | Эта проблема сообщается о элементе кода, связанном с слоем, свойством которого "Запрещенные имена имен" содержит пространство имен, в котором этот элемент кода определен. Это нарушение ограничения именования. Обратите внимание, что свойство "Запрещенное имя" определяется как разделенный список разделенных пространств имен, в котором не следует определять кодовые элементы, связанные с этим слоем. |
| DV2001: **Присутствие диаграммы слоя** | Эта проблема сообщается о проекте, который не включает файл диаграммы зависимости, но относится к анализатору проверки зависимостей. Если проверка зависимостей не была использована, можно удалить "Microsoft.DependencyValidation.Analyzers" прямо из Solution Explorer или подавить это предупреждение. Для добавления диаграммы зависимости [см. Диаграммы зависимости из кода.](../modeling/create-layer-diagrams-from-your-code.md) |
| DV2002: **База неотображеных типов** | Эта проблема регистрируется, когда элемент кода не отображается на каком-либо слое. |
| DV3001: **Отсутствует ссылка** | Слой '*LayerName*' ссылки на '*Артефакт*", которые не могут быть найдены. Отсутствует ссылка на сборку? |
| DV9001: **Архитектурный анализ обнаружил внутренние ошибки** | Результат может быть неполным. Для получения дополнительных сведений см. подробный журнал событий построения или окно вывода. |

## <a name="see-also"></a>См. также раздел

- [Проверка живой зависимости в Visual Studio](https://devblogs.microsoft.com/devops/live-dependency-validation-in-visual-studio-2017/)
- [Проверка системы в ходе разработки](../modeling/validate-your-system-during-development.md)
- [Видео: Проверка зависимостей архитектуры в режиме реального времени](https://sec.ch9.ms/sessions/69613110-c334-4f25-bb36-08e5a93456b5/170ValidateArchitectureDependenciesWithVisualStudio.mp4)
