---
title: Проверка кода по схемам зависимостей
ms.date: 09/28/2018
ms.topic: conceptual
helpviewer_keywords:
- dependency diagrams, validating
- validation, dependency diagrams
- validation, code
- code exploration, validating
- architecture, validating
- Visual Studio Ultimate, validating code
- validation, architecture
- validation, dependencies
- MSBuild, tasks
- MSBuild, dependency diagrams
- MSBuild, validating code
author: gewarren
ms.author: gewarren
manager: jillfra
ms.workload:
- multiple
ms.openlocfilehash: 6e21c3699d796d6037d3b8ca0e744e792b9810b6
ms.sourcegitcommit: 75807551ea14c5a37aa07dd93a170b02fc67bc8c
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 07/11/2019
ms.locfileid: "67824543"
---
# <a name="validate-code-with-dependency-diagrams"></a>Проверка кода по схемам зависимостей

## <a name="why-use-dependency-diagrams"></a>Зачем использовать схемы зависимостей?

Чтобы убедиться, что код не конфликтует со структурой, проверьте его с помощью схем зависимостей в Visual Studio. Это может помочь:

- Найти конфликты между зависимостями в коде и зависимостями на схеме зависимостей.

- Найти зависимости, на которые могут повлиять предложенные изменения.

   Например можно изменить диаграмму зависимостей для отображения потенциальных изменений архитектуры и затем проверить код, чтобы просмотреть затронутые зависимости.

- Выполнить рефакторинг или миграцию кода в другую структуру.

   Найти код или зависимости, с которыми потребуется выполнить определенные действия даже после перемещения кода в другую архитектуру.

**Требования**

- Visual Studio

- Решение, включающее проект моделирования со схемой зависимостей. На этой схеме зависимости должны быть связаны с артефактами в проектах C# или Visual Basic, которые вы хотите проверить. См. в разделе [Создание схем зависимостей из кода](../modeling/create-layer-diagrams-from-your-code.md).

> [!NOTE]
> Схемы зависимостей не поддерживаются для проектов .NET Core в Visual Studio.

Чтобы узнать, какие выпуски Visual Studio поддерживают эту функцию, см. в разделе [Edition поддержка для инструментов моделирования и архитектуры](../modeling/what-s-new-for-design-in-visual-studio.md#VersionSupport).

Можно проверить код вручную из схемы откройте зависимостей в Visual Studio или из командной строки. Можно также проверять код автоматически при выполнении локальных сборок или конвейеры Azure сборок. См. в разделе [видео на Channel 9: Для проектирования и проверки архитектуры с помощью схем зависимостей](http://go.microsoft.com/fwlink/?LinkID=252073).

> [!IMPORTANT]
> Если вы хотите выполнить проверку слоев с помощью Team Foundation Server (TFS), необходимо также установить ту же версию Visual Studio на сервере сборки.

## <a name="live-dependency-validation"></a>Динамическая проверка зависимостей

Проверка зависимостей происходит в режиме реального времени и немедленно отображаются ошибки в **список ошибок**.

* Динамическая проверка поддерживается для C# и Visual Basic.

* Чтобы включить полный анализ решения, при использовании Динамическая проверка зависимостей, откройте настройки параметров в строке gold, отображаемый в **список ошибок**.

  - Она может закрыть окончательно в том случае, если вы не хотите просмотреть все архитектуры в решении проблемы.
  - Если не включить полный анализ решения, анализ выполняется только для файлов, который редактируется.

* При обновлении проектов для включения динамической проверки, диалоговое окно показывает ход выполнения преобразования.

* При обновлении проекта для Динамическая проверка зависимостей, версия пакета NuGet обновляется должны совпадать для всех проектов и самую новую версию используется.

* Добавив новые триггеры проекта проверки зависимостей обновление проекта.

## <a name="see-if-an-item-supports-validation"></a>Определение, поддерживает ли элемент проверку

Можно связать слои с веб-сайтов, документов Office, обычными текстовыми файлами и файлами в проектах, которые являются общими для нескольких приложений, но они не войдут в процессе проверки. Ошибки проверки для ссылок на проекты или сборки, связанные с отдельными слоями, отображаются только в том случае, если между этими слоями отображаются зависимости. Эти ссылки считаются зависимостями, только если используются в коде.

1. На схеме зависимостей, выберите один или несколько слоев, щелкните правой кнопкой мыши выбранные параметры и нажмите кнопку **Просмотр ссылок**.

2. В **обозреватель слоев**, рассмотрим **поддержка проверки** столбца. Если значение равно false, элемент не поддерживает проверку.

## <a name="include-other-net-assemblies-and-projects-for-validation"></a>Включение других сборок и проектов .NET для проверки

При перетаскивании элементов на схему зависимостей, ссылки на соответствующие сборки или проекты .NET автоматически добавляются в **ссылки слоя** папки в проекте моделирования. Эта папка содержит ссылки на сборки и проекты, которые анализируются во время проверки. Можно включить другие сборки .NET и проекты для проверки не вручную, перетащив их в диаграмму зависимостей.

1. В **обозревателе решений**, щелкните правой кнопкой мыши проект моделирования или **ссылки слоя** папку, а затем щелкните **добавить ссылку**.

2. В **добавить ссылку** диалоговом окне выберите сборки или проекты и нажмите кнопку **ОК**.

## <a name="validate-code-manually"></a>Проверка кода вручную

Если у вас есть диаграмму зависимостей open, связанного с элементами решения, можно запустить **Validate** команда быстрого доступа из схемы. Также можно использовать командную строку для запуска **msbuild** с **/p:ValidateArchitecture** пользовательское свойство, значение **True**. Например, при внесении изменений в код регулярно выполняйте проверку слоев, чтобы заранее обнаруживать конфликты зависимостей.

### <a name="validate-code-from-an-open-dependency-diagram"></a>Проверка кода из схемы откройте зависимостей

1. Щелкните правой кнопкой мыши поверхность схемы и нажмите кнопку **проверить архитектуру**.

    > [!NOTE]
    > По умолчанию **действие при построении** присваивается свойству зависимостей файл схемы (.layerdiagram) **Validate** таким образом, чтобы схема включена в процесс проверки.

     **Список ошибок** окно сообщает обо всех возникающих ошибках. Дополнительные сведения об ошибках проверки см. в разделе [Устранение неполадок проверки слоев](#troubleshoot-layer-validation-issues).

2. Чтобы просмотреть источник каждой ошибки, дважды щелкните ошибку в **список ошибок** окна.

    > [!NOTE]
    > Visual Studio может вместо источника ошибки показывать карту кода. Это происходит, когда код имеет зависимость от сборки, которая не задал диаграмму зависимостей, либо в коде отсутствует зависимость, которая определяется схема зависимостей. Просмотрите карту кода или код, чтобы определить, должна ли существовать зависимость. Дополнительные сведения о картах кода, см. в разделе [сопоставление зависимостей в решениях](../modeling/map-dependencies-across-your-solutions.md).

3. Для управления ошибками, см. в разделе [Устранение ошибок проверки слоев](#resolve-layer-validation-errors).

### <a name="validate-code-at-the-command-prompt"></a>Проверка кода в командной строке

1. Откройте командную строку Visual Studio.

2. Выберите один из следующих вариантов.

   - Чтобы проверить код на соответствие конкретному проекту моделирования в решении, запустите MSBuild со следующим пользовательским свойством.

       ```
       msbuild <FilePath+ModelProjectFileName>.modelproj /p:ValidateArchitecture=true
       ```

     - или

       Перейдите в папку, содержащую проект моделирования (.modelproj) файл и зависимости схемы, а затем запустите MSBuild со следующим пользовательским свойством:

       ```
       msbuild /p:ValidateArchitecture=true
       ```

   - Чтобы проверить код на соответствие всем проектам моделирования в решении, запустите MSBuild со следующим пользовательским свойством:

       ```
       msbuild <FilePath+SolutionName>.sln /p:ValidateArchitecture=true
       ```

     - или

       Перейдите к папке решения, в которой должен находиться проект моделирования со схемой зависимостей и запустите MSBuild со следующим пользовательским свойством:

       ```
       msbuild /p:ValidateArchitecture=true
       ```

     Отобразятся любые возникающие ошибки. Дополнительные сведения о MSBuild см. в разделе [MSBuild](../msbuild/msbuild.md) и [задачи MSBuild](../msbuild/msbuild-task.md).

   Дополнительные сведения об ошибках проверки см. в разделе [Устранение неполадок проверки слоев](#troubleshoot-layer-validation-issues).

### <a name="manage-validation-errors"></a>Управление ошибками проверки

В процессе разработки может понадобиться подавить некоторые конфликты, выявленные в ходе проверки. Например, можно подавлять ошибки, над которыми уже ведется работа, а также ошибки, не имеющие отношения к конкретному сценарию. При подавлении ошибки рекомендуется журнала рабочего элемента в Team Foundation.

> [!WARNING]
> Вы должны быть уже подключены к управлению исходным кодом (SCC) TFS для создания рабочего элемента или связи с ним. При попытке открыть соединение с другим SCC TFS Visual Studio автоматически закрывает текущее решение. Убедитесь, что вы уже подключены соответствующему SCC, перед попыткой создания рабочего элемента или связи с ним. В последних выпусках Visual Studio команды меню недоступны, если вы не подключены к SCC.

#### <a name="create-a-work-item-for-a-validation-error"></a>Создание рабочего элемента для ошибки проверки

- В **список ошибок** окно, щелкните ошибку правой кнопкой мыши **Создание рабочего элемента**, а затем выберите тип рабочего элемента, который вы хотите создать.

Использование этих задач для управления ошибками проверки в **список ошибок** окна:

|**Задача**|**Выполните следующие действия**|
|-|-|
|Подавить выбранные ошибки во время проверки|Щелкните один или несколько выбранных ошибок правой кнопкой мыши **Управление ошибками проверки**, а затем нажмите кнопку **подавление ошибок**.<br /><br /> Отобразятся подавленные ошибки с форматированием в виде зачеркивания. При выполнении проверки в следующий раз эти ошибки отображаться не будут.<br /><br /> Подавленные ошибки отслеживаются в suppressions-файле для соответствующего файла схеме зависимостей.|
|Остановить подавление выбранных ошибок|Щелкните выбранную подавленную ошибку или ошибки правой кнопкой мыши **Управление ошибками проверки**, а затем нажмите кнопку **Отменить подавление ошибок**.<br /><br /> При выполнении проверки в следующий раз выбранные подавленные ошибки будут отображаться.|
|Восстановить все подавленные ошибки в **список ошибок** окно|Щелкните правой кнопкой мыши **список ошибок** окна **Управление ошибками проверки**, а затем нажмите кнопку **Показать все подавленные ошибки**.|
|Скрыть все подавленные ошибки в **список ошибок** окно|Щелкните правой кнопкой мыши **список ошибок** окна **Управление ошибками проверки**, а затем нажмите кнопку **скрыть все подавленные ошибки**.|

## <a name="validate-code-automatically"></a>Автоматическая проверка кода

Проверку слоев можно выполнять при каждом выполнении локальной сборки. Если команда использует DevOps в Azure, можно выполнить проверку слоев с условными возвратами, которые можно задать путем создания пользовательской задачи MSBuild и использовать отчеты по сборке для сбора ошибок проверки. Чтобы создать с условным возвратом, см. в разделе [TFVC с условным возвратом](/azure/devops/pipelines/build/triggers#gated).

### <a name="to-validate-code-automatically-during-a-local-build"></a>Автоматическая проверка кода во время локальной сборки

Откройте файл проекта моделирования (.modelproj) в текстовом редакторе и включите следующее свойство.

```xml
<ValidateArchitecture>true</ValidateArchitecture>
```

\- или -

1. В **обозревателе решений**, щелкните правой кнопкой мыши проект моделирования, который содержит диаграмму зависимостей или схемы и нажмите кнопку **свойства**.

2. В **свойства** окне задайте проект моделирования **проверить архитектуру** свойства **True**.

    Это позволяет включить проект моделирования в процесс проверки.

3. В **обозревателе решений**, щелкните файл схемы (.layerdiagram) зависимостей, который вы хотите использовать для проверки.

4. В **свойства** окна, убедитесь, что схемы **действие при построении** свойству **Validate**.

    Сюда входят диаграмму зависимостей в процесс проверки.

Для управления ошибками в окне списка ошибок, см. в разделе [Устранение ошибок проверки слоев](#resolve-layer-validation-errors).

## <a name="troubleshoot-layer-validation-issues"></a>Устранение неполадок проверки слоев

Следующая таблица описывает проблемы проверки слоев и способы их устранения. Эти проблемы отличаются от ошибок, возникающих из-за несоответствия между кодом и структурой. Дополнительные сведения об этих ошибках см. в разделе [Устранение неполадок проверки слоев](#troubleshoot-layer-validation-issues).

|**Проблема**|**Возможная причина**|**Решение**|
|-|-|-|
|Ошибки проверки не возникают так, как это ожидается.|Проверка не работает на диаграммах зависимостей, которые скопированы из других схем зависимостей в обозревателе решений и находятся в том же проекте моделирования. схемы зависимостей, которые копируются в этом случае содержат те же ссылки, что и исходная схема зависимостей.|Добавьте новую схему зависимостей в проект моделирования.<br /><br /> Скопируйте элементы из исходной схемы зависимостей в новую диаграмму.|

## <a name="resolve-layer-validation-errors"></a>Устранение ошибок проверки слоев

При проверке кода по схеме зависимостей, ошибки проверки возникают, когда код конфликтует со структурой. Например, ошибки проверки могут происходить по следующим причинам:

- Артефакт назначен неправильному слою. В этом случае следует переместить артефакт.

- Способ использования артефактом (например, классом) другого класса конфликтует с имеющейся архитектурой. В этом случае необходимо выполнить рефакторинг кода, чтобы устранить зависимость.

Для устранения этих ошибок следует обновлять код до тех пор, пока в процессе проверки не перестанут происходить ошибки. Эту процедуру можно выполнить методом итераций.

В следующем разделе описывается синтаксис, используемый в этих ошибках, объясняется значение этих ошибок и предлагаются пути решения или управления ими.

|**Синтаксис**|**Описание**|
|-|-|
|*ArtifactN*(*ArtifactTypeN*)|*ArtifactN* — это артефакт, связанный со слоем на схеме зависимостей.<br /><br /> *ArtifactTypeN* — это тип *ArtifactN*, такие как **класс** или **метод**, например:<br /><br /> MySolution.MyProject.MyClass.MyMethod(Method)|
|*NamespaceNameN*|Имя пространства имен.|
|*LayerNameN*|Имя слоя на диаграмме зависимостей.|
|*Тип_зависимости*|Тип отношения зависимости между *Artifact1* и *Artifact2*. Например *Artifact1* имеет **вызовы** взаимосвязь *Artifact2*.|

| **Синтаксическая ошибка** | **Описание ошибки** |
|-|-|
| DV0001: **Недопустимая зависимость** | Эта проблема передается в том случае, если элемент кода (пространство имен, тип, член) сопоставлено ссылки слоя код элемента, сопоставленного с другого слоя, но есть не стрелка зависимости между этими уровнями в схема проверки зависимостей, содержащий этот слои. Это нарушение ограничения зависимостей. |
| DV1001: **Неверное имя пространства имен** | Эта проблема передаются на элемент кода, связанный со слоем, в котором свойство «Допускается имена пространства имен» не содержит пространство имен, в котором определен данный элемент кода. Это нарушение ограничения именования. Обратите внимание, что быть точкой с запятой список пространств имен кода элементы, связанные с представляют слой используется синтаксис «Допускается имена пространства имен» могут быть определены. |
| DV1002: **Зависимость от имен, на которые невозможно сослаться** | Эта проблема передаются на элемент кода, связанный со слоем и ссылкой на другой элемент кода, определенных в пространстве имен, который определен в свойстве «На которые невозможно сослаться пространства имен» слоя. Это нарушение ограничения именования. Обратите внимание на то, что свойство «На которые невозможно сослаться пространства имен» определяется как список пространств имен, не следует ссылаться в элементах кода, связанные с этим слоем, разделенных точкой с запятой. |
| DV1003: **Запрещенные пространства имен** | Эта проблема передаются на элемент кода, связанный со слоем, содержащий свойство «Запрещенные имена пространств имен» пространство имен, в котором определен данный элемент кода. Это нарушение ограничения именования. Обратите внимание на то, что свойство «Имя пространства имен не разрешено» определен как разделяются точкой с запятой список пространств имен, в какой код не следует определять элементы, связанные с этим слоем. |
| DV3001: **Отсутствует ссылка** | Уровень "*LayerName*«содержит ссылки на»*артефакта*" который невозможно найти. Отсутствует ссылка на сборку? |
| DV9001: **Анализ архитектуры, обнаружены внутренние ошибки** | Результат может быть неполным. Для получения дополнительных сведений см. подробный журнал событий построения или окно вывода. |

## <a name="see-also"></a>См. также

- [Динамическая проверка зависимостей в Visual Studio](https://devblogs.microsoft.com/devops/live-dependency-validation-in-visual-studio-2017/)
- [Проверка системы в ходе разработки](../modeling/validate-your-system-during-development.md)
- [Видео. Проверка зависимостей архитектуры в режиме реального времени](https://sec.ch9.ms/sessions/69613110-c334-4f25-bb36-08e5a93456b5/170ValidateArchitectureDependenciesWithVisualStudio.mp4)
