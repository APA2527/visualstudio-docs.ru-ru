---
title: Диагностика расширения пользовательского интерфейса задерживает в Visual Studio | Документация Майкрософт
ms.date: 01/26/2018
ms.topic: conceptual
author: PooyaZv
ms.author: pozandev
manager: jillfra
ms.workload: multiple
ms.openlocfilehash: 00266fd8fbc881707652247e08b093ca4b15a88d
ms.sourcegitcommit: 94b3a052fb1229c7e7f8804b09c1d403385c7630
ms.translationtype: MT
ms.contentlocale: ru-RU
ms.lasthandoff: 04/23/2019
ms.locfileid: "62912078"
---
# <a name="how-to-diagnose-ui-delays-caused-by-extensions"></a>Практическое руководство. Диагностика задержек в пользовательском интерфейсе, связанных с расширениями

Когда пользовательский Интерфейс перестает отвечать, Visual Studio проверяет стек вызовов потока пользовательского интерфейса, начиная с листового узла и направлении базы. Если Visual Studio определяет, что стек вызовов кадр принадлежит модулю, который является частью установленного и включенного расширения, система выводит уведомление.

![Задержка в пользовательском Интерфейсе (зависания) уведомлений](media/ui-delay-notification-in-vs.png)

Уведомление информирует пользователя, что задержка в пользовательском Интерфейсе (то есть зависания в пользовательском Интерфейсе) был результат выполнения кода из расширения. Он также предоставляет пользователю с параметрами, чтобы отключить расширение или будущих уведомлений для этого расширения.

В этом документе описывается, как диагностировать в код расширения причину задержки уведомлений пользовательского интерфейса.

> [!NOTE]
> Не используйте экспериментальный экземпляр Visual Studio для диагностики задержки пользовательского интерфейса. Некоторые части анализ стека вызовов, необходимые для уведомления о задержка пользовательского интерфейса будут отключены при использовании экспериментальный экземпляр, это означает, что уведомления о задержка пользовательского интерфейса могут не отображаться.

Обзор диагностики процесса выглядит следующим образом:
1. Определение сценария триггера.
2. Перезапустите VS с действием, вход в систему.
3. Начать трассировку событий Windows.
4. Вызывающее уведомление снова будет появляться.
5. Остановите отслеживание ETW.
6. Изучите журнал действий, чтобы получить идентификатор задержки.
7. Анализ трассировки событий Windows с помощью идентификатора задержки из шага 6.

В следующих разделах мы рассмотрим эти этапы в деталях.

## <a name="identify-the-trigger-scenario"></a>Определение сценария триггера

Для диагностики задержка в пользовательском Интерфейсе, необходимо сначала определить, какие (последовательность действий) приводит к Visual Studio, чтобы показать уведомление. Это, чтобы для вас возможность позже вызывающее уведомление с ведением журнала.

## <a name="restart-vs-with-activity-logging-on"></a>Перезапустите VS с действием, вход в систему

Visual Studio можно создавать «журнал действий», предоставляющий сведения, полезные при отладке проблемы. Чтобы включить действия, ведение журнала в Visual Studio, откройте Visual Studio с `/log` параметр командной строки. После запуска Visual Studio, журнал действий хранятся в следующем расположении:

```DOS
%APPDATA%\Microsoft\VisualStudio\<vs_instance_id>\ActivityLog.xml
```

Чтобы узнать больше о том, как можно найти в VS идентификатор экземпляра, см. в разделе [средства для обнаружения и управления экземплярами Visual Studio](../install/tools-for-managing-visual-studio-instances.md). Мы будем использовать этот журнал действий позже для получения дополнительных сведений о пользовательском Интерфейсе задержки и связанные с ним уведомления.

## <a name="starting-etw-tracing"></a>Запуск отслеживания ETW

Можно использовать [PerfView](https://github.com/Microsoft/perfview/) для сбора трассировки приложения трассировки событий Windows. PerfView предоставляет простой в использовании интерфейс для анализа и для сбора трассировки ETW. Для сбора трассировки, используйте следующую команду:

```DOS
Perfview.exe collect C:\trace.etl /BufferSizeMB=1024 -CircularMB:2048 -Merge:true -Providers:*Microsoft-VisualStudio:@StacksEnabled=true -NoV2Rundown /kernelEvents=default+FileIOInit+ContextSwitch+Dispatcher
```

Это позволяет поставщику «Microsoft VisualStudio», который является поставщиком, используемый Visual Studio для событий, связанных с уведомления о задержка пользовательского интерфейса. Также указывается ключевое слово для поставщика ядра, PerfView можно использовать для создания **стеки потоков времени** представления.

## <a name="trigger-the-notification-to-appear-again"></a>Триггер снова будет появляться уведомление

После запуска коллекции трассировки PerfView последовательность действий триггера (из шага 1) для уведомления можно использовать снова будет появляться. После отображения уведомления вы можете остановить сбор данных трассировки для PerfView для обработки и создания в выходном файле трассировки.

## <a name="stop-etw-tracing"></a>Остановить отслеживание ETW

Чтобы остановить сбор данных трассировки, просто используйте **остановка сбора** , окно PerfView. После остановки сбора трассировки PerfView будет автоматически обрабатывать события трассировки событий Windows и создает выходной файл трассировки.

## <a name="examine-the-activity-log-to-get-the-delay-id"></a>Изучите журнал действий, чтобы получить идентификатор задержки

Как упоминалось ранее, можно найти в журнал действий *%APPDATA%\Microsoft\VisualStudio\<vs_instance_id > \ActivityLog.xml*. Каждый раз, Visual Studio обнаруживает расширением задержка в пользовательском Интерфейсе, он записывает узел в журнал действий с `UIDelayNotifications` как источник. Этот узел содержит четыре части информации о задержка в пользовательском Интерфейсе:

- Идентификатор задержка пользовательского интерфейса, это число, однозначно определяющее задержка в пользовательском Интерфейсе в сеансе VS
- Идентификатор сеанса, который однозначно идентифицирует сеанс Visual Studio от начала до закрытия
- Ли уведомление было показано для задержка в пользовательском Интерфейсе
- Расширение, которое вероятная причина-задержка в пользовательском Интерфейсе

```xml
<entry>
  <record>271</record>
  <time>2018/02/03 12:02:52.867</time>
  <type>Information</type>
  <source>UIDelayNotifications</source>
  <description>A UI delay (Delay ID = 0) has been detected. (Session ID=16e49d4b-26c2-4247-ad1c-488edeb185e0; Blamed extension="UIDelayR2"; Notification shown? Yes.)</description>
</entry>
```

> [!NOTE]
> Не все результат задержки пользовательского интерфейса в уведомлении. Поэтому всегда следует выполнять проверку **показано уведомление?** значение, чтобы правильно определить правой задержка в пользовательском Интерфейсе.

Найдя правильный задержка в пользовательском Интерфейсе в журнале действий, запишите идентификатор задержка пользовательского интерфейса, указанное в узле. Идентификатор используется для поиска соответствующего события трассировки событий Windows на следующем шаге.

## <a name="analyze-the-etw-trace"></a>Анализ трассировки событий Windows

Затем откройте файл трассировки. Это можно сделать с помощью один и тот же экземпляр объекта PerfView или создав новый экземпляр и параметр текущий путь к папке в верхнем левом углу окна в расположение файла трассировки.

![Задание пути к папке в Perfview](media/perfview-set-path.png)

Затем выберите файл трассировки в области слева и откройте его, выбрав **откройте** из контекстного меню.

> [!NOTE]
> По умолчанию PerfView выводит ZIP-архив. При открытии *trace.zip*, она автоматически распаковывает архив и открывает трассировки. Это действие можно пропустить, сняв флажок **Zip** поле во время сбора трассировки. Тем не менее, если вы планируете перенести и применения трассировок на разных компьютерах, настоятельно не рекомендуется сняв флажок **Zip** поле. Без этого параметра требуется PDB-файлы для сборок Ngen не будет сопровождать трассировки, и таким образом символы из сборок Ngen не будут разрешены на конечном компьютере. (См. в разделе [этой записи блога](https://devblogs.microsoft.com/devops/creating-ngen-pdbs-for-profiling-reports/) Дополнительные сведения о PDB-файлы для сборок Ngen.)

Может занять несколько минут PerfView для обработки и откройте трассировку. Если трассировка уже открыт, в нем отобразится список различных «представления».

![Представление "Сводка" трассировки PerfView](media/perfview-summary-view-events-selected.png)

Сначала мы используем **события** представление, чтобы получить диапазон времени задержка в пользовательском Интерфейсе:

1. Откройте **события** представление, выбрав `Events` узел в трассировке и выбрав **откройте** из контекстного меню.
2. Выберите "`Microsoft-VisualStudio/ExtensionUIUnresponsiveness`" в левой области.
3. Нажмите клавишу ВВОД

Выделение применяется и все `ExtensionUIUnresponsiveness` события отображаются в области справа.

![Выбор событий в представлении событий](media/perfview-event-selection.png)

Каждая строка в правой области соответствует задержка в пользовательском Интерфейсе. Событие включает значение «Задержка ID», которое должен совпадать с Идентификатором задержки в журнале действий с шага 6. Так как `ExtensionUIUnresponsiveness` возникает в конце задержка в пользовательском Интерфейсе, метка времени события (примерно) метки времени завершения задержка в пользовательском Интерфейсе. Событие также содержит длительность задержки. Мы можно вычитать время из отметка времени окончания, чтобы получить метку времени, при запуске задержка в пользовательском Интерфейсе.

![Вычисление пользовательского интерфейса задержки диапазон времени](media/ui-delay-time-range.png)

В предыдущем снимке экрана например, метка времени события — 12,125.679 и длительность задержки — 6,143.085 (мс). Таким образом, выражение
* Начало задержки — 12,125.679 6,143.085 = 5,982.594.
* Диапазон времени задержки пользовательского интерфейса — 5,982.594 для 12,125.679.

Получив диапазон времени, можно закрыть из **события** Просмотр и открытие **стеки потоков времени (с действиями StartStop)** представления. В этом представлении особенно удобно, поскольку часто расширений, которые блокируют поток пользовательского интерфейса просто ожидает другие потоки или операции ввода-вывода. Таким образом **стека ЦП** представление, которое является идеально подходит для большинства случаев, не может фиксировать время нового потока, блокировка, так как она не использует ЦП в течение этого времени. **Стеки потоков времени** решает эту проблему, правильно отображения заблокированных времени.

![Узел стеки времени (с действиями StartStop) потока в представлении сводки PerfView](media/perfview-thread-time-with-startstop-activities-stacks.png)

При открытии **стеки потоков времени** просмотреть, выберите **devenv** процесса для запуска анализа.

![Поток представление стеков времени для задержки анализ пользовательского интерфейса](media/ui-delay-thread-time-stacks.png)

В **стеки потоков времени** просмотра, в верхнем левом углу страницы, можно задать диапазон времени значения, вычисленного в предыдущем шаге и нажмите клавишу **ввод** , стеки, корректируются с учетом этого диапазона времени.

> [!NOTE]
> Определить, какой поток пользовательского интерфейса (запуска) может быть поток нелогичным, если сбор данных трассировки запускается после Visual Studio уже открыт. Тем не менее, первый элемент в стеке потока пользовательского интерфейса (загрузка) — это наиболее вероятный всегда операционной системы библиотеки DLL (*ntdll.dll* и *kernel32.dll*) следуют `devenv!?` и затем `msenv!?` . Эта последовательность может помочь определить в потоке пользовательского интерфейса.

 ![Определять поток запуска](media/ui-delay-startup-thread.png)

Можно также отфильтровать это представление, только в том числе стеков, которые содержат модули из пакета.

* Задайте **GroupPats** в пустой текст для удаления любое группирование, добавляется по умолчанию.
* Задайте **IncPats** для включает имя сборки в дополнение к существующий фильтр процесса. В этом случае следует **devenv; UIDelayR2**.

![Задание GroupPath и IncPath в представление стеков потоков времени](media/perfview-tts-group-path-inc-path.png)

PerfView содержит подробные инструкции в разделе **помочь** меню, которое можно использовать для выявления узких мест производительности в коде. Кроме того следующие ссылки предоставляют дополнительные сведения о том, как использовать Visual Studio, работа с потоками API-интерфейсы для оптимизации кода:

* [https://aka.ms/vsthreading](https://aka.ms/vsthreading)
* [https://aka.ms/vsthreadingcookbook](https://aka.ms/vsthreadingcookbook)

Можно также использовать новый статический анализаторы Visual Studio для расширения (пакет NuGet [здесь](https://www.nuget.org/packages/microsoft.visualstudio.sdk.analyzers)), предоставить рекомендации по рекомендации по написанию эффективного расширения. Просмотреть список [анализаторы VS SDK](https://github.com/Microsoft/VSSDK-Analyzers/blob/master/doc/index.md) и [threading анализаторы](https://github.com/Microsoft/vs-threading/blob/master/doc/analyzers/index.md).

> [!NOTE]
> Если вы не сможете решить зависания, из-за зависимостей, у вас нет контроля над (например, если расширение имеет вызов синхронных служб VS в потоке пользовательского интерфейса), мы бы хотели узнать об этом. Если вы являетесь участником нашей Visual Studio партнерской программы, свяжитесь с нами, отправив запрос в службу поддержки разработчиков. В противном случае используйте средство «Сообщить о проблеме», отправьте свой отзыв и включить `"Extension UI Delay Notifications"` в заголовке. Также включите подробное описание анализа.
